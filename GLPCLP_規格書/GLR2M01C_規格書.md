# 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLR2M01C
- **程式說明**：會計系統總分類帳科目彙總報表執行程式
- **程式語言**：CLP
- **程式位置**：QCLSRC_GLPLIB/GLR2M01C
- **開發人員**：A1087 JOYCE
- **建立日期**：1992/11/27
- **系統名稱**：會計系統
- **子系統**：會計處理
- **備註**：總分類帳科目彙總報表執行
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLWF10：會計主檔
  - GLAHLF02：會計明細檔
- **相關程式**
  - GLR2M01：報表產生程式
  - GLR2M02：報表處理程式
  - GLR2M03：報表處理程式
  - P64：報表列印控制程式

## 3. 檔案欄位規格說明
### 變數宣告：
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| &$PENV | 字元 | 1位元 | 環境變數 |
| &$CPY | 字元 | 3位元 | 公司代號 |
| &$PRTCD | 字元 | 2位元 | 列印代號 |
| &P6401I | 字元 | 10位元 | 報表名稱 |
| &P6403I | 數值 | 3位元 | 公司代號 |
| &DAH01 | 字元 | 2位元 | 系統代號 |
| &DAH04 | 字元 | 8位元 | 會計科目 |
| &DAH26F | 字元 | 10位元 | 日期起始值 |
| &DAH26T | 字元 | 10位元 | 日期結束值 |
| &DAH10F | 字元 | 8位元 | 借方科目起始值 |
| &DAH10T | 字元 | 8位元 | 借方科目結束值 |
| &DAH25F | 字元 | 8位元 | 貸方科目起始值 |
| &DAH25T | 字元 | 8位元 | 貸方科目結束值 |
| &DAH05S | 字元 | 20位元 | 借方摘要起始值 |
| &DAH05E | 字元 | 20位元 | 借方摘要結束值 |
| &DAH06S | 字元 | 20位元 | 貸方摘要起始值 |
| &DAH06E | 字元 | 20位元 | 貸方摘要結束值 |
| &DAH07S | 字元 | 20位元 | 借方部門起始值 |
| &DAH07E | 字元 | 20位元 | 借方部門結束值 |
| &DAH08S | 字元 | 20位元 | 貸方部門起始值 |
| &DAH08E | 字元 | 20位元 | 貸方部門結束值 |
| &DAH09F | 字元 | 8位元 | 借方專案起始值 |
| &DAH09T | 字元 | 8位元 | 借方專案結束值 |
| &DK | 字元 | 1位元 | 報表格式選擇 |
| &WDJS | 字元 | 13位元 | 借方金額起始值 |
| &WDJE | 字元 | 13位元 | 借方金額結束值 |
| &WCJS | 字元 | 13位元 | 貸方金額起始值 |
| &WCJE | 字元 | 13位元 | 貸方金額結束值 |

## 4. 輸出/入螢幕布局與說明
- 無螢幕輸出
- 報表格式：
  * 主報表（GLR2M0P）：
    - 頁面大小：198
    - 字型大小：15
    - 溢位控制：55
  * 明細報表（GLR2M1P）：
    - 頁面大小：198
    - 字型大小：15

## 5. 處理流程程序說明
### 1. 程式初始化
- 宣告變數
- 從LDA資料區讀取參數：
  * 系統代號（LDA 501-502）
  * 會計科目（LDA 503-510）
  * 日期範圍（LDA 511-530）
  * 借方科目範圍（LDA 545-560）
  * 貸方科目範圍（LDA 575-590）
  * 摘要範圍（LDA 592-760）
  * 部門範圍（LDA 612-740）
  * 專案範圍（LDA 672-768）
  * 報表格式（LDA 778）
  * 金額範圍（LDA 780-832）

### 2. 主要處理邏輯
1. 資料庫檔案處理：
   - 複製並清除GLWF10到QTEMP
   - 覆蓋資料庫檔案為共享模式

2. 查詢條件設定：
   - 建立查詢檔案，條件包含：
     * 系統代號（AH01）
     * 會計科目（AH04）
     * 日期範圍（AH26）
     * 借方科目範圍（AH10C）
     * 貸方科目範圍（AH25C）
     * 摘要範圍（AH05-AH08）
     * 專案範圍（AH09C）
     * 金額範圍（AH12C, AH13C）
     * 其他條件（AH18='V'）

3. 報表產生與處理：
   - 呼叫GLR2M01產生報表
   - 根據&DK選擇報表格式：
     * '1'或'3'：呼叫GLR2M02
     * '2'或'3'：呼叫GLR2M03

4. 報表列印控制：
   - 讀取系統參數：
     * 環境變數（LDA 219）
     * 公司代號（LDA 125-127）
     * 列印代號（LDA 217-218）
   - 根據報表格式列印：
     * 主報表（GLR2M0P）
     * 明細報表（GLR2M1P）

## 6. 子程序處理邏輯說明
- **GLR2M01**：報表產生程式
  * 負責報表內容的產生
  * 使用GLAHLF02資料來源

- **GLR2M02**：報表處理程式
  * 處理主報表格式
  * 當&DK='1'或'3'時執行

- **GLR2M03**：報表處理程式
  * 處理明細報表格式
  * 當&DK='2'或'3'時執行

- **P64**：報表列印控制程式
  * 控制報表的實際列印
  * 參數：
    - 報表名稱（&P6401I）
    - 環境設定（&$PENV）
    - 公司代號（&P6403I）
    - 列印代號（&$PRTCD）

## 7. 錯誤處理程序說明與訊息清冊
- 資料庫檔案處理錯誤：
  * CPF2817：檔案已存在
  * 查詢檔案建立失敗時會影響報表產生
- 報表列印錯誤：
  * 報表格式設定錯誤時會影響輸出
  * 列印控制失敗時會影響實際輸出

## 8. 備註
- 程式主要用於執行總分類帳科目彙總報表的產生和列印
- 支援多種報表格式：
  * 主報表
  * 明細報表
  * 可同時產生兩種報表
- 使用LDA資料區傳遞參數
- 程式結構包含：
  * 參數讀取
  * 資料查詢
  * 報表產生
  * 報表處理
  * 報表列印
- 查詢條件特點：
  * 支援多欄位範圍查詢
  * 包含金額範圍控制
  * 支援借貸方資料處理
  * 可依部門和專案篩選 
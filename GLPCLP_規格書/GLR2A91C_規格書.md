# 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLR2A91C
- **程式說明**：會計系統報表執行程式（進階版）
- **程式語言**：CLP
- **程式位置**：QCLSRC_GLPLIB/GLR2A91C
- **開發人員**：A1149 MAY
- **建立日期**：1992/11/13
- **系統名稱**：會計系統
- **子系統**：會計處理
- **備註**：報表執行（進階版）
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLWF02：工作檔案
  - GLAHLF01：會計主檔
  - GLAILF01：會計明細檔
- **相關程式**
  - GLR2A01：報表產生程式
  - GLR2A011：總分類帳報表程式
  - GLR2A012：明細分類帳報表程式
  - P64：報表列印控制程式

## 3. 檔案欄位規格說明
### 變數宣告：
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| &DAH01 | 字元 | 2位元 | 系統代號 |
| &DOPT | 字元 | 1位元 | 報表選項 |
| &DAH04S | 字元 | 8位元 | 起始科目代號 |
| &DAH04E | 字元 | 8位元 | 結束科目代號 |
| &DATE | 字元 | 8位元 | 日期 |
| &P006O1 | 字元 | 8位元 | 起始日期 |
| &P006O2 | 字元 | 8位元 | 結束日期 |
| &P006O3 | 字元 | 1位元 | 選項3 |
| &P006O4 | 字元 | 1位元 | 選項4 |
| &DAH04 | 字元 | 8位元 | 科目代號 |
| &DSEL | 字元 | 1位元 | 選擇條件 |
| &DAH05S | 字元 | 20位元 | 起始部門代號 |
| &DAH06S | 字元 | 20位元 | 起始專案代號 |
| &DAH07S | 字元 | 20位元 | 起始成本中心代號 |
| &DAH08S | 字元 | 20位元 | 起始預算代號 |
| &DAH09F | 字元 | 8位元 | 起始日期 |
| &DAH05E | 字元 | 20位元 | 結束部門代號 |
| &DAH06E | 字元 | 20位元 | 結束專案代號 |
| &DAH07E | 字元 | 20位元 | 結束成本中心代號 |
| &DAH08E | 字元 | 20位元 | 結束預算代號 |
| &DAH09T | 字元 | 8位元 | 結束日期 |
| &$YEAR | 字元 | 4位元 | 年度 |
| &$PENV | 字元 | 1位元 | 環境變數 |
| &$CPY | 字元 | 3位元 | 公司代號 |
| &$PRTCD | 字元 | 2位元 | 列印代號 |
| &P6401I | 字元 | 10位元 | 報表名稱 |
| &P6403I | 數值 | 3位元 | 公司代號 |

## 4. 輸出/入螢幕布局與說明
- 無螢幕輸出
- 使用報表檔案：
  * GLR2A0P：總分類帳報表
  * GLR2A1P：明細分類帳報表
- 報表格式：
  * 字體大小：15 CPI

## 5. 處理流程程序說明
### 1. 程式初始化
- 宣告變數
- 從LDA資料區讀取參數：
  * 系統代號（LDA 501-502）
  * 報表選項（LDA 503）
  * 科目代號範圍（LDA 504-512）
  * 日期（LDA 520-527）
  * 其他參數（LDA 528-760）

### 2. 主要處理邏輯
1. 工作檔案處理：
   - 複製工作檔案（GLWF02）到QTEMP
   - 清除檔案內容
   - 覆蓋資料庫檔案

2. 資料庫檔案處理：
   - 覆蓋資料庫檔案為共享模式
   - 根據選擇條件建立查詢檔案：
     * 條件N：基本查詢
       - 系統代號（AH01）
       - 科目代號範圍（AH04）
       - 日期範圍（AH10C）
       - 有效資料（AH18 = 'V'）
     * 其他條件：進階查詢
       - 系統代號（AH01）
       - 科目代號（AH04）
       - 日期範圍（AH10C）
       - 有效資料（AH18 = 'V'）
       - 部門範圍（AH05）
       - 專案範圍（AH06）
       - 成本中心範圍（AH07）
       - 預算範圍（AH08）
       - 日期範圍（AH09C）

3. 報表產生與列印：
   - 呼叫GLR2A01產生報表
   - 根據報表選項執行不同報表：
     * 選項1：總分類帳報表（GLR2A011）
     * 選項2：明細分類帳報表（GLR2A012）
   - 關閉查詢檔案
   - 刪除覆蓋設定

4. 報表列印控制：
   - 讀取系統參數
   - 呼叫P64程式進行報表列印

## 6. 子程序處理邏輯說明
- **GLR2A01**：報表產生程式
  * 負責基本報表內容的產生

- **GLR2A011**：總分類帳報表程式
  * 產生總分類帳報表
  * 使用GLR2A0P報表格式

- **GLR2A012**：明細分類帳報表程式
  * 產生明細分類帳報表
  * 使用GLR2A1P報表格式

- **P64**：報表列印控制程式
  * 控制報表的實際列印
  * 參數：
    - 報表名稱（&P6401I）
    - 環境設定（&$PENV）
    - 公司代號（&P6403I）
    - 列印代號（&$PRTCD）

## 7. 錯誤處理程序說明與訊息清冊
- 工作檔案處理錯誤：
  * CPF2817：檔案已存在
  * 其他錯誤：清除檔案內容
- 查詢檔案建立失敗時會影響報表產生
- 報表列印失敗時會影響實際輸出

## 8. 備註
- 程式主要用於執行會計報表的產生和列印（進階版）
- 支援兩種報表類型：
  * 總分類帳報表
  * 明細分類帳報表
- 支援兩種查詢模式：
  * 基本查詢（條件N）
  * 進階查詢（其他條件）
- 使用LDA資料區傳遞參數
- 程式結構包含：
  * 參數讀取
  * 檔案處理
  * 資料查詢
  * 報表產生
  * 報表列印 
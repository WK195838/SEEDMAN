# 銷貨模組程式功能規格書

## 一、基本資料

| 項目 | 說明 |
|------|------|
| **系統名稱** | 10.10.10.180 企業管理系統 |
| **模組名稱** | 銷貨模組 |
| **模組代號** | NP (Sales) |
| **程式名稱** | 銷貨管理系統 |
| **程式代號** | NPMGT |
| **功能名稱** | 銷貨管理 |
| **功能代號** | NP001 |
| **撰寫人員** | 系統分析師 |
| **撰寫日期** | 2024/12/19 |
| **審核人員** | 專案經理 |
| **審核日期** | 2024/12/19 |
| **版本編號** | v1.0 |
| **文件狀態** | 草稿 |

---

## 二、檔案架構與關聯圖

### 2.1 銷貨模組檔案架構圖

```mermaid
graph TB
    subgraph "銷貨模組檔案架構"
        subgraph "主檔層"
            A[NPAHPF - 銷貨訂單檔]
            B[NPACPF - 客戶主檔]
            C[NPACLF - 客戶邏輯檔]
            D[NPAIPF - 銷貨項目檔]
        end
        
        subgraph "工作檔層"
            E[NPWF01 - 訂單工作檔]
            F[NPWF02 - 客戶工作檔]
            G[NPWF03 - 出貨工作檔]
            H[NPWF04 - 報表工作檔]
        end
        
        subgraph "參照檔層"
            I[NPRF - 銷貨參照檔]
            J[NPARF - 參數參照檔]
            K[NPCODRF - 代碼參照檔]
            L[NPPARF - 價格參照檔]
        end
        
        subgraph "報表檔層"
            M[NPRP001 - 銷貨訂單表]
            N[NPRP002 - 客戶明細表]
            O[NPRP003 - 出貨明細表]
            P[NPRP004 - 銷貨分析表]
        end
    end
    
    A --> E
    B --> F
    C --> G
    D --> H
    I --> A
    J --> B
    K --> C
    L --> D
    E --> M
    F --> N
    G --> O
    H --> P
```

### 2.2 銷貨模組系統架構圖

```mermaid
graph LR
    subgraph "使用者介面層"
        UI1[Web 介面]
        UI2[終端機介面]
        UI3[行動裝置介面]
    end
    
    subgraph "應用邏輯層"
        AL1[訂單處理邏輯]
        AL2[客戶管理邏輯]
        AL3[出貨管理邏輯]
        AL4[價格管理邏輯]
        AL5[報表產生邏輯]
    end
    
    subgraph "資料存取層"
        DA1[資料庫連線管理]
        DA2[交易管理]
        DA3[資料快取]
        DA4[檔案存取]
    end
    
    subgraph "資料儲存層"
        DS1[IBM i 資料庫]
        DS2[檔案系統]
        DS3[備份系統]
        DS4[日誌系統]
    end
    
    UI1 --> AL1
    UI2 --> AL2
    UI3 --> AL3
    AL1 --> DA1
    AL2 --> DA2
    AL3 --> DA3
    AL4 --> DA4
    AL5 --> DA1
    DA1 --> DS1
    DA2 --> DS2
    DA3 --> DS3
    DA4 --> DS4
```

### 2.3 檔案關聯圖

```mermaid
erDiagram
    NPAHPF ||--o{ NPAIPF : "訂單明細"
    NPAHPF ||--|| NPACPF : "客戶參照"
    NPACPF ||--o{ NPACLF : "邏輯檢索"
    NPAHPF ||--o{ NPWF01 : "訂單處理"
    NPAHPF ||--o{ NPWF03 : "出貨處理"
    
    NPAHPF {
        string 訂單編號 PK
        string 客戶代碼 FK
        date 訂單日期
        string 訂單狀態
        decimal 訂單金額
        string 付款條件
        string 建立人員
        timestamp 建立時間
    }
    
    NPACPF {
        string 客戶代碼 PK
        string 客戶名稱
        string 客戶類別
        string 聯絡地址
        string 聯絡電話
        string 信用額度
        string 狀態
    }
    
    NPAIPF {
        string 訂單編號 FK
        string 產品代碼 FK
        int 序號
        decimal 數量
        decimal 單價
        decimal 金額
        string 備註
    }
    
    NPWF01 {
        string 工作編號 PK
        string 訂單編號 FK
        string 處理狀態
        string 暫存資料
        timestamp 建立時間
    }
```

### 2.4 檔案清單

| 檔案類型 | 檔案名稱 | 檔案代號 | 用途說明 |
|----------|----------|----------|----------|
| 主檔 | 銷貨訂單檔 | NPAHPF | 儲存所有銷貨訂單的主檔資料 |
| 主檔 | 客戶主檔 | NPACPF | 儲存客戶基本資料的主檔 |
| 主檔 | 銷貨項目檔 | NPAIPF | 儲存訂單明細項目的資料 |
| 邏輯檔 | 客戶邏輯檔 | NPACLF | 提供客戶查詢和排序的邏輯檔案 |
| 工作檔 | 訂單工作檔 | NPWF01 | 訂單處理過程中的暫存資料 |
| 工作檔 | 客戶工作檔 | NPWF02 | 客戶管理過程中的暫存資料 |
| 工作檔 | 出貨工作檔 | NPWF03 | 出貨處理過程中的暫存資料 |
| 工作檔 | 報表工作檔 | NPWF04 | 報表產生過程中的暫存資料 |
| 參照檔 | 銷貨參照檔 | NPRF | 銷貨模組的參照資料 |
| 參照檔 | 參數參照檔 | NPARF | 銷貨模組的參數設定 |
| 參照檔 | 代碼參照檔 | NPCODRF | 銷貨模組的代碼對照 |
| 參照檔 | 價格參照檔 | NPPARF | 產品價格的參照資料 |

---

## 三、檔案名稱，欄位代號、名稱、位置、長度、型態、屬性、檢核說明

### 3.1 銷貨訂單檔 (NPAHPF) 欄位規格

#### 3.1.1 記錄格式：NPAHPR
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 檢核說明 |
|----------|----------|------|------|------|------|----------|
| AH01 | 公司代碼 | 1-3 | 3 | CHAR | PK | 必填，參照公司主檔 |
| AH02 | 訂單編號 | 4-15 | 12 | CHAR | PK | 必填，系統自動產生 |
| AH03 | 客戶代碼 | 16-20 | 5 | CHAR | FK | 必填，參照客戶主檔 |
| AH04 | 訂單日期 | 21-28 | 8 | DATE | - | 必填，格式：YYYYMMDD |
| AH05 | 訂單狀態 | 29-29 | 1 | CHAR | - | 必填，1:草稿 2:確認 3:出貨 4:完成 5:取消 |
| AH06 | 訂單金額 | 30-39 | 10 | DECIMAL | - | 必填，金額格式 |
| AH07 | 付款條件 | 40-41 | 2 | CHAR | - | 必填，參照付款條件檔 |
| AH08 | 交貨日期 | 42-49 | 8 | DATE | - | 必填，不能早於訂單日期 |
| AH09 | 交貨地址 | 50-89 | 40 | CHAR | - | 必填，最多40字元 |
| AH10 | 備註 | 90-129 | 40 | CHAR | - | 可選，最多40字元 |
| AH11 | 建立人員 | 130-134 | 5 | CHAR | - | 必填，參照使用者檔 |
| AH12 | 建立時間 | 135-142 | 8 | TIMESTAMP | - | 系統自動產生 |
| AH13 | 修改人員 | 143-147 | 5 | CHAR | - | 可選，參照使用者檔 |
| AH14 | 修改時間 | 148-155 | 8 | TIMESTAMP | - | 系統自動產生 |
| AH15 | 狀態 | 156-156 | 1 | CHAR | - | 必填，A:有效 D:刪除 |

#### 3.1.2 主鍵欄位
- **主鍵1**：AH01 - 公司代碼 (CHAR(3))
- **主鍵2**：AH02 - 訂單編號 (CHAR(12))

#### 3.1.3 索引資料
| 索引名稱 | 索引類型 | 索引欄位 | 說明 |
|----------|----------|----------|------|
| NPH001 | 主鍵索引 | AH01, AH02 | 主要查詢索引 |
| NPH002 | 一般索引 | AH03, AH04 | 客戶日期查詢索引 |
| NPH003 | 一般索引 | AH05, AH04 | 狀態日期查詢索引 |
| NPH004 | 一般索引 | AH11, AH12 | 建立人員時間索引 |

### 3.2 客戶主檔 (NPACPF) 欄位規格

#### 3.2.1 記錄格式：NPACPR
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 檢核說明 |
|----------|----------|------|------|------|------|----------|
| AC01 | 客戶代碼 | 1-5 | 5 | CHAR | PK | 必填，唯一值 |
| AC02 | 客戶名稱 | 6-35 | 30 | CHAR | - | 必填，最多30字元 |
| AC03 | 客戶類別 | 36-36 | 1 | CHAR | - | 必填，1:一般 2:VIP 3:經銷商 |
| AC04 | 聯絡地址 | 37-76 | 40 | CHAR | - | 必填，最多40字元 |
| AC05 | 聯絡電話 | 77-86 | 10 | CHAR | - | 必填，電話格式 |
| AC06 | 聯絡人員 | 87-96 | 10 | CHAR | - | 必填，最多10字元 |
| AC07 | 信用額度 | 97-106 | 10 | DECIMAL | - | 必填，金額格式 |
| AC08 | 付款條件 | 107-108 | 2 | CHAR | - | 必填，參照付款條件檔 |
| AC09 | 稅籍編號 | 109-118 | 10 | CHAR | - | 可選，統一編號格式 |
| AC10 | 狀態 | 119-119 | 1 | CHAR | - | 必填，A:有效 D:停用 |
| AC11 | 建立人員 | 120-124 | 5 | CHAR | - | 必填，參照使用者檔 |
| AC12 | 建立時間 | 125-132 | 8 | TIMESTAMP | - | 系統自動產生 |

#### 3.2.2 主鍵欄位
- **主鍵1**：AC01 - 客戶代碼 (CHAR(5))

#### 3.2.3 索引資料
| 索引名稱 | 索引類型 | 索引欄位 | 說明 |
|----------|----------|----------|------|
| NPC001 | 主鍵索引 | AC01 | 主要查詢索引 |
| NPC002 | 一般索引 | AC02 | 客戶名稱查詢索引 |
| NPC003 | 一般索引 | AC03, AC10 | 類別狀態查詢索引 |
| NPC004 | 一般索引 | AC09 | 稅籍編號查詢索引 |

### 3.3 銷貨項目檔 (NPAIPF) 欄位規格

#### 3.3.1 記錄格式：NPAIPR
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 檢核說明 |
|----------|----------|------|------|------|------|----------|
| AI01 | 訂單編號 | 1-12 | 12 | CHAR | FK | 必填，參照銷貨訂單檔 |
| AI02 | 序號 | 13-15 | 3 | INTEGER | PK | 必填，1-999 |
| AI03 | 產品代碼 | 16-20 | 5 | CHAR | FK | 必填，參照產品主檔 |
| AI04 | 產品名稱 | 21-50 | 30 | CHAR | - | 必填，最多30字元 |
| AI05 | 規格 | 51-80 | 30 | CHAR | - | 可選，最多30字元 |
| AI06 | 數量 | 81-88 | 8 | DECIMAL | - | 必填，正數 |
| AI07 | 單位 | 89-90 | 2 | CHAR | - | 必填，參照單位檔 |
| AI08 | 單價 | 91-100 | 10 | DECIMAL | - | 必填，金額格式 |
| AI09 | 折扣率 | 101-103 | 3 | DECIMAL | - | 可選，0-100% |
| AI10 | 金額 | 104-113 | 10 | DECIMAL | - | 必填，數量×單價×(1-折扣率) |
| AI11 | 備註 | 114-143 | 30 | CHAR | - | 可選，最多30字元 |

#### 3.3.2 主鍵欄位
- **主鍵1**：AI01 - 訂單編號 (CHAR(12))
- **主鍵2**：AI02 - 序號 (INTEGER)

#### 3.3.3 外鍵關聯
- **關聯主檔1**：銷貨訂單檔 (NPAHPF)
- **關聯欄位1**：AI01 → AH02
- **關聯主檔2**：產品主檔 (PTAPF)
- **關聯欄位2**：AI03 → PT01

### 3.4 訂單工作檔 (NPWF01) 欄位規格

#### 3.4.1 記錄格式：NPWF01R
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 檢核說明 |
|----------|----------|------|------|------|------|----------|
| WF0101 | 工作編號 | 1-10 | 10 | CHAR | PK | 必填，系統自動產生 |
| WF0102 | 訂單編號 | 11-22 | 12 | CHAR | FK | 必填，參照銷貨訂單檔 |
| WF0103 | 處理狀態 | 23-23 | 1 | CHAR | - | 必填，P:處理中 C:完成 E:錯誤 |
| WF0104 | 處理類型 | 24-24 | 1 | CHAR | - | 必填，1:新增 2:修改 3:刪除 |
| WF0105 | 暫存資料 | 25-124 | 100 | CHAR | - | 可選，處理中的暫存資料 |
| WF0106 | 建立時間 | 125-132 | 8 | TIMESTAMP | - | 系統自動產生 |
| WF0107 | 完成時間 | 133-140 | 8 | TIMESTAMP | - | 可選，處理完成時間 |

#### 3.4.2 主鍵欄位
- **主鍵1**：WF0101 - 工作編號 (CHAR(10))

#### 3.4.3 外鍵關聯
- **關聯主檔**：銷貨訂單檔 (NPAHPF)
- **關聯欄位**：WF0102 → AH02

---

## 四、輸出/入螢幕布局與說明

### 4.1 銷貨管理主畫面布局

#### 4.1.1 主畫面配置圖

```mermaid
graph TB
    subgraph "銷貨管理主畫面"
        subgraph "功能選單區域"
            A[銷貨管理] --> B[訂單管理]
            A --> C[客戶管理]
            A --> D[出貨管理]
            A --> E[價格管理]
            A --> F[報表管理]
        end
        
        subgraph "查詢條件區域"
            G[日期範圍] --> H[開始日期]
            G --> I[結束日期]
            J[客戶範圍] --> K[全部客戶]
            J --> L[指定客戶]
            M[訂單狀態] --> N[全部狀態]
            M --> O[指定狀態]
        end
        
        subgraph "功能按鈕區域"
            P[新增訂單] --> Q[訂單輸入]
            R[查詢訂單] --> S[訂單查詢]
            T[客戶維護] --> U[客戶設定]
            V[出貨處理] --> W[出貨選擇]
        end
        
        subgraph "資料顯示區域"
            X[訂單清單] --> Y[訂單編號]
            X --> Z[客戶名稱]
            X --> AA[訂單日期]
            X --> BB[訂單金額]
            X --> CC[訂單狀態]
            X --> DD[交貨日期]
        end
    end
```

#### 4.1.2 主畫面詳細配置
```
┌─────────────────────────────────────────────────────────────┐
│                    銷貨管理系統 - 主畫面                      │
├─────────────────────────────────────────────────────────────┤
│ 功能選單區域                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [銷貨管理] [訂單管理] [客戶管理] [出貨管理] [價格管理]   │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 查詢條件區域                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 日期範圍: [2024/01/01] 至 [2024/12/31]                │ │
│ │ 客戶範圍: [全部客戶 ▼]    訂單狀態: [全部狀態 ▼]        │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 功能按鈕區域                                                │
│ [新增訂單] [查詢訂單] [客戶維護] [出貨處理] [報表產生]    │
├─────────────────────────────────────────────────────────────┤
│ 訂單資料顯示區域                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 訂單編號 │ 客戶名稱 │ 訂單日期 │ 訂單金額 │ 狀態 │ 交貨日期 │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ NP001    │ 客戶A   │ 2024/12/19│ 50,000   │ 確認 │ 2024/12/25│
│ │ NP002    │ 客戶B   │ 2024/12/19│ 75,000   │ 草稿 │ 2024/12/26│
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.3 欄位說明
| 欄位標籤 | 欄位名稱 | 欄位類型 | 必填 | 預設值 | 說明 |
|----------|----------|----------|------|--------|------|
| 開始日期 | 開始日期 | 日期選擇器 | 否 | 年度開始日 | 查詢的開始日期 |
| 結束日期 | 結束日期 | 日期選擇器 | 否 | 年度結束日 | 查詢的結束日期 |
| 客戶範圍 | 客戶範圍 | 下拉選單 | 否 | 全部客戶 | 選擇要查詢的客戶範圍 |
| 訂單狀態 | 訂單狀態 | 下拉選單 | 否 | 全部狀態 | 選擇要查詢的訂單狀態 |

### 4.2 訂單輸入畫面布局

#### 4.2.1 訂單輸入畫面配置圖

```mermaid
graph TB
    subgraph "訂單輸入畫面"
        subgraph "訂單標頭區域"
            A[訂單編號] --> B[系統自動產生]
            C[客戶代碼] --> D[客戶選擇器]
            E[訂單日期] --> F[日期選擇器]
            G[交貨日期] --> H[日期選擇器]
        end
        
        subgraph "訂單明細區域"
            I[產品代碼] --> J[產品選擇器]
            K[數量] --> L[數量輸入框]
            M[單價] --> N[單價輸入框]
            O[金額] --> P[金額顯示框]
        end
        
        subgraph "功能按鈕區域"
            Q[新增明細] --> R[新增一筆明細]
            S[儲存訂單] --> T[儲存訂單資料]
            U[取消] --> V[取消輸入]
        end
    end
```

#### 4.2.2 訂單輸入詳細配置
```
┌─────────────────────────────────────────────────────────────┐
│                    訂單輸入 - 新增訂單                      │
├─────────────────────────────────────────────────────────────┤
│ 訂單標頭區域                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 訂單編號: [NP001        ] (系統自動產生)                │ │
│ │ 客戶代碼: [C001 ▼]      客戶名稱: [客戶A              ] │ │
│ │ 訂單日期: [2024/12/19 ▼]                               │ │
│ │ 交貨日期: [2024/12/25 ▼]                               │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 訂單明細區域                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 序號 │ 產品代碼 │ 產品名稱 │ 數量 │ 單價 │ 金額 │ 備註 │
│ ├─────────────────────────────────────────────────────────┤ │
│ │  1   │ [P001 ▼] │ [產品A  ] │ [100] │ [500] │ [50,000] │ [    ] │
│ │  2   │ [P002 ▼] │ [產品B  ] │ [ 50] │ [500] │ [25,000] │ [    ] │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 訂單總計: 75,000                                           │
│ 功能按鈕區域                                                │
│ [新增明細] [儲存訂單] [取消]                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、處理流程程序說明

### 5.1 銷貨管理主要處理流程

#### 5.1.1 訂單處理流程圖

```mermaid
flowchart TD
    A[開始] --> B[使用者登入銷貨系統]
    B --> C[選擇訂單管理功能]
    C --> D[選擇新增訂單]
    D --> E[顯示訂單輸入畫面]
    E --> F[輸入訂單標頭資料]
    F --> G[輸入訂單明細資料]
    G --> H{資料驗證}
    H -->|驗證失敗| I[顯示錯誤訊息]
    I --> G
    H -->|驗證成功| J[儲存訂單資料]
    J --> K[更新庫存預留]
    K --> L[記錄處理日誌]
    L --> M[顯示成功訊息]
    M --> N[返回主畫面]
    N --> O[結束]
```

#### 5.1.2 客戶管理流程圖

```mermaid
flowchart TD
    A[開始] --> B[選擇客戶管理功能]
    B --> C[選擇客戶維護]
    C --> D[顯示客戶清單]
    D --> E{選擇操作類型}
    E -->|新增客戶| F[顯示新增客戶畫面]
    E -->|修改客戶| G[顯示修改客戶畫面]
    E -->|刪除客戶| H[顯示刪除確認畫面]
    F --> I[輸入客戶資料]
    G --> J[修改客戶資料]
    H --> K[確認刪除客戶]
    I --> L[驗證客戶資料]
    J --> L
    K --> L
    L --> M{資料驗證}
    M -->|驗證失敗| N[顯示錯誤訊息]
    N --> I
    M -->|驗證成功| O[儲存客戶資料]
    O --> P[更新相關索引]
    P --> Q[記錄操作日誌]
    Q --> R[顯示成功訊息]
    R --> S[返回客戶清單]
    S --> T[結束]
```

#### 5.1.3 出貨處理流程圖

```mermaid
flowchart TD
    A[開始] --> B[選擇出貨管理功能]
    B --> C[選擇出貨處理]
    C --> D[選擇要出貨的訂單]
    D --> E[檢查訂單狀態]
    E --> F{訂單是否可出貨}
    F -->|否| G[顯示狀態錯誤訊息]
    G --> D
    F -->|是| H[顯示出貨確認畫面]
    H --> I[確認出貨資料]
    I --> J[更新訂單狀態]
    J --> K[更新庫存數量]
    K --> L[產生出貨單]
    L --> M[記錄出貨日誌]
    M --> N[顯示成功訊息]
    N --> O[返回出貨清單]
    O --> P[結束]
```

### 5.2 資料驗證流程

#### 5.2.1 訂單資料驗證流程

```mermaid
flowchart TD
    A[開始驗證] --> B[驗證訂單標頭]
    B --> C[驗證客戶代碼]
    C --> D[驗證訂單日期]
    D --> E[驗證交貨日期]
    E --> F[驗證訂單明細]
    F --> G[驗證產品代碼]
    G --> H[驗證數量格式]
    H --> I[驗證單價格式]
    I --> J[驗證金額計算]
    J --> K{金額是否正確}
    K -->|不正確| L[顯示金額計算錯誤]
    K -->|正確| M[驗證庫存數量]
    M --> N{庫存是否足夠}
    N -->|不足| O[顯示庫存不足錯誤]
    N -->|足夠| P[驗證完成]
    P --> Q[結束驗證]
```

#### 5.2.2 欄位驗證規則
| 欄位名稱 | 驗證類型 | 驗證規則 | 錯誤訊息 |
|----------|----------|----------|----------|
| 客戶代碼 | 存在性驗證 | 客戶代碼必須存在於客戶主檔中 | 客戶代碼不存在 |
| 訂單日期 | 日期驗證 | 日期格式：YYYYMMDD，不能超過當前日期 | 訂單日期格式錯誤或超過當前日期 |
| 交貨日期 | 日期驗證 | 交貨日期不能早於訂單日期 | 交貨日期不能早於訂單日期 |
| 產品代碼 | 存在性驗證 | 產品代碼必須存在於產品主檔中 | 產品代碼不存在 |
| 數量 | 數量驗證 | 數量必須為正數，不能超過庫存數量 | 數量格式錯誤或庫存不足 |
| 單價 | 金額驗證 | 單價必須為正數，最多10位整數，2位小數 | 單價格式錯誤 |

#### 5.2.3 業務邏輯驗證
| 驗證項目 | 驗證邏輯 | 錯誤訊息 |
|----------|----------|----------|
| 訂單金額 | 明細金額總和 = 訂單金額 | 訂單金額計算錯誤，請檢查明細 |
| 庫存數量 | 訂單數量 ≤ 可用庫存數量 | 庫存數量不足，無法建立訂單 |
| 客戶狀態 | 客戶狀態必須為有效(A) | 客戶已停用，無法建立訂單 |
| 信用額度 | 訂單金額 ≤ 客戶信用額度 | 訂單金額超過客戶信用額度 |

---

## 六、子程序處理邏輯說明

### 6.1 子程序清單
| 子程序名稱 | 子程序代號 | 功能說明 | 呼叫時機 |
|------------|------------|----------|----------|
| 訂單編號產生 | NP001 | 自動產生訂單編號 | 新增訂單時 |
| 客戶信用檢查 | NP002 | 檢查客戶信用額度 | 儲存訂單前 |
| 庫存數量檢查 | NP003 | 檢查產品庫存數量 | 儲存訂單前 |
| 訂單金額計算 | NP004 | 計算訂單總金額 | 儲存訂單前 |
| 出貨狀態更新 | NP005 | 更新訂單出貨狀態 | 出貨處理時 |

### 6.2 子程序詳細說明

#### 6.2.1 訂單編號產生 (NP001)

**功能說明**：自動產生唯一的訂單編號，確保訂單編號的唯一性和連續性

**輸入參數**：
- 公司代碼 (COMPANY_CODE) - CHAR(3) - 公司代碼
- 訂單日期 (ORDER_DATE) - DATE - 訂單日期

**輸出參數**：
- 訂單編號 (ORDER_NO) - CHAR(12) - 產生的訂單編號
- 狀態碼 (STATUS) - CHAR(1) - 處理狀態：S成功，E失敗

**處理邏輯**：
```mermaid
flowchart TD
    A[開始] --> B[接收輸入參數]
    B --> C[查詢日期最大訂單編號]
    C --> D{是否找到記錄}
    D -->|否| E[設定起始編號為NP000000000001]
    D -->|是| F[取得最大編號並加1]
    E --> G[格式化訂單編號]
    F --> G
    G --> H[檢查編號唯一性]
    H --> I{編號是否唯一}
    I -->|否| F
    I -->|是| J[回傳訂單編號]
    J --> K[結束]
```

**錯誤處理**：
- 資料庫連線失敗：記錄錯誤日誌，回傳錯誤狀態
- 編號重複：自動重新產生編號
- 參數錯誤：回傳參數錯誤訊息

#### 6.2.2 客戶信用檢查 (NP002)

**功能說明**：檢查客戶的信用額度是否足夠支付訂單金額

**輸入參數**：
- 客戶代碼 (CUSTOMER_CODE) - CHAR(5) - 客戶代碼
- 訂單金額 (ORDER_AMOUNT) - DECIMAL(12,2) - 訂單金額

**輸出參數**：
- 檢查結果 (CHECK_RESULT) - CHAR(1) - 檢查結果：P通過，F失敗
- 錯誤訊息 (ERROR_MESSAGE) - VARCHAR(200) - 錯誤訊息內容

**處理邏輯**：
```mermaid
flowchart TD
    A[開始] --> B[接收輸入參數]
    B --> C[查詢客戶信用額度]
    C --> D[查詢客戶未付款訂單總額]
    D --> E[計算可用信用額度]
    E --> F{可用額度是否足夠}
    F -->|不足| G[設定檢查失敗]
    F -->|足夠| H[設定檢查通過]
    G --> I[回傳檢查結果]
    H --> I
    I --> J[結束]
```

**錯誤處理**：
- 客戶資料不存在：回傳客戶不存在錯誤
- 信用額度查詢失敗：回傳查詢失敗錯誤
- 計算錯誤：回傳計算錯誤訊息

#### 6.2.3 庫存數量檢查 (NP003)

**功能說明**：檢查產品的庫存數量是否足夠滿足訂單需求

**輸入參數**：
- 產品代碼 (PRODUCT_CODE) - CHAR(5) - 產品代碼
- 訂購數量 (ORDER_QUANTITY) - DECIMAL(8,0) - 訂購數量

**輸出參數**：
- 檢查結果 (CHECK_RESULT) - CHAR(1) - 檢查結果：P通過，F失敗
- 可用庫存 (AVAILABLE_STOCK) - DECIMAL(8,0) - 可用庫存數量
- 錯誤訊息 (ERROR_MESSAGE) - VARCHAR(200) - 錯誤訊息內容

**處理邏輯**：
```mermaid
flowchart TD
    A[開始] --> B[接收輸入參數]
    B --> C[查詢產品庫存數量]
    C --> D[查詢已預留數量]
    D --> E[計算可用庫存數量]
    E --> F{庫存是否足夠}
    F -->|不足| G[設定檢查失敗]
    F -->|足夠| H[設定檢查通過]
    G --> I[回傳檢查結果和可用庫存]
    H --> I
    I --> J[結束]
```

**錯誤處理**：
- 產品資料不存在：回傳產品不存在錯誤
- 庫存查詢失敗：回傳查詢失敗錯誤
- 計算錯誤：回傳計算錯誤訊息

---

## 七、錯誤處理程序說明與訊息清冊

### 7.1 錯誤處理流程

#### 7.1.1 錯誤處理架構圖

```mermaid
flowchart TD
    A[錯誤發生] --> B[錯誤分類]
    B --> C{錯誤類型}
    C -->|系統錯誤| D[系統錯誤處理]
    C -->|業務錯誤| E[業務錯誤處理]
    C -->|使用者錯誤| F[使用者錯誤處理]
    C -->|資料庫錯誤| G[資料庫錯誤處理]
    
    D --> H[記錄系統錯誤日誌]
    E --> I[顯示業務錯誤訊息]
    F --> J[顯示使用者錯誤訊息]
    G --> K[記錄資料庫錯誤日誌]
    
    H --> L[通知系統管理員]
    I --> M[記錄業務錯誤日誌]
    J --> N[提供錯誤解決建議]
    K --> O[嘗試錯誤恢復]
    
    L --> P[錯誤處理完成]
    M --> P
    N --> P
    O --> P
```

#### 7.1.2 錯誤處理策略
| 錯誤類型 | 處理策略 | 使用者通知 | 日誌記錄 |
|----------|----------|------------|----------|
| 系統錯誤 | 記錄錯誤日誌，通知管理員 | 顯示系統維護訊息 | 記錄詳細錯誤資訊 |
| 業務錯誤 | 顯示具體錯誤訊息，提供解決建議 | 顯示業務錯誤說明 | 記錄業務邏輯錯誤 |
| 使用者錯誤 | 顯示輸入錯誤，提供正確格式 | 顯示輸入格式說明 | 記錄使用者操作錯誤 |
| 資料庫錯誤 | 記錄資料庫錯誤，嘗試恢復 | 顯示系統忙碌訊息 | 記錄資料庫錯誤詳情 |

### 7.2 錯誤訊息清冊

#### 7.2.1 系統錯誤訊息
| 錯誤代碼 | 錯誤訊息 | 錯誤原因 | 解決方案 |
|----------|----------|----------|----------|
| NP001 | 系統連線失敗，請稍後再試 | 資料庫連線異常 | 檢查網路連線，聯絡系統管理員 |
| NP002 | 系統資源不足，請稍後再試 | 系統記憶體或CPU不足 | 等待系統負載降低，聯絡系統管理員 |
| NP003 | 系統維護中，請稍後再試 | 系統正在進行維護 | 等待維護完成，查看系統公告 |

#### 7.2.2 業務錯誤訊息
| 錯誤代碼 | 錯誤訊息 | 錯誤原因 | 解決方案 |
|----------|----------|----------|----------|
| NP101 | 客戶代碼不存在，請檢查客戶代碼 | 輸入的客戶代碼在系統中不存在 | 查詢正確的客戶代碼，或聯絡管理員新增客戶 |
| NP102 | 客戶已停用，無法建立訂單 | 選擇的客戶狀態為停用 | 選擇其他有效客戶，或聯絡管理員啟用客戶 |
| NP103 | 訂單金額超過客戶信用額度 | 訂單金額超過客戶的信用額度限制 | 減少訂單數量或金額，或聯絡管理員調整信用額度 |
| NP104 | 產品庫存數量不足 | 訂購數量超過可用庫存數量 | 減少訂購數量，或等待庫存補充 |

#### 7.2.3 使用者錯誤訊息
| 錯誤代碼 | 錯誤訊息 | 錯誤原因 | 解決方案 |
|----------|----------|----------|----------|
| NP201 | 訂單日期格式錯誤，請使用YYYYMMDD格式 | 日期輸入格式不正確 | 使用正確的日期格式，如：20241219 |
| NP202 | 交貨日期不能早於訂單日期 | 交貨日期設定錯誤 | 設定正確的交貨日期，不能早於訂單日期 |
| NP203 | 數量格式錯誤，請輸入正確的數字格式 | 數量輸入格式不正確 | 輸入正數，最多8位整數 |
| NP204 | 單價格式錯誤，請輸入正確的金額格式 | 單價輸入格式不正確 | 輸入正數，最多10位整數，2位小數 |

#### 7.2.4 資料庫錯誤訊息
| 錯誤代碼 | 錯誤訊息 | 錯誤原因 | 解決方案 |
|----------|----------|----------|----------|
| NP301 | 資料庫連線逾時，請稍後再試 | 資料庫連線超過時間限制 | 等待系統恢復，或聯絡系統管理員 |
| NP302 | 資料庫鎖定衝突，請稍後再試 | 資料被其他使用者鎖定 | 等待其他使用者完成操作，或聯絡系統管理員 |
| NP303 | 資料庫空間不足，無法儲存資料 | 資料庫磁碟空間不足 | 聯絡系統管理員清理資料庫空間 |
| NP304 | 資料庫索引損壞，請聯絡管理員 | 資料庫索引檔案損壞 | 立即聯絡系統管理員進行修復 |

---

## 八、備註

### 8.1 特殊說明
- **訂單編號規則**：訂單編號格式為 NP + 10位序號，每年重新開始編號
- **客戶代碼規則**：客戶代碼為5位字元，前2位為客戶類別，後3位為序號
- **金額精度**：所有金額欄位支援到小數點後2位，超過部分自動四捨五入
- **日期格式**：系統使用 YYYYMMDD 格式儲存日期，顯示時轉換為 YYYY/MM/DD 格式

### 8.2 限制條件
- **訂單數量限制**：每個公司每年最多可建立 999,999,999 張訂單
- **客戶數量限制**：每個公司最多可建立 99,999 個客戶
- **明細數量限制**：每張訂單最多可包含 999 筆明細
- **備註長度限制**：訂單備註最多 40 個字元，明細備註最多 30 個字元

### 8.3 未來擴充
- **電子商務整合**：未來版本將支援電子商務平台整合
- **行動裝置支援**：未來版本將提供行動裝置專用介面
- **多幣別支援**：未來版本將支援多幣別訂單處理
- **智慧定價**：未來版本將整合 AI 技術，提供智慧化定價建議

### 8.4 相關文件
- **銷貨模組操作手冊**：詳細的操作步驟和畫面說明
- **銷貨模組技術文件**：系統架構和技術實現細節
- **客戶管理使用指南**：客戶資料的設定和管理說明
- **出貨處理使用手冊**：出貨流程和相關操作說明

---

## 九、文件修訂記錄

| 版本 | 修訂日期 | 修訂人員 | 修訂內容 | 修訂原因 |
|------|----------|----------|----------|----------|
| v1.0 | 2024/12/19 | 系統分析師 | 初始版本 | 文件建立 |

---

**文件建立日期**：2024年12月19日  
**最後更新日期**：2024年12月19日  
**文件狀態**：草稿  
**下次檢討日期**：2025年1月19日 
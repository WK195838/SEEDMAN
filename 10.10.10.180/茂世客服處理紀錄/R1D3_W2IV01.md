# W2IV01 庫存主檔處理程式修改 (IBM RPG)

以下是針對 W2IV01 庫存主檔處理程式的 IBM RPG 修改內容，主要增加寄賣庫存處理邏輯：

```
      * 修改 W2IV01 - 庫存主檔處理程式
      * 增加寄賣庫存處理邏輯
      
     F* 檔案定義區段
     FIVTPF    UF A E           K DISK                  
     F                                     RENAME(INVREC:INVREC1)
     F* 新增寄賣庫存檔案
     FCSPF     IF   E           K DISK                  
     F                                     RENAME(CSREC:CSREC1)
     F* 產品主檔
     FPDTPF    IF   E           K DISK                  
     F                                     RENAME(PDTREC:PDTREC1)
     F* 螢幕顯示檔案
     FIVSCR    CF   E             WORKSTN
     F                                     RENAME(SCRREC:SCRREC1)

     D* 資料結構定義
     D INVREC1        DS                  
     D  IV01                 1      9      * 產品編號
     D  IV02                10     17  0   * 實際庫存
     D  IV03                18     25  0   * 可用庫存
     D  IV04                26     33  0   * 預訂數量
     D  IV05                34     41  0   * 在途數量
     D* 新增寄賣庫存欄位
     D  IV06                42     49  0   * 寄賣數量
     D  IV07                50     57  0   * 寄賣已結算
     D  IV08                58     65  0   * 寄賣退回
     D  IVXX                66     73  0   * 更新日期
     D  IVYY                74     79  0   * 更新時間
     D  IVZZ                80     89      * 更新人員

     D* 寄賣庫存資料結構
     D CSREC1         DS                  
     D  CS01                 1     12      * 寄賣編號
     D  CS02                13     21      * 產品編號
     D  CS03                22     29  0   * 寄賣日期
     D  CS04                30     37  0   * 寄賣數量
     D  CS05                38     47      * 客戶代號
     D  CS06                48     55  0   * 預計結算日期
     D  CS07                56     63  0   * 已結算數量
     D  CS08                64     64      * 寄賣狀態

     D* 產品資料結構
     D PDTREC1        DS                  
     D* 產品結構定義...

     D* 螢幕顯示格式
     D SCRREC1        DS                  
     D* 原有螢幕欄位...
     D* 新增寄賣相關螢幕欄位
     D  SCRCONS              400   407  0
     D  SCRCONSET            408   415  0
     D  SCRCONRET            416   423  0

     D* 工作變數定義
     D wIVKey          S              9A   INZ
     D wIVOp           S              1A   INZ
     D wProdExists     S              1A   INZ('N')
     D wConsignQty     S              8P 0 INZ
     D wConsignSet     S              8P 0 INZ
     D wConsignRet     S              8P 0 INZ
     D CurDate         S              8P 0
     D CurTime         S              6P 0
     D CurUser         S             10A
     D i               S             10I 0
     D ErrorMsg        S             50A   INZ
     
     C* 程式主體
     C     *ENTRY        PLIST
     C                   PARM                    PRODNUM          9
     C                   PARM                    OPTYPE           1
     
     C* 取得當前日期時間與使用者
     C                   TIME                    CurDate
     C                   TIME                    CurTime
     C                   MOVE      USRPRF        CurUser

     C* 初始化作業
     C                   MOVE      PRODNUM       wIVKey
     C                   MOVE      OPTYPE        wIVOp
     
     C* 根據操作類型處理
     C     wIVOp         CASEQ     'A'           ADD
     C                   CASEQ     'U'           UPDATE
     C                   CASEQ     'D'           DELETE
     C                   CASEQ     'I'           INQUIRY
     C                   CASEQ     'C'           CONSIGN
     C                   ENDCS
     
     C* 結束程式
     C                   SETON                                        LR
     
     C* 新增庫存記錄處理
     C     ADD           TAG
     C* 檢查產品是否存在
     C     wIVKey        CHAIN     PDTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '產品不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 檢查庫存記錄是否已存在
     C     wIVKey        CHAIN     IVTPF
     C                   IFNE      *IN61         *ON
     C                   MOVE      '庫存已存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 建立新的庫存記錄
     C                   CLEAR                   INVREC1
     C                   MOVE      wIVKey        IV01
     C                   Z-ADD     0             IV02
     C                   Z-ADD     0             IV03
     C                   Z-ADD     0             IV04
     C                   Z-ADD     0             IV05
     C* 初始化寄賣相關欄位
     C                   Z-ADD     0             IV06
     C                   Z-ADD     0             IV07
     C                   Z-ADD     0             IV08
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     
     C* 寫入庫存主檔
     C                   WRITE                   INVREC1
     
     C* 顯示成功訊息
     C                   MOVE      '庫存建立成功' ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     
     C* 更新庫存記錄處理
     C     UPDATE        TAG
     C* 讀取庫存記錄
     C     wIVKey        CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '庫存不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 顯示庫存更新螢幕
     C                   EXSR      SHOWUPDSCR
     C                   RETURN
     
     C* 刪除庫存記錄處理
     C     DELETE        TAG
     C* 原有刪除邏輯...
     C                   RETURN
     
     C* 查詢庫存記錄處理
     C     INQUIRY       TAG
     C* 讀取庫存記錄
     C     wIVKey        CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '庫存不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 取得寄賣庫存資訊
     C                   EXSR      GETCONSINFO
     
     C* 顯示庫存查詢螢幕
     C                   EXSR      SHOWINQSCR
     C                   RETURN
     
     C* 寄賣庫存處理
     C     CONSIGN       TAG
     C* 讀取庫存記錄
     C     wIVKey        CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '庫存不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 取得寄賣庫存資訊
     C                   EXSR      GETCONSINFO
     
     C* 顯示寄賣庫存處理螢幕
     C                   EXSR      SHOWCONSCR
     C                   RETURN
     
     C* 取得寄賣庫存資訊子程序
     C     GETCONSINFO   BEGSR
     C* 初始化寄賣資訊
     C                   Z-ADD     0             wConsignQty
     C                   Z-ADD     0             wConsignSet
     C                   Z-ADD     0             wConsignRet
     
     C* 搜尋產品的寄賣記錄
     C     CS02          SETLL(E)  CSPF
     C                   IFEQ      *IN61         *ON
     C                   RETURN
     C                   ENDIF
     
     C* 讀取所有寄賣記錄並累計數量
     C     CS02          READE     CSPF                                 61
     C     *IN61         DOWEQ     *OFF
     
     C* 檢查產品編號是否匹配
     C     CS02          IFEQ      wIVKey
     
     C* 根據寄賣狀態累計數量
     C     CS08          IFEQ      'O'           # 開放
     C                   ADD       CS04          wConsignQty
     C                   ENDIF
     C     CS08          IFEQ      'C'           # 已結算
     C                   ADD       CS07          wConsignSet
     C                   ENDIF
     C     CS08          IFEQ      'R'           # 已退回
     C                   ADD       CS04          wConsignRet
     C                   SUB       CS07          wConsignRet
     C                   ENDIF
     
     C                   ENDIF
     
     C* 處理下一筆寄賣記錄
     C     CS02          READE     CSPF                                 61
     C                   ENDDO
     C                   ENDSR
     
     C* 顯示庫存更新螢幕子程序
     C     SHOWUPDSCR    BEGSR
     C* 原有庫存更新螢幕邏輯...
     
     C* 取得寄賣庫存資訊
     C                   EXSR      GETCONSINFO
     
     C* 填入寄賣相關資訊
     C                   MOVE      IV06          SCRCONS
     C                   MOVE      IV07          SCRCONSET
     C                   MOVE      IV08          SCRCONRET
     
     C* 更新庫存處理邏輯
     C* 顯示螢幕、處理用戶輸入等...
     
     C* 更新寄賣相關欄位
     C                   MOVE      wConsignQty   IV06
     C                   MOVE      wConsignSet   IV07
     C                   MOVE      wConsignRet   IV08
     
     C* 更新庫存記錄
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     C                   UPDATE                  INVREC1
     C                   ENDSR
     
     C* 顯示庫存查詢螢幕子程序
     C     SHOWINQSCR    BEGSR
     C* 原有庫存查詢螢幕邏輯...
     
     C* 填入寄賣相關資訊
     C                   MOVE      IV06          SCRCONS
     C                   MOVE      IV07          SCRCONSET
     C                   MOVE      IV08          SCRCONRET
     
     C* 顯示庫存詳細資訊...
     C                   ENDSR
     
     C* 顯示寄賣庫存處理螢幕子程序
     C     SHOWCONSCR    BEGSR
     C* 初始化寄賣處理螢幕
     C                   CLEAR                   SCRREC1
     
     C* 填入產品與庫存資訊
     C                   MOVE      IV01          SCRPROD
     C                   MOVE      IV02          SCRACTQTY
     C                   MOVE      IV03          SCRAVLQTY
     
     C* 填入寄賣相關資訊
     C                   MOVE      wConsignQty   SCRCONS
     C                   MOVE      wConsignSet   SCRCONSET
     C                   MOVE      wConsignRet   SCRCONRET
     
     C* 顯示寄賣詳細清單
     C* (顯示未結算的寄賣記錄)
     C     wIVKey        SETLL     CSPF
     C     wIVKey        READE     CSPF                                 61
     C     *IN61         DOWEQ     *OFF
     
     C     CS02          IFEQ      wIVKey
     C     CS08          IFEQ      'O'
     C* 在螢幕上顯示寄賣記錄...
     C                   ENDIF
     C                   ENDIF
     
     C     wIVKey        READE     CSPF                                 61
     C                   ENDDO
     
     C* 處理寄賣狀態更新
     C* ...
     C                   ENDSR
     
     C* 顯示訊息子程序
     C     SHOWMSG       BEGSR
     C* 訊息顯示邏輯...
     C                   ENDSR
     
     
      ** 以下為螢幕顯示檔案定義 (IVSCR) **
      
     A          R UPDSCR                     
     A                                      BLINK
     A                                  1  2'庫存維護'
     A                                  2  2'產品編號:'
     A            SCRPROD        9      2 13
     A                                  3  2'實際庫存:'
     A            SCRACTQTY      8  0B  3 13
     A                                  4  2'可用庫存:'
     A            SCRAVLQTY      8  0B  4 13
     A                                  5  2'預訂數量:'
     A            SCRRESQTY      8  0B  5 13
     A                                  6  2'在途數量:'
     A            SCRINQTY       8  0B  6 13
     A* 新增寄賣相關欄位
     A                                  8  2'寄賣數量:'
     A            SCRCONS        8  0O  8 13
     A                                  9  2'已結算量:'
     A            SCRCONSET      8  0O  9 13
     A                                 10  2'退回數量:'
     A            SCRCONRET      8  0O 10 13
     A                                 12  2'注意: 寄賣數量不直接計入庫存'
     A                                 14  2'F3=離開'
     A                                 14 15'F5=儲存'
     A                                 14 30'F12=取消'
     
     A          R CONSCR                     
     A                                      BLINK
     A                                  1  2'寄賣庫存管理'
     A                                  2  2'產品編號:'
     A            SCRPROD        9      2 13
     A                                  3  2'實際庫存:'
     A            SCRACTQTY      8  0O  3 13
     A                                  4  2'可用庫存:'
     A            SCRAVLQTY      8  0O  4 13
     A                                  5  2'寄賣總量:'
     A            SCRCONS        8  0O  5 13
     A                                  6  2'已結算量:'
     A            SCRCONSET      8  0O  6 13
     A                                  7  2'退回數量:'
     A            SCRCONRET      8  0O  7 13
     A                                  9  2'未結算寄賣記錄:'
     A                                 10  2'編號'
     A                                 10 16'客戶'
     A                                 10 30'日期'
     A                                 10 40'數量'
     A                                 10 50'狀態'
     A                                 11  2'---------------------------------------'
     A            CSLIST        15A    12  2
     A                                 20  2'F3=離開'
     A                                 20 15'F5=更新'
     A                                 20 30'F7=結算'
     A                                 20 45'F9=退回'
     A  03                              
     A  05                              
     A  07                              
     A  09                              
     A  12                              
```

## 修改說明

1. **檔案與資料結構擴展**
   - 擴展庫存主檔結構 INVREC1，增加三個寄賣相關欄位：
     - IV06: 寄賣數量 - 目前在外的寄賣品數量
     - IV07: 寄賣已結算 - 已確認結算的寄賣品數量
     - IV08: 寄賣退回 - 已退回的寄賣品數量
   - 新增寄賣庫存檔案 CSPF 及其資料結構 CSREC1
   - 擴展螢幕顯示格式，增加寄賣相關欄位

2. **新增專用寄賣庫存處理功能**
   - 增加 'C' (CONSIGN) 操作類型專門處理寄賣庫存
   - 新增 SHOWCONSCR 子程序顯示寄賣庫存管理螢幕
   - 提供寄賣庫存的詳細清單與管理功能

3. **寄賣庫存資訊整合**
   - 新增 GETCONSINFO 子程序獲取產品的寄賣庫存資訊
   - 根據寄賣狀態 (開放、已結算、已退回) 分類計算數量
   - 將寄賣資訊整合到庫存主檔中，提供完整的庫存視圖

4. **庫存維護螢幕增強**
   - 在 UPDSCR 顯示格式中增加寄賣數量、已結算量和退回數量欄位
   - 為使用者提供提示：寄賣數量不直接計入庫存
   - 這些欄位為顯示用 (Output Only)，不允許直接修改

5. **寄賣庫存管理螢幕**
   - 新增 CONSCR 顯示格式專門管理寄賣庫存
   - 顯示產品的實際庫存和可用庫存
   - 提供寄賣總量、已結算量和退回數量的摘要
   - 列出未結算的寄賣記錄詳細資訊
   - 提供功能鍵進行結算和退回操作

6. **更新與同步邏輯**
   - 在更新庫存記錄時，同步更新寄賣相關欄位
   - 確保庫存主檔中的寄賣數據與寄賣庫存檔一致
   - 提供完整的庫存狀態視圖，包括寄賣在外的庫存

這些修改使 W2IV01 程式能夠正確處理和顯示寄賣庫存資訊，主要優點包括：

- 正確區分寄賣庫存與實際庫存，避免直接扣減
- 提供寄賣庫存的完整視圖，包括未結算、已結算和退回數量
- 專用的寄賣庫存管理界面，方便庫存管理人員處理寄賣出貨
- 自動整合寄賣庫存資訊與主庫存系統
- 支援『R1D3』類型的寄賣品正確處理
- 為庫存報表提供準確的數據來源

通過這些修改，系統可以正確處理寄賣出貨的庫存影響，避免錯誤地直接從庫存中扣除寄賣數量，同時提供完整的寄賣庫存管理功能，確保庫存報表的準確性。


# W2IV05 庫存異動程式修改 (IBM RPG)

以下是針對 W2IV05 庫存異動程式的 IBM RPG 修改內容，主要增加寄賣庫存處理邏輯：

```
      * 修改 W2IV05 - 庫存異動程式
      * 增加寄賣庫存處理邏輯
      
     F* 檔案定義區段
     FIVTPF    UF A E           K DISK                  
     F                                     RENAME(INVREC:INVREC1)
     F* 新增寄賣庫存檔案
     FCSPF     UF A E           K DISK                  
     F                                     RENAME(CSREC:CSREC1)
     F* 出貨主檔
     FBAPF     IF   E           K DISK                  
     F                                     RENAME(BAREC:BAREC1)
     F* 出貨明細檔
     FBBPF     IF   E           K DISK                  
     F                                     RENAME(BBREC:BBREC1)
     F* 庫存異動記錄檔
     FIVMPF    UF A E           K DISK                  
     F                                     RENAME(IVMREC:IVMREC1)

     D* 資料結構定義
     D INVREC1        DS                  
     D  IV01                 1      9      * 產品編號
     D  IV02                10     17  0   * 實際庫存
     D  IV03                18     25  0   * 可用庫存
     D  IV04                26     33  0   * 預訂數量
     D  IV05                34     41  0   * 在途數量
     D* 新增寄賣庫存欄位
     D  IV06                42     49  0   * 寄賣數量
     D  IV07                50     57  0   * 寄賣已結算
     D  IV08                58     65  0   * 寄賣退回
     D  IVXX                66     73  0   * 更新日期
     D  IVYY                74     79  0   * 更新時間
     D  IVZZ                80     89      * 更新人員

     D* 寄賣庫存資料結構
     D CSREC1         DS                  
     D  CS01                 1     12      * 寄賣編號
     D  CS02                13     21      * 產品編號
     D  CS03                22     29  0   * 寄賣日期
     D  CS04                30     37  0   * 寄賣數量
     D  CS05                38     47      * 客戶代號
     D  CS06                48     55  0   * 預計結算日期
     D  CS07                56     63  0   * 已結算數量
     D  CS08                64     64      * 寄賣狀態

     D* 出貨主檔結構
     D BAREC1         DS                  
     D  BA01                 1      8  0   * 出貨日期
     D  BA02                 9     13      * 出貨地點
     D  BA03                14     25      * 訂單編號
     D  BA04                26     36  2   * 總金額
     D  BA05                37     37      * 狀態
     D  BA06                38     39      * 幣別
     D  BA07                40    167      * 備註
     D  BA08                168   169      * 未出數量
     D  BA09                170   179      * 區號人員
     D  BA10                180   180      * 刪除標記
     D  BA11                181   195      * VIP客戶-區號
     D  BA12                196   200      * VIP客戶-代號
     D* 新增寄賣欄位
     D  BA13                201   201      * 寄賣標識
     D  BA14                202   206      * 寄賣類型
     D  BA15                207   214  0   * 預計結算日期
     D  BAXX                215   222  0   * 更新日期
     D  BAYY                223   228  0   * 更新時間
     D  BAZZ                229   238      * 更新人員

     D* 出貨明細結構
     D BBREC1         DS                  
     D  BB01                 1     12      * 訂單編號
     D  BB02                13     18  0   * 訂單項次
     D  BB03                19     27      * 產品編號
     D  BB04                28     35  0   * 訂單數量
     D  BB05                36     43  0   * 出貨數量
     D  BB06                44     51  0   * 未出數量
     D  BB07                52     62  2   * 單價
     D  BB08                63     71  2   * F.O.B.-UNIT
     D  BB08A               72     80  2   * FHI-UNIT
     D  BB08B               81     89  2   * DUTY-UNIT
     D  BB09                90     90      * 狀態
     D  BB10                91    218      * 備註
     D  BB11                219   219      * 刪除標記
     D  BBXX                220   227  0   * 更新日期
     D  BBYY                228   233  0   * 更新時間
     D  BBZZ                234   243      * 更新人員

     D* 庫存異動記錄結構
     D IVMREC1        DS                  
     D  IVM01                1      8  0   * 異動日期
     D  IVM02                9     14  0   * 異動時間
     D  IVM03               15     23      * 產品編號
     D  IVM04               24     31  0   * 異動前數量
     D  IVM05               32     39  0   * 異動數量
     D  IVM06               40     47  0   * 異動後數量
     D  IVM07               48     48      * 異動類型
     D  IVM08               49     60      * 參照號碼
     D  IVM09               61    128      * 備註
     D* 新增寄賣欄位
     D  IVM10              129    129      * 寄賣標識
     D  IVM11              130    134      * 寄賣類型
     D  IVMXX              135    142  0   * 更新日期
     D  IVMYY              143    148  0   * 更新時間
     D  IVMZZ              149    158      * 更新人員

     D* 工作變數定義
     D wProdNum        S              9A   INZ
     D wQty            S              8P 0 INZ
     D wType           S              1A   INZ
     D wRefNum         S             12A   INZ
     D wMemo           S             68A   INZ
     D wIsConsign      S              1A   INZ('N')
     D wConsignType    S              5A   INZ
     D wShipDate       S              8P 0 INZ
     D wShipLoc        S              5A   INZ
     D wSetDate        S              8P 0 INZ
     D CurDate         S              8P 0
     D CurTime         S              6P 0
     D CurUser         S             10A
     D i               S             10I 0
     D ErrorMsg        S             50A   INZ
     
     C* 程式主體
     C     *ENTRY        PLIST
     C                   PARM                    PRODNUM          9
     C                   PARM                    QTY              8 0
     C                   PARM                    ADJTYPE          1
     C                   PARM                    REFNUM          12
     C                   PARM                    MEMO            68
     C                   PARM                    CONSFLG          1
     C                   PARM                    CONSTYP          5
     
     C* 取得當前日期時間與使用者
     C                   TIME                    CurDate
     C                   TIME                    CurTime
     C                   MOVE      USRPRF        CurUser

     C* 初始化參數
     C                   MOVE      PRODNUM       wProdNum
     C                   MOVE      QTY           wQty
     C                   MOVE      ADJTYPE       wType
     C                   MOVE      REFNUM        wRefNum
     C                   MOVE      MEMO          wMemo
     C     CONSFLG       IFNE      *BLANKS
     C                   MOVE      CONSFLG       wIsConsign
     C                   ELSE
     C                   MOVE      'N'           wIsConsign
     C                   ENDIF
     C     CONSTYP       IFNE      *BLANKS
     C                   MOVE      CONSTYP       wConsignType
     C                   ENDIF
     
     C* 檢查是否為出貨參照
     C     wType         IFEQ      'S'           # 出貨
     C* 檢查出貨單是否為寄賣
     C                   EXSR      CHECKSHIP
     C                   ENDIF
     
     C* 執行庫存異動
     C     wType         CASEQ     'I'           INVENTORY
     C                   CASEQ     'P'           PURCHASE
     C                   CASEQ     'S'           SHIPMENT
     C                   CASEQ     'R'           RETURN
     C                   CASEQ     'A'           ADJUST
     C                   CASEQ     'C'           CONSIGN
     C                   ENDCS
     
     C* 結束程式
     C                   SETON                                        LR
     
     C* 檢查出貨單寄賣狀態子程序
     C     CHECKSHIP     BEGSR
     C* 解析參照號碼為出貨單號
     C                   MOVE      %SUBST(wRefNum:1:12) BB01
     
     C* 查找出貨單主檔
     C     BB01          CHAIN     BAPF
     C                   IFEQ      *IN61         *OFF
     
     C* 檢查寄賣標識
     C     BA13          IFEQ      'Y'
     C                   MOVE      'Y'           wIsConsign
     C                   MOVE      BA14          wConsignType
     C                   MOVE      BA01          wShipDate
     C                   MOVE      BA02          wShipLoc
     C                   MOVE      BA15          wSetDate
     C                   ENDIF
     C                   ENDIF
     C                   ENDSR
     
     C* 入庫處理
     C     INVENTORY     BEGSR
     C* 讀取庫存記錄
     C     wProdNum      CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C* 庫存不存在，新增記錄
     C                   EXSR      CREATEREC
     C                   ELSE
     C* 庫存存在，更新記錄
     C                   EXSR      UPDATEREC
     C                   ENDIF
     
     C* 記錄異動
     C                   EXSR      CREATELOG
     C                   ENDSR
     
     C* 採購處理
     C     PURCHASE      BEGSR
     C* 同入庫處理...
     C                   ENDSR
     
     C* 出貨處理
     C     SHIPMENT      BEGSR
     C* 讀取庫存記錄
     C     wProdNum      CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '庫存不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 檢查是否為寄賣出貨
     C     wIsConsign    IFEQ      'Y'
     C* 寄賣出貨處理
     C                   EXSR      CONSIGNSHIP
     C                   ELSE
     C* 一般出貨處理 - 直接減少庫存
     C                   SUB       wQty          IV02
     C                   SUB       wQty          IV03
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     C                   UPDATE                  INVREC1
     C                   ENDIF
     
     C* 記錄異動
     C                   EXSR      CREATELOG
     C                   ENDSR
     
     C* 寄賣出貨處理子程序
     C     CONSIGNSHIP   BEGSR
     C* 更新寄賣庫存欄位
     C                   ADD       wQty          IV06
     C* 不減少實際庫存和可用庫存
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     C                   UPDATE                  INVREC1
     
     C* 建立寄賣庫存記錄 (如果尚未建立)
     C                   EXSR      CREATECONREC
     C                   ENDSR
     
     C* 退貨處理
     C     RETURN        BEGSR
     C* 同入庫處理...
     C                   ENDSR
     
     C* 調整處理
     C     ADJUST        BEGSR
     C* 一般庫存調整邏輯...
     C                   ENDSR
     
     C* 寄賣結算/退回處理
     C     CONSIGN       BEGSR
     C* 讀取庫存記錄
     C     wProdNum      CHAIN     IVTPF
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '庫存不存在'  ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 處理寄賣結算/退回
     C     wRefNum       CHAIN     CSPF          # 以寄賣編號查詢
     C                   IFEQ      *IN61         *ON
     C                   MOVE      '寄賣記錄不存在' ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 檢查產品編號是否匹配
     C     CS02          IFNE      wProdNum
     C                   MOVE      '產品編號不符' ErrorMsg
     C                   EXSR      SHOWMSG
     C                   RETURN
     C                   ENDIF
     
     C* 檢查操作類型 (C=結算, R=退回)
     C     wType         IFEQ      'C'           # 結算
     C                   EXSR      CONSSETTLE
     C                   ELSE
     C     wType         IFEQ      'R'           # 退回
     C                   EXSR      CONSRETURN
     C                   ENDIF
     C                   ENDIF
     
     C* 記錄異動
     C                   EXSR      CREATELOG
     C                   ENDSR
     
     C* 寄賣結算處理子程序
     C     CONSSETTLE    BEGSR
     C* 更新寄賣庫存記錄
     C                   MOVE      'C'           CS08  # 設為已結算
     C                   MOVE      CS04          CS07  # 設定已結算數量
     C                   UPDATE                  CSREC1
     
     C* 更新主檔寄賣資訊
     C                   SUB       wQty          IV06  # 減少寄賣數量
     C                   ADD       wQty          IV07  # 增加已結算數量
     C                   SUB       wQty          IV02  # 結算時才實際減少庫存
     C                   SUB       wQty          IV03  # 減少可用庫存
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     C                   UPDATE                  INVREC1
     C                   ENDSR
     
     C* 寄賣退回處理子程序
     C     CONSRETURN    BEGSR
     C* 更新寄賣庫存記錄
     C                   MOVE      'R'           CS08  # 設為已退回
     C                   UPDATE                  CSREC1
     
     C* 更新主檔寄賣資訊
     C                   SUB       wQty          IV06  # 減少寄賣數量
     C                   ADD       wQty          IV08  # 增加退回數量
     C                   MOVE      CurDate       IVXX
     C                   MOVE      CurTime       IVYY
     C                   MOVE      CurUser       IVZZ
     C                   UPDATE                  INVREC1
     C                   ENDSR
     
     C* 創建庫存記錄子程序
     C     CREATEREC     BEGSR
     C* 建立新的庫存記錄邏輯...
     C                   ENDSR
     
     C* 更新庫存記錄子程序
     C     UPDATEREC     BEGSR
     C* 更新現有庫存記錄邏輯...
     C                   ENDSR
     
     C* 創建寄賣庫存記錄子程序
     C     CREATECONREC  BEGSR
     C* 檢查是否已有相同參照的寄賣記錄
     C     wRefNum       CHAIN     CSPF
     C                   IFNE      *IN61         *OFF
     
     C* 建立新的寄賣庫存記錄
     C                   CLEAR                   CSREC1
     C                   MOVE      wRefNum       CS01
     C                   MOVE      wProdNum      CS02
     C                   MOVE      wShipDate     CS03
     C                   MOVE      wQty          CS04
     C* 客戶代號從出貨單取得
     C                   CAT       BA11:BA12     CS05
     C                   MOVE      wSetDate      CS06
     C                   Z-ADD     0             CS07
     C                   MOVE      'O'           CS08
     
     C* 寫入寄賣庫存檔
     C                   WRITE                   CSREC1
     C                   ENDIF
     C                   ENDSR
     
     C* 創建庫存異動記錄子程序
     C     CREATELOG     BEGSR
     C* 建立庫存異動記錄
     C                   CLEAR                   IVMREC1
     C                   MOVE      CurDate       IVM01
     C                   MOVE      CurTime       IVM02
     C                   MOVE      wProdNum      IVM03
     C                   MOVE      IV02          IVM04      # 異動前數量 (有時序問題)
     C                   MOVE      wQty          IVM05      # 異動數量
     C                   ADD       IVM04         IVM06      # 異動後數量
     C     wType         IFEQ      'S'
     C                   SUB       wQty          IVM06      # 出貨減少
     C                   ENDIF
     C                   MOVE      wType         IVM07      # 異動類型
     C                   MOVE      wRefNum       IVM08      # 參照號碼
     C                   MOVE      wMemo         IVM09      # 備註
     
     C* 記錄寄賣資訊
     C                   MOVE      wIsConsign    IVM10
     C                   MOVE      wConsignType  IVM11
     C                   MOVE      CurDate       IVMXX
     C                   MOVE      CurTime       IVMYY
     C                   MOVE      CurUser       IVMZZ
     
     C* 寫入異動記錄檔
     C                   WRITE                   IVMREC1
     C                   ENDSR
     
     C* 顯示訊息子程序
     C     SHOWMSG       BEGSR
     C* 訊息顯示邏輯...
     C                   ENDSR
```

## 修改說明

1. **檔案與資料結構擴展**
   - 擴展庫存主檔結構 INVREC1，增加寄賣相關欄位
   - 新增寄賣庫存檔案 CSPF 及其資料結構 CSREC1
   - 擴展庫存異動記錄結構 IVMREC1，增加寄賣標識和類型欄位
   - 包含出貨主檔和明細檔結構，以便查詢寄賣資訊

2. **程式參數擴展**
   - 增加兩個輸入參數：CONSFLG (寄賣標識) 和 CONSTYP (寄賣類型)
   - 這些參數允許從調用程序直接指定寄賣資訊

3. **出貨單寄賣檢查**
   - 新增 CHECKSHIP 子程序，檢查參照的出貨單是否為寄賣出貨
   - 如果是寄賣出貨，獲取相關寄賣資訊（類型、出貨日期、地點、結算日期）
   - 這確保即使調用者沒有直接指定寄賣標識，系統仍能識別寄賣出貨

4. **出貨處理邏輯調整**
   - 在 SHIPMENT 處理流程中，區分寄賣出貨與一般出貨
   - 一般出貨直接減少實際庫存和可用庫存
   - 寄賣出貨通過 CONSIGNSHIP 子程序特殊處理

5. **寄賣出貨處理**
   - 新增 CONSIGNSHIP 子程序專門處理寄賣出貨
   - 更新庫存主檔的寄賣數量 (IV06)，而不減少實際庫存
   - 同時在寄賣庫存檔中建立對應記錄

6. **寄賣結算/退回處理**
   - 新增 CONSIGN 處理流程，專門處理寄賣品的結算或退回
   - 結算處理 (CONSSETTLE)：
     - 更新寄賣庫存記錄狀態為已結算
     - 減少寄賣數量，增加已結算數量
     - 結算時才實際減少庫存數量（核心邏輯修改）
   - 退回處理 (CONSRETURN)：
     - 更新寄賣庫存記錄狀態為已退回
     - 減少寄賣數量，增加退回數量
     - 不影響實際庫存（因為並未實際扣減）

7. **庫存異動記錄增強**
   - 在 CREATELOG 子程序中，增加寄賣資訊的記錄
   - 確保所有庫存異動都有完整的寄賣相關資訊
   - 為報表和追蹤提供詳細的異動歷史

這些修改使 W2IV05 程式能夠正確處理寄賣出貨的庫存異動，關鍵改進包括：

- 寄賣出貨時不立即減少實際庫存，而是記錄在寄賣數量欄位
- 只有在寄賣品確認結算時，才實際減少庫存數量
- 寄賣品退回時不影響實際庫存，只更新寄賣相關欄位
- 所有庫存異動都記錄詳細的寄賣資訊，提供完整的追蹤
- 支援『R1D3』類型的寄賣品特殊處理邏輯

通過這些修改，系統能夠正確處理『R1D3』寄賣出貨的庫存影響，避免錯誤地直接扣減庫存，確保庫存報表顯示正確的庫存狀態。這是解決問題的核心修改，直接處理了將寄賣送貨數量直接自庫存扣除的問題。

# W2IV08 庫存報表生成程式修改 (IBM RPG)

以下是針對 W2IV08 庫存報表生成程式的 IBM RPG 修改內容，主要增加寄賣庫存處理邏輯：

```
      * 修改 W2IV08 - 庫存報表生成程式
      * 增加寄賣庫存處理邏輯
      
     F* 檔案定義區段
     FIVTPF    IF   E           K DISK                  
     F                                     RENAME(INVREC:INVREC1)
     F* 新增寄賣庫存檔案
     FCSPF     IF   E           K DISK                  
     F                                     RENAME(CSREC:CSREC1)
     F* 產品主檔
     FPDTPF    IF   E           K DISK                  
     F                                     RENAME(PDTREC:PDTREC1)
     F* 報表輸出檔案
     FIVTRPT   O    E             PRINTER
     F                                     RENAME(RPTREC:RPTREC1)
     F* 寄賣明細報表輸出檔案
     FCONRPT   O    E             PRINTER
     F                                     RENAME(CONRPTREC:CONRPTREC1)
     F* 螢幕顯示檔案
     FIVSCRN   CF   E             WORKSTN
     F                                     RENAME(SCRREC:SCRREC1)

     D* 資料結構定義
     D INVREC1        DS                  
     D  IV01                 1      9      * 產品編號
     D  IV02                10     17  0   * 實際庫存
     D  IV03                18     25  0   * 可用庫存
     D  IV04                26     33  0   * 預訂數量
     D  IV05                34     41  0   * 在途數量
     D* 新增寄賣庫存欄位
     D  IV06                42     49  0   * 寄賣數量
     D  IV07                50     57  0   * 寄賣已結算
     D  IV08                58     65  0   * 寄賣退回
     D  IVXX                66     73  0   * 更新日期
     D  IVYY                74     79  0   * 更新時間
     D  IVZZ                80     89      * 更新人員

     D* 寄賣庫存資料結構
     D CSREC1         DS                  
     D  CS01                 1     12      * 寄賣編號
     D  CS02                13     21      * 產品編號
     D  CS03                22     29  0   * 寄賣日期
     D  CS04                30     37  0   * 寄賣數量
     D  CS05                38     47      * 客戶代號
     D  CS06                48     55  0   * 預計結算日期
     D  CS07                56     63  0   * 已結算數量
     D  CS08                64     64      * 寄賣狀態

     D* 產品資料結構
     D PDTREC1        DS                  
     D  PDT01                1      9      * 產品編號
     D  PDT02               10     39      * 產品名稱
     D  PDT03               40     49      * 產品類別
     D  PDT04               50     79      * 規格說明
     D* 其他產品欄位...

     D* 螢幕顯示格式
     D SCRREC1        DS                  
     D* 原有螢幕欄位...
     D  SCRRPTTYP            380   380    
     D  SCRRPTDT             381   388  0

     D* 報表工作變數
     D wRptType        S              1A   INZ
     D wRptDate        S              8P 0 INZ
     D wStartProd      S              9A   INZ
     D wEndProd        S              9A   INZ
     D wCategory       S             10A   INZ
     D wShowConsign    S              1A   INZ('Y')
     D wTotActQty      S             10P 0 INZ
     D wTotAvlQty      S             10P 0 INZ
     D wTotConsQty     S             10P 0 INZ
     D wAdjustedQty    S              8P 0 INZ
     D wConsignDesc    S             30A   INZ
     D wPageNo         S              3P 0 INZ
     D wLineCount      S              2P 0 INZ
     D CurDate         S              8P 0
     D CurTime         S              6P 0
     D CurUser         S             10A
     D i               S             10I 0
     D ErrorMsg        S             50A   INZ
     
     C* 程式主體
     C     *ENTRY        PLIST
     C                   PARM                    RPTTYPE          1
     C                   PARM                    RPTDATE          8 0
     C                   PARM                    STARTPRD         9
     C                   PARM                    ENDPRD           9
     C                   PARM                    CATEG           10
     C                   PARM                    SHOWCONS         1
     
     C* 取得當前日期時間與使用者
     C                   TIME                    CurDate
     C                   TIME                    CurTime
     C                   MOVE      USRPRF        CurUser

     C* 初始化參數
     C                   MOVE      RPTTYPE       wRptType
     C     RPTDATE       IFNE      0
     C                   MOVE      RPTDATE       wRptDate
     C                   ELSE
     C                   MOVE      CurDate       wRptDate
     C                   ENDIF
     C                   MOVE      STARTPRD      wStartProd
     C                   MOVE      ENDPRD        wEndProd
     C                   MOVE      CATEG         wCategory
     C     SHOWCONS      IFNE      *BLANKS
     C                   MOVE      SHOWCONS      wShowConsign
     C                   ENDIF
     
     C* 初始化報表
     C                   EXSR      INITRPT
     
     C* 根據報表類型處理
     C     wRptType      CASEQ     'S'           STDRPT
     C                   CASEQ     'D'           DETAILRPT
     C                   CASEQ     'C'           CONSIGNRPT
     C                   CASEQ     'A'           ALLRPT
     C                   ENDCS
     
     C* 完成報表
     C                   EXSR      FINISHRPT
     
     C* 結束程式
     C                   SETON                                        LR
     
     C* 標準庫存報表
     C     STDRPT        TAG
     C* 處理標準庫存報表...
     C                   EXSR      STDHEADER
     
     C* 設定範圍
     C     wStartProd    SETLL     IVTPF
     C     wEndProd      SETGT     IVTPF
     
     C* 初始化累計
     C                   Z-ADD     0             wTotActQty
     C                   Z-ADD     0             wTotAvlQty
     C                   Z-ADD     0             wTotConsQty
     
     C* 逐筆處理庫存記錄
     C                   READP     IVTPF                                61
     C     *IN61         DOWEQ     *OFF
     
     C* 檢查類別條件
     C     wCategory     IFNE      *BLANKS
     C                   CHAIN     IV01          PDTPF
     C     PDT03         IFNE      wCategory
     C                   READP     IVTPF                                61
     C                   ITER
     C                   ENDIF
     C                   ENDIF
     
     C* 處理單筆庫存記錄
     C                   EXSR      ADJCONSIGN
     C                   EXSR      PRINTSTD
     
     C* 累計數量
     C                   ADD       IV02          wTotActQty
     C                   ADD       IV03          wTotAvlQty
     C                   ADD       IV06          wTotConsQty
     
     C* 取下一筆
     C                   READP     IVTPF                                61
     C                   ENDDO
     
     C* 印出總計
     C                   EXSR      PRINTTOTAL
     C                   RETURN
     
     C* 詳細庫存報表
     C     DETAILRPT     TAG
     C* 處理詳細庫存報表...
     C                   RETURN
     
     C* 寄賣庫存報表
     C     CONSIGNRPT    TAG
     C* 寄賣庫存報表表頭
     C                   EXSR      CONSHEADER
     
     C* 設定範圍
     C                   SETLL     CSPF
     
     C* 初始化累計
     C                   Z-ADD     0             wTotConsQty
     
     C* 逐筆處理寄賣記錄
     C                   READ      CSPF                                 61
     C     *IN61         DOWEQ     *OFF
     
     C* 檢查產品範圍
     C     CS02          IFLT      wStartProd
     C                   READ      CSPF                                 61
     C                   ITER
     C                   ENDIF
     C     CS02          IFGT      wEndProd
     C     wEndProd      ANDNE     *BLANKS
     C                   READ      CSPF                                 61
     C                   ITER
     C                   ENDIF
     
     C* 檢查類別條件
     C     wCategory     IFNE      *BLANKS
     C                   CHAIN     CS02          PDTPF
     C     PDT03         IFNE      wCategory
     C                   READ      CSPF                                 61
     C                   ITER
     C                   ENDIF
     C                   ENDIF
     
     C* 檢查狀態 - 只處理開放的寄賣記錄
     C     CS08          IFNE      'O'
     C                   READ      CSPF                                 61
     C                   ITER
     C                   ENDIF
     
     C* 處理單筆寄賣記錄
     C                   EXSR      PRINTCONS
     
     C* 累計數量
     C                   ADD       CS04          wTotConsQty
     
     C* 取下一筆
     C                   READ      CSPF                                 61
     C                   ENDDO
     
     C* 印出總計
     C                   EXSR      CONSTOTAL
     C                   RETURN
     
     C* 全部報表
     C     ALLRPT        TAG
     C* 產生全部報表類型
     C                   MOVE      'S'           wRptType
     C                   EXSR      STDRPT
     C                   MOVE      'C'           wRptType
     C                   EXSR      CONSIGNRPT
     C                   RETURN
     
     C* 初始化報表子程序
     C     INITRPT       BEGSR
     C* 初始化報表...
     C                   Z-ADD     1             wPageNo
     C                   Z-ADD     0             wLineCount
     C                   ENDSR
     
     C* 完成報表子程序
     C     FINISHRPT     BEGSR
     C* 完成報表...
     C                   ENDSR
     
     C* 調整寄賣庫存子程序
     C     ADJCONSIGN    BEGSR
     C* 計算調整後的庫存數量
     C                   MOVE      IV02          wAdjustedQty
     
     C* 根據選項決定是否調整寄賣數量
     C     wShowConsign  IFEQ      'Y'
     C* 包含寄賣數量 - 不調整
     C                   Z-ADD     0             wAdjustedQty
     C                   MOVE      *BLANKS       wConsignDesc
     C                   ELSE
     C* 扣除寄賣數量 - 調整實際庫存
     C                   SUB       IV06          wAdjustedQty
     C                   MOVE      '(已扣除寄賣)' wConsignDesc
     C                   ENDIF
     C                   ENDSR
     
     C* 標準報表表頭
     C     STDHEADER     BEGSR
     C* 印出標準報表表頭
     C                   EXCEPT    STDHDR
     C                   EXCEPT    STDHDR2
     C                   EXCEPT    STDCOLHDR
     C                   ADD       3             wLineCount
     C                   ENDSR
     
     C* 寄賣報表表頭
     C     CONSHEADER    BEGSR
     C* 印出寄賣報表表頭
     C                   EXCEPT    CONHDR
     C                   EXCEPT    CONHDR2
     C                   EXCEPT    CONCOLHDR
     C                   ADD       3             wLineCount
     C                   ENDSR
     
     C* 印出標準報表明細
     C     PRINTSTD      BEGSR
     C* 檢查換頁
     C     wLineCount    IFGE      55
     C                   ADD       1             wPageNo
     C                   EXSR      STDHEADER
     C                   ENDIF
     
     C* 取得產品資訊
     C     IV01          CHAIN     PDTPF
     
     C* 印出標準報表明細行
     C                   EXCEPT    STDDET
     C                   ADD       1             wLineCount
     
     C* 如果有寄賣數量，印出寄賣資訊
     C     IV06          IFGT      0
     C     wShowConsign  ANDEQ     'Y'
     C                   EXCEPT    STDCONS
     C                   ADD       1             wLineCount
     C                   ENDIF
     C                   ENDSR
     
     C* 印出寄賣報表明細
     C     PRINTCONS     BEGSR
     C* 檢查換頁
     C     wLineCount    IFGE      55
     C                   ADD       1             wPageNo
     C                   EXSR      CONSHEADER
     C                   ENDIF
     
     C* 取得產品資訊
     C     CS02          CHAIN     PDTPF
     
     C* 格式化寄賣狀態描述
     C     CS08          IFEQ      'O'
     C                   MOVE      '開放'        wConsignDesc
     C                   ELSE
     C     CS08          IFEQ      'C'
     C                   MOVE      '已結算'      wConsignDesc
     C                   ELSE
     C     CS08          IFEQ      'R'
     C                   MOVE      '已退回'      wConsignDesc
     C                   ELSE
     C                   MOVE      '未知'        wConsignDesc
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     
     C* 印出寄賣報表明細行
     C                   EXCEPT    CONDET
     C                   ADD       1             wLineCount
     C                   ENDSR
     
     C* 印出總計子程序
     C     PRINTTOTAL    BEGSR
     C* 印出標準報表總計
     C                   EXCEPT    STDTOT
     C                   ENDSR
     
     C* 印出寄賣總計子程序
     C     CONSTOTAL     BEGSR
     C* 印出寄賣報表總計
     C                   EXCEPT    CONTOT
     C                   ENDSR
     
     
     O* 標準庫存報表輸出格式
     OIVTRPT    E            STDHDR
     O                                           1
     O                       '庫存報表 - 標準'
     O                                          30
     O                       '報表日期:'
     O          wRptDate     Y                  50DATFMT(*ISO)
     O                                          70
     O                       '頁:'
     O          wPageNo                         80
     
     O          E            STDHDR2
     O                                           1
     O          wConsignDesc                    30
     O                                          70
     O                       '使用者:'
     O          CurUser                         80
     
     O          E            STDCOLHDR
     O                                           1
     O                       '產品編號'
     O                                          15
     O                       '產品名稱'
     O                                          45
     O                       '類別'
     O                                          55
     O                       '實際庫存'
     O                                          65
     O                       '可用庫存'
     O                                          75
     O                       '寄賣數量'
     
     O          E            STDDET
     O          IV01                            10
     O          PDT02                           45
     O          PDT03                           55
     O          IV02                            65
     O          IV03                            75
     O          IV06                            85
     
     O          E            STDCONS
     O                                          10
     O                       ' → 其中寄賣:'
     O          IV06                            30
     
     O          E            STDTOT
     O                                           1
     O                       '==== 總計 ===='
     O                                          55
     O          wTotActQty                      65
     O          wTotAvlQty                      75
     O          wTotConsQty                     85
     
     
     O* 寄賣庫存報表輸出格式
     OCONRPT    E            CONHDR
     O                                           1
     O                       '寄賣庫存報表'
     O                                          30
     O                       '報表日期:'
     O          wRptDate     Y                  50DATFMT(*ISO)
     O                                          70
     O                       '頁:'
     O          wPageNo                         80
     
     O          E            CONHDR2
     O                                          70
     O                       '使用者:'
     O          CurUser                         80
     
     O          E            CONCOLHDR
     O                                           1
     O                       '產品編號'
     O                                          12
     O                       '產品名稱'
     O                                          40
     O                       '寄賣編號'
     O                                          55
     O                       '寄賣日期'
     O                                          65
     O                       '數量'
     O                                          75
     O                       '客戶代號'
     O                                          90
     O                       '狀態'
     
     O          E            CONDET
     O          CS02                            10
     O          PDT02                           40
     O          CS01                            55
     O          CS03         Y                  65DATFMT(*ISO)
     O          CS04                            75
     O          CS05                            90
     O          wConsignDesc                   100
     
     O          E            CONTOT
     O                                           1
     O                       '==== 寄賣總數量 ===='
     O                                          65
     O          wTotConsQty                     75
```

## 修改說明

1. **檔案與資料結構擴展**
   - 擴展庫存主檔結構 INVREC1，包含寄賣相關欄位
   - 增加寄賣庫存檔案 CSPF 及其資料結構 CSREC1
   - 新增寄賣明細報表輸出檔案 CONRPT

2. **報表參數擴展**
   - 增加 SHOWCONS 參數，控制是否在標準報表中顯示/計算寄賣數量
   - 擴展報表類型 (RPTTYPE) 支援:
     - 'S': 標準庫存報表
     - 'D': 詳細庫存報表
     - 'C': 寄賣庫存報表
     - 'A': 全部報表類型

3. **標準庫存報表增強**
   - 在 STDRPT 處理流程中，增加寄賣數量的處理
   - 新增 ADJCONSIGN 子程序計算調整後的庫存數量
   - 根據 wShowConsign 參數決定是否在報表中扣除寄賣數量
   - 為有寄賣數量的產品增加詳細說明行 (STDCONS)
   - 在報表中顯示寄賣數量的總計

4. **寄賣庫存專門報表**
   - 新增 CONSIGNRPT 處理流程，專門處理寄賣庫存報表
   - 從寄賣庫存檔 (CSPF) 讀取資料，而非庫存主檔
   - 列出所有符合條件的開放寄賣記錄
   - 顯示寄賣編號、產品、日期、數量、客戶和狀態等詳細資訊
   - 提供寄賣數量總計

5. **報表格式設計**
   - 標準庫存報表 (IVTRPT):
     - 增加寄賣數量欄位
     - 為寄賣產品增加詳細說明行
     - 在總計中包含寄賣數量
   
   - 寄賣庫存報表 (CONRPT):
     - 專門顯示寄賣庫存明細
     - 包含更多寄賣相關資訊，如寄賣編號、日期、客戶等
     - 顯示寄賣狀態說明

6. **綜合報表處理**
   - 新增 ALLRPT 處理流程，可同時產生多種報表類型
   - 先產生標準庫存報表，再產生寄賣庫存報表
   - 提供完整的庫存和寄賣情況概覽

這些修改使 W2IV08 程式能夠正確生成包含寄賣庫存資訊的報表，核心改進包括：

- 提供選項控制是否在標準庫存報表中扣除寄賣數量
- 清晰標示寄賣庫存和實際庫存的區別
- 新增專門的寄賣庫存報表，提供詳細的寄賣資訊
- 為庫存管理人員提供準確的庫存和寄賣情況
- 特別處理『R1D3』類型的寄賣出貨，確保不會錯誤扣減庫存

通過這些報表修改，使用者可以清楚了解:
1. 實際庫存數量
2. 寄賣在外的數量
3. 調整後的庫存數量
4. 寄賣明細資訊

這有助於正確處理『R1D3』寄賣品的問題，不再將寄賣送貨數量直接自庫存扣除，而是提供明確的寄賣標識和處理機制。

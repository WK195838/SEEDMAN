# 應收帳款系統—統一發票記錄作業程式規格書（ARA010）

## 一、基本資訊
- **程式名稱**：ARA010
- **作者**：A1118 PHILP TSAI
- **建立日期**：81/04/29
- **修改日期**：
- **系統**：應收帳款系統
- **子系統**：應收帳款子系統
- **功能說明**：統一發票記錄作業
- **修改記錄**：
  - M001 (98.11.17) MANUAL MODIFY BY MICHELLE FOR Y2K

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **PA#BPF**：公司資訊檔（DISK，查詢用）
- **ARA010D**：顯示檔（WORKSTN）

### 2. 檔案關聯圖
```
  [PA#BPF]──►[ARA010]──►[ARA010D]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. PA#BPF（公司資訊檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| #B0      | -    | 字串 | 公司主鍵 | - |

### 2. ARA010D（顯示檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| DSI01    | 2    | 字串 | 公司代號 | 必填、須存在公司主檔 |
| DSI21S   | 6    | 日期 | 起始發票日期 | 必須為有效日期 |
| DSI21E   | 6    | 日期 | 結束發票日期 | 必須為有效日期且不可小於起始日期 |
| MMS      | 2    | 字串 | 起始月份 | 1-12 |
| YYS      | 2    | 字串 | 起始年份 | - |
| MME      | 2    | 字串 | 結束月份 | 1-12 |
| YYE      | 2    | 字串 | 結束年份 | - |
| WSI21S   | 8    | 日期 | 工作起始日期 | Y2K格式日期 |
| WSI21E   | 8    | 日期 | 工作結束日期 | Y2K格式日期 |

### 3. 系統變數與參數
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| $EVR     | 1    | 整數 | 版本號 | - |
| $CPY     | 3    | 字串 | 公司編號 | - |
| $PRTID   | 2    | 字串 | 印表機ID | - |
| LDA      | -    | 區域 | 本地資料區 | - |
| APPSCR   | 6    | 字串 | 應用程式螢幕 | - |
| D#ROW    | -    | 整數 | 游標列位置 | - |
| D#COL    | -    | 整數 | 游標行位置 | - |
| FYY4     | 4    | 字串 | 四位數年份 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（DSPD1/SCR001）
- 統一發票查詢條件設定區：
  - 公司代號（DSI01）
  - 發票日期區間：
    - 起始發票日期（DSI21S）- 年份（YYS）、月份（MMS）
    - 結束發票日期（DSI21E）- 年份（YYE）、月份（MME）
  - 印表機ID：使用F4查詢功能可選擇

### 2. 功能鍵
- F3：離開
- F4：代碼表查詢（印表機ID）
- ENTER：確認執行

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數
2. 畫面顯示（EXFMT DSPD1）：顯示主畫面進行條件設定
3. 功能處理：
   - F3：離開系統
   - F4：印表機ID查詢（RTNF4）
   - ENTER：確認執行，進行欄位檢查（RTN100）
4. 輸出LDA（OUTLDA）：將處理結果寫入本地資料區
5. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境與變數
  - 初始化畫面欄位
  - 設定APPSCR為'SCR001'
  - 設定$EVR版本號為1
  
- RTN100：檢查畫面欄位
  - 檢查公司代號（DSI01）是否為空值
  - 檢查公司代號是否存在公司主檔
  - 檢查發票日期區間是否有效
  - 處理Y2K日期格式轉換
  - 設定工作日期變數（WSI21S、WSI21E）
  
- RTNF4：F4代碼表查詢處理
  - 根據游標位置判斷查詢項目
  - 印表機ID：呼叫WDS011程式查詢
  
- OUTLDA：輸出LDA處理
  - 將處理結果寫入本地資料區

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 欄位檢查錯誤：設置對應的錯誤指示器，在下次畫面顯示時提示用戶
- 公司代號檢查：檢查公司代號是否存在於公司主檔中
- 日期格式檢查：檢查月份是否在1-12之間
- Y2K日期處理：使用HB@24Y子程序處理世紀轉換

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN03  | F3離開功能鍵 |
| *IN04  | F4說明功能鍵 |
| *IN40  | 記錄未找到 |
| *IN60  | 一般錯誤訊息 |
| *IN61  | 發票日期錯誤 |
| *IN87  | 執行記錄旗標 |
| *IN94  | 月份錯誤（1-12） |
| *IN95  | 公司不存在 |
| *IN96  | 公司代號空白 |
| *IN97  | 處理執行旗標 |
| *IN98  | 處理執行旗標 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. Y2K日期處理
- 使用HB@24Y子程序進行2位數到4位數年份的轉換
- DSI21S和DSI21E日期欄位拆分為年份（YYS/YYE）和月份（MMS/MME）處理
- 轉換後的4位數年份格式存入WSI21S和WSI21E欄位

### 2. 公司代號處理
- 檢查公司代號是否填寫
- 透過CHAIN操作檢查公司代號是否存在於PA#BPF檔案中

### 3. 印表機選擇功能
- 通過F4功能鍵調用WDS011程式查詢印表機ID
- 印表機ID存入$PRTID變數中用於後續報表輸出

### 4. 處理流程控制
- 使用多個控制旗標（*IN87/*IN97/*IN98）控制程式執行流程
- 執行成功後，透過LDA將處理結果傳遞給其他相關程式

本規格書依據ARA010.txt製作，完整記錄ARA010程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
# 應收帳款系統—退貨折讓處理程式規格書（ARA008）

## 一、基本資訊
- **程式名稱**：ARA008
- **作者**：A1092 TAYLOR
- **建立日期**：81/03/25
- **修改日期**：81/04/17 PHILIP
- **系統**：應收帳款系統
- **子系統**：應收帳款系統
- **功能說明**：退貨折讓處理
- **修改記錄**：
  - M001 (98.11.10) MANUAL MODIFY BY MICHELLE FOR Y2K
  - M002 (98.11.25) 123199 = 123129
  - M003 (00.04.14) FOR DUTY稅率支援
  - M004 (02.04.14) RE-MODIFY M003

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **SOSGPF**：退貨主檔（DISK，更新用）
- **SOSGLF2**：退貨邏輯檔（DISK，查詢用）
- **SOSHPF**：退貨明細檔（DISK，更新用）
- **SOSIPF**：發票主檔（DISK，更新用）
- **SOSJPF**：客戶訂單檔（DISK，更新用）
- **SOSXPF**：退貨稅額檔（DISK，更新用）
- **SOSYPF**：沖銷檔（DISK，更新用）
- **SOS2PF**：類別檔（DISK，更新用）
- **ARAGPF**：單號檔（DISK，更新用）
- **MTMDPF**：部門檔（DISK，更新用）
- **IMIAPF**：存貨主檔（DISK，更新用）
- **MTMAPF**：物料主檔（DISK，更新用）
- **ARACLF04**：財務檔（DISK，更新用）
- **MTMEPF**：地址檔（DISK，查詢用）
- **PA#BPF**：公司資訊檔（DISK，查詢用）
- **PA#GPF**：印花稅檔（DISK，查詢用）
- **ARA008D**：顯示檔（WORKSTN，支援SFL）

### 2. 檔案關聯圖
```
  [SOSGLF2]◄────────┐
      │                │
      ▼                │
  [SOSGPF]◄────────────┼────────────┐
      │                │            │
      │                │            │
      ├────────────►[SOSHPF]◄───────┼────────┐
      │                │            │        │
      │                │            │        │
      ├────────────►[SOSIPF]◄───────┼────────┼───┐
      │                │            │        │   │
      │                │            │        │   │
      ├────────────►[SOSJPF]◄───────┼────────┼───┼───┐
      │                │            │        │   │   │
      │                │            │        │   │   │
  [SOSXPF]             │            │        │   │   │
      │                │            │        │   │   │
      │                │            │        │   │   │
  [SOSYPF]             │            │        │   │   │
      │                │            │        │   │   │
      │                │            │        │   │   │
  [SOS2PF]             │            │        │   │   │
      │                │            │        │   │   │
      │                │            │        │   │   │
  [ARAGPF]◄────────────┼────────────┼────────┼───┼───┤
      │                │            │        │   │   │
      │                │            │        │   │   │
  [MTMDPF]◄────────────┼────────────┼────────┼───┼───┤
      │                │            │        │   │   │
      │                │            │        │   │   │
  [IMIAPF]◄────────────┼────────────┼────────┼───┼───┤
      │                │            │        │   │   │
      │                │            │        │   │   │
  [MTMAPF]◄────────────┼────────────┼────────┼───┼───┤
      │                │            │        │   │   │
      │                │            │        │   │   │
  [ARACLF04]◄──────────┼────────────┼────────┼───┼───┤
      │                │            │        │   │   │
      │                │            │        │   │   │
  [MTMEPF]             │            │        │   │   │
      │                │            │        │   │   │
      │                │            │        │   │   │
  [PA#BPF]             │            │        │   │   │
      │                │            │        │   │   │
      │                │            │        │   │   │
  [PA#GPF]             │            │        │   │   │
      │                │            │        │   │   │
      ▼                ▼            ▼        ▼   ▼   ▼
      [ARA008]────────────────────────────────────►[ARA008D]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. SOSGPF（退貨主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SG01     | 2    | 字串 | 公司代號 | 必填、須存在公司主檔 |
| SG02     | 12   | 字串 | 退貨單號 | 必填、自動產生、為唯一鍵 |
| SG04     | 5    | 字串 | 部門代號 | 必填、須存在部門主檔 |
| SG05     | 4    | 字串 | 業務代號 | 必填、須與部門代號匹配 |
| SG06     | 8    | 日期 | 退貨日期 | 必填、有效日期 |
| SG09     | 12   | 字串 | 關聯單號 | - |
| SG10     | -    | 數值 | 退貨金額 | 必填、大於0 |
| SG11     | -    | 字串 | 說明備註 | - |
| SG13     | -    | 數值 | 實退金額 | - |
| SG14     | 1    | 字元 | 狀態代碼 | '*'=待確認,'V'=已確認,'A'=已補帳,'N'=已補帳 |
| SG16     | -    | 字元 | 補帳記號 | - |
| SG17     | -    | 字串 | 序號記號 | - |
| SG18     | -    | 字串 | 客戶代號 | - |
| SG19     | -    | 數值 | 訂購數量 | - |
| SG20     | -    | 數值 | 出貨數量 | - |
| SG21     | -    | 數值 | 退貨數量 | - |
| SG22     | -    | 數值 | 未稅金額 | - |
| SG23     | -    | 數值 | 進貨總額 | - |
| SG24     | -    | 數值 | 稅額 | - |
| SG25     | -    | 數值 | 營業額 | - |
| SG26     | -    | 日期 | 確認日期 | - |
| SGXX     | -    | 日期 | 更新日期 | 系統自動產生 |
| SGYY     | -    | 時間 | 更新時間 | 系統自動產生 |
| SGZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 2. SOSHPF（退貨明細檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SH02     | 12   | 字串 | 退貨單號 | - |
| SH03     | 9    | 字串 | 品項代號 | - |
| SH04     | -    | 數值 | 訂購數量 | - |
| SH05     | -    | 數值 | 出貨數量 | - |
| SH06     | -    | 數值 | 退貨數量 | - |
| SH07     | -    | 數值 | 未稅單價 | - |
| SH08     | -    | 數值 | 實際成本 | - |
| SH10     | -    | 字串 | 倉庫代號 | - |
| SH11     | -    | 字串 | 存貨類別 | - |
| SH12     | -    | 數值 | 已退數量 | - |
| SH13     | -    | 數值 | 已收數量 | - |
| SH14     | -    | 數值 | 實際金額 | - |
| SH15     | -    | 數值 | 毛利金額 | - |
| SH16     | -    | 數值 | 退回金額 | - |
| SH17     | -    | 數值 | 未稅金額 | - |
| SH18     | -    | 數值 | 進貨總額 | - |
| SH19     | -    | 數值 | 稅額 | - |
| SH20     | -    | 數值 | 營業額 | - |

### 3. SOSXPF（退貨稅額檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SX10     | -    | 數值 | 稅額 | - |

### 4. SOSJPF（客戶訂單檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SJ08     | -    | 數值 | 退貨數量 | - |
| SJ09     | -    | 數值 | 退貨金額 | - |
| SJ14     | -    | 數值 | 含稅退貨數量 | - |
| SJ15     | -    | 數值 | 免稅退貨數量 | - |

### 5. SOSIPF（發票主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SI28     | -    | 數值 | 退貨金額 | - |

### 6. SOSYPF（沖銷檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SY07     | -    | 數值 | 未稅沖銷金額 | - |
| SY08     | -    | 數值 | 稅額 | - |

### 7. MTMDPF（部門檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| MD01     | -    | 字串 | 部門代號 | - |
| MD29     | -    | 數值 | 一般統計金額 | - |
| MD31     | -    | 數值 | 累計統計金額 | - |

### 8. IMIAPF（存貨主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| IA01     | -    | 字串 | 存貨類別 | - |
| IA02     | -    | 字串 | 倉庫代號 | - |
| IA03     | -    | 字串 | 品項代號 | - |
| IA04     | -    | 字串 | 材質說明 | - |
| IA05     | -    | 字串 | 品項說明 | - |
| IA06     | -    | 數值 | 庫存數量 | - |
| IA07     | -    | 數值 | 在途數量 | - |
| IA08     | -    | 數值 | 成本單價 | - |
| IA09     | -    | 數值 | 單位總成本 | - |
| IA10     | -    | 數值 | 庫存金額 | - |

### 9. MTMAPF（物料主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| MA08     | -    | 字串 | 品項說明 | - |
| MA09     | -    | 字串 | 材質說明 | - |
| MA26     | -    | 數值 | FOB 金額 | - |
| MA27     | -    | 數值 | 加工金額 | - |
| MA28     | -    | 數值 | 稅額 | - |
| MA30     | -    | 數值 | 庫存數量 | - |
| MA31     | -    | 數值 | FOB 單價 | - |
| MA32     | -    | 數值 | 加工單價 | - |
| MA33     | -    | 數值 | 稅額單價 | - |

### 10. ARACLF04（財務檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AC01     | -    | 字串 | 公司代號 | - |
| AC02     | -    | 字串 | 部門代號 | - |
| AC03     | -    | 字串 | 業務代號 | - |
| AC04     | -    | 日期 | 確認日期 | - |
| AC05     | -    | 字串 | 交易類型 | '50'=退貨 |
| AC06     | -    | 字串 | 關聯單號 | - |
| AC07     | -    | 數值 | 未稅金額 | - |
| AC08     | -    | 數值 | 稅額 | - |
| AC09     | -    | 字串 | 說明備註 | - |
| AC10     | -    | 數值 | 總額 | - |
| AC11     | -    | 數值 | 已沖銷金額 | - |

### 11. PA#BPF（公司資訊檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| #B03     | -    | 字串 | 公司名稱 | - |

### 12. 系統變數與設定
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| $ADD     | 1    | 字元 | 新增權限 | Y/N |
| $UPD     | 1    | 字元 | 修改權限 | Y/N |
| $DLT     | 1    | 字元 | 刪除權限 | Y/N |
| $INQ     | 1    | 字元 | 查詢權限 | Y/N |
| DATE     | 8    | 整數 | Y2K系統日期 | - |
| WFUN     | 5    | 字串 | 功能代碼表 | - |
| WA01     | 5    | 字串 | 權限陣列 | - |
| ARR      | 4    | 陣列 | 狀態代碼陣列 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（SCR001）
- 查詢條件輸入區：
  - 公司代號（DBGN1）
  - 退貨日期（DBGN2）- 預設為12/31/29
  - 退貨單號（DBGN3）
- 子檔清單（SFLSR1）：顯示符合條件的退貨資料
  - 顯示欄位：公司代號、退貨單號、退貨日期、客戶代號、狀態等
  - 顯示狀態：待確認、待退貨確認、已確認、已補帳
- 功能選項：輸入選項（1=新增、2=修改、4=刪除、5=查詢）

### 2. 明細畫面（SCR002）
- 顯示區（標題區）：
  - 公司代號（SG01）- 顯示公司名稱（#B03）
  - 退貨單號（SG02）
  - 部門代號（SG04）、業務代號（SG05）- 顯示業務名稱（ME04）
  - 退貨日期（SG06）
  - 確認日期（SG26）
  - 關聯單號（SG09）
  - 退貨金額（SG10）
- 子檔清單（SFLSR2）：顯示退貨明細資料
  - 顯示欄位：品項代號、訂購數量、出貨數量、退貨數量、未稅單價等
  - 選項：2=修改、4=刪除、5=查詢
- 功能鍵：F3=離開、F12=返回

### 3. 功能鍵
- F3：離開
- F4：代碼表查詢（業務代號）
- F5：重新整理
- F12：取消/返回
- ENTER：執行/確認
- ROLL UP：下一頁

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數、設定權限
2. 初始化畫面（RTN191）：初始化分頁顯示子檔
3. 讀取符合條件資料（RTN192/RTN193）：讀取符合條件的退貨資料
4. 畫面顯示（RTN195）：顯示主畫面與子檔資料
5. 功能處理：
   - ENTER（RTN170）：處理選項與更新
   - 選項處理（RTN171/RTN180）：檢查選項並執行對應功能
6. 資料操作：
   - 修改（RTN220）：修改退貨資料
   - 刪除（RTN230）：刪除退貨資料
7. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境、變數與權限，設定初始查詢條件
- RTN170：ENTER鍵處理與查詢條件變更處理
- RTN171：讀取子檔選項並處理
- RTN180：檢查選項與權限
  - 檢查狀態是否為已補帳（不可刪除）
  - 檢查退貨單號是否已存在印花稅檔中
  - 檢查狀態是否為已確認或已補帳（不可修改）
- RTN185：獲取退貨主檔資料顯示於標題區
- RTN191：初始化子檔顯示設定，設置查詢條件
- RTN192/RTN193：讀取下一頁資料處理，日期格式轉換，狀態代碼顯示
- RTN195：顯示主畫面與子檔
- RTN200：子畫面處理主控
- RTN220：修改退貨處理
- RTN230：刪除退貨處理
- RTN280：檢查明細畫面子檔選項與權限
  - 檢查狀態是否為已確認（不可修改）
  - 檢查狀態是否為已補帳或已確認（不可刪除）
  - 檢查存貨是否足夠（不可刪除）
  - 檢查財務檔是否有差異（不可刪除）
- RTN291：初始化明細子檔
- RTN298：讀取退貨明細資料到子檔
- RTN29B：處理退貨明細檔資料顯示
- RTN29T：刪除處理
  - 更新存貨主檔
  - 更新物料主檔
  - 更新退貨明細檔
  - 更新客戶訂單檔
  - 更新發票主檔
  - 更新沖銷檔
  - 更新部門檔
  - 更新退貨主檔
  - 更新退貨稅額檔
  - 更新財務檔
- RTN990：權限檢查
- RTNF4：F4說明處理（代碼表查詢）
- ERRSR：錯誤處理

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 檔案存取錯誤：呼叫 ERRSR 子程序，顯示錯誤訊息
- 權限檢查錯誤：呼叫 RTN990 子程序，檢查使用者權限
- 資料確認：刪除資料前，使用 WDS000 程式進行使用者確認
- Y2K日期處理：特殊處理以確保世紀轉換正確性
- 資料刪除確認：RTN29T 子程序處理刪除前的各項檢查與關聯檔案更新

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN03  | F3離開功能鍵 |
| *IN12  | F12返回功能鍵 |
| *IN25  | 下一頁功能 |
| *IN30  | 修改模式 |
| *IN40  | 記錄未找到 |
| *IN41  | 稅額記錄查詢旗標 |
| *IN44  | 記錄讀取結束 |
| *IN46  | 記錄讀取結束 |
| *IN50  | 子檔顯示控制 |
| *IN51  | 子檔控制顯示 |
| *IN52  | 子檔初始化 |
| *IN53  | 子檔讀取結束 |
| *IN54  | 子檔讀取模式 |
| *IN57  | 子檔讀取旗標 |
| *IN60  | 一般錯誤訊息 |
| *IN85  | 財務檔有差異（不可刪除）|
| *IN86  | 已補帳或已確認（不可刪除）|
| *IN87  | 存貨不足（不可刪除）|
| *IN88  | 已補帳（不可修改）|
| *IN94  | 無資料訊息 |
| *IN95  | 執行完成訊息 |
| *IN96  | 無權限執行此功能 |
| *IN97  | 確認訊息提示 |
| *IN98  | 已到最後一頁 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. 退貨狀態處理邏輯
- **待確認 ('*')**：初始狀態，退貨單已建立但尚未確認
- **待退貨確認 (' ')**：已初步處理但尚未完全確認
- **已確認 ('V')**：退貨單已確認但尚未進行財務補帳
- **已補帳 ('A'或'N')**：退貨單已確認且已進行財務補帳處理

### 2. 稅額處理邏輯
- M003增加稅額計算功能
- 退貨稅額儲存於SOSXPF檔案
- 刪除退貨時需一併刪除對應的稅額記錄

### 3. 金額處理邏輯
- 刪除退貨時的金額處理：
  - 更新存貨主檔（減少庫存數量和庫存金額）
  - 更新部門檔統計金額
  - 更新發票主檔退貨金額
  - 更新財務檔金額統計
  - 沖銷檔處理：如果沖銷金額為零，則刪除記錄，否則更新金額

### 4. 相關程式連結
- **ARA0081**：退貨確認處理子程式
  - 由選項2（修改）呼叫
  - 參數：關聯單號、品項代號、退貨單號
- **ARA0083**：退貨明細查詢子程式
  - 由選項5（查詢）呼叫
  - 參數：關聯單號、品項代號、退貨單號
- 其它共用函式：
  - RES001：日期格式轉換處理
  - P50：錯誤訊息處理
  - WDS000：確認對話框處理
  - S#S01：系統權限檢查

本規格書依據 ARA008.txt 製作，完整記錄 ARA008 程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
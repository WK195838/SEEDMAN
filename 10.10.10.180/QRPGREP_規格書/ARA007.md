# 應收帳款系統—折讓處理程式規格書（ARA007）

## 一、基本資訊
- **程式名稱**：ARA007
- **作者**：A1139 JANE
- **建立日期**：81/03/26
- **修改日期**：無
- **系統**：應收帳款系統
- **子系統**：應收帳款子系統
- **功能說明**：折讓資料處理 (新增/修改/刪除/查詢)
- **修改記錄**：
  - M001 (98.11.10) MANUAL MODIFY BY MICHELLE FOR Y2K
  - M002 (98.11.25) 123199 = 123129
  - M004 (00.04.12) FOR DUTY稅率支援
  - M005 (03.04.09) 發票折讓可允出77作為發票折讓金額

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **ARAFPF**：折讓主檔（DISK，更新用）
- **FSOSYPF**：沖銷檔（DISK，更新用）
- **SOSIPF**：發票主檔（DISK，更新用）
- **MTMDPF**：部門檔（DISK，更新用）
- **ARAFLF9**：折讓邏輯檔（DISK，查詢用）
- **ARAFLF8**：折讓邏輯檔（DISK，查詢用）
- **MTMEPF**：地址檔（DISK，查詢用）
- **PA#BPF**：公司資訊檔（DISK，查詢用）
- **PA#APF**：參數主檔（DISK，查詢用）
- **SOSEPF**：發票明細檔（DISK，查詢用）
- **PA#GPF**：印花稅檔（DISK，查詢用）
- **ARA007D**：顯示檔（WORKSTN，支援SFL）

### 2. 檔案關聯圖
```
  [ARAFLF9]◄───────┐
      │               │
      ▼               │
  [ARAFPF]◄───────────┼─────────┐
      │               │         │
      │               │         │
      ├─────────────►[SOSIPF]◄──┼─────────┐
      │               │         │         │
      │               │         │         │
      ├─────────────►[MTMDPF]◄──┼─────────┼─────┐
      │               │         │         │     │
      │               │         │         │     │
  [ARAFLF8]           │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [MTMEPF]            │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [PA#BPF]            │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [PA#APF]            │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [SOSEPF]            │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [PA#GPF]            │         │         │     │
      │               │         │         │     │
      │               │         │         │     │
  [FSOSYPF]◄──────────┼─────────┼─────────┼─────┤
      │               │         │         │     │
      ▼               ▼         ▼         ▼     ▼
     [ARA007]───────────────────────────────►[ARA007D]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. ARAFPF（折讓主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AF01     | 2    | 字串 | 公司代號 | 必填、須存在公司主檔 |
| AF02     | 12   | 字串 | 折讓單號 | 必填、自動產生、為唯一鍵 |
| AF03     | 5    | 字串 | 部門代號 | 必填、須存在部門主檔 |
| AF04     | 4    | 字串 | 業務代號 | 必填、須與部門代號匹配 |
| AF05     | 8    | 日期 | 折讓日期 | 必填、有效日期 |
| AF06     | 10   | 字串 | 發票號碼 | 必填、須存在發票主檔 |
| AF07     | -    | 數值 | 金額 | 必填、大於0 |
| AF08     | 10   | 字串 | 折讓類別 | 必填、須有效 |
| AF09     | -    | 數值 | 稅額 | M004後新增 |
| AF10     | -    | 數值 | 總額 | M004後新增 |
| AFXX     | -    | 日期 | 更新日期 | 系統自動產生 |
| AFYY     | -    | 時間 | 更新時間 | 系統自動產生 |
| AFZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 2. SOSIPF（發票主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SI01     | 2    | 字串 | 公司代號 | - |
| SI02     | 10   | 字串 | 發票號碼 | - |
| SI11     | -    | 字串 | 客戶編號 | - |
| SI12     | 5    | 字串 | 業務部門 | - |
| SI13     | 4    | 字串 | 業務人員 | - |
| SI18     | -    | 字串 | 已收金額 | - |
| SI19     | 1    | 字元 | 確認旗標 | 'V'=已確認 |
| SI22     | 1    | 字元 | 發票屬性 | 'D'=含稅 |
| SI24     | -    | 數值 | 未稅餘額 | - |
| SI25     | -    | 數值 | 發票總額 | - |
| SI26     | -    | 數值 | 收款金額 | - |
| SI27     | -    | 數值 | 折讓金額 | - |
| SI28     | -    | 數值 | 發票/收銀機發票 | - |
| SI30     | -    | 數值 | 未收金額 | - |

### 3. FSOSYPF（沖銷檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SY01     | 2    | 字串 | 公司代號 | - |
| SY02     | 10   | 字串 | 發票號碼 | - |
| SY03     | 5    | 字串 | 業務部門 | - |
| SY07     | -    | 數值 | 未稅沖銷金額 | - |
| SY08     | -    | 數值 | 稅額 | - |

### 4. MTMDPF（部門檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| MD01     | -    | 字串 | 部門代號 | - |
| MD29     | -    | 數值 | 一般統計金額 | - |
| MD31     | -    | 數值 | 累計統計金額 | - |

### 5. PA#BPF（公司資訊檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| #B03     | -    | 字串 | 公司名稱 | - |

### 6. SOSEPF（發票明細檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SE09     | 1    | 字元 | 確認旗標 | 'V'=已確認 |

### 7. 系統變數與設定
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| $ADD     | 1    | 字元 | 新增權限 | Y/N |
| $UPD     | 1    | 字元 | 修改權限 | Y/N |
| $DLT     | 1    | 字元 | 刪除權限 | Y/N |
| $INQ     | 1    | 字元 | 查詢權限 | Y/N |
| DATE     | 8    | 整數 | Y2K系統日期 | - |
| WFUN     | 5    | 字串 | 功能代碼表 | - |
| WA01     | 5    | 字串 | 權限陣列 | - |
| DUTY1    | -    | 數值 | 稅率 | M004後新增 |

## 四、輸出入螢幕規格

### 1. 主畫面（SCR001）
- 查詢條件輸入區：
  - 公司代號（DBGN1）
  - 折讓日期（DBGN2）- 預設為12/31/29
  - 折讓單號（DBGN3）
- 子檔清單（SFLSR）：顯示符合條件的折讓資料
  - 顯示欄位：公司代號、折讓單號、折讓日期、發票號碼、折讓類別、金額、稅額等
- 功能選項：輸入選項（1=新增、2=修改、4=刪除、5=查詢）

### 2. 明細畫面（SCR002）
- 輸入/顯示區：
  - 公司代號（DAF01）- 顯示公司名稱（D#B03）
  - 折讓單號（DAF02）
  - 部門代號（DAF03）、業務代號（DAF04）- 顯示業務名稱（ME04）
  - 折讓日期（DAF05）
  - 發票號碼（DAF06）
  - 金額（DAF07）- 不含稅
  - 稅額（DAF09）
  - 總額（DAF10）- 含稅
  - 折讓類別（DAF08）- 顯示類別說明（D#A031）
  - 發票未收金額（DSI30）
  - 發票未稅餘額（DSI24）
- 功能鍵：F3=離開、F4=代碼表查詢、F5=重新整理、F12=返回

### 3. 功能鍵
- F3：離開
- F4：代碼表查詢（業務代號、折讓類別、發票號碼）
- F5：重新整理
- F6：新增
- F12：取消/返回
- ENTER：執行/確認
- ROLL UP：下一頁

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數、設定權限
2. 初始化畫面（RTN191）：初始化分頁顯示子檔
3. 讀取符合條件資料（RTN192/RTN193）：讀取符合條件的折讓資料
4. 畫面顯示（RTN195）：顯示主畫面與子檔資料
5. 功能處理：
   - F6（RTN120）：新增資料
   - ENTER（RTN170）：處理選項與更新
   - 選項處理（RTN171/RTN180）：檢查選項並執行對應功能
6. 資料操作：
   - 新增（RTN210）：新增折讓資料
   - 修改（RTN220）：修改折讓資料
   - 刪除（RTN230）：刪除折讓資料
   - 查詢（RTN240）：查詢折讓詳細資訊
7. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境、變數與權限，設定初始查詢條件
- RTN100：檢查公司代號與顯示公司名稱
- RTN111：檢查業務代號與顯示業務名稱
- RTN120：F6新增功能處理
- RTN170：ENTER鍵處理與查詢條件變更處理
- RTN171：讀取子檔選項並處理
- RTN180：檢查選項與權限
- RTN191：初始化子檔顯示設定，設置查詢條件
- RTN192/RTN193：讀取下一頁資料處理，日期格式轉換
- RTN195：顯示主畫面與子檔
- RTN200：子畫面處理主控
- RTN210：新增折讓處理
- RTN220：修改折讓處理
- RTN230：刪除折讓處理
- RTN240：查詢折讓詳細資訊
- RTN251：清除畫面欄位
- RTN252：檔案資料移至畫面
  - 公司資訊查詢與顯示
  - 業務資訊查詢與顯示
  - 折讓類別說明查詢與顯示
  - 發票資訊查詢與顯示
- RTN253：畫面資料移至檔案
  - 日期格式轉換
  - 單號產生（新增時）
  - 稅額計算
- RTN270：F5處理（重新整理）
- RTN280：檢查畫面欄位資料
  - 檢查公司代號有效性
  - 檢查業務代號與部門代號關聯性
  - 檢查日期有效性
  - 檢查發票號碼有效性
  - 檢查發票是否已確認或已收款
  - 檢查發票業務部門是否與輸入的業務部門相符
  - 檢查折讓類別有效性
  - 檢查金額有效性
  - 檢查金額是否超過發票未收金額
  - 檢查折讓單號異動情況（修改時）
  - 檢查發票折讓未稅餘額是否足夠
  - 檢查發票折讓特殊類別（77）處理
- RTN29F：更新相關檔案
  - 更新沖銷檔金額統計
  - 更新發票主檔折讓金額累計
  - 更新部門檔金額統計
- RTN990：權限檢查
- RTNF4：F4說明處理（代碼表查詢）
- ERRSR：錯誤處理

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 檔案存取錯誤：呼叫 ERRSR 子程序，顯示錯誤訊息
- 權限檢查錯誤：呼叫 RTN990 子程序，檢查使用者權限
- 資料確認：刪除資料前，使用 WDS000 程式進行使用者確認
- Y2K日期處理：特殊處理以確保世紀轉換正確性
- 資料驗證：由 RTN280 子程序進行各項資料檢查
- 稅務處理：M004新增稅率處理，自動計算稅額

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN30  | 新增模式 |
| *IN31  | 修改模式 |
| *IN40  | 記錄未找到 |
| *IN44  | 發票折讓特殊讀取旗標 |
| *IN46  | 記錄讀取結束 |
| *IN50  | 子檔顯示控制 |
| *IN51  | 子檔控制顯示 |
| *IN52  | 子檔初始化 |
| *IN53  | 子檔讀取結束 |
| *IN54  | 子檔讀取模式 |
| *IN60  | 一般錯誤訊息 |
| *IN61  | 業務代號錯誤 |
| *IN62  | 業務部門錯誤 |
| *IN64  | 日期錯誤 |
| *IN65  | 發票號碼錯誤 |
| *IN66  | 金額錯誤 |
| *IN67  | 稅額錯誤 |
| *IN68  | 折讓總額錯誤 |
| *IN75  | 折讓類別變更錯誤（特殊類別77） |
| *IN76  | 未稅餘額不足 |
| *IN77  | 稅額計算錯誤 |
| *IN78  | 稅額為零，非免稅發票錯誤 |
| *IN79  | 超過發票未收金額 |
| *IN80  | 發票明細未確認 |
| *IN81  | 發票明細不存在 |
| *IN82  | 發票已確認 |
| *IN83  | 折讓金額超過未收金額 |
| *IN85  | 折讓日期不可修改 |
| *IN86  | 未稅餘額不足 |
| *IN87  | 業務部門不符合 |
| *IN88  | 印花稅異動 |
| *IN89  | 公司代號錯誤或不存在 |
| *IN90  | 日期格式錯誤 |
| *IN93  | 必填欄位未輸入 |
| *IN94  | 無資料訊息 |
| *IN95  | 執行完成訊息 |
| *IN96  | 無權限執行此功能 |
| *IN97  | 確認訊息提示 |
| *IN98  | 已到最後一頁 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. 折讓類別處理邏輯
- 一般折讓：正常處理折讓金額與發票未收金額
- **77 (發票折讓特殊類別)**：
  - M005後新增，允許折讓項目可作為純折讓金額處理
  - 不會影響發票未收金額
  - 僅用於特殊折讓處理

### 2. 稅額處理邏輯
- M004增加稅額計算功能
- 發票屬性為'D'(含稅)時：
  - 計算公式：總額除以(1+稅率)得到未稅金額
  - 稅額 = 總額 - 未稅金額
- 發票屬性非'D'時：
  - 未稅金額為輸入金額
  - 稅額 = 未稅金額 × 稅率
  - 總額 = 未稅金額 + 稅額

### 3. 金額處理邏輯
- 新增時：檢查折讓金額不能超過發票未收金額
- 修改時：系統計算折讓金額差額，更新相關檔案
- 刪除時：恢復相關檔案中的金額統計
- 特殊類別77：允許不檢查發票未收金額限制

### 4. 相關共用函式
- RES001：日期格式轉換處理
- RES012：折讓單號產生處理
- P09：日期格式檢查處理
- P50：錯誤訊息處理
- WDS000：確認對話框處理
- WDS003：業務代號查詢處理
- WDS012：折讓類別查詢處理
- WDS023：發票號碼查詢處理
- S#S01：系統權限檢查

本規格書依據 ARA007.txt 製作，完整記錄 ARA007 程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
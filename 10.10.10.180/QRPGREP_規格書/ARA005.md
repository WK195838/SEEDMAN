# 應收帳款系統—遲延款處理程式規格書（ARA005）

## 一、基本資訊
- **程式名稱**：ARA005
- **作者**：A1087 JOYCE
- **建立日期**：81/03/23
- **修改日期**：無
- **系統**：應收帳款系統
- **子系統**：應收帳款作業
- **功能說明**：遲延款處理
- **修改記錄**：
  - M001 (98.11.10) MANUAL MODIFY BY MICHELLE FOR Y2K
  - M002 (98.11.25) 123199 = 123129
  - M003 (99.12.22) 修正支票號碼更換情況，同步更新CKHAPF
  - M004 (2022/07/24) DEREK新增遲延款類別35（託管款），與收款類別20併用

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **ARACPF**：遲延款主檔（DISK，更新用）
- **ARADPF**：遲延款明細檔（DISK，更新用）
- **CKHALF96**：支票檔（DISK，更新用）
- **MTMDPF**：部門檔（DISK，更新用）
- **ARACLF2**：遲延款邏輯檔（DISK，查詢用）
- **CKHDLF01**：支票邏輯檔（DISK，查詢用）
- **MTMCPF**：貨幣檔（DISK，查詢用）
- **PA#BPF**：公司資訊檔（DISK，查詢用）
- **PA#APF**：參數主檔（DISK，查詢用）
- **MTMEPF**：地址檔（DISK，查詢用）
- **PT#XPF**：系統共用檔（DISK，查詢用）
- **ARA005D**：顯示檔（WORKSTN，支援SFL）

### 2. 檔案關聯圖
```
   [ARACLF2]◄───────────┐
       │                    │
       ▼                    │
   [ARACPF]◄───────────────┼─────┐
       │                    │     │
       │                    │     │
       ▼                    │     │
   [ARADPF]◄───────────────┼─────┼───┐
       │                    │     │   │
       ▼                    │     │   │
   [CKHDLF01]───┐          │     │   │
       │        │          │     │   │
       ▼        ▼          │     │   │
   [CKHALF96]   │          │     │   │
       │        │          │     │   │
       │        │          │     │   │
   [MTMDPF]     │          │     │   │
       │        │          │     │   │
       │        │          │     │   │
   [MTMCPF]     │          │     │   │
       │        │          │     │   │
       ▼        ▼          ▼     ▼   ▼
      [ARA005]─────────────►[ARA005D]
       ▲
       │
   [PA#BPF]
       │
   [PA#APF]
       │
   [MTMEPF]
       │
   [PT#XPF]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. ARACPF（遲延款主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AC01     | 2    | 字串 | 公司代號 | 必填、須存在公司主檔 |
| AC02     | 5    | 字串 | 部門代號 | 必填、須存在部門主檔 |
| AC03     | 4    | 字串 | 業務代號 | 必填、須與部門代號匹配 |
| AC04     | 8    | 日期 | 遲延款日期 | 必填、有效日期 |
| AC05     | 2    | 字串 | 遲延款類別 | 必填、有效類別(10/20/30/35) |
| AC06     | 14   | 字串 | 支票號碼/其他號碼 | 條件必填 |
| AC07     | 8    | 日期 | 預計收款日期 | 遲延款類別為10時必填 |
| AC08     | -    | 數值 | 金額 | 必填、須為正數 |
| AC09     | 6    | 字串 | 幣別代號 | 必填、須存在幣別主檔 |
| AC10     | -    | 數值 | 剩餘金額 | 系統計算，初始等於AC08 |
| AC11     | 8    | 日期 | 清除日期 | - |
| AC12     | 14   | 字串 | 帳款編號 | 視AC05類別決定必填與否 |
| AC13     | 1    | 字元 | 確認旗標 | 'V'=已確認 |
| AC14     | 2    | 字串 | 支票旗標 | 'CK'=支票類型 |
| ACXX     | -    | 日期 | 更新日期 | 系統自動產生 |
| ACYY     | -    | 時間 | 更新時間 | 系統自動產生 |
| ACZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 2. ARADPF（遲延款明細檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AD01     | 2    | 字串 | 公司代號 | 必填、須存在公司主檔 |
| AD02     | 5    | 字串 | 部門代號 | 必填、須存在部門主檔 |
| AD03     | 4    | 字串 | 業務代號 | 必填、須與部門代號匹配 |
| AD04     | 8    | 日期 | 遲延款日期 | 必填、有效日期 |
| AD05     | 2    | 字串 | 遲延款類別 | 必填、有效類別 |
| AD06     | 14   | 字串 | 支票號碼/其他號碼 | 條件必填 |
| AD12     | 8    | 日期 | 資料日期 | - |

### 3. CKHALF96（支票檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| HA01     | -    | 字串 | 公司代號 | - |
| HA02     | 2    | 字串 | 支票類型 | - |
| HA04     | -    | 日期 | 支票日期 | - |
| HA06     | -    | 字串 | 銀行帳號 | - |
| HA11     | -    | 日期 | 預計兌現日期 | - |
| HA13     | -    | 字串 | 幣別代號 | - |
| HA16     | -    | 字串 | 帳款編號 | - |
| HA55     | -    | 數值 | 支票金額 | - |

### 4. MTMDPF（部門檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| MD01     | -    | 字串 | 部門代號 | - |
| MD29     | -    | 數值 | 一般遲延款統計金額 | - |
| MD31     | -    | 數值 | 累計遲延款總額 | - |
| MD32     | -    | 數值 | 累計支票金額 | - |

### 5. 系統變數與設定
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| $ADD     | 1    | 字元 | 新增權限 | Y/N |
| $UPD     | 1    | 字元 | 修改權限 | Y/N |
| $DLT     | 1    | 字元 | 刪除權限 | Y/N |
| $INQ     | 1    | 字元 | 查詢權限 | Y/N |
| $RMK01   | 1    | 字元 | 子程式1權限 | Y/N |
| $RMK02   | 1    | 字元 | 子程式2權限 | Y/N |
| $EG8     | 8    | 整數 | Y2K系統日期 | - |
| WFUN     | 7    | 字串 | 功能代碼表 | - |
| WA01     | 7    | 字串 | 權限陣列 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（SCR001）
- 查詢條件輸入區：
  - 公司代號（DBGN1）
  - 遲延款日期（DBGN2）- 預設為12/31/29
  - 部門代號（DBGN3）
  - 業務代號（DBGN4）
- 子檔清單（SFLSR）：顯示符合條件的遲延款資料
  - 顯示欄位：公司代號、部門代號、業務代號、遲延款日期、類別、支票號碼等
- 功能選項：輸入選項（1=新增、2=修改、4=刪除、5=查詢、6=子程式1、7=子程式2）

### 2. 明細畫面（SCR002）
- 輸入/顯示區：
  - 公司代號（DAC01）- 顯示公司名稱（#B03）
  - 部門代號（DAC02）、業務代號（DAC03）- 顯示業務名稱（ME04）
  - 遲延款日期（DAC04）
  - 遲延款類別（DAC05）- 顯示類別說明（#A03）
  - 支票號碼/其他號碼（DAC06）
  - 預計收款日期（DAC07）
  - 金額（DAC08）
  - 幣別（DAC09）- 顯示幣別名稱（MC02）
  - 清除日期（DAC11）
  - 帳款編號（DAC12）
- 功能鍵：F3=離開、F4=代碼表查詢、F5=重新整理、F12=返回

### 3. 功能鍵
- F3：離開
- F4：代碼表查詢（部門代號、業務代號、遲延款類別、支票號碼、幣別、帳款編號）
- F5：重新整理
- F6：新增
- F12：取消/返回
- ENTER：執行/確認
- ROLL UP：下一頁

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數、設定權限
2. 初始化畫面（RTN191）：初始化分頁顯示子檔
3. 讀取符合條件資料（RTN192/RTN193）：讀取符合條件的遲延款資料
4. 畫面顯示（RTN195）：顯示主畫面與子檔資料
5. 功能處理：
   - F6（RTN110）：新增資料
   - ENTER（RTN170）：處理選項與更新
   - 選項處理（RTN171/RTN180）：檢查選項並執行對應功能
6. 資料操作：
   - 新增（RTN210）：新增遲延款資料
   - 修改（RTN220）：修改遲延款資料
   - 刪除（RTN230）：刪除遲延款資料
   - 查詢（RTN240）：查詢遲延款詳細資訊
   - 子程式1（RTN250）：呼叫ARA0051
   - 子程式2（RTN260）：呼叫ARA0052
7. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境、變數與權限，設定初始查詢條件
- RTN110：F6新增功能處理
- RTN170：ENTER鍵處理與查詢條件變更處理
- RTN171：讀取子檔選項並處理
- RTN180：檢查選項與權限
- RTN191：初始化子檔顯示設定，設置查詢條件
- RTN192/RTN193：讀取下一頁資料處理，日期格式轉換
- RTN195：顯示主畫面與子檔
- RTN200：子畫面處理主控
- RTN210：新增遲延款處理
- RTN220：修改遲延款處理
- RTN230：刪除遲延款處理
- RTN240：查詢遲延款詳細資訊
- RTN250：呼叫ARA0051子程式（特殊處理）
- RTN260：呼叫ARA0052子程式（特殊處理）
- RTN251：清除畫面欄位
- RTN252：檔案資料移至畫面
- RTN253：畫面資料移至檔案
  - 日期格式轉換
  - 支票類型處理
  - 剩餘金額計算
- RTN270：F5處理（重新整理）
- RTN280：檢查畫面欄位資料
  - 檢查公司代號有效性
  - 檢查業務代號與部門代號關聯性
  - 檢查日期有效性
  - 檢查遲延款類別有效性
  - 檢查支票號碼有效性（類別10時）
  - 檢查金額有效性
  - 檢查幣別有效性
  - 檢查帳款編號有效性（類別20、30、35時）
- RTN29F：更新相關檔案
  - 更新部門檔金額統計
  - 更新遲延款明細檔
  - 更新支票檔金額
- RTN990：權限檢查
- RTNF4：F4說明處理（代碼表查詢）
- ERRSR：錯誤處理

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 檔案存取錯誤：呼叫 ERRSR 子程序，顯示錯誤訊息
- 權限檢查錯誤：呼叫 RTN990 子程序，檢查使用者權限
- 資料確認：刪除資料前，使用 WDS000 程式進行使用者確認
- Y2K日期處理：特殊處理以確保世紀轉換正確性
- 資料驗證：由 RTN280 子程序進行各項資料檢查

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN60  | 一般錯誤訊息 |
| *IN61  | 業務代號錯誤 |
| *IN62  | 日期錯誤 |
| *IN63  | 遲延款類別錯誤 |
| *IN64  | 支票號碼錯誤 |
| *IN65  | 預計收款日期錯誤 |
| *IN66  | 金額錯誤 |
| *IN67  | 剩餘金額不足 |
| *IN68  | 幣別錯誤 |
| *IN69  | 帳款編號錯誤 |
| *IN83  | 支票類型不符合 |
| *IN84  | 記錄已確認 |
| *IN85  | 收款類別不可修改 |
| *IN87  | 金額與剩餘金額不符 |
| *IN88  | 清除日期不為空白 |
| *IN89  | 公司代號錯誤或不存在 |
| *IN90  | 日期格式錯誤 |
| *IN91  | 資料已存在 |
| *IN92  | 支票帳號格式錯誤 |
| *IN93  | 必填欄位未輸入 |
| *IN94  | 無資料訊息 |
| *IN96  | 無權限執行此功能 |
| *IN97  | 確認訊息提示 |
| *IN98  | 已到最後一頁 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. 遲延款類別處理邏輯
- **10 (支票)**：
  - 需輸入支票號碼(DAC06)與預計收款日期(DAC07)
  - 更新支票檔(CKHALF96)金額統計
  - 更新部門檔(MTMDPF)支票金額統計(MD32)
- **20 (託收款)**：
  - 需輸入帳款編號(DAC12)
  - 更新部門檔一般遲延款統計(MD29)
- **30 (其他遲延款)**：
  - 需輸入帳款編號(DAC12)
  - 更新部門檔一般遲延款統計(MD29)
- **35 (託管款)**：
  - 需輸入帳款編號(DAC12)
  - 更新部門檔一般遲延款統計(MD29)
  - 與收款類別20併用

### 2. 金額處理邏輯
- 新增時：設定剩餘金額(AC10)等於總金額(AC08)
- 修改時：更新相關檔案中的金額統計
- 刪除時：恢復相關檔案中的金額統計

### 3. 關聯子程式
- ARA0051：特殊處理子程式1
- ARA0052：特殊處理子程式2
- WDS000：確認對話框處理
- RES001：日期格式轉換處理
- P09：日期格式檢查處理
- P31：日期計算處理
- P50：錯誤訊息處理
- CKI999：支票號碼查詢處理
- CKI1D0：帳款編號查詢處理

本規格書依據 ARA005.txt 製作，完整記錄 ARA005 程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
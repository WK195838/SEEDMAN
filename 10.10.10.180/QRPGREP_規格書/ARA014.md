# 應收帳款系統—銷帳明細報表程式規格書（ARA014）

## 一、基本資訊
- **程式名稱**：ARA014
- **作者**：D910074 TINA
- **建立日期**：82/03/03
- **系統**：應收帳款系統
- **子系統**：應收帳款系統
- **功能說明**：銷帳明細報表作業
- **修改記錄**：
  - M001 (98.11.17) MANUAL MODIFY BY MICHELLE FOR Y2K
  - M002 (99.08.20) OLD SOURCE LOSE RE-MODIFY

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **ARACPF**：應收帳款公司檔（DISK，查詢用）
- **PA#BPF**：公司資訊檔（DISK，查詢用）
- **ARABLF01**：應收帳款銷帳邏輯檔（DISK，查詢用）
- **ARA014D**：顯示檔（WORKSTN）

### 2. 檔案關聯圖
```
  [ARACPF]──┐
            │
  [PA#BPF]──┼──►[ARA014]──►[ARA014D]
            │
  [ARABLF01]┘
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. ARACPF（應收帳款公司檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AC0      | -    | -    | 檔案鍵值 | - |

### 2. PA#BPF（公司資訊檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| #B0      | -    | -    | 公司主鍵 | - |

### 3. ARABLF01（應收帳款銷帳邏輯檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AB0      | -    | -    | 檔案鍵值 | - |
| AB01     | -    | 字串 | 公司代號 | - |
| AB011    | -    | 字串 | 公司代號 | - |
| AB02     | -    | 字串 | 銀行代號 | - |
| AB021    | -    | 字串 | 銀行代號 | - |

### 4. ARA014D（顯示檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| DAC01    | 2    | 字串 | 本公司代號 | 必填、須存在公司主檔 |
| DAD10S   | 2    | 字串 | 起始銷帳公司代號 | 必填、須存在公司主檔 |
| DAD10E   | 2    | 字串 | 結束銷帳公司代號 | 必填、須存在公司主檔、不可小於起始代號 |
| DAC02    | 5    | 字串 | 單別代號 | 預設值為'A0002' |
| DAC08    | -    | 數值 | 金額條件 | 必填 |
| DAC04    | 6    | 日期 | 帳款日期 | 必須為有效日期 |
| WAC04    | 8    | 日期 | 工作帳款日期 | Y2K格式日期 |
| DAC12    | 14   | 字串 | 銀行代號 | 必填 |
| DAC121   | 6    | 字串 | 銀行代號 | 必填 |
| AA       | 1    | 字元 | 本公司代號首字元 | - |
| BB       | 1    | 字元 | 起始公司代號首字元 | - |
| CC       | 1    | 字元 | 結束公司代號首字元 | - |

### 5. 系統變數與參數
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| DATE     | 8    | 日期 | Y2K系統日期 | - |
| LDA      | -    | 區域 | 本地資料區 | - |
| APPSCR   | 6    | 字串 | 應用程式螢幕 | - |
| D#ROW    | -    | 整數 | 游標列位置 | - |
| D#COL    | -    | 整數 | 游標行位置 | - |
| KEYAC    | -    | 組合鍵 | ARACPF查詢鍵 | - |
| KEYAB    | -    | 組合鍵 | ARABLF01查詢鍵 | - |
| FAC03    | 4    | 字串 | 組合鍵欄位值 | - |
| FAC05    | 2    | 字串 | 組合鍵欄位值 | - |
| FAC06    | 14   | 字串 | 組合鍵欄位值 | - |
| W6       | 6    | 日期 | 暫存日期 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（DSPD1/SCR001）
- 報表條件設定區：
  - 本公司代號（DAC01）
  - 銷帳公司代號區間：
    - 起始銷帳公司代號（DAD10S）
    - 結束銷帳公司代號（DAD10E）
  - 單別代號（DAC02）- 預設為'A0002'
  - 金額條件（DAC08）
  - 帳款日期（DAC04）- 預設為系統日期
  - 銀行代號（DAC12/DAC121）- 使用F4查詢功能可選擇

### 2. 功能鍵
- F3：離開
- F4：代碼表查詢（銀行代號）
- F14：執行報表
- ENTER：確認執行

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數
2. 畫面顯示（EXFMT DSPD1）：顯示主畫面進行條件設定
3. 功能處理：
   - F3：離開系統
   - F4：銀行代號查詢（RTNF4）
   - F14：執行報表
   - ENTER：確認執行，進行欄位檢查（RTN100）
4. 輸出LDA（OUTLDA）：將處理結果寫入本地資料區
5. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境與變數
  - 初始化畫面欄位（DAC01、DAD10S、DAD10E、DAC02、DAC12、DAC04、DAC08）
  - 設定預設值（DAC02='A0002'、DAC04=$EGMDY）
  - 設定應用程式螢幕（APPSCR='SCR001'）
  - 設定組合鍵欄位值（FAC03、FAC05='20'、FAC06）
  
- RTN100：檢查畫面欄位
  - 檢查本公司代號（DAC01）是否為空值及是否存在公司主檔
  - 檢查起始銷帳公司代號（DAD10S）是否為空值及是否存在公司主檔
  - 檢查結束銷帳公司代號（DAD10E）是否為空值及是否存在公司主檔
  - 檢查起始代號是否小於等於結束代號
  - 檢查公司代號首字元是否一致
  - 檢查金額條件（DAC08）是否為空值
  - 檢查帳款日期（DAC04）是否有效，使用P09程式驗證
  - 處理Y2K日期格式轉換，使用RES001程式和HB@68L子程序
  - 檢查銀行代號（DAC121）是否為空值
  - 檢查邏輯檔（ARABLF01）中是否存在對應的銀行代碼記錄
  - 檢查公司檔（ARACPF）中是否存在相符的組合鍵記錄
  
- RTNF4：F4代碼表查詢處理
  - 根據游標位置判斷查詢項目
  - 銀行代號：呼叫WDS0141程式查詢
  
- OUTLDA：輸出LDA處理
  - 將處理結果寫入本地資料區

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 欄位檢查錯誤：設置對應的錯誤指示器，在下次畫面顯示時提示用戶
- 公司代號檢查：檢查公司代號是否存在於公司主檔中
- 日期格式檢查：使用P09程式驗證日期格式
- Y2K日期處理：使用RES001程式和HB@68L子程序處理世紀轉換
- 資料存在檢查：使用CHAIN操作檢查記錄是否存在

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN03  | F3離開功能鍵 |
| *IN04  | F4說明功能鍵 |
| *IN10  | 初始化旗標 |
| *IN14  | F14執行報表功能鍵 |
| *IN40  | 記錄查詢旗標 |
| *IN60  | 一般錯誤訊息 |
| *IN61  | 公司代號區間錯誤 |
| *IN62  | 系統起始公司代號錯誤 |
| *IN63  | 金額條件為空錯誤 |
| *IN64  | 帳款日期錯誤 |
| *IN65  | 銀行代號為空錯誤 |
| *IN84  | 公司不存在訊息 |
| *IN85  | 公司代號首字元不一致 |
| *IN92  | 公司代號前後順序錯誤 |
| *IN93  | 日期格式無效 |
| *IN94  | 記錄檢查存在訊息 |
| *IN95  | 公司代號為空訊息 |
| *IN98  | 已傳入參數旗標 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. 組合鍵處理
- KEYAC（ARACPF查詢鍵）：
  - 包含DAC01（本公司代號）、DAC02（單別代號）、FAC03、WAC04（Y2K帳款日期）、FAC05、FAC06
  - 用於檢查ARACPF是否存在指定的記錄
  
- KEYAB（ARABLF01查詢鍵）：
  - 包含AB011（本公司代號）、AB021（銀行代號）
  - 用於檢查銀行代號是否有效

### 2. 日期處理
- 使用P09程式檢查日期格式是否有效
- 使用RES001程式將MDY格式日期轉換為畫面顯示格式
- 使用HB@68L子程序進行6位元到8位元的日期格式轉換（Y2K）

### 3. 銀行代號處理
- 提供F4功能鍵調用WDS0141程式查詢銀行代號
- 檢查銀行代號是否存在於邏輯檔（ARABLF01）中
- 如果存在，自動從邏輯檔取得銀行全名（AB02）填入DAC12

### 4. 公司代號一致性檢查
- 檢查本公司代號、起始銷帳公司代號和結束銷帳公司代號首字元是否一致
- 檢查以確保銷帳操作在相同系統內進行

本規格書依據ARA014.txt製作，完整記錄ARA014程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
# 應收帳款系統—應收帳款客戶對帳單程式規格書（ARA013）

## 一、基本資訊
- **程式名稱**：ARA013
- **系統**：應收帳款系統
- **子系統**：應收帳款作業
- **功能說明**：應收帳款客戶對帳單產生作業
- **修改記錄**：
  - B2MOD：Y2K相關修改

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **ARAKLF01**：應收帳款客戶邏輯檔（DISK，查詢用）
- **ARA013D**：顯示檔（WORKSTN）

### 2. 檔案關聯圖
```
  [ARAKLF01]──►[ARA013]──►[ARA013D]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. ARAKLF01（應收帳款客戶邏輯檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| AK0      | -    | -    | 檔案鍵值 | - |
| AK01     | 6    | 字串 | 年月代碼 | - |
| AK01Y    | 4    | 字串 | 年份代碼 | - |
| AK01M    | 2    | 字串 | 月份代碼 | - |

### 2. ARA013D（顯示檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| DATE     | 6    | 日期 | 報表日期 | - |
| DATEY    | 4    | 字串 | 報表年份 | - |
| DATEM    | 2    | 字串 | 報表月份 | 1-12 |
| DAK01    | 4    | 字串 | 年月代碼 | - |
| DAK01M   | 2    | 字串 | 月份 | 1-12 |
| DAK01Y   | 2    | 字串 | 年份 | - |
| DAK02    | 1    | 字元 | 客戶類別 | 不可為空 |

### 3. 系統變數與參數
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | - |
| LDA      | -    | 區域 | 本地資料區 | - |
| KEYAK    | -    | 組合鍵 | 檔案查詢鍵 | - |
| IN03     | 1    | 旗標 | F3功能鍵狀態 | - |
| IN14     | 1    | 旗標 | F14功能鍵狀態 | - |
| IN96     | 1    | 旗標 | 控制旗標 | - |
| IN97     | 1    | 旗標 | 控制旗標 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（DSPD1）
- 報表條件設定區：
  - 客戶類別（DAK02）
  - 年月代碼（DAK01）- 包含年份（DAK01Y）和月份（DAK01M）

### 2. 功能鍵
- F3：離開
- F14：執行報表
- ENTER：確認執行

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境、初始化變數
2. 畫面顯示（EXFMT DSPD1）：顯示主畫面進行條件設定
3. 功能處理：
   - F3：離開系統
   - F14：執行報表
   - ENTER：確認執行，進行欄位檢查（RTN100）
4. 輸出LDA（OUTLDA）：將處理結果寫入本地資料區
5. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境與變數
  - 初始化畫面欄位（DAK02、DATE、DAK01）
  - 設置畫面狀態指示器
  
- RTN100：檢查畫面欄位
  - 檢查客戶類別（DAK02）是否為空
  - 檢查年月代碼（DAK01）是否有效
  - 如果年月代碼為空，讀取最近的記錄並自動增加月份
  - 檢查月份（DAK01M）是否在1-12範圍內
  - 處理Y2K日期格式轉換：使用HB@24Y子程序
  - 檢查記錄是否存在於ARAKLF01檔案中
  
- OUTLDA：輸出LDA處理
  - 將處理結果寫入本地資料區

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 欄位檢查錯誤：設置對應的錯誤指示器，在下次畫面顯示時提示用戶
- Y2K日期處理：使用HB@24Y子程序處理世紀轉換
- 資料存在檢查：使用SETLL操作檢查記錄是否存在

### 2. 訊息清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN03  | F3離開功能鍵 |
| *IN10  | 初始化旗標 |
| *IN14  | F14執行報表功能鍵 |
| *IN40  | 記錄檢查旗標 |
| *IN45  | 記錄讀取結束 |
| *IN60  | 一般錯誤訊息 |
| *IN61  | 查詢錯誤 |
| *IN86  | 報表執行旗標 |
| *IN95  | 客戶類別空白錯誤 |
| *IN96  | 參數傳入旗標 |
| *IN97  | 參數傳入旗標 |
| *IN98  | 月份錯誤訊息 |
| *IN99  | 系統錯誤 |

## 七、特殊處理邏輯

### 1. 年月處理
- 自動獲取下一報表月份：
  - 如果年月代碼為空，讀取最近的記錄
  - 自動增加月份值（AK01M + 1）
  - 如果月份大於12，將月份設為1並增加年份
  
- Y2K日期處理：
  - DAK01Y日期欄位使用HB@24Y子程序進行2位數到4位數年份的轉換
  - 轉換後的4位數年份格式存入DATEY欄位

### 2. 檔案查詢與記錄檢查
- 使用組合查詢鍵（KEYAK）檢查記錄是否存在
- KEYAK包含客戶類別（DAK02）和日期（DATE）
- 使用SETLL操作進行記錄存在檢查

### 3. 執行流程控制
- 使用多個控制旗標控制程式執行流程
- *IN10：初始化完成旗標
- *IN96、*IN97：參數已傳入旗標
- *IN86：報表執行控制旗標

本規格書依據ARA013.txt製作，完整記錄ARA013程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
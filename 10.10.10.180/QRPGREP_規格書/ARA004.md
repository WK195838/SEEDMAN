# 應收帳款系統—發票作廢作業程式規格書（ARA004）

## 一、基本資訊
- **程式名稱**：ARA004
- **作者**：A1118 PHILIP
- **建立日期**：81/03/20
- **修改日期**：81/05/21（修改原因：修正重複進行確認時發生錯誤問題）
- **系統**：應收帳款系統
- **子系統**：應收帳款作業子系統
- **功能說明**：發票作廢作業處理（新增/修改/刪除/查詢）
- **修改記錄**：
  - M001 (98.11.09) MANUAL MODIFY BY MICHELLE FOR Y2K
  - M002 (98.11.25) 123199 = 123129

## 二、檔案架構與關聯圖

### 1. 主要檔案
- **SOSILF1**：發票主檔邏輯檔（DISK，查詢用）
- **SOSIPF**：發票主檔（DISK，更新用）
- **SOSCPF**：客戶主檔（DISK，更新用）
- **SOSEPF**：發票明細檔（DISK，更新用）
- **MTMEPF**：地址資料檔（DISK，查詢用）
- **MTMDPF**：部門資料檔（DISK，查詢用）
- **PA#BPF**：公司資料檔（DISK，查詢用）
- **ARA004D**：顯示檔（WORKSTN，支援SFL）

### 2. 檔案關聯圖
```
  [SOSILF1]◄───(查詢)────┐
       │                   │
       │                   │
       ▼                   │
  [SOSIPF]◄───(更新)───┐  │
       │                │  │
       │                │  │
       ▼                │  │
  [SOSCPF]◄─────────┐  │  │
       │             │  │  │
       │             │  │  │
       ▼             │  │  │
  [SOSEPF]◄────┐    │  │  │
       ▲        │    │  │  │
       │        │    │  │  │
       │        │    │  │  │
  [MTMEPF]      │    │  │  │
       │        │    │  │  │
       │        │    │  │  │
  [MTMDPF]      │    │  │  │
       │        │    │  │  │
       │        │    │  │  │
  [PA#BPF]      │    │  │  │
       │        │    │  │  │
       ▼        ▼    ▼  ▼
      [ARA004]───────▶[ARA004D]
```

## 三、檔案欄位名稱、長度屬性與檢核規則

### 1. SOSIPF（發票主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SI01     | -    | 字串 | 發票編號 | 必填、唯一鍵 |
| SI02     | -    | 字串 | 發票序號 | 必填、唯一鍵 |
| SI21     | 8    | 整數 | 發票日期 | 必填、有效日期 |
| SI11     | 12   | 字串 | 客戶編號 | 必填 |
| SI08     | -    | 字串 | 部門代號 | 必填 |
| SI09     | -    | 字串 | 業務代號 | 必填 |
| SI10     | -    | 字串 | 客戶訂單編號 | - |
| SI12     | -    | 字串 | 寄件地址類型1 | - |
| SI13     | -    | 字串 | 寄件地址代號1 | - |
| SI14     | -    | 字串 | 寄件地址類型2 | - |
| SI15     | -    | 字串 | 寄件地址代號2 | - |
| SI18     | -    | 字元 | 作廢標記 | 'D'=作廢 |
| SI19     | -    | 字元 | 確認標記 | 'V'=已確認 |
| SIXX     | -    | 整數 | 更新日期 | 系統自動產生 |
| SIYY     | -    | 整數 | 更新時間 | 系統自動產生 |
| SIZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 2. SOSEPF（發票明細檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SE11     | -    | 字串 | 客戶編號 | 必填 |
| SE24     | -    | 整數 | 發票金額 | 必填 |
| SE08     | -    | 整數 | 已收款金額 | - |
| SE31     | -    | 字元 | 作廢標記 | 'D'=作廢, '*'=特殊作廢 |
| SEXX     | -    | 整數 | 更新日期 | 系統自動產生 |
| SEYY     | -    | 整數 | 更新時間 | 系統自動產生 |
| SEZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 3. SOSCPF（客戶主檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| SC03     | -    | 字串 | 客戶類型 | 'S2', 'S3' |
| SC06     | -    | 字串 | 客戶名稱 | - |
| SC13     | -    | 字元 | 作廢標記 | 'D'=作廢 |
| SCXX     | -    | 整數 | 更新日期 | 系統自動產生 |
| SCYY     | -    | 整數 | 更新時間 | 系統自動產生 |
| SCZZ     | -    | 字串 | 更新人員 | 系統自動產生 |

### 4. MTMEPF（地址資料檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| ME01     | -    | 字串 | 地址類型 | - |
| ME02     | -    | 字串 | 地址代號 | - |
| ME03     | -    | 字串 | 地址第一行 | - |
| ME04     | -    | 字串 | 地址類型說明 | - |
| ME05     | -    | 字串 | 地址第二行 | - |
| ME06     | -    | 字串 | 地址第三行 | - |

### 5. MTMDPF（部門資料檔）
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| MD17     | -    | 字串 | 部門名稱 | - |

### 6. 系統變數與設定
| 欄位名稱 | 長度 | 屬性 | 說明 | 檢核規則 |
|----------|------|------|------|----------|
| $USER    | 10   | 字串 | 使用者代碼 | - |
| $EGMDY   | 6    | 整數 | 系統日期 | 日期格式 |
| $ADD     | 1    | 字元 | 新增權限 | Y/N |
| $UPD     | 1    | 字元 | 修改權限 | Y/N |
| $DLT     | 1    | 字元 | 刪除權限 | Y/N |
| $INQ     | 1    | 字元 | 查詢權限 | Y/N |
| DATE     | 8    | 整數 | Y2K修正日期 | 系統日期 |
| WFUN     | 6    | 字串 | 功能代碼表 | - |
| WA01     | 6    | 字串 | 權限陣列 | - |

## 四、輸出入螢幕規格

### 1. 主畫面（SCR001）
- 查詢條件輸入區：
  - 發票編號（DBGN1）
  - 發票日期（DBGN2）- 預設為12/31/29
  - 發票序號（DBGN3）
- 子檔清單（SFLSR1）：顯示符合條件的發票資料
  - 顯示欄位：發票編號、發票日期、客戶名稱等
- 功能選項：輸入選項（4=刪除、5=查詢、6=明細查詢）

### 2. 明細畫面（SCR002）- 刪除/查詢用
- 資料顯示區：
  - 客戶編號、發票號碼、序號
  - 發票日期（DSI21C）、月份（DSIMM）
  - 部門/業務資訊
  - 公司名稱及相關資訊
  - 發票地址資訊（ME031, ME051, ME061等）
- 功能鍵：F3=離開、F12=返回

### 3. 明細查詢畫面（SCR003）
- 特殊明細查詢功能，顯示更多詳細的發票資訊
- 使用ARA0042子程式實現

### 4. 功能鍵
- F3：離開
- F6：新增/呼叫ARA0041子程式
- F12：取消/返回
- ENTER：執行/確認
- ROLL UP：下一頁

## 五、處理流程與子程序邏輯

### 1. 主流程
1. 初始化（RTN010）：設定環境變數、初始化查詢條件
2. 初始化畫面（RTN191）：初始化分頁顯示子檔
3. 讀取符合條件資料（RTN192/RTN193）：讀取符合條件的發票資料，顯示在子檔中
4. 畫面顯示（RTN195）：顯示主畫面與子檔資料
5. 功能處理：
   - F6（RTN120）：新增發票，呼叫ARA0041子程式
   - ENTER（RTN170）：處理選項與更新
   - 選項處理（RTN171/RTN180）：檢查選項並執行對應功能
6. 資料操作：
   - 刪除（RTN230）：處理發票作廢流程
   - 查詢（RTN240）：顯示發票詳細資訊
   - 明細查詢（RTN250）：顯示發票特殊明細，呼叫ARA0042子程式
7. 結束（LR）：釋放資源，結束程式

### 2. 子程序邏輯與運算規則
- RTN010：初始化環境、變數與權限，設定初始查詢條件
- RTN120：F6新增功能處理，呼叫ARA0041子程式
- RTN170：ENTER鍵處理與查詢條件變更處理
- RTN171：讀取子檔選項並處理
- RTN180：檢查選項與權限
- RTN191：初始化子檔顯示設定，設置查詢條件
- RTN192/RTN193：讀取下一頁資料處理，將資料填入子檔
- RTN195：顯示主畫面與子檔
- RTN200：子畫面處理主控
- RTN230：刪除（作廢）發票處理
  - 更新發票主檔作廢標記
  - 更新發票明細檔作廢標記
  - 若有必要，更新客戶資料作廢標記
- RTN240：查詢發票詳細資訊
- RTN250：特殊明細查詢，呼叫ARA0042子程式
- RTN251：清除畫面欄位
- RTN252：檔案資料移至畫面，包括：
  - 客戶資訊查詢
  - 日期轉換處理
  - 部門與業務資訊查詢
  - 地址資訊查詢
- RTN990：權限檢查
- ERRSR：錯誤處理

## 六、錯誤處理程序說明與訊息清冊

### 1. 錯誤處理程序
- 檔案存取錯誤：呼叫 ERRSR 子程序，顯示錯誤訊息
- 權限檢查錯誤：呼叫 RTN990 子程序，檢查使用者權限
- 資料確認：作廢發票前，使用 WDS000 程式進行使用者確認
- Y2K日期處理：特殊處理以確保世紀轉換正確性

### 2. 狀態指示器清冊
| 指示器 | 訊息說明 |
|--------|----------|
| *IN03  | F3離開功能鍵 |
| *IN06  | F6新增功能鍵 |
| *IN12  | F12返回功能鍵 |
| *IN25  | 向下查詢頁鍵 |
| *IN40  | 記錄不存在 |
| *IN46  | 記錄讀取結束 |
| *IN50  | 子檔顯示控制 |
| *IN51  | 子檔控制顯示 |
| *IN52  | 子檔初始化 |
| *IN53  | 子檔讀取結束 |
| *IN54  | 子檔讀取模式 |
| *IN60  | 一般錯誤訊息 |
| *IN80  | 作廢標記 |
| *IN94  | 無資料訊息 |
| *IN96  | 無權限訊息 |
| *IN97  | 檔案鎖定錯誤 |
| *IN98  | 已到最後一頁 |
| *IN99  | 系統錯誤訊息 |

## 七、其他備註
1. 日期處理：程式包含Y2K年份調整，將123199改為123129
2. 作廢處理流程：
   - 首先更新發票主檔的作廢標記(SI18='D')和確認標記(SI19='V')
   - 若發票已有收款金額(SE08!=0)，則將明細檔作廢標記設為'*'，否則設為'D'
   - 若為特定客戶類型(SC03='S2'或'S3')，則同時更新客戶主檔作廢標記(SC13='D')
3. 特殊查詢功能：
   - 選項5：基本查詢，顯示發票基本資訊
   - 選項6：呼叫ARA0042子程式，顯示發票的詳細明細資訊
4. 關聯子程式：
   - ARA0041：發票新增處理
   - ARA0042：發票明細特殊查詢
   - WDS000：確認對話框處理
   - RES001：日期格式轉換處理

本規格書依據 ARA004.0.txt 製作，完整記錄 ARA004 程式結構、檔案欄位、處理流程與錯誤處理。如需調整或有其他需求，歡迎隨時告知！ 
# GLA110 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA110
- **程式說明**：傳票登錄
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA110
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.16
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：提供傳票登錄及維護功能
- **聯絡電話**：7313250
- **修改紀錄**：
  - M001（2002.01.24）MICHELLE：訊息處理
  - 00A（2024.01.12）KEVIN：檢查大傳票日期小於傳票日期

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHPF：傳票主檔（輸出模式）
  - GLA7PF：傳票明細檔（輸出模式）
  - GLAPPF：輸入項目檔（輸入模式）
  - GLAQPF：交易項目檔（輸入模式）
  - GLAAPF：輸入欄位檔（輸入模式）
  - GLADPF：摘要檔（輸入模式）
  - GLAFPF：交易別檔（輸入模式）
  - GLAKPF：會計科目檔（輸入模式）
  - PT#BPF：部門檔（輸入模式）
  - PT#YPF：功能參數檔（輸入模式）
- **顯示檔案**
  - GLA110D：傳票登錄螢幕格式檔
  - SFLSR：資料子檔（傳票明細資料顯示用）
  - SFLSRC：資料子檔（貸方傳票明細顯示用）
  - SFLSRD：資料子檔（借方傳票明細顯示用）
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - P31：日期轉換程式

## 3. 檔案欄位規格說明

### GLAHPF（傳票主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH01 | 部門代號 | 字元 | 主索引鍵之一 |
| AH02 | 傳票號碼 | 字元 | 主索引鍵之二 |
| AH03 | 明細筆數 | 數值 | 記錄傳票明細總筆數 |
| AH04 | 會計科目 | 字元 | |
| AH05 | 摘要內容1 | 字元 | |
| AH05A | 摘要內容1說明 | 字元 | |
| AH06 | 摘要內容2 | 字元 | |
| AH06A | 摘要內容2說明 | 字元 | |
| AH07 | 摘要內容3 | 字元 | |
| AH07A | 摘要內容3說明 | 字元 | |
| AH08 | 摘要內容4 | 字元 | |
| AH08A | 摘要內容4說明 | 字元 | |
| AH09 | 金額 | 數值 | |
| AH09A | 金額說明 | 字元 | |
| AH10 | 傳票日期 | 數值 | |
| AH12 | 借方金額 | 數值 | |
| AH13 | 貸方金額 | 數值 | |
| AH14 | 數量 | 數值 | |
| AH14A | 數量說明 | 字元 | |
| AH15 | 其他 | 字元 | |
| AH15A | 其他說明 | 字元 | |
| AH16 | 備註 | 字元 | |
| AH17 | 系統代碼 | 字元 | 預設為'GL' |
| AH18 | 保留欄位 | 字元 | |
| AH19 | 主要處理旗標 | 字元 | 'V'表示主要處理 |
| AH20 | 保留欄位 | 字元 | |
| AH21 | 大傳票日期 | 數值 | |
| AH22 | 摘要代號 | 字元 | |
| AH23 | 保留欄位 | 數值 | |
| AH24 | 傳票明細號碼 | 字元 | |
| AH25 | 建檔日期 | 數值 | |
| AH26 | 建檔人員 | 字元 | |
| AH97 | 建檔時間 | 時間 | |
| AH98 | 建檔日期 | 數值 | |
| AH99 | 建檔人員 | 字元 | |

### GLA7PF（傳票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A701 | 部門代號 | 字元 | 主索引鍵之一 |
| A702 | 傳票號碼 | 字元 | 主索引鍵之二 |
| A703 | 明細序號 | 數值 | 主索引鍵之三 |
| A704 | 備註代碼 | 字元 | |
| A705 | 簽核人 | 字元 | |
| A706 | 金額 | 數值 | |
| A707 | 備註說明 | 字元 | |
| A797 | 建檔時間 | 時間 | |
| A798 | 建檔日期 | 數值 | |
| A799 | 建檔人員 | 字元 | |

### GLAFPF（交易別檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AF02 | 會計科目 | 字元 | 主索引鍵之一 |
| AF03 | 會計科目說明 | 字元 | |
| AF08 | 啟用狀態 | 字元 | '1'為啟用 |
| AF11 | 輸入項目1名稱 | 字元 | |
| AF12 | 輸入項目2名稱 | 字元 | |
| AF13 | 輸入項目3名稱 | 字元 | |
| AF14 | 輸入項目4名稱 | 字元 | |
| AF15 | 輸入項目5名稱 | 字元 | |
| AF16 | 輸入項目6名稱 | 字元 | |
| AF17 | 輸入項目7名稱 | 字元 | |
| AF18 | 處理旗標 | 字元 | |

### GLADPF（摘要檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AD01 | 部門代號 | 字元 | 主索引鍵之一 |
| AD02 | 摘要代號 | 字元 | 主索引鍵之二 |
| AD03 | 摘要說明 | 字元 | |

### GLAPPF（輸入項目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AP02 | 會計科目 | 字元 | 主索引鍵之一 |
| AP03 | 控制項目 | 字元 | 主索引鍵之二 |
| AP04 | 輸入項目 | 字元 | 主索引鍵之三 |
| AP05 | 序號 | 字元 | 主索引鍵之四 |
| AP06 | 有效日期 | 數值 | |

### GLAQPF（交易項目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AQ04 | 會計科目 | 字元 | 主索引鍵之一 |
| AQ05 | 摘要內容1 | 字元 | |
| AQ06 | 摘要內容2 | 字元 | |
| AQ07 | 摘要內容3 | 字元 | |
| AQ08 | 摘要內容4 | 字元 | |
| AQ09 | 金額 | 數值 | |
| AQ12 | 百分比 | 數值 | |
| AQ14 | 數量 | 數值 | |
| AQ15 | 其他 | 字元 | |
| AQ16 | 備註 | 字元 | |
| AQ22 | 摘要代號 | 字元 | |

### GLAAPF（輸入欄位檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AA01 | 部門代號 | 字元 | 主索引鍵之一 |
| AA02 | 輸入項目代碼 | 字元 | 主索引鍵之二 |
| AA03 | 輸入項目說明 | 字元 | |
| AA04 | 檢核程式名稱 | 字元 | |
| AA05 | 傳參數名稱 | 字元 | |

### GLAKPF（會計科目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 部門代號 | 字元 | 主索引鍵之一 |
| AK09 | 科目控制項目2 | 字元 | |
| AK11 | 科目控制項目1 | 字元 | |
| AK15 | 狀態旗標 | 字元 | |

### PT#BPF（部門檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #B01 | 部門代號 | 字元 | 主索引鍵 |
| #B02 | 部門說明 | 字元 | |
| #B12 | 部門狀態 | 字元 | '1'為啟用 |

### PT#YPF（功能參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #Y01 | 參數代號 | 字元 | 主索引鍵 |
| #Y02 | 檢核程式名稱 | 字元 | |

## 4. 輸出/入螢幕布局與說明

### 畫面流程
- **SC01**：傳票主檔輸入畫面（部門代號、傳票號碼、日期等）
- **SC02**：會計科目輸入畫面（借貸金額登錄）
- **SC03**：傳票明細輸入畫面（摘要內容登錄）
- **SC04**：傳票明細瀏覽畫面（明細資料一覽）
- **SC05**：傳票明細修改畫面

### SC01 - 傳票主檔輸入畫面
```
                    傳票登錄

部門代號: [____] [________________]
傳票號碼: [_________]
傳票日期: [________]
大傳票日期: [________]

功能鍵:
F3=離開  F13=列印設定  Enter=繼續
```

### SC02 - 會計科目輸入畫面
```
                    傳票登錄

部門代號: 1234 會計部門
傳票號碼: A12345678
傳票日期: 20240125

會計科目: [________] [________________]

借方金額: [______________]
貸方金額: [______________]
調整比例: [______]%

功能鍵:
F3=離開  F4=會計科目查詢  F6=儲存  F9=列印傳票  F12=返回  F18=明細檢視
```

### SC03 - 傳票明細輸入畫面
```
                    傳票登錄

部門代號: 1234 會計部門     會計科目: 11001001 現金
傳票號碼: A12345678         傳票日期: 20240125

摘要內容1: [____________________] 摘要欄位說明1
摘要內容2: [____________________] 摘要欄位說明2
摘要內容3: [____________________] 摘要欄位說明3
摘要內容4: [____________________] 摘要欄位說明4
金額: [______________]
數量: [______________]
其他: [____________________]
摘要代號: [________] [________________]
傳票明細號碼: [_________]

備註代碼: [_]
簽核人: [____________________]
金額: [______________]
備註說明: [________________________________]

功能鍵:
F3=離開  F4=欄位查詢  F5=確認  F12=返回
```

### SC04 - 傳票明細瀏覽畫面
```
                    傳票明細一覽

部門代號: 1234 會計部門
傳票號碼: A12345678
傳票日期: 20240125

選擇  序號  借方會計科目  貸方會計科目  會計科目說明  借方金額   貸方金額   摘要內容   備註
 _     1    11001001                    現金        10,000.00             購買設備
 _     2                 21001001       應付帳款               10,000.00  購買設備

功能鍵:
F3=離開  F12=返回
```

### SC05 - 傳票明細修改畫面
```
與SC03內容相同，但為修改模式
```

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和參數（R0100）
2. 依畫面代碼SCID執行不同畫面處理：
   - SC01：執行傳票主檔輸入（R1000）
   - SC02：執行會計科目和金額輸入（R2000）
   - SC04：執行傳票明細一覽（R4000）
3. 結束程式（SETON LR）

### SC01 畫面流程（傳票主檔）
1. 顯示SC01畫面
2. 使用者輸入部門代號、傳票號碼、傳票日期等基本資料
3. 檢核輸入資料（R1B00）：
   - 檢查部門代號是否存在且有效
   - 檢查傳票日期是否有效
   - 檢查會計期間資料是否建立
   - 檢查大傳票日期（若有輸入）是否小於傳票日期
4. 若檢核通過，進入SC02畫面（R1C00）

### SC02 畫面流程（會計科目和金額輸入）
1. 初始化SC02畫面（R2A00）
2. 使用者輸入會計科目和借貸金額
3. 檢核輸入資料（R2B00）：
   - 檢查會計科目是否存在且有效
   - 檢查借貸方金額必須一邊為零
4. 若使用者按F6或F9鍵，執行資料儲存（R2D00）
5. 使用者選擇輸入明細資料，進入SC03畫面（R3000）
6. 使用者按F18鍵，進入SC04畫面（明細一覽）

### SC03 畫面流程（明細資料輸入）
1. 初始化SC03畫面（R3A00）
2. 顯示與會計科目相關的輸入項目名稱
3. 使用者輸入摘要內容、金額、數量等資料
4. 檢核輸入資料（R3B00）：
   - 檢查必填項目是否已輸入
   - 由相關檢核程式檢查輸入值是否有效
5. 儲存明細資料到子檔（R3D00）
6. 返回SC02畫面繼續輸入其他會計科目

### SC04 畫面流程（明細一覽）
1. 初始化SC04畫面和子檔(R4A10)
2. 顯示SC04畫面並讀取使用者選擇
3. 處理使用者選擇的明細資料(R4B00)
4. 依選項進入不同畫面：
   - 選項2：進入修改畫面(R4C00)
   - 選項4及以上：進入明細輸入畫面(R3000)

### 資料儲存流程（R2D30）
1. 取得傳票號碼（若為新增）
2. 儲存傳票主檔資料（GLAHPF）
3. 循環處理借方和貸方明細：
   - 儲存傳票明細資料（GLA7PF）
   - 儲存明細相關的備註資料
4. 選擇列印傳票（若按F9鍵）
5. 返回SC01畫面繼續新增其他傳票

## 6. 子程序處理邏輯說明

### R0100 - 初始化程式
- 讀取PTDA01資料區
- 呼叫P31程式處理日期格式轉換
- 設定初始畫面ID為SC01
- 設定功能權限（新增、修改、刪除、查詢）
- 初始化主畫面欄位

### R1000 - SC01畫面處理
- 顯示SC01畫面並讀取使用者輸入
- 檢查F3鍵（離開）、F13鍵（列印設定）
- 呼叫R1B00檢核輸入資料
- 若檢核通過，呼叫R1C00初始化SC02畫面，並切換到SC02

### R1B00 - SC01資料檢核
- 檢查使用者功能權限
- 檢查部門代號是否輸入
- 檢查部門是否存在於部門檔(PT#BPF)且為啟用狀態
- 檢查部門是否存在於會計科目檔(GLAKPF)
- 檢查傳票日期是否輸入及有效性
- 檢查會計期間資料是否建立
- 檢查使用者是否有特殊權限
- 檢查大傳票日期（若有輸入）是否有效及是否小於傳票日期

### R2000 - SC02畫面處理
- 呼叫R2A00初始化SC02畫面
- 顯示SC02畫面並讀取使用者輸入
- 檢查功能鍵：
  - F4：會計科目查詢(R2E00)
  - F6/F9：儲存資料(R2D00)
  - F18：明細瀏覽(切換至SC04)
- 檢核會計科目和金額輸入(R2B00)
- 若會計科目變更，初始化明細輸入畫面(R2C00)
- 進入明細資料輸入(R3000)

### R2B00 - SC02資料檢核
- 檢查會計科目是否輸入
- 檢查會計科目是否存在且為啟用狀態
- 檢查借方金額和貸方金額不能同時為零或同時有值

### R2D00 - 資料儲存處理
- 檢查是否有明細資料
- 檢查借貸方總金額是否相等
- 處理所有借方明細和貸方明細
- 儲存傳票主檔和明細資料
- 若按F9鍵，呼叫列印程式GLR1K0

### R3000 - SC03畫面處理
- 呼叫R3A00初始化SC03畫面
- 顯示SC03畫面並讀取使用者輸入
- 檢查F4鍵（欄位查詢）
- 檢核明細輸入資料(R3B00)
- 儲存明細資料到子檔(R3D00)

### R3A00 - SC03畫面初始化
- 設定輸入項目名稱（依會計科目設定）
- 取得相關檢核程式名稱
- 初始化輸入欄位
- 設定高亮顯示欄位

### R3B00 - SC03資料檢核
- 檢查必填欄位是否已輸入
- 呼叫相關檢核程式檢查輸入值有效性
- 處理摘要代號和相關說明
- 處理簽核人資料

### R4000 - SC04畫面處理
- 初始化SC04畫面和子檔(R4A10)
- 顯示SC04畫面並讀取使用者選擇
- 處理使用者選擇的明細資料(R4B00)
- 依選項進入不同畫面：
  - 選項2：進入修改畫面(R4C00)
  - 選項4及以上：進入明細輸入畫面(R3000)

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理方式
- 使用*IN99指示燈標示錯誤狀態
- 使用ERRID和ERRF存儲錯誤訊息代碼和檔案
- 使用GOTO E1B00等標籤控制錯誤後的程式流程

### 主要錯誤訊息
- UPT0010：必填欄位未輸入
- UPT0012：數值欄位不可為零
- UPT0030：輸入資料無效
- UPT0040：日期格式無效
- UPT2010：資料不存在於檔案中
- UPT2072：新增作業完成
- UPT2150：使用者無權限
- UGL0004：部門非啟用狀態
- UGL0009：會計科目非啟用狀態
- UGL0010：借貸方金額不能同時輸入
- UGL0011：借貸方總金額不相等
- UGL0012：明細資料不存在
- UGL0029：會計期間未建立

### 特殊錯誤檢查
- 檢查大傳票日期不能小於傳票日期（00A修改）
- 檢查使用者是否有特殊權限（$RMK01）

## 8. 備註
1. 本程式提供傳票登錄的完整功能，包括傳票主檔輸入、會計科目輸入、明細資料輸入及檢視。
2. 程式提供多個畫面，使用SCID變數控制畫面切換流程。
3. 儲存資料前會進行借貸平衡檢查，確保借貸方總金額相等。
4. 針對每個輸入欄位，會呼叫相應的檢核程式進行有效性檢查。
5. 可透過摘要代號快速帶入預設的摘要內容。
6. 支援明細資料的瀏覽和修改功能。
7. 提供傳票列印功能，可在儲存後直接列印傳票。
8. 系統會自動取得下一個傳票號碼（GLS002程式）。
9. 支援分攤比例功能，可按比例自動分配借貸金額。
10. 於2024.01.12新增大傳票日期檢查，確保大傳票日期不小於傳票日期。 
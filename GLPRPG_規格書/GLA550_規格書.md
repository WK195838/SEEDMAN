# GLA550 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA550
- **程式說明**：年度餘絀轉出累積一覽
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA550
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.05
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：年度餘絀轉出累積一覽報表產生程式
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAKPF：會計參數檔
- **顯示檔案**
  - GLA550D：年度餘絀轉出累積一覽螢幕顯示檔
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - GLA5501：報表處理程式
  - P31：日期轉換程式
  - P64I：印表機選擇程式

## 3. 檔案欄位規格說明

### GLAKPF（會計參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 部門別 | 參照GLRF | 主鍵欄位 |
| AK02 | 主管限制旗標 | 參照GLRF | 'V'=不允許(顯示'N'),'空白'=允許(顯示'Y') |
| AK15 | 過帳限制 | 參照GLRF | 'Y'=不可跨過帳一年,'空白'=無限制 |

### GLA550D（螢幕顯示檔）
| 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| CONAME | 1,25 | 32 | A | O | 公司名稱 |
| DDATE | 1,72 | 6 | Y | O | 系統日期 |
| $USERN | 2,2 | 10 | A | O | 使用者代號 |
| DAH01 | 6,43 | - | R | B | 公司代號 |
| $CPY | 16,43 | 3 | Y | B | 列印份數 |
| $PRTCD | 17,43 | 2 | A | B | 列印代號 |

### 程式內部變數
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| #CSR | 數值 | 10 | 游標位置 |
| #LIN | 數值 | 5 | 游標行位置 |
| #COL | 數值 | 5 | 游標列位置 |
| ERRID | 字元 | 7 | 錯誤代碼 |
| ERRF | 字元 | 10 | 錯誤檔案 |
| $PFMT | 字元 | 1 | 參數區日期格式 |
| $PTYPE | 字元 | 1 | 參數區日期型態 |
| $USER | 字元 | 10 | 使用者代號 |
| $CHYMD | 字元 | 6 | 日期資訊 |
| $ADD | 字元 | 1 | 新增權限 |
| $UPD | 字元 | 1 | 修改權限 |
| $DLT | 字元 | 1 | 刪除權限 |
| $INQ | 字元 | 1 | 查詢權限 |
| $A8YMD | 字元 | 8 | 系統日期 |
| $C8YMD | 字元 | 8 | 日期資訊 |
| $PENV | 字元 | 1 | 執行環境變數 |

## 4. 輸出/入螢幕布局與說明

### 1. 畫面描述
```
<GLA550.1>                [公司名稱]                       日期: [YYMMDD]
[使用者ID]                年度餘絀轉出累積一覽             時間: [時間]









                         公司代號: [   ] - [   ]









                         列印份數: [   ]

                         列印代號: [  ]


[錯誤訊息顯示區域]
注意    PF3 =返回前頁    PF4 =列印資料    PF14 =批次處理
                                                           【茂世資訊】
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化程式環境（R0100）
2. 執行主畫面處理（R1000），直到使用者按下PF3離開
3. 結束程式（LR）

### 初始化程序（R0100）
1. 設定初始畫面指示燈（指示燈27=開）
2. 讀取參數資料區（PTDA01）
3. 呼叫日期處理程式（P31）轉換系統日期為顯示日期
4. 初始化公司代號欄位（預設空白）
5. 設定列印份數預設值（1）
6. 設定列印代號預設值（'00'）

### 主畫面處理程序（R1000）
1. 顯示主畫面（DSPD1）
2. 清除所有指示燈（60-99）
3. 初始化游標位置變數
4. 當使用者按下PF3（指示燈03=開）時，返回主程序
5. 當使用者按下PF4（指示燈04=開）時，呼叫提示處理子程序（R1E00）
6. 執行資料檢查（R1B00）
7. 當使用者按下PF14（指示燈14=開）且無錯誤（指示燈99=關）時：
   - 關閉主畫面（指示燈27=關）
   - 顯示處理中提示（指示燈28=開）
   - 更新畫面並關閉處理中提示
   - 將資料寫入LDA資料區
   - 呼叫報表處理程式（GLA5501）
   - 重新開啟主畫面（指示燈27=開）
   - 設定處理完成提示（錯誤代碼UPT2142）

### 資料檢查程序（R1B00）
1. 檢查公司代號是否為空白：
   - 若為空白，設定錯誤訊息（UPT0010）並返回
2. 檢查公司代號是否存在（檢索GLAKPF檔案）：
   - 若不存在，設定錯誤訊息（UPT2010）並返回
   - 若存在但過帳限制（AK15）不為空白，設定錯誤訊息（UGL0013）並返回
3. 檢查使用者功能權限：
   - 若新增、修改、刪除、查詢權限均不為'Y'，設定錯誤訊息（UPT2150）並返回

### 提示處理程序（R1E00）
1. 計算游標行列位置（將#CSR除以256得到#LIN和#COL）
2. 當游標位於列印代號欄位（行=17，列=43-44）時：
   - 呼叫印表機選擇程式（P64I）
   - 傳遞當前列印代號並接收新的列印代號

## 6. 子程序處理邏輯說明

### GLA5501 - 年度餘絀轉出累積程式
- 功能：根據指定的公司代號，產生年度餘絀轉出累積一覽報表
- 參數：由LDA資料區傳遞公司代號（位置501-502）
- 動作：執行報表產生並輸出

### P31 - 日期轉換程式
- 功能：將系統日期轉換為顯示格式
- 參數：
  * P3101I：輸入日期（$A8YMD）
  * P3102I：日期類型（'2'=輸出）
  * P3103I：日期顯示類型（'1'=年月日）
  * P3104I：日期格式（$PFMT）
  * P3105I：日期型態（$PTYPE）
- 回傳：P3101O（輸出日期，儲存於DDATE）

### P64I - 印表機選擇程式
- 功能：提供印表機代號選擇
- 參數：P64II1（輸入/輸出印表機代號，$PRTCD）
- 回傳：更新後的印表機代號

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 公司代號不可為空白 |
| UPT2010 | PTMF | 公司代號不存在 |
| UGL0013 | GLMF | 公司過帳限制設定不允許跨年度過帳 |
| UPT2150 | PTMF | 使用者權限不足 |
| UPT2142 | PTMF | 處理完成提示 |

## 8. 備註

1. 本程式為會計總帳系統中的年度餘絀轉出累積一覽程式，用於產生年度餘絀轉出累積報表。
2. 程式檢查使用者是否有足夠的權限執行此功能，並驗證公司代號是否存在及其過帳限制設定。
3. 會計年度結算時使用此程式可以確保餘絀金額正確轉出至累積帳戶。
4. 報表可設定列印份數及使用不同印表機輸出。
5. 本程式適用於茂世資訊系統中的會計總帳模組。 
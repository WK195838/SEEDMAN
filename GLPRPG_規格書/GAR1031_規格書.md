# 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR1031
- **程式說明**：會計系統資料處理程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR1031
- **系統名稱**：會計系統
- **子系統**：會計處理

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHLF99：會計歷史資料檔
  - GLABPF：會計批次檔
  - GAWF04：會計工作檔（更新模式）

## 3. 檔案欄位規格說明
### 資料區定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| $PFMT | 1 | 1 | 字元 | 報表格式 |
| $PTYPE | 2 | 1 | 字元 | 報表類型 |
| $USER | 101-110 | 10 | 字元 | 使用者代號 |
| $CPY | 125-127 | 3 | 數值 | 公司代號 |
| $INQ | 138 | 1 | 字元 | 查詢標記 |
| $A8YMD | 201-208 | 8 | 數值 | 會計年度 |
| $C8YMD | 209-216 | 8 | 數值 | 系統日期 |
| $PRTCD | 217-218 | 2 | 字元 | 列印代號 |
| $PENV | 219 | 1 | 字元 | 環境變數 |

## 4. 輸出/入螢幕布局與說明
- 使用工作檔：GAWF04
- 資料處理功能：
  * 批次資料處理
  * 歷史資料處理
  * 資料更新與刪除

## 5. 處理流程程序說明
### 1. 批次資料處理（R1000）
- 讀取GLABPF資料：
  * 移動系統代號（AB01）到工作檔（WF0401）
  * 移動會計期間（AB02）到工作檔（WF0402）
  * 設定金額欄位（WF0403）為0
  * 移動批次金額（AB03）到工作檔（WF0404）
  * 寫入工作檔記錄

### 2. 歷史資料處理（R2000）
1. 資料讀取與更新：
   - 使用KEYAH（系統代號+會計期間）查詢工作檔
   - 檢查會計科目（AH02）是否匹配
   - 根據條件執行更新或刪除操作

2. 新增資料處理：
   - 當工作檔無對應資料時
   - 移動系統代號到工作檔
   - 移動會計期間到工作檔
   - 設定金額欄位
   - 寫入新記錄

## 6. 子程序處理邏輯說明
- 無子程序呼叫

## 7. 錯誤處理程序說明與訊息清冊
- 資料處理錯誤：
  * 工作檔更新失敗
  * 工作檔刪除失敗
  * 工作檔新增失敗
- 資料驗證錯誤：
  * 會計科目不匹配
  * 資料格式錯誤

## 8. 備註
- 程式主要用於處理會計資料
- 資料處理特點：
  * 支援批次資料處理
  * 支援歷史資料處理
  * 支援資料更新與刪除
  * 使用工作檔進行資料暫存
- 處理邏輯：
  * 先處理批次資料
  * 再處理歷史資料
  * 最後進行資料更新 
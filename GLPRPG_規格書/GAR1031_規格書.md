# GAR1031 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR1031
- **程式說明**：參數日曆系統管理報表子程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR1031
- **開發人員**：未指定
- **建立日期**：未指定
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：參數日曆系統管理報表資料處理子程式
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHLF99：參數日曆歷史檔
  - GLABPF：會計基本參數檔
  - GAWF04：工作檔（統計資料暫存）
- **資料區**
  - PTDA01：參數資料區
- **相關程式**
  - GAR103：參數日曆系統管理報表主程式

## 3. 檔案欄位規格說明

### GLAHLF99（參數日曆歷史檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH01 | 公司代號 | 字元 | 主鍵1 |
| AH02 | 參數代碼數量 | 數值 | 用於統計 |
| AH10 | 參數日期 | 數值 | 主鍵2 |

### GLABPF（會計基本參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AB01 | 公司代號 | 字元 | 主鍵1 |
| AB02 | 參數日期 | 數值 | 主鍵2 |
| AB03 | 參數記錄數量 | 數值 | 用於統計 |

### GAWF04（工作檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| WF0401 | 公司代號 | 字元 | 主鍵1 |
| WF0402 | 參數日期 | 數值 | 主鍵2 |
| WF0403 | 參數代碼數量 | 數值 | 統計值 |
| WF0404 | 參數記錄數量 | 數值 | 統計值 |

### 資料區定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $PFMT | 1 | 1 | 參數區日期格式 |
| $PTYPE | 2 | 1 | 參數區日期型態 |
| $USER | 101-110 | 10 | 使用者代號 |
| $CPY | 125-127 | 3 | 列印份數 |
| $INQ | 138 | 1 | 查詢標記 |
| $A8YMD | 201-208 | 8 | 系統日期 |
| $C8YMD | 209-216 | 8 | 系統日期 |
| $PRTCD | 217-218 | 2 | 列印機台 |
| $PENV | 219 | 1 | 輸出裝置 |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| DAH01 | 字元 | 暫存公司代號 |
| DAH10 | 數值 | 暫存參數日期 |
| WAH02 | 數值 | 暫存參數代碼數量 |

## 4. 處理流程程序說明

### 主程序流程
1. 讀取參數資料區(PTDA01)
2. 處理基本參數檔(GLABPF)資料，執行 R1000 程序
3. 處理歷史參數檔(GLAHLF99)資料，執行 R2000 程序
4. 使用KLIST鍵值列表設定讀取條件
5. 結束程式時設定 LR 指示燈

### 子程序處理流程

#### R1000 - 基本參數檔處理
1. 讀取會計基本參數檔(GLABPF)資料
2. 將公司代號(AB01)複製到工作檔公司欄位(WF0401)
3. 將參數日期(AB02)複製到工作檔日期欄位(WF0402)
4. 將參數代碼數量初始化為0(WF0403)
5. 將參數記錄數量(AB03)複製到工作檔數量欄位(WF0404)
6. 寫入工作檔(GAWF04)記錄

#### R2000 - 歷史參數檔處理
1. 使用KEYAH鍵值列表讀取工作檔記錄
2. 取得歷史參數檔中的參數代碼數量(AH02)
3. 檢查記錄是否存在(指示燈40判斷)
   - 若記錄存在，且參數代碼數量等於記錄數量，則刪除記錄
   - 若記錄存在，但數量不同，則更新記錄
   - 若記錄不存在，則建立新記錄
4. 更新工作檔中的參數代碼數量與記錄數量資訊

## 5. 錯誤處理程序說明與訊息清冊
- 使用指示燈40控制檔案存取狀態
- 使用指示燈46控制檔案讀取循環
- 程式內不包含明確的錯誤訊息處理，錯誤處理由主程式(GAR103)執行

## 6. 備註
1. 本程式為參數日曆系統管理報表的子程式，主要負責資料收集與統計處理
2. 程式將參數日曆系統的基本資料與歷史資料整合在一起，計算每個公司的參數代碼數量與記錄數量
3. 處理結果儲存在工作檔(GAWF04)中，供主程式(GAR103)產生報表使用
4. 程式使用標準的RPG鍵值列表(KLIST)處理複合鍵值檔案
5. 此子程式不直接輸出報表，而是由主程式調用 
# GAR1011 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR1011
- **程式說明**：參數日曆產生報表輸出子程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR1011
- **開發人員**：未指定
- **建立日期**：未指定
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：參數日曆報表輸出子程式，負責實際報表產生與列印
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHLF01：會計主檔（輸入模式）
  - GLAKPF：會計參數檔（輸入模式）
  - GLAFPF：會計參數來源檔（輸入模式）
  - PT#YPF：參數來源檔（輸入模式）
  - S#SUPF：系統參數說明檔（輸入模式）
  - PT#BPF：部門說明檔（輸入模式）
- **印表檔案**
  - GAR101P：參數日曆產生報表輸出檔
- **資料區**
  - PTDA01：參數資料區
- **相關程式**
  - P31：日期轉換程式
  - GAR101：參數日曆產生報表輸出（主程式）

## 3. 檔案欄位規格說明

### GLAHLF01（會計主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH02 | 參數代碼 | 字元 | 層級1欄位 |
| AH04 | 會計科目 | 字元 | - |
| AH09 | 參數版本 | 數值 | - |
| AH10 | 參數日期 | 數值 | - |
| AH12 | 參數旗標 | 數值 | - |
| AH17 | 參數來源 | 字元 | - |
| AH21 | 參數金額 | 數值 | - |
| AH25 | 建檔日期 | 數值 | - |
| AH26 | 建檔人 | 字元 | - |

### GLAKPF（會計參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 公司代號 | 字元 | - |
| AK09 | 日期格式 | 字元 | - |
| AK11 | 日期類型 | 字元 | - |

### GLAFPF（會計參數來源檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AF03 | 參數說明 | 字元 | - |

### 資料區定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $PFMT | 1 | 1 | 參數區日期格式 |
| $PTYPE | 2 | 1 | 參數區日期型態 |
| $USER | 101-110 | 10 | 使用者代號 |
| $CPY | 125-127 | 3 | 列印份數 |
| $INQ | 138 | 1 | 查詢標記 |
| $A8YMD | 201-208 | 8 | 系統日期 |
| $C8YMD | 209-216 | 8 | 系統日期 |
| $PRTCD | 217-218 | 2 | 列印機台 |
| $PENV | 219 | 1 | 輸出裝置 |

### 程式使用資料定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| DAH01 | 501-502 | 2 | 公司別 |
| DAH25F | 503-510 | 8 | 建檔日期(起) |
| DAH25T | 511-518 | 8 | 建檔日期(迄) |
| DAH10F | 519-526 | 8 | 參數日期(起) |
| DAH10T | 527-534 | 8 | 參數日期(迄) |
| DAH02F | 535-543 | 9 | 參數代碼(起) |
| DAH02T | 544-552 | 9 | 參數代碼(迄) |
| DAH26F | 553-562 | 10 | 建檔人(起) |
| DAH26T | 563-572 | 10 | 建檔人(迄) |
| DAH17F | 573-574 | 2 | 來源代碼(起) |
| DAH17T | 575-576 | 2 | 來源代碼(迄) |
| DAH19 | 577 | 1 | 顯示內容 |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| PDATE | 數值 | 轉換後系統日期 |
| P25F | 數值 | 轉換後建檔日期(起) |
| P25T | 數值 | 轉換後建檔日期(迄) |
| P10F | 數值 | 轉換後參數日期(起) |
| P10T | 數值 | 轉換後參數日期(迄) |
| PAH25 | 數值 | 轉換後建檔日期 |
| PAH10 | 數值 | 轉換後參數日期 |
| PAH21 | 數值 | 轉換後參數金額 |
| PAH04 | 字元 | 會計科目 |
| PAF03 | 字元 | 參數說明 |
| PSU02 | 字元 | 使用者名稱 |
| P#Y03 | 字元 | 參數來源說明 |
| PAH09 | 數值 | 參數版本 |
| PFLD1 | 字元 | 顯示內容說明 |
| D#Y03 | 字元 | 參數來源暫存 |
| WTMP1 | 字元 | 鍵值暫存1 |
| WTMP2 | 字元 | 鍵值暫存2 |
| #Y01 | 字元 | 鍵值欄位1 |
| #Y02 | 字元 | 鍵值欄位2 |
| #B03 | 字元 | 公司名稱 |

## 4. 輸出/入螢幕布局與說明

### 報表格式
使用GAR101P列印檔案產生以下報表：

```
[公司名稱]

會計參數日曆產生報表輸出

建檔日期: [起始日期] - [結束日期]
參數日期: [起始日期] - [結束日期]
參數代碼: [起始代碼] - [結束代碼]
建檔人  : [建檔人名稱]    (可空白代表*ALL )
參數來源: [參數來源]      (可空白代表*ALL )      頁次: [頁碼]
顯示內容: [顯示內容][內容說明]                    時間: [時間]    <GAR101P>
========================================================================
參數代碼  建檔日期  參數日期  更新日期  有效 版本 排序 來源      建檔人
------------------------------------------------------------------------
         日期                            成本金額      下架金額      會計科目      專案代碼1      狀態
                                         單位別       專案代碼2      日期        數量         說明
========================================================================

[參數代碼] [建檔日期] [參數日期] [更新日期] [有效] [版本] [排序] [來源] [來源說明] [建檔人]
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化程式（EXSR R1000）
2. 處理層級1初始化（EXSR R7100，若有L1層級控制）
3. 處理明細資料（EXSR R2000）
4. 處理層級1控制（EXSR R8100，若有L1層級控制且層級改變）
5. 處理總計輸出（EXSR R8900，若有資料）
6. 處理無資料情況（EXSR R8999，若無資料）

### 子程序處理流程

#### R1000 - 初始化處理
1. 設定控制指示燈（10,39）
2. 關閉層級1-第一次中斷指示燈（11）
3. 讀取參數資料區(PTDA01)
4. 呼叫P31日期轉換程式，處理系統日期格式
5. 讀取會計參數檔（GLAKPF，KEY#B）取得公司資訊
6. 進行建檔日期格式轉換（DAH25F/DAH25T）
7. 進行參數日期格式轉換（DAH10F/DAH10T）
8. 處理參數來源說明：
   - 若參數來源非空白，讀取參數來源說明（PT#YPF）
9. 處理顯示內容選項：
   - 若DAH19='1'，設定PFLD1為"已核准"
   - 若DAH19='2'，設定PFLD1為"未核准"
   - 若DAH19='3'，設定PFLD1為"全部  "

#### R2000 - 明細處理
1. 判斷是否需要輸出標題（*IN39='1'）：
   - 若需要：輸出標題（WRITEPH1），關閉標題指示燈，設定欄位控制指示燈（31,32）
2. 進行建檔日期格式轉換（AH25→PAH25）
3. 進行參數日期格式轉換（AH10→PAH10）
4. 處理參數金額格式轉換（AH21→PAH21）
5. 讀取參數來源說明（PT#YPF，KEY#Y）
6. 讀取使用者名稱（S#SUPF，KEY#S）
7. 處理會計科目顯示（AH04→PAH04）：
   - 根據參數旗標（AH12）決定顯示方式
8. 處理參數說明（AF03→PAF03）：
   - 根據參數旗標（AH12）決定顯示方式
9. 將參數版本（AH09）複製到輸出變數（PAH09）
10. 輸出明細資料（WRITEPD1）
11. 關閉欄位控制指示燈（31,32）

#### R7100 - 層級1初始處理
1. 若層級1第一次控制（*IN11='1'）輸出合計線（WRITEPT1）
2. 設定欄位控制指示燈（32）
3. 設定層級控制指示燈（31,11）

#### R8100 - 層級1控制處理
- 此子程序為層級1控制處理，但本程式中沒有實際執行代碼

#### R8900 - 有資料總計處理
1. 輸出合計線（WRITEPT1）

#### R8999 - 無資料處理
1. 執行初始化（EXSR R1000）
2. 輸出標題（WRITEPH1）
3. 輸出無資料訊息（WRITEPE9）

## 6. 子程序處理邏輯說明
- **P31程式**：日期格式轉換
  * 輸入參數：
    - P3101I：輸入日期（$A8YMD、DAH25F/T、DAH10F/T、AH25、AH10、AH21）
    - P3102I：格式代碼（'2'）
    - P3103I：轉換類型（'1'）
    - P3104I：日期格式（$PFMT/AK11）
    - P3105I：日期類型（$PTYPE/AK09）
  * 輸出參數：
    - P3101O：轉換後日期（PDATE、P25F/T、P10F/T、PAH25、PAH10、PAH21）

## 7. 錯誤處理程序說明與訊息清冊
- 使用指示燈39控制報表標題輸出
- 使用指示燈10控制程式初始化
- 使用指示燈11控制層級1的第一次處理
- 使用指示燈31,32控制明細欄位輸出
- 使用指示燈40檢查檔案讀取狀態
- 使用層級指示燈L1控制層級1處理
- 無資料時顯示"無符合條件之資料"訊息

## 8. 備註
1. 本程式為參數日曆產生報表輸出的子程式，負責將篩選後的資料輸出到報表
2. 程式透過讀取會計主檔（GLAHLF01）獲取參數資料，包括參數代碼、參數日期、建檔日期等
3. 使用多個參數檔案（GLAKPF、PT#YPF、S#SUPF）取得額外的資訊，增強報表的可讀性
4. 所有日期格式都透過P31程式進行標準化處理，確保日期格式一致
5. 此程式使用層級控制（Level Break）技術處理報表的分組與小計
6. 提供全面的參數日曆狀態顯示，包括已核准、未核准或全部參數
7. 報表內的金額、科目和說明都根據參數旗標（AH12）進行特殊處理，提高報表的準確性 
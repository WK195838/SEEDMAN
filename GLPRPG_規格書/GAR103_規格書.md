# GAR103 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR103
- **程式說明**：參數日曆系統管理報表
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR103
- **開發人員**：未指定
- **建立日期**：未指定
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：參數日曆系統報表產生程式
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **顯示檔案**
  - GAR103D：參數日曆系統管理報表螢幕顯示檔
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - P31：日期轉換程式
  - P64I：印表機選擇程式

## 3. 檔案欄位規格說明

### GAR103D（螢幕顯示檔）
| 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| CONAME | 1,26 | 32 | A | O | 公司名稱 |
| DDATE | 1,72 | 6 | Y | O | 系統日期 |
| $USERN | 2,2 | 10 | A | O | 使用者代號 |
| $PENV | 13,39 | 1 | A | B | 輸出裝置 |
| $CPY | 15,39 | 3 | Y | B | 列印份數 |
| $PRTCD | 17,39 | 2 | A | B | 列印機台 |

### 程式內部變數
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| #CSR | 數值 | 10 | 游標位置 |
| #LIN | 數值 | 5 | 游標行位置 |
| #COL | 數值 | 5 | 游標列位置 |
| ERRID | 字元 | 7 | 錯誤代碼 |
| ERRF | 字元 | 10 | 錯誤檔案 |
| $PFMT | 字元 | 1 | 參數區日期格式 |
| $PTYPE | 字元 | 1 | 參數區日期型態 |
| @PRT | 字元 | 1 | 列印控制旗標 |

## 4. 輸出/入螢幕布局與說明

### 1. 主畫面布局
```
<GAR103.1>                     [公司名稱]                        [日期]
[使用者ID]                   測試參數系統報表

                         


                         
                         
                         
                         
                         

                         輸出裝置: [ ] (0-螢幕 1-印表 2-檔案)

                         列印份數: [   ]

                         列印機台: [  ]


[錯誤訊息顯示區域]
注意    PF3 =回主畫面    PF4 =重新查詢    PF14 =處理作業
                                                           【茂世資訊】
```

## 5. 處理流程程序說明

### 主程序流程
1. 若指示燈10為開，則執行初始化訊息設定（R0200）
2. 若指示燈10為關，則執行初始化畫面設定（R0100）
3. 初始化列印旗標（@PRT）為空白
4. 循環執行主畫面處理（R1000），直到使用者按下PF3（指示燈03=開）或列印旗標（@PRT）為'Y'
5. 若指示燈03為開，則設定結束程式指示燈（LR）並返回

### 初始化畫面設定程序（R0100）
1. 設定指示燈10和27為開
2. 讀取參數資料區（PTDA01）
3. 呼叫日期處理程式（P31）轉換系統日期為顯示日期格式

### 初始化訊息設定程序（R0200）
1. 設定指示燈27和99為開
2. 根據執行環境變數（$PENV）設定不同的訊息代碼：
   - $PENV='0'（查詢模式）：錯誤代碼UPT2142
   - $PENV='1'（線上模式）：錯誤代碼UPT2140
   - $PENV='2'（批次模式）：錯誤代碼UPT2110

### 主畫面處理程序（R1000）
1. 顯示主畫面（DSPD1）
2. 清除所有指示燈（60-99）
3. 初始化游標位置變數（#LIN和#COL）
4. 當使用者按下PF3（指示燈03=開）時，返回主程序
5. 當使用者按下PF4（指示燈04=開）時，呼叫提示處理子程序（R1E00）並返回主畫面
6. 當使用者按下PF14（指示燈14=開）且無錯誤（指示燈99=關）時：
   - 關閉主畫面（指示燈27=關）
   - 顯示處理中提示（指示燈28=開）
   - 更新畫面並關閉處理中提示
   - 將資料寫入LDA資料區
   - 設定列印旗標（@PRT）為'Y'

### 提示處理程序（R1E00）
1. 計算游標行列位置（將#CSR除以256得到#LIN和#COL）
2. 當游標位於列印機台欄位（行=17，列=39-40）時：
   - 呼叫印表機選擇程式（P64I）
   - 傳遞當前列印機台代號，接收新的列印機台代號

## 6. 子程序處理邏輯說明

### P31 - 日期轉換程式
- 功能：將日期轉換為指定的格式
- 參數：
  * P3101I：輸入日期
  * P3102I：日期類型
  * P3103I：日期格式
  * P3104I：輸出類型
  * P3105I：輸出格式
- 回傳：P3101O（格式化後的日期值）

### P64I - 印表機選擇程式
- 功能：提供印表機代號選擇
- 參數：P64II1（輸入/輸出印表機代號，$PRTCD）
- 回傳：更新後的印表機代號

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT2110 | PTMF | 批次處理模式訊息 |
| UPT2140 | PTMF | 線上模式訊息 |
| UPT2142 | PTMF | 查詢模式訊息 |

## 8. 備註

1. 本程式為會計總帳系統的參數日曆系統管理報表產生程式，用於產生系統相關報表。
2. 程式提供簡化的用戶界面，主要讓使用者指定報表輸出方式。
3. 可設定輸出至螢幕、印表機或檔案，並可指定列印份數及印表機代號。
4. 與其他報表程式（如GAR101、GAR102）不同，此程式不需要用戶輸入複雜的篩選條件。
5. 本程式主要用於系統管理人員產生系統狀態和統計報表。
6. 程式自動從系統取得必要參數，不需要使用者指定。
7. 輸出裝置設定值（$PENV）為：0-螢幕、1-印表機、2-檔案。
8. 使用標準的系統處理流程，確保與其他程式的一致性。
9. 採用茂世資訊標準的報表輸出格式。 
# GLA910 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA910
- **程式說明**：總帳檔案轉檔作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA910
- **開發人員**：A1034 STEPHANIE
- **建立日期**：1993.07.27
- **系統**：會計總帳

## 2. 檔案架構與關聯圖
此程式使用多個檔案進行轉檔處理，從來源檔案讀取資料並寫入到目標檔案：

### 輸入檔案 (來源檔案)
- PT#BPF@#：系統參數檔
- PT#APF@#：代碼檔案
- PT#1PF@#：系統參數檔
- GLAAPF@#：幣別設定檔
- GLABPF@#：會計期間檔
- GLAEPF@#：分錄類型檔
- GLAFPF@#：會計科目檔
- GLAHPF@#：會計分錄檔
- GLAKPF@#：公司檔案

### 輸出檔案 (目標檔案)
- PT#YPF：代碼檔案
- PT#BPF：系統參數檔
- PT#ZPF：系統參數檔
- GLAAPF：幣別設定檔
- GLABPF：會計期間檔
- GLADPF：部門資料檔
- GLAEPF：分錄類型檔
- GLAFPF：會計科目檔
- GLAHPF：會計分錄檔
- GLAKPF：公司檔案
- QSYSPRT：錯誤報表輸出

### 檔案間關聯
- 公司代碼 (AK01) 連結各個檔案
- 會計科目 (AF01, AF02) 連結 GLAHPF 與 GLAFPF
- 部門代碼 (AK07, AK08) 連結 GLAKPF 與 GLADPF

## 3. 檔案欄位規格說明

### 主要檔案欄位

#### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|
| #B01 | 代碼 | - | 文字 | 參數代碼 |
| #B02 | 名稱 | - | 文字 | 參數名稱 |
| #B03 | 說明 | 80 | 文字 | 參數說明 |
| #B04~#B11 | 參數設定 | - | 文字 | 不同參數設定值 |

#### GLAAPF (幣別設定檔)
| 欄位代號 | 名稱 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|
| AA01 | 公司代碼 | - | 文字 | 主鍵 |
| AA02 | 幣別代碼 | - | 文字 | 主鍵 |
| AA03 | 幣別說明 | - | 文字 | 幣別描述 |

#### GLAFPF (會計科目檔)
| 欄位代號 | 名稱 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|
| AF01 | 公司代碼 | - | 文字 | 主鍵 |
| AF02 | 會計科目 | - | 文字 | 主鍵 |
| AF05 | 科目類型 | - | 文字 | 借/貸類型 |
| AF08 | 科目種類 | - | 文字 | 科目分類 |
| AF21 | 科目設定 | - | 文字 | 特殊設定 |

#### GLAKPF (公司檔案)
| 欄位代號 | 名稱 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|
| AK01 | 公司代碼 | - | 文字 | 主鍵 |
| AK02 | 公司名稱 | - | 文字 | 公司描述 |
| AK04 | 會計科目 | 8 | 文字 | 預設科目 |
| AK07 | 內部部門 | 8 | 文字 | 內部部門代碼 |
| AK08 | 外部部門 | 8 | 文字 | 外部部門代碼 |

#### GLADPF (部門資料檔)
| 欄位代號 | 名稱 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|
| AD01 | 公司代碼 | - | 文字 | 主鍵 |
| AD02 | 部門代碼 | - | 文字 | 主鍵 |
| AD03 | 部門名稱 | - | 文字 | 部門描述 |
| AD05 | 部門類型 | 1 | 文字 | 1:內部, 2:外部 |

## 4. 輸出/入螢幕布局與說明
此程式為批次處理程式，無螢幕輸入輸出。僅在錯誤時輸出訊息到 QSYSPRT 印表機檔。

### 錯誤訊息輸出格式
- 輸出檔案名稱
- 相關錯誤資料的主鍵值
- 特殊錯誤訊息 (如「無法分配」或「參數錯誤」)

## 5. 處理流程程序說明

### 主要處理流程
1. 執行初始化 (R0000)
2. 處理系統參數檔 PT#BPF (R0100)
3. 處理代碼檔案 PT#APF (R0200)
4. 處理系統參數檔 PT#1PF (R0300)
5. 處理幣別設定檔 GLAAPF (R0400)
6. 處理會計期間檔 GLABPF (R0500)
7. 處理分錄類型檔 GLAEPF (R0600)
8. 處理會計科目檔 GLAFPF (R0700)
9. 處理會計分錄檔 GLAHPF (R0800)
10. 處理公司檔案 GLAKPF (R0900)
11. 如果無錯誤，設定指示器 98

### 錯誤處理
- 各子程序中，若寫入目標檔案時發生錯誤 (指示器 99)，則輸出錯誤訊息並跳到程序結束
- 程式使用指示器 99 控制錯誤流程，若發生錯誤則中斷後續處理

## 6. 子程序處理邏輯說明

### R0000 - 初始化
接收參數並設定初始值：
- IN99：錯誤指示器
- IN98：成功指示器
- LIB：庫名稱
- AK04P, AK07P, AK08P：預設會計科目與部門代碼

### R0100 - PT#BPF 處理
1. 讀取 PT#BPF@# 檔案內容
2. 轉換欄位並處理文字格式
3. 設定固定值及預設參數
4. 寫入目標檔案 PT#BPF
5. 如有錯誤輸出訊息並結束

### R0200 - PT#APF 處理
1. 讀取 PT#APF@# 檔案內容
2. 轉換至目標檔案格式
3. 設定 #Y04 為 'Y'
4. 寫入目標檔案 PT#YPF
5. 如有錯誤輸出訊息並結束

### R0700 - GLAFPF 處理
1. 讀取 GLAFPF@# 檔案內容
2. 轉換多個欄位格式
3. 處理輸入代碼與設定代碼:
   - 將 ARR3 陣列中的 'X' 替換為 'V'
   - 依據 ARR4 陣列轉換設定 ARR5 陣列
4. 寫入目標檔案 GLAFPF

### R0900 - GLAKPF 處理
1. 讀取 GLAKPF@# 檔案內容
2. 設定鍵值清單 KEYAF4 和 KEYAF5
3. 轉換公司資料並寫入 GLAKPF
4. 檢查相關科目設定:
   - 如 AF21 不為全 '0'，輸出「預算限制」錯誤
   - 如 AF08 不為 '2'，輸出「安全參數」錯誤
5. 呼叫 R0910 處理部門資料

### R0910 - GLADPF 處理
1. 設定鍵值清單 KEYAD7 和 KEYAD8
2. 檢查內部部門是否存在，若不存在則:
   - 新增內部部門記錄到 GLADPF
   - 設定部門類型 AD05 為 '1'
3. 檢查外部部門是否存在，若不存在則:
   - 新增外部部門記錄到 GLADPF
   - 設定部門類型 AD05 為 '2'

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理機制
- 程式使用指示器 99 標記錯誤狀態
- 使用 EXCPT 輸出錯誤訊息到 QSYSPRT 印表機檔

### 錯誤訊息清冊
| 錯誤代碼 | 訊息內容 | 說明 |
|----------|----------|------|
| ERR01 | PT#BPF | 系統參數檔處理錯誤 |
| ERR02 | PT#APF | 代碼檔案處理錯誤 |
| ERR03 | PT#1PF | 系統參數檔處理錯誤 |
| ERR04 | GLAAPF | 幣別設定檔處理錯誤 |
| ERR05 | GLABPF | 會計期間檔處理錯誤 |
| ERR06 | GLAEPF | 分錄類型檔處理錯誤 |
| ERR07 | GLAFPF | 會計科目檔處理錯誤 |
| ERR08 | GLAHPF | 會計分錄檔處理錯誤 |
| ERR09 | GLAKPF | 公司檔案處理錯誤 |
| ERR091 | 預算限制 | 科目設定檢查錯誤 |
| ERR092 | 安全參數 | 科目類型檢查錯誤 |

## 8. 備註
- 此程式主要用於系統間資料轉換和移轉
- 程式會自動產生部門資料，包括內部部門和外部部門
- 轉換過程中，部分欄位會進行格式轉換和代碼轉換
- 程式末端定義了「內部部門」和「外部部門」的常數資料
- 程式程序碼包含日期格式轉換 (19110000 加法運算)，這是因為民國年和西元年的轉換 
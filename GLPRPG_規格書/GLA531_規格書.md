# GLA531 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA531
- **程式說明**：年結分錄作業執行分錄
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA531
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.04 (81/12/04)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAHLF01**：傳票檔
- **GLAPPF**：傳票明細檔
- **GLAQPF**：傳票明細分配檔
- **GLAAPF**：會計項目檔
- **GLADPF**：部門檔
- **GLAFPF**：會計項目檔
- **GLAKPF**：參數檔
- **PT#BPF**：部門參數檔
- **GLA531D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA531
- **呼叫程式**：
  - P31：日期格式處理程式
  - P50：錯誤處理程式
  - GLA190：傳票輸入程式
  - GLS001：字串處理程式
  - GLS002：單據號碼處理程式
  - GLI410：會計項目查詢程式
  - GLI440：部門代碼查詢程式
  - GLI1E0：傳票查詢程式
- **被呼叫者**：
  - GLA530：年結分錄作業主程式
- **功能鍵**：F3(離開), F4(查詢), F5(重新輸入), F12(返回)

## 3. 檔案欄位規格說明

### *ENTRY 參數定義
- **P531I1 (DAH01)**：部門代號，長度2
- **P531I2 (WAH02)**：分錄號碼，長度9
- **P531I3 (DAH10)**：分錄日期，長度80
- **@RTNC**：返回代碼，長度2

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：系統日期
  - $CPY (125-127)：公司代號
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $RMK01 (139-139)：特殊權限標記
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $PRTCD (217-218)：印表機代碼
  - $PENV (219-219)：印表機環境

### 陣列定義
- **@A01 (功能權限陣列)**：儲存各種功能權限
- **WFUN (功能代碼陣列)**：儲存功能代碼
- **W02 (會計項目代碼陣列)**：儲存會計項目代碼
- **W03 (會計項目名稱陣列)**：儲存會計項目名稱
- **W04 (檢核程式名稱陣列)**：儲存檢核程式名稱
- **W05 (欄位內容陣列)**：儲存輸入欄位內容
- **W06 (欄位內容說明陣列)**：儲存輸入欄位內容說明
- **W07 (欄位檢核碼陣列)**：儲存輸入欄位檢核碼
- **W13, W14, W15 (記錄追蹤陣列)**：用於資料處理追蹤

### 主要欄位說明
- **DAH01**：部門代號
- **WAH02**：分錄號碼
- **DAH03**：明細序號
- **DAH04**：會計項目代號
- **DAH05-DAH08**：各種輸入欄位內容
- **DAH09**：金額
- **DAH10**：分錄日期
- **DAH11**：有效標記
- **DAH12**：借方金額
- **DAH13**：貸方金額
- **DAH14**：數量
- **DAH15**：備註
- **DAH22**：部門代碼
- **DAH24**：傳票號碼
- **WDR**：借方金額累計
- **WCR**：貸方金額累計

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (SC01-SFLCR)
- **螢幕標題**：年結分錄明細清單
- **畫面描述**：顯示已輸入的分錄明細清單
- **顯示欄位**：
  - 序號 (DAH03)：明細序號
  - 會計項目 (DAH04)：會計項目代號
  - 會計項目說明 (DAF03)：會計項目說明
  - 借方金額 (DAH12)：借方金額
  - 貸方金額 (DAH13)：貸方金額
  - 有效標記 (DAH11)：資料有效標記
- **功能鍵**：
  - F3：離開
  - F6：確認分錄
  - F9：列印分錄
  - F12：返回上一畫面

### 明細輸入畫面 (DSPD3)
- **螢幕標題**：年結分錄明細資料細項
- **畫面描述**：輸入分錄明細的細項資料
- **輸入欄位**：
  - 會計項目 (DAH04)：輸入會計項目代號
  - 說明 (DAH05)：輸入說明文字
  - 摘要 (DAH06)：輸入摘要
  - 交易代碼1 (DAH07)：輸入交易代碼1
  - 交易代碼2 (DAH08)：輸入交易代碼2
  - 金額 (DAH09)：輸入金額
  - 借方金額 (DAH12)：輸入借方金額
  - 貸方金額 (DAH13)：輸入貸方金額
  - 數量 (DAH14)：輸入數量
  - 備註 (DAH15)：輸入備註
  - 部門代碼 (DAH22)：輸入部門代碼
  - 傳票號碼 (DAH24)：輸入傳票號碼
- **功能鍵**：
  - F3：離開
  - F4：查詢功能
  - F12：返回上一畫面

## 5. 處理流程程序說明

### 主要流程
1. 接收GLA530程式傳入的部門代號、分錄號碼和分錄日期參數
2. 初始化程式環境 (R0100)
3. 進入主畫面處理迴圈 (R2000)
4. 讀取並顯示分錄明細資料
5. 根據使用者動作執行相應處理
6. 返回結果代碼給GLA530程式

### 主程式處理流程 (R2000)
1. 初始化子檔畫面 (R2A10)
2. 顯示子檔畫面 (R2A20)
3. 處理使用者輸入
4. 若按F3或F12則返回相應代碼
5. 若按F6或F9則檢核資料並儲存 (R2D00)

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 設定初始螢幕代碼 (SCID = 'SC01')
2. 讀取參數資料區 (PTDA01)
3. 呼叫P31設定日期格式
4. 設定功能權限 (@A01)
5. 讀取部門和參數檔資料
6. 初始化明細畫面 (R1C00)

### 明細初始化 (R1C00)
1. 初始化明細序號、子檔計數器和金額累計
2. 清空並初始化子檔畫面
3. 根據傳入的分錄號碼讀取傳票檔 (GLAHLF01)
4. 將讀取的傳票明細資料移至子檔畫面
5. 計算總借方和總貸方金額
6. 若借貸金額不平衡則建立平衡分錄 (R1C20)
7. 更新子檔計數器

### 讀取分錄明細資料顯示 (R1C10)
1. 從傳票檔讀取明細資料
2. 設定子檔顯示欄位值
3. 根據借貸方金額判斷寫入借方或貸方子檔

### 自動建立平衡分錄 (R1C20)
1. 讀取累計損益科目資料
2. 設定平衡分錄的會計項目和相關欄位
3. 計算並設定平衡金額
4. 寫入子檔畫面

### 檢核及儲存分錄資料 (R2D00)
1. 檢核分錄明細資料 (R2D10)
2. 若無錯誤則儲存分錄資料 (R2D30)
3. 若按F9則呼叫傳票列印程式 (GLR1K0)
4. 設定返回代碼為'00'表示成功執行

### 分錄資料檢核 (R2D10)
1. 檢查明細資料是否存在
2. 檢查借貸方金額是否平衡
3. 逐一檢核各明細資料的有效性

### 明細資料儲存至傳票檔 (R2D30)
1. 呼叫GLS002取得分錄號碼
2. 設定傳票主檔資料
3. 逐一儲存明細資料到傳票檔 (R2D40)

### 儲存明細資料 (R2D40)
1. 設定明細欄位值
2. 設定更新時間、日期及使用者資訊
3. 寫入傳票檔

### 明細細項編輯 (R3000, R4000)
1. 顯示明細細項輸入畫面
2. 檢核使用者輸入 (R3B00, R4B00)
3. 保存使用者輸入資料 (R4D00)

### 查詢功能 (R3E00, R4E00)
1. 根據游標位置判斷查詢項目
2. 呼叫對應查詢程式 (GLI410, GLI440, GLI1E0等)
3. 處理查詢結果

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0012**：數值欄位必須大於零
- **UPT0030**：欄位資料格式錯誤
- **UPT2010**：資料不存在
- **UPT2150**：無權限執行此功能
- **UGL0009**：會計項目非有效狀態
- **UGL0010**：借貸方金額必須擇一輸入
- **UGL0011**：借貸方金額必須相等
- **UGL0012**：明細資料不存在

### 錯誤處理
- 檔案錯誤處理 (ERRSR)：呼叫P50取得錯誤訊息
- 設定對應的錯誤指示燈 (IN60-IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

### 返回代碼
- **'00'**：處理成功
- **'03'**：使用者按下F3離開
- **'12'**：使用者按下F12返回

## 8. 備註

本程式是GLA530年結分錄作業的執行模組，具有以下特點：

1. 負責年結分錄的實際處理作業，執行從GLA530傳來的分錄資料
2. 支援傳票資料的讀取、顯示和編輯功能
3. 提供自動平衡功能，確保借貸方金額平衡
4. 支援會計項目查詢、部門代碼查詢等功能
5. 執行自動檢核，確保分錄資料的正確性：
   - 借貸平衡檢查
   - 會計項目有效性檢查
   - 明細資料完整性檢查
6. 儲存分錄資料至傳票檔，完成年結分錄作業

此程式是會計年度結束時的重要工具，配合GLA530程式使用，協助會計人員建立正確的年結調整分錄，確保年結作業的正確性和完整性。 
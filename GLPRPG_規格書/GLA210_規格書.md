# GLA210 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA210
- **程式說明**：會計科目備註設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA210
- **開發人員**：A1150
- **建立日期**：81/12/29
- **修改日期**：
- **系統**：總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAFPF**：會計科目檔案
- **GLAAPF**：會計科目名稱檔案
- **GLAEPF**：分類科目檔案
- **PT#BPF**：參數檔案
- **GLA210D**：螢幕顯示檔案 (含子檔)

### 程式關係
- **主程式**：GLA210
- **呼叫程式**：
  - GLI410：科目瀏覽查詢程式
  - S#S01：權限檢查程式
  - P31：日期格式處理程式
- **功能鍵**：F3(離開), F12(返回), F18(科目瀏覽), ROLLUP(下一頁)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置
  - #DRRN (378-379)：顯示紀錄號碼

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $INQ (138-138)：查詢權限
  - $UPD (136-136)：修改權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：日期
  - $C8YMD (209-216)：日期

- **分類科目工作變數**
  - ARF, ART：科目備註設定數值陣列
  - WAE04, WAE05：螢幕顯示用科目備註設定數值
  - @DRCD：顯示紀錄數量
  - @PRCD：每頁筆數
  - @BOTOM：是否到達檔案結尾標記
  
- **鍵值列表**
  - KEYAF：會計科目檔主鍵 (公司別+科目)
  - KEYAE：分類科目檔主鍵 (公司別+備註代碼)
  - KEY#B：公司別索引鍵
  - KEYAA：會計科目名稱檔主鍵 (公司別+科目)

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPD1)
- **螢幕標題**：會計科目備註設定作業
- **輸入欄位**：
  - 公司別 (DAF01)：必填
  - 建立日期 (DAF02)：必填

- **功能鍵**：
  - F3：結束程式
  - F18：科目瀏覽查詢

### 子檔畫面 (SFLCR)
- **螢幕標題**：會計科目備註設定作業
- **顯示欄位**：
  - 公司別、建立日期
  - 分類設定相關資訊（1.借貸科目、2.稅額、3.會計科目1、4.會計科目2、5.其他）
  - 備註代碼及說明
  
- **子檔欄位**：
  - 選項 (DOPT)：輸入"/"執行設定
  - 序號 (RRN)：顯示序號
  - 科目代碼 (AE02)：科目代碼
  - 五種分類科目設定值與標記 (AE041-AE045, AE051-AE055)

- **功能鍵**：
  - F3：結束程式
  - F12：返回主畫面
  - ROLLUP：下一頁

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 依據畫面代碼(SCID)執行不同處理流程
   - SC01：顯示主畫面，接收公司別和建立日期
   - SC02：顯示子檔畫面，處理分類科目備註設定

### 程式初始化流程 (R0100)
1. 讀取參數資料區
2. 呼叫P31設定日期格式
3. 初始化畫面ID為SC01
4. 初始化公司別與建立日期欄位為空白

### SC01畫面流程 (R1000)
1. 顯示主畫面並等待使用者輸入
2. 若按F3：結束程式
3. 若按F18：呼叫科目瀏覽程式 (R1A00)
4. 若按ENTER：檢核輸入資料 (R1B00)
5. 若檢核通過：初始化子檔 (R1C00)並切換至SC02畫面

### SC02畫面流程 (R2000)
1. 顯示子檔畫面並等待使用者輸入
2. 若按F3：結束程式
3. 若按F12：返回主畫面 (SC01)
4. 若按ROLLUP：顯示下一頁資料 (R2N00)
5. 若選擇特定科目設定：處理用戶輸入的選項 (R2C00)

## 6. 子程序處理邏輯說明

### 科目瀏覽查詢 (R1A00)
1. 檢查用戶是否有查詢權限 (S#S01)
2. 呼叫GLI410程式進行科目瀏覽
3. 將查詢結果回傳至主畫面

### 主畫面資料檢核 (R1B00)
1. 檢查用戶是否有修改或查詢權限
2. 檢查公司別是否有輸入
3. 檢查建立日期是否有輸入
4. 檢查公司別和建立日期是否存在於會計科目檔中
5. 若有任何檢核失敗，顯示對應錯誤訊息

### 子檔初始化 (R1C00 + R2A00)
1. 設定每頁顯示筆數為6筆
2. 清除子檔資料 (SFLCLR)
3. 設定子檔控制指示燈 (SFLDSPCTL)
4. 準備子檔標題資訊 (R2A20)
5. 依公司別取得分類科目資料
6. 將分類科目資料加入子檔中 (R2A10 + R2A11)
7. 若有資料，顯示子檔；若無資料，顯示無資料訊息

### 分類科目資料加入子檔 (R2A10 + R2A11)
1. 根據公司別讀取分類科目資料
2. 檢查各分類科目設定值的有效性
3. 將有效的分類科目資料寫入子檔

### 科目設定處理 (R2C00)
1. 讀取用戶選擇的子檔記錄
2. 處理用戶對特定科目的備註設定
3. 更新會計科目檔中的備註設定資訊
4. 清除選項並返回主畫面 (SC01)

### 下一頁處理 (R2N00)
1. 檢查是否已到達檔案結尾
2. 若未結尾，加載下一頁資料
3. 若已結尾，顯示已到最後一頁訊息

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT2150**：使用者無權限執行此功能
- **UPT0010**：必填欄位未輸入 (公司別/建立日期)
- **UPT2010**：公司別/建立日期不存在
- **UPT2050**：無查詢資料
- **CPF5203**：已顯示最後一頁

### 錯誤處理
- 設定對應的錯誤指示燈
- 返回主畫面並顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於設定會計科目的備註分類，主要功能包括：

1. 依公司別和建立日期查詢會計科目
2. 設定每個會計科目的備註分類，包含五種不同類型：
   - 借貸科目分類
   - 稅額分類
   - 會計科目分類1
   - 會計科目分類2
   - 其他分類
3. 每種分類都有數值和標記兩部分，用於會計報表產生時的分類依據
4. 維護完成後，更新會計科目檔中的備註設定
5. 此程式為總帳系統的基礎設定功能，對於財務報表的正確產出至關重要

程式使用子檔顯示多筆會計科目記錄，便於使用者一次維護多個科目的備註設定，提高作業效率。維護完成後，使用者可以即時看到更新結果，確保資料一致性。 
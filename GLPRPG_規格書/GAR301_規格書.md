# GAR301 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR301
- **程式說明**：會計科目一覽表
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR301
- **開發人員**：MERCURY
- **建立日期**：82/01/19
- **系統名稱**：台灣積體電路
- **子系統**：總帳系統
- **備註**：會計科目一覽表報表產生程式
- **聯絡電話**：5042266

## 2. 檔案架構與關聯圖
### 使用檔案：
- **顯示檔案**
  - GAR301D：會計科目一覽表螢幕顯示檔
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - P31：日期轉換程式
  - P64I：印表機選擇程式

## 3. 檔案欄位規格說明

### 資料區定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| $PFMT | 1 | 1 | 字元 | 參數區日期格式 |
| $PTYPE | 2 | 1 | 字元 | 參數區日期型態 |
| $USER | 101-110 | 10 | 字元 | 使用者代號 |
| $CPY | 125-127 | 3 | 數值 | 列印份數 |
| $INQ | 138 | 1 | 字元 | 查詢標記 |
| $USERN | 152-161 | 10 | 字元 | 使用者名稱 |
| $A8YMD | 201-208 | 8 | 數值 | 系統起始日期 |
| $C8YMD | 209-216 | 8 | 數值 | 系統結束日期 |
| $PRTCD | 217-218 | 2 | 字元 | 列印機台 |
| $PENV | 219 | 1 | 字元 | 輸出裝置 |

### 程式使用資料定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| DAC01S | 601-602 | 2 | 字元 | 科目起始碼 |
| DAC01E | 603-604 | 2 | 字元 | 科目結束碼 |
| DAC02S | 605-608 | 4 | 數值 | 會計年度起始值 |
| DAC02E | 609-612 | 4 | 數值 | 會計年度結束值 |
| WAC02S | 613-616 | 4 | 數值 | 會計年度起始暫存 |
| WAC02E | 617-620 | 4 | 數值 | 會計年度結束暫存 |

### GAR301D（螢幕顯示檔）
| 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| DSPD1 | - | - | - | - | 主螢幕格式 |
| DAC01S | 11,39 | 2 | A | B | 科目起始碼 |
| DAC01E | 13,39 | 2 | A | B | 科目結束碼 |
| DAC02S | 15,39 | 4 | P | B | 會計年度起始值 |
| DAC02E | 17,39 | 4 | P | B | 會計年度結束值 |
| $PRTCD | 19,41 | 2 | A | B | 列印機台 |

### 程式內部變數
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| #CSR | 數值 | 10 | 游標位置 |
| #LIN | 數值 | 5 | 游標行位置 |
| #COL | 數值 | 5 | 游標列位置 |
| ERRID | 字元 | 7 | 錯誤代碼 |
| ERRF | 字元 | 10 | 錯誤檔案 |
| @PRT | 字元 | 1 | 列印控制旗標 |

## 4. 輸出/入螢幕布局與說明

### 1. 主畫面布局
```
<GAR301.1>                     [公司名稱]                        [日期]
[使用者ID]                     會計科目一覽表

                         


                         
                         
                         科目起: [  ]
                         
                         科目迄: [  ]

                         年度起: [    ]

                         年度迄: [    ]

                         列印機台: [  ]


[錯誤訊息顯示區域]
注意    PF3 =回主畫面    PF4 =提示    PF14 =處理作業
                                                           【台灣積體電路】
```

## 5. 處理流程程序說明

### 主程序流程
1. 若指示燈10為開，則執行初始化訊息設定（R0200）
2. 若指示燈10為關，則執行初始化畫面設定（R0100）
3. 初始化列印旗標（@PRT）為空白
4. 循環執行主畫面處理（R1000），直到使用者按下PF3（指示燈03=開）或列印旗標（@PRT）為'Y'
5. 若指示燈03為開，則設定結束程式指示燈（LR）並返回

### 初始化畫面設定程序（R0100）
1. 設定指示燈10和27為開
2. 讀取參數資料區（PTDA01）
3. 呼叫日期處理程式（P31）轉換系統日期為顯示日期格式
4. 初始化科目起始碼（DAC01S）和科目結束碼（DAC01E）為空白
5. 初始化會計年度起始值（DAC02S）和會計年度結束值（DAC02E）為0

### 初始化訊息設定程序（R0200）
1. 設定指示燈27和99為開
2. 根據執行環境變數（$PENV）設定不同的訊息代碼：
   - $PENV='0'（查詢模式）：錯誤代碼UPT2142
   - $PENV='1'（線上模式）：錯誤代碼UPT2140
   - $PENV='2'（批次模式）：錯誤代碼UPT2110

### 主畫面處理程序（R1000）
1. 顯示主畫面（DSPD1）
2. 清除所有指示燈（60-99）
3. 初始化游標位置變數（#LIN和#COL）
4. 當使用者按下PF3（指示燈03=開）時，返回主程序
5. 當使用者按下PF4（指示燈04=開）時，呼叫提示處理子程序（R1E00）並返回主畫面
6. 執行資料檢核程序（R1B00）
7. 當使用者按下PF14（指示燈14=開）且無錯誤（指示燈99=關）時：
   - 關閉主畫面（指示燈27=關）
   - 顯示處理中提示（指示燈28=開）
   - 更新畫面並關閉處理中提示
   - 將資料寫入LDA資料區
   - 設定列印旗標（@PRT）為'Y'

### 資料檢核程序（R1B00）
1. 檢核科目起始碼（DAC01S）：
   - 若為空白，設定為最小值（*LOVAL）
2. 檢核科目結束碼（DAC01E）：
   - 若為空白，設定為最大值（*HIVAL）
3. 檢核科目代碼起迄關係：
   - 若起始碼大於結束碼，顯示錯誤訊息UPT0042
4. 檢核年度起始值（DAC02S）：
   - 若為0，保持為0
5. 檢核年度結束值（DAC02E）：
   - 若為0，設定為9999
6. 檢核年度起迄關係：
   - 若起始年度大於結束年度，顯示錯誤訊息UPT0042
7. 檢核功能權限：
   - 若非批次處理模式（$PENV≠'2'）且無查詢權限（$INQ≠'Y'），顯示錯誤訊息UPT2150

### 提示處理程序（R1E00）
1. 計算游標行列位置（將#CSR除以256得到#LIN和#COL）
2. 當游標位於列印機台欄位（行=17，列=41-42）時：
   - 呼叫印表機選擇程式（P64I）
   - 傳遞當前列印機台代號，接收新的列印機台代號

## 6. 子程序處理邏輯說明

### P31 - 日期轉換程式
- 功能：將日期轉換為指定的格式
- 參數：
  * P3101I：輸入日期
  * P3102I：日期類型
  * P3103I：日期格式
  * P3104I：輸出類型
  * P3105I：輸出格式
- 回傳：P3101O（格式化後的日期值）

### P64I - 印表機選擇程式
- 功能：提供印表機代號選擇
- 參數：P64II1（輸入/輸出印表機代號，$PRTCD）
- 回傳：更新後的印表機代號

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0042 | PTMF | 起始值不可大於結束值 |
| UPT2110 | PTMF | 批次處理模式訊息 |
| UPT2140 | PTMF | 線上模式訊息 |
| UPT2142 | PTMF | 查詢模式訊息 |
| UPT2150 | PTMF | 無此功能權限 |

## 8. 備註

1. 本程式為會計總帳系統的會計科目一覽表報表產生程式。
2. 程式提供簡化的用戶界面，主要讓使用者指定報表的查詢條件及輸出方式。
3. 提供科目代碼區間、會計年度區間等條件篩選功能。
4. 科目起始碼若未指定，預設為系統最小值（*LOVAL）。
5. 科目結束碼若未指定，預設為系統最大值（*HIVAL）。
6. 會計年度起始值若未指定，預設為0。
7. 會計年度結束值若未指定，預設為9999。
8. 本程式主要用於會計部門產生科目清單報表，便於會計人員檢視科目結構。
9. 執行環境變數（$PENV）設定：0-查詢模式、1-線上模式、2-批次模式。
10. 權限控管透過$INQ變數實現，確保未授權使用者無法執行此功能。 
# GLA7801 程式功能規格書

## 1. 基本資料
- 程式編號: GLA780
- 程式名稱: 帳冊結轉作業
- 作者: A1087 JOYCE
- 建立日期: 1992.11.06
- 修改日期: -
- 系統名稱: 會計帳冊

## 2. 檔案架構與關聯圖

程式GLA7801使用下列檔案:
- GLAHLF01 (更新) - 主檔案
- GLAILF01 (更新) - 年度沖帳餘額檔
- GLALPF (更新) - 沖帳餘額主檔
- GLALLF03 (更新) - 沖帳餘額檔(待處理檔)
- GLALLF01 (更新) - 沖帳餘額檔(待處理檔)
- GLAKPF (輸入) - 參數檔
- GLAMPF (更新) - 沖帳餘額明細檔
- GLAMLF01 (更新) - 沖帳餘額明細檔(待刪除)
- GLAFPF (輸入) - 帳款參數檔
- GLA7801D (螢幕輸入/輸出) - 螢幕子檔(SFLSRA/SFLSRB)
- GLACPF (輸入) - 會計參數檔(僅供共用)
- GLACLF01 (輸入) - 系統參數檔(僅供共用)

檔案間關聯:
- GLAHLF01 為主檔案，包含需處理的帳款資料
- GLAFPF 檔案通過 AH01/AH04 欄位與主檔案關聯，提供帳款參數設定
- GLAILF01 檔案儲存年度沖帳餘額，透過 KEYAI/KEYAI1 關聯
- GLALPF 檔案儲存沖帳餘額主檔，透過 KEYLA/KEYLB 關聯
- GLALLF01/GLALLF03 檔案處理沖帳餘額待處理檔案，透過 KEYLA1/KEYLB1 關聯
- GLAMPF 檔案儲存沖帳餘額明細檔，透過 KEYAM/KEYAL 關聯
- GLAMLF01 檔案存放待刪除的明細記錄

## 3. 檔案名稱與欄位規格

### GLAHLF01
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AH01    | 公司別   | -    | 2    | 字元 | 主鍵     |
| AH02    | 帳款編號 | -    | 9    | 字元 | 主鍵     |
| AH04    | -       | -    | -    | 字元 | 與GLAFPF關聯 |
| AH05-AH09| -      | -    | -    | 字元 | 類別細分代碼 |
| AH10    | 帳款內容 | -    | 80   | 字元 | -       |
| AH12    | 借方金額 | -    | -    | 數值 | -       |
| AH13    | 貸方金額 | -    | -    | 數值 | -       |
| AH17    | -       | -    | -    | 字元 | 前次資料儲存 |
| AH18    | 處理旗標 | -    | 1    | 字元 | 初始化為空白 |
| AH19    | -       | -    | -    | 字元 | 來自AK02 |
| AH21    | -       | -    | -    | 數值 | 結轉後初始化為0 |
| AH22    | -       | -    | -    | 字元 | -       |
| AH23    | -       | -    | -    | 數值 | -       |

### GLAILF01
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AI01    | 公司別   | -    | -    | 字元 | -       |
| AI02    | 會計年度 | -    | 4    | 數值 | -       |
| AI03    | -       | -    | -    | 字元 | -       |
| AI04-AI08| -      | -    | -    | 字元 | -       |
| AI10-AI10B| -     | -    | -    | 數值 | -       |
| WAI1    | 實際餘額 | -    | 13x13| 數值 | 儲存每月餘額 |
| WAI2    | 借方金額 | -    | 13x13| 數值 | 儲存每月借方 |
| WAI3    | 貸方金額 | -    | 13x13| 數值 | 儲存每月貸方 |

### GLALPF
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AL01    | 公司別   | -    | -    | 字元 | -       |
| AL02    | -       | -    | -    | 字元 | -       |
| AL03    | 帳款編號 | -    | -    | 字元 | -       |
| AL04-AL08| -      | -    | -    | 多種 | 類別細分代碼 |
| AL09    | 沖帳餘額 | -    | -    | 數值 | -       |
| AL10    | 沖帳總額 | -    | -    | 數值 | -       |
| AL11    | 沖帳期數 | -    | -    | 數值 | -       |

### GLAMPF
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AM01-AM08| -      | -    | -    | 多種 | 對應AL01-AL08 |
| AM09    | 帳款編號 | -    | -    | 字元 | -       |
| AM10    | -       | -    | -    | 數值 | -       |
| AM11    | 已沖金額 | -    | -    | 數值 | -       |

## 4. 輸出/入螢幕布局與說明
程式使用GLA7801D螢幕檔案進行畫面處理，主要包含:
- SFLSRA 子檔 - 用於顯示沖帳資料
- SFLSRB 子檔 - 用於顯示沖出資料
程式透過這兩個子檔顯示沖帳/沖出資訊，並進行相關處理。

## 5. 處理流程程序說明

程式主要流程:
1. 初始化參數與相關變數 (R0100)
2. 初始化螢幕子檔 (R0200)
3. 讀取主檔案 GLAHLF01 的帳款資料
4. 處理每筆帳款資料
   a. 計算年度沖帳餘額 (R1000)
   b. 更新帳款旗標與資訊 (AH18, AH19等)
5. 若有資料，執行沖帳處理 (R2000)
6. 計算總計並更新總帳 (R8000)
7. 更新大量帳款 (R3000)
8. 結束程式

## 6. 子程序處理邏輯說明

### R0100 - 初始化
- 初始化程式參數與工作變數
- 讀取參數檔案GLAKPF
- 呼叫日期處理程式P31
- 設定系統日期

### R0200 - 初始化螢幕子檔
- 清除子檔記錄計數器(RRNA/RRNB)
- 初始化螢幕資料

### R1000 - 計算年度沖帳餘額
- 呼叫R1A00取得會計年度
- 通過KEYAF關聯取得GLAFPF資料
- 若找到相關記錄，則計算年度沖帳餘額
- 更新或寫入GLAILF01檔案
- 若為損益表科目，則計算並累計損益差額

### R1A00 - 會計年度計算
- 呼叫GLS005系統程式取得會計年度與期間
- 設定WY(會計年度)與WM(會計期間)變數

### R1100 - 更新/寫入年度沖帳餘額檔
- 若GLAILF01無相關記錄，則建立新記錄
- 依據借貸屬性(AF06)計算實際餘額
- 減少相應月份的餘額、借方和貸方金額(結轉操作)
- 更新檔案時間戳記
- 寫入或更新GLAILF01檔案

### R2000 - 處理沖帳作業
- 讀取GLAMLF01檔案記錄
- 更新GLALPF檔案中的沖帳總額
- 刪除GLAMLF01檔案記錄
- 處理GLALLF03檔案記錄
- 根據沖帳情況填充子檔資料
- 處理沖入/沖出操作

### R2100 - 將資料寫入螢幕子檔
- 根據沖帳金額(AM11)判斷是沖帳還是沖出
- 若AM11>0，則寫入SFLSRA子檔(沖帳)
- 若AM11<=0，則寫入SFLSRB子檔(沖出)
- 增加對應的記錄計數器

### R2200 - 處理沖入沖銷登錄
- 循環處理子檔記錄
- 讀取對應的GLALLF01檔案記錄
- 處理沖帳餘額與沖帳總額差額調整
- 更新GLALLF01檔案
- 新增/更新沖帳明細檔(GLAMPF)
- 新增/更新沖帳餘額主檔(GLALPF)

### R2300 - 處理沖出沖銷
- 循環處理子檔記錄
- 讀取對應的GLALPF檔案記錄
- 處理沖帳餘額與沖帳總額差額調整
- 更新GLALPF檔案
- 新增/更新沖帳明細檔(GLAMPF)

### R3000 - 更新大量帳款
- 讀取GLAHLF01檔案記錄
- 將AH21欄位重置為0
- 更新檔案時間戳記
- 更新GLAHLF01檔案

### R8000 - 處理總計
- 呼叫GLS005系統程式取得會計年度與期間
- 通過KEYAK關聯讀取GLAKPF主檔
- 設定GLAILF01檔案的鍵值
- 若檔案不存在則建立新記錄
- 減少對應月份的總計金額
- 更新檔案時間戳記
- 寫入或更新GLAILF01檔案

## 7. 錯誤處理程序說明與訊息清冊

錯誤處理:
- 當找不到相關記錄時，設置對應的指示器(例如*IN40, *IN48等)
- 程式各流程中會檢查相關記錄是否存在，進行適當的處理
- 在檔案讀取與處理過程中，使用指示器控制流程，確保資料一致性

## 8. 備註

1. 此程式為會計帳冊系統中的帳冊結轉作業程式，負責處理年度結帳時的帳款結轉。
2. 程式處理多個檔案間的資料關聯，執行沖帳、結轉與清除操作。
3. 程式包含螢幕處理功能，使用子檔顯示沖帳/沖出資訊，方便操作人員查看。
4. 程式使用RPG III語言撰寫，包含多個子程序處理不同功能。
5. 處理流程設計具備錯誤檢查與資料一致性維護，確保帳冊結轉的正確性。
6. 程式在結轉過程中會重置相關帳款記錄，並更新年度餘額資料。 
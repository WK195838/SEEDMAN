# GLA352 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA352
- **程式說明**：報表格式設定子程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA352
- **開發人員**：A1149 MAY
- **建立日期**：1992.11.06
- **修改日期**：
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLARPF**：報表格式主檔
- **GLASPF**：報表格式子檔
- **GLAXPF**：公司代號檔案
- **GLAFPF**：會計科目檔案
- **GLASLF01**：會計科目資料檔案
- **PT#BPF**：參數檔案
- **PT#YPF**：參數檔案
- **GLA352D**：螢幕顯示檔案（含子檔）

### 程式關係
- **主程式**：GLA352
- **呼叫程式**：
  - GLI410：科目瀏覽查詢程式
  - P31：日期格式處理程式
  - 在F19功能下會動態呼叫參數檔中定義的程式
- **被呼叫**：可能由報表格式相關程式如GLA351透過F19功能鍵呼叫
- **功能鍵**：F3(離開), F4(提示), F5(儲存), F12(返回), F19(特殊處理), F25(下一頁)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置
  - #DRRN (378-379)：顯示記錄號

- **DS#ASL**
  - ##ASL (397-400)：ASLF01 檔案的相對記錄號

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **資料結構**
  - DAS06 (1-8)：科目定義結構
    - W02 (1-2)：科目類型符號
    - W06 (3-6)：科目代號
    - W01 (1-1)：科目首碼
    - W05 (2-5)：科目代號

  - DAS07 (1-8)：科目定義結構
    - #02 (1-2)：科目類型符號
    - #06 (3-6)：科目代號
    - #01 (1-1)：科目首碼
    - #05 (2-5)：科目代號

### 主要欄位說明
- **KEYAS**：子檔鍵值 (AS01+AS02+AS03+AS04)
- **KEYAR**：主檔鍵值 (AR01+AR02+AR03)
- **KEYARC**：複製記錄鍵值 (AR01C+AR02C+AR03C)
- **KEY#Y**：參數檔鍵值
- **KEYAF**：會計科目檔鍵值 (DAF01+DAF02)
- **KEY#B**：公司檔鍵值
- **KEYAX**：公司資料鍵值

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPC1)
- **螢幕標題**：報表格式設定子程式
- **畫面描述**：
  - 上半部顯示報表格式主檔資訊
  - 下半部為子檔明細資料，使用子檔顯示

- **輸入欄位**：
  - 主檔資訊：
    - 公司別 (DAR01)：2碼
    - 報表代碼 (DAR02)：2碼，固定為設計格式代碼21
    - 格式代碼 (DAR03)：3碼
    - 說明 (DAR04)：30碼
    - 屬性 (DAR05)：1碼，1=餘額表，2=期間表

  - 子檔資訊 (每行顯示)：
    - 刪除標記 (DDEL)：1碼，4=刪除
    - 新增標記 (DNEW)：1碼，Y=新增
    - 類型 (DAS04)：4碼
    - 正負號 (DAS05)：1碼，+/-
    - 起始科目 (DAS06)：8碼
    - 結束科目 (DAS07)：8碼
    - 明細/合計 (DAS08)：1碼
    - 標題 (DAS09)：30碼
    - 部門 (A)：8碼
    - 部門說明 (DAS10)：20碼

- **功能鍵**：
  - F3：回前一畫面
  - F4：提示功能
  - F5：確認儲存
  - F12：回前一畫面
  - F19：特殊處理功能（呼叫其他相關程式）
  - F25：下一頁

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 若為複製模式，讀取來源資料 (R1CB0, R1CE0)
3. 初始化子檔資料 (R1CD0)
4. 顯示主畫面並等待使用者輸入 (R1000)
5. 根據功能鍵或選項執行不同處理：
   - F3/F12：結束程式
   - F4：提供欄位提示功能 (R1E00)
   - F5：檢核輸入資料並儲存 (R1B00, R2D00)
   - F19：執行特殊處理功能 (R1F00)
   - F25：顯示下一頁子檔資料

### 程式初始化流程 (R0100)
1. 讀取參數資料區
2. 呼叫P31設定日期格式
3. 設定各項權限標記
4. 初始化各項輸入欄位
5. 根據選項設定相應的處理模式（新增、修改、刪除、查詢）
6. 讀取公司資料及報表代碼資料
7. 處理複製來源資料（若有指定複製來源）

### 子檔處理流程 (R1C00)
1. 初始化子檔顯示設定 (R1CC0)
2. 根據操作選項執行不同處理：
   - 新增且無複製來源：初始化主檔及明細資料 (R1CA0, R1CD0)
   - 新增且有複製來源：讀取來源資料並複製 (R1CB0, R1CE0, R1CD0)
   - 修改：讀取原有資料 (R1CB0, R1CE0, R1CD0)
   - 刪除/查詢：只讀取資料，不允許修改 (R1CB0, R1CE0)
3. 設定子檔顯示及控制指標

## 6. 子程序處理邏輯說明

### 子檔初始化 (R1CC0)
1. 設定子檔顯示參數：每頁顯示9筆，子檔範圍從第12行到第20行
2. 清除子檔並設定子檔控制指標
3. 初始化記錄計數器

### 子檔資料初始化 (R1CD0)
1. 根據當前記錄數計算需要顯示的記錄數
2. 逐筆新增空白記錄至子檔
3. 更新最後記錄號及顯示記錄號

### 特殊處理功能 (R1F00)
1. 從參數檔中讀取指定的處理程式（報表代碼21的相關設定）
2. 呼叫對應的處理程式，傳遞必要的參數
3. 處理呼叫結果

### 資料驗證 (R1B00)
1. 對子檔中每一筆記錄執行檢核 (R1B10)
2. 主要檢核內容：
   - 檢查類型欄位 (DAS04) 是否符合規定格式 (@0-@9, @S, @T, @-, @C)，注意本程式中使用@T而非GLA351中的@R
   - 檢查起始科目 (DAS06) 是否存在於會計科目檔
   - 檢查結束科目 (DAS07) 是否存在且大於或等於起始科目
   - 檢查部門代碼 (A) 是否有效
   - 若有錯誤，設定相應的錯誤代碼及指示燈

### 檔案處理 (R2D00)
1. 根據操作選項執行不同的檔案處理：
   - 新增 (R2D10)：寫入主檔及子檔資料
   - 修改 (R2D20)：更新主檔及子檔資料，處理刪除標記
   - 刪除 (R2D30)：刪除主檔及相關子檔資料

### 檔案新增處理 (R2D10)
1. 讀取子檔中的每一筆記錄
2. 轉換螢幕資料為檔案格式 (R2D11)
3. 寫入主檔及子檔資料
4. 設定操作模式為修改，以便於後續操作

### 檔案修改處理 (R2D20)
1. 讀取子檔中的每一筆記錄
2. 判斷記錄狀態：新增、修改或刪除
3. 根據狀態執行相應操作：
   - 刪除標記=4：從檔案中刪除記錄
   - 空白記錄：判斷是否需要刪除
   - 有效記錄：更新檔案中的資料
4. 更新主檔資料

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0011**：結束科目不可為空白
- **UPT0030**：輸入資料錯誤
- **UPT0042**：起始科目不可大於結束科目
- **UPT2050**：無資料
- **UPT2072**：新增作業已完成
- **UPT2075**：修改作業已完成
- **UPT2150**：使用者無權限執行此功能
- **UGL0013**：科目已結案，不可使用

### 錯誤處理
- 設定對應的錯誤指示燈 (IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位
- 對於功能完成的訊息，顯示成功訊息並繼續處理

## 8. 備註

本程式為報表格式設定的專用子程式，與GLA351結構類似，但專用於特定類型（報表代碼21）的報表格式設定。程式提供完整的資料檢核機制，確保輸入資料的正確性和一致性。

特殊功能說明：
1. 科目範圍設定：可設定起始科目和結束科目，定義報表要包含的科目範圍
2. 科目類型設定：支援多種科目類型代碼 (@0-@9, @S, @T, @-, @C)，用於不同的統計和報表顯示需求
3. 提供資料複製功能：可從現有報表格式複製設定，提高工作效率
4. 彈性的部門設定：可指定特定部門的資料
5. 支援正負號設定：用於控制金額的正負顯示
6. 特殊處理功能 (F19)：可呼叫特定處理程式進行特殊操作

科目類型代碼說明：
- @0-@9：一般科目代碼
- @S：特殊處理代碼
- @T：特殊表格處理代碼（區別於GLA351中的@R範圍代碼）
- @-：減項處理代碼
- @C：合計處理代碼

本程式與GLA351功能相似，但專注於特定類型報表的格式設定，提供了額外的特殊處理功能，使報表格式設定更加靈活和專業化。 
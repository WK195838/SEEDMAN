# GLA780 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA780
- **程式說明**：結帳分錄作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA780
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.06
- **修改日期**：-
- **系統**：會計總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAKPF**：會計參數檔
- **GLAGPF**：大帳主檔
- **GLAHLF01**：會計認證主檔
- **GLA780D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA780
- **呼叫程式**：
  - P31：日期格式處理程式
  - GLA7801C：控制程式
- **子程式**：
  - GLA7801：實際結帳處理程式

## 3. 檔案欄位規格說明

### GLAKPF (會計參數檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 公司別 | 字元 | 主索引鍵 |
| AK09 | 日期顯示格式 | 字元 | - |
| AK10 | 會計期間類別 | 字元 | 1=12期間, 2=13期間 |
| AK13 | 最大查詢月數 | 數值 | - |
| AK15 | 公司啟用狀態 | 字元 | - |

### GLAHLF01 (會計認證主檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH01 | 公司別 | 字元 | 主索引鍵之一 |
| AH02 | 認證編號 | 字元 | 主索引鍵之二 |
| AH10 | 認證日期 | 數值 | - |
| AH11 | 認證總金額 | 數值 | - |
| AH18 | 狀態 | 字元 | V=已結案 |

### GLAGPF (大帳主檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AG01 | 公司別 | 字元 | 主索引鍵之一 |
| AG02 | 年度 | 數值 | 主索引鍵之二 |
| AG03 | 大帳認證編號 | 字元 | 為結帳後產生的認證編號 |

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPD1)
- **畫面標題**：結帳分錄作業
- **輸入欄位**：
  - 公司別 (DAH01)：必填，需為有效公司別
  - 認證編號 (DAH02)：必填，需為存在的認證編號
  - 大帳認證編號 (DAG03)：顯示欄位，結帳後會顯示對應的大帳認證編號

- **功能鍵**：
  - F3：結束
  - F14：處理作業

## 5. 處理流程程序說明

### 主要流程
1. 初始化環境和畫面 (R0100)
2. 執行主畫面處理 (R1000)：
   - 顯示主畫面並等待使用者輸入
   - 檢查輸入資料 (R1B00)
   - 若按下 F14 則呼叫結帳處理程式 (GLA7801C)
3. 程式結束

### 結帳處理流程
1. 呼叫控制程式 GLA7801C
2. 控制程式會：
   - 設定檔案共享模式
   - 呼叫處理程式 GLA7801
   - 釋放資源
3. GLA7801 會：
   - 產生結帳分錄
   - 更新認證狀態
   - 產生大帳認證編號
   - 回傳處理結果

## 6. 子程序處理邏輯說明

### 初始化處理 (R0100)
- 設定初始參數
- 取得系統日期
- 設定螢幕欄位為空值
- 設定公司別和印表機參數

### 資料檢核 (R1B00)
1. 檢查公司別：
   - 必須輸入
   - 必須存在於會計參數檔案中
   - 公司必須為啟用狀態
2. 檢查認證編號：
   - 必須輸入
   - 必須存在於會計認證主檔中
3. 檢查認證狀態：
   - 檢查認證是否已結案，若已結案則顯示錯誤訊息
4. 檢查認證日期：
   - 檢查認證日期是否已超過最大查詢月數
5. 檢查操作權限：
   - 使用者必須具有新增、修改、刪除或查詢的權限

### 結帳處理 (透過 GLA7801)
1. 讀取認證資料
2. 產生大帳認證編號
3. 建立結帳分錄
4. 更新認證主檔狀態為已結案
5. 更新大帳主檔
6. 回傳處理結果

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 必填欄位不可為空白 |
| UPT2010 | PTMF | 資料不存在 |
| UPT2142 | PTMF | 處理完成提示 |
| UPT2150 | PTMF | 使用者無權限操作 |
| UGL0013 | GLMF | 公司別未啟用 |
| UGL0029 | GLMF | 無效的認證期間 |
| UGL0030 | GLMF | 認證已結案 |
| UGL0032 | GLMF | 認證日期超過最大查詢月數 |

## 8. 備註

1. 本程式為會計總帳系統中的結帳分錄作業程式，用於將會計認證主檔中的記錄進行結帳處理。
2. 結帳處理將會更新認證狀態為已結案，表示該認證已經完成結帳程序，不可再進行修改。
3. 程式會產生大帳認證編號，並更新到大帳主檔中，便於後續查詢和報表產生。
4. 結帳作業是會計系統中的重要流程，必須確保所有認證資料正確無誤後才能進行結帳。
5. 結帳後的認證狀態會被標記為 'V'，表示已經結案，不可再進行修改或刪除。
6. 程式使用控制程式 GLA7801C 來進行實際的結帳處理，確保檔案共享和資源管理。
7. 實際的結帳處理邏輯由 GLA7801 程式負責執行，包括資料檢核、產生結帳分錄和更新相關檔案。
8. 程式結帳完成後會顯示處理完成的訊息，通知使用者結帳程序已經完成。 
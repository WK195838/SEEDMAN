# GLA120 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA120
- **程式說明**：總帳傳票登錄
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA120
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.19
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：提供總帳傳票登錄及維護功能
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHPF：傳票主檔（輸出模式）
  - GLANPF：傳票編號檔（輸入模式）
  - GLAOPF：傳票明細檔（輸入模式）
  - GLAPPF：輸入項目檔（輸入模式）
  - GLAQPF：交易項目檔（輸入模式）
  - GLAFPF：交易別檔（輸入模式）
  - GLAKPF：會計科目檔（輸入模式）
  - PT#BPF：部門檔（輸入模式）
- **螢幕檔案**
  - GLA120D：傳票登錄螢幕格式檔
  - SFLSR：資料子檔（傳票明細資料顯示用）
  - SFLSRC：資料子檔（貸方傳票明細顯示用）
  - SFLSRD：資料子檔（借方傳票明細顯示用）
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - GLA121：傳票修改程式
  - GLR1K0：傳票列印程式
  - GLS002：取得傳票號碼程式
  - GLS005：檢查會計期間程式
  - GLA190：總帳明細資料輸入程式
  - P30：日期檢核程式
  - P31：日期轉換程式
  - P64I：印表機設定程式
  - GLI310：傳票號碼查詢程式

## 3. 檔案欄位規格說明

### GLAHPF（傳票主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH01 | 部門代號 | 字元 | 主索引鍵之一 |
| AH02 | 傳票號碼 | 字元 | 主索引鍵之二 |
| AH03 | 明細筆數 | 數值 | 記錄傳票明細總筆數 |
| AH04 | 會計科目 | 字元 | |
| AH05 | 摘要內容1 | 字元 | |
| AH05A | 摘要內容1說明 | 字元 | |
| AH06 | 摘要內容2 | 字元 | |
| AH06A | 摘要內容2說明 | 字元 | |
| AH07 | 摘要內容3 | 字元 | |
| AH07A | 摘要內容3說明 | 字元 | |
| AH08 | 摘要內容4 | 字元 | |
| AH08A | 摘要內容4說明 | 字元 | |
| AH09 | 金額 | 數值 | |
| AH09A | 金額說明 | 字元 | |
| AH10 | 傳票日期 | 數值 | |
| AH12 | 借方金額 | 數值 | |
| AH13 | 貸方金額 | 數值 | |
| AH14 | 數量 | 數值 | |
| AH14A | 數量說明 | 字元 | |
| AH15 | 其他 | 字元 | |
| AH15A | 其他說明 | 字元 | |
| AH16 | 備註 | 字元 | |
| AH17 | 系統代碼 | 字元 | 預設為'GL' |
| AH18 | 保留欄位 | 字元 | |
| AH19 | 主要處理旗標 | 字元 | 'V'表示主要處理 |
| AH20 | 保留欄位 | 字元 | |
| AH21 | 大傳票日期 | 數值 | |
| AH22 | 摘要代號 | 字元 | |
| AH23 | 保留欄位 | 數值 | |
| AH24 | 傳票明細號碼 | 字元 | |
| AH97 | 建檔時間 | 時間 | |
| AH98 | 建檔日期 | 數值 | |
| AH99 | 建檔人員 | 字元 | |

### GLANPF（傳票編號檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AN01 | 部門代號 | 字元 | 主索引鍵之一 |
| AN02 | 傳票號碼 | 字元 | 主索引鍵之二 |
| AN03 | 傳票說明 | 字元 | |
| AH10 | 傳票日期 | 數值 | |
| AH21 | 大傳票日期 | 數值 | |

### GLAOPF（傳票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AO01 | 部門代號 | 字元 | 主索引鍵之一 |
| AO02 | 傳票號碼 | 字元 | 主索引鍵之二 |
| AO04 | 會計科目 | 字元 | |
| AO05 | 摘要內容1 | 字元 | |
| AO06 | 摘要內容2 | 字元 | |
| AO07 | 摘要內容3 | 字元 | |
| AO08 | 摘要內容4 | 字元 | |
| AO09 | 金額 | 數值 | |
| AO11 | 分攤旗標 | 字元 | 'Y'表示需要分攤 |
| AO12 | 借方金額 | 數值 | |
| AO13 | 貸方金額 | 數值 | |
| AO14 | 數量 | 數值 | |
| AO15 | 其他 | 字元 | |
| AO16 | 備註 | 字元 | |
| AO22 | 摘要代號 | 字元 | |

### GLAFPF（交易別檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AF02 | 會計科目 | 字元 | 主索引鍵之一 |
| AF03 | 會計科目說明 | 字元 | |
| AF08 | 啟用狀態 | 字元 | '1'為啟用 |
| AF11 | 輸入項目1名稱 | 字元 | |
| AF12 | 輸入項目2名稱 | 字元 | |
| AF13 | 輸入項目3名稱 | 字元 | |
| AF14 | 輸入項目4名稱 | 字元 | |
| AF15 | 輸入項目5名稱 | 字元 | |
| AF16 | 輸入項目6名稱 | 字元 | |
| AF17 | 輸入項目7名稱 | 字元 | |
| AF18 | 處理旗標 | 字元 | |

### GLAQPF（交易項目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AQ04 | 會計科目 | 字元 | 主索引鍵之一 |
| AQ05 | 摘要內容1 | 字元 | |
| AQ06 | 摘要內容2 | 字元 | |
| AQ07 | 摘要內容3 | 字元 | |
| AQ08 | 摘要內容4 | 字元 | |
| AQ09 | 金額 | 數值 | |
| AQ12 | 分攤比例 | 數值 | |
| AQ14 | 數量 | 數值 | |
| AQ15 | 其他 | 字元 | |
| AQ16 | 備註 | 字元 | |
| AQ22 | 摘要代號 | 字元 | |

### GLAPPF（輸入項目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AP02 | 會計科目 | 字元 | 主索引鍵之一 |
| AP03 | 控制項目 | 字元 | 主索引鍵之二 |
| AP04 | 輸入項目 | 字元 | 主索引鍵之三 |
| AP05 | 序號 | 字元 | 主索引鍵之四 |
| AP06 | 有效日期 | 數值 | |

### GLAKPF（會計科目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 部門代號 | 字元 | 主索引鍵之一 |
| AK02 | 會計科目旗標 | 字元 | 'V'表示主要科目 |
| AK09 | 科目控制項目2 | 字元 | |
| AK11 | 科目控制項目1 | 字元 | |
| AK15 | 狀態旗標 | 字元 | |

### PT#BPF（部門檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #B01 | 部門代號 | 字元 | 主索引鍵 |
| #B02 | 部門說明 | 字元 | |
| #B12 | 部門狀態 | 字元 | '1'為啟用 |

## 4. 輸出/入螢幕布局與說明

### 畫面流程
- **SC01**：傳票主檔輸入畫面（部門代號、傳票號碼範圍、日期等）
- **SC02**：傳票明細一覽畫面（顯示傳票明細）

### SC01 - 傳票主檔輸入畫面
```
                    總帳傳票登錄

部門代號: [____] [________________]
傳票號碼區間:
從: [_________]
至: [_________]
傳票日期: [________]
大傳票日期: [________]

功能鍵:
F3=離開  F4=提示  Enter=繼續
```

### SC02 - 傳票明細一覽畫面
```
                    總帳傳票明細一覽

部門代號: 1234 會計部門            傳票日期: 20240125
大傳票日期: 20240120

選擇 傳票號碼     明細說明                        
 _   A12345678   日常營運支出明細
 _   A12345679   固定資產採購明細

功能鍵:
F3=離開  F12=返回  F13=列印設定
```

### SC03 - 傳票修改選項畫面
```
呼叫GLA121程式進行傳票修改
```

### SC04 - 傳票列印畫面
```
呼叫GLR1K0程式進行傳票列印
```

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和參數（R0100）
2. 依畫面代碼SCID執行不同畫面處理：
   - SC01：執行傳票主檔輸入（R1000）
   - SC02：執行傳票明細一覽（R2000）
3. 結束程式（SETON LR）

### SC01 畫面流程（傳票主檔輸入）
1. 顯示SC01畫面
2. 使用者輸入部門代號、傳票號碼範圍、傳票日期等基本資料
3. 檢核輸入資料（R1B00）：
   - 檢查部門代號是否存在且有效
   - 檢查部門是否存在於會計科目檔
   - 檢查傳票號碼範圍有效性
   - 檢查傳票日期是否有效
   - 檢查會計期間資料是否建立
   - 檢查使用者是否有特殊權限
   - 檢查大傳票日期（若有輸入）是否有效
4. 若檢核通過，進入SC02畫面，執行傳票明細一覽

### SC02 畫面流程（傳票明細一覽）
1. 初始化SC02畫面和子檔（R2A10）
   - 依據傳票號碼範圍讀取傳票資料
   - 將傳票資料顯示在子檔中
2. 顯示SC02畫面並等待使用者選擇
3. 處理使用者選擇：
   - 選項2：修改傳票（R2F00，呼叫GLA121程式）
   - 選項6或9：列印傳票（R2D00，呼叫GLR1K0程式）
   - F13：進入列印設定（R2C00）
4. 若按下F3或F12，返回SC01畫面

### 資料儲存流程（R2D30）
1. 初始化子檔（R1C00）
2. 檢核資料（R2D10）
3. 若檢核通過：
   - 取得傳票號碼（呼叫GLS002程式）
   - 轉換傳票日期格式（呼叫P31程式）
   - 儲存傳票主檔與明細資料
   - 若選擇列印，呼叫GLR1K0程式列印傳票

## 6. 子程序處理邏輯說明

### R0100 - 初始化程式
- 讀取PTDA01資料區
- 呼叫P31程式處理日期格式轉換
- 設定初始畫面ID為SC01
- 設定功能權限（新增、修改、刪除、查詢）
- 初始化主畫面欄位

### R1000 - SC01畫面處理
- 顯示SC01畫面並讀取使用者輸入
- 檢查F3鍵（離開）、F4鍵（提示）
- 呼叫R1B00檢核輸入資料
- 若檢核通過，切換到SC02進行傳票明細一覽

### R1B00 - SC01資料檢核
- 檢查使用者功能權限
- 檢查部門代號是否輸入
- 檢查部門是否存在於部門檔(PT#BPF)且為啟用狀態
- 檢查部門是否存在於會計科目檔(GLAKPF)
- 檢查傳票號碼範圍，如果結束號碼為空白則設定為*ALL'9'
- 檢查傳票日期是否有效
- 檢查會計期間資料是否建立（呼叫GLS005程式）
- 檢查使用者是否有特殊權限
- 檢查大傳票日期（若有輸入）是否有效

### R1C00 - 初始化SC02畫面
- 設定子檔使用變數（RRND、RRNC等）
- 清除子檔記錄
- 設定子檔顯示旗標

### R1E00 - 提示處理
- 計算游標位置（#LIN、#COL）
- 依游標位置提供不同的提示功能：
  - 傳票號碼1：呼叫GLI310程式提供傳票號碼查詢
  - 傳票號碼2：呼叫GLI310程式提供傳票號碼查詢

### R2000 - SC02畫面處理
- 呼叫R2A10初始化SC02畫面和子檔
- 顯示SC02畫面並讀取使用者選擇
- 處理使用者選擇：
  - F3鍵：離開程式
  - F12鍵：返回SC01畫面
  - F13鍵：進入列印設定（R2C00）
- 呼叫R2B00檢核使用者輸入
- 依使用者選項執行不同功能：
  - 選項2：修改傳票（R2F00）
  - 選項6或9：列印傳票（R2D00）

### R2A10 - 初始化SC02子檔
- 清除子檔記錄
- 設定子檔顯示旗標
- 依據傳票號碼範圍讀取傳票資料
- 呼叫R2A30將傳票資料移至子檔

### R2A30 - 資料移至子檔
- 將傳票資料（傳票號碼、說明、日期等）移至子檔
- 增加子檔記錄號

### R2B00 - SC02資料檢核
- 讀取子檔記錄
- 檢查使用者選項
- 依選項呼叫相應處理程序：
  - 選項2：呼叫R2F00修改傳票
  - 其他選項：呼叫R2D00檢核並儲存

### R2B10 - 日期檢核
- 檢查傳票日期不可為零
- 檢查傳票日期有效性（呼叫P30程式）
- 檢查會計期間是否建立（呼叫GLS005程式）
- 檢查使用者權限
- 檢查大傳票日期有效性

### R2C00 - 列印設定
- 顯示列印設定畫面
- 處理使用者選擇（如F4設定印表機）

### R2D00 - 檢核並儲存
- 初始化子檔（R1C00）
- 檢核資料（R2D10）
- 若檢核通過，儲存資料（R2D30）
- 若選項為9，列印傳票（呼叫GLR1K0程式）

### R2D10 - 檢核子檔資料
- 讀取傳票明細資料
- 計算借貸方總金額
- 檢查分攤旗標，若需分攤則執行R2D20
- 若不需分攤則執行R2D80

### R2D20 - 處理分攤明細
- 設定分攤比例（WPSN）
- 讀取會計科目相關輸入項目名稱
- 呼叫R2D2A移動資料至工作陣列
- 讀取交易項目檔資料
- 呼叫GLA190程式處理明細分攤輸入

### R2D50 - 處理分攤匹配
- 呼叫GLA190程式進行明細資料輸入
- 儲存明細資料至子檔
- 累加明細筆數

### R2D60 - 處理其他分攤
- 處理剩餘的分攤比例
- 呼叫GLA190程式進行明細資料輸入
- 儲存明細資料至子檔

### R2D80 - 處理非分攤明細
- 直接呼叫GLA190程式進行明細資料輸入
- 儲存明細資料至子檔

### R2D30 - 儲存資料至資料庫
- 取得傳票號碼（呼叫GLS002程式）
- 轉換傳票日期格式（呼叫P31程式）
- 設定傳票主檔資料
- 讀取並儲存所有借方和貸方明細資料

### R2F00 - 修改傳票
- 呼叫GLA121程式修改傳票
- 傳遞部門代號、傳票號碼等參數

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理方式
- 使用*IN99指示燈標示錯誤狀態
- 使用ERRID和ERRF存儲錯誤訊息代碼和檔案
- 使用GOTO E1B00等標籤控制錯誤後的程式流程

### 主要錯誤訊息
- UPT0010：必填欄位未輸入
- UPT0012：數值欄位不可為零
- UPT0030：輸入資料無效
- UPT0040：日期格式無效
- UPT0042：傳票號碼範圍無效
- UPT2010：資料不存在於檔案中
- UPT2072：新增作業完成
- UPT2150：使用者無權限
- UGL0004：部門非啟用狀態
- UGL0029：會計期間未建立

### 特殊錯誤檢查
- 檢查傳票號碼範圍的有效性
- 檢查使用者是否有特殊權限（$RMK01）
- 檢查會計期間是否已建立

## 8. 備註
1. 本程式提供總帳傳票登錄的功能，可以依據傳票號碼範圍查詢並維護傳票資料。
2. 程式支援傳票明細的分攤功能，可依比例自動分配借貸金額。
3. 提供傳票修改功能，透過呼叫GLA121程式進行傳票資料修改。
4. 提供傳票列印功能，透過呼叫GLR1K0程式進行傳票列印。
5. 系統會自動取得傳票號碼（透過GLS002程式）。
6. 對每個傳票日期，會檢查會計期間是否已建立。
7. 使用者需具備特定權限才能處理封閉會計期間的傳票。
8. 傳票登錄時可以輸入大傳票日期，提供額外的日期資訊。
9. 支援使用提示功能（F4）查詢傳票號碼。
10. 傳票可以依據部門和日期條件進行查詢和處理。 
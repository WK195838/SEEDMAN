# GLA1501 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1501
- **程式說明**：取消結案作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1501
- **開發人員**：A1152 ANGY
- **建立日期**：1992.11.09
- **系統**：會計總帳

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHLF01**：會計分錄歷史檔（更新檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **S#SUPF**：員工資料檔（參考檔案）
- **GLAKPF**：公司檔案（參考檔案）
- **GLA1501D**：螢幕顯示檔

### 檔案間關聯
- 使用公司代碼（AH01/DAH01）連結各檔案
- 使用分錄編號（AH02/DAH02）作為GLAHLF01的次要鍵值
- 使用員工代碼（AH26）連結S#SUPF取得員工資料

## 3. 檔案欄位規格說明

### GLAHLF01 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | - | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | - | 文字 | 主鍵 |
| AH10 | 交易日期 | - | - | 數值 | 會計交易日期 |
| AH19 | 結案狀態 | - | - | 文字 | 空白=取消結案 |
| AH21 | 作業日期 | - | - | 數值 | 作業執行日期 |
| AH25 | 結案日期 | - | - | 數值 | 結案處理日期 |
| AH26 | 員工代碼 | - | - | 文字 | 處理人員代碼 |
| AH97 | 最後處理時間 | - | - | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | - | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | - | 文字 | 使用者代碼 |

### S#SUPF (員工資料檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| SU02 | 員工姓名 | - | - | 文字 | 員工名稱 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 參數類別 | - | - | 文字 | 主鍵 |
| #B02 | 參數名稱 | - | - | 文字 | 參數說明 |

### GLAKPF (公司檔案)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AK01 | 公司代碼 | - | - | 文字 | 主鍵 |
| AK09 | 公司參數 | - | - | 文字 | 顯示格式參數 |
| AK11 | 公司參數 | - | - | 文字 | 日期顯示參數 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
螢幕顯示格式為子檔式顯示，列出符合條件的會計分錄資料。

#### 子檔部分
| 欄位名稱 | 說明 |
|---------|------|
| DOPT | 選項欄位，可輸入'5'查詢明細或'6'進行取消結案處理 |
| DAH02 | 分錄編號 |
| DSU02 | 員工姓名 |
| DAH10 | 交易日期（已格式化） |
| DAH25 | 結案日期（已格式化） |
| DAH21 | 作業日期（已格式化） |

#### 標題部分
| 欄位名稱 | 說明 |
|---------|------|
| DAH01 | 公司代碼 |
| D#B02 | 公司名稱 |

#### 功能鍵說明
| 功能鍵 | 功能說明 |
|--------|---------|
| F3 | 結束程式 |
| F12 | 返回前一頁 |
| F13 | 執行全部取消結案處理 |

## 5. 處理流程程序說明

### 主要處理流程
1. 執行初始化子程序 R0100
2. 主迴圈：只要F3, F12, F13皆未按下，則執行螢幕處理 R1000
3. 程式結束

### 初始化處理 (R0100)
1. 讀取參數區域
2. 呼叫 P31 設定日期顯示格式
3. 讀取公司檔案資料
4. 執行子檔初始化 R1A00

### 螢幕處理 (R1000)
1. 顯示主畫面
2. 根據功能鍵執行不同操作：
   - F3：結束程式
   - F12：重置並返回
   - F13：執行全部取消結案處理 R1C00
3. 處理子檔選項 R1D00

## 6. 子程序處理邏輯說明

### 子檔初始化 (R1A00)
1. 設定子檔控制指示器
2. 執行子檔標題設定 R1A20
3. 添加子檔資料 R1A10
4. 根據記錄數設定顯示狀態或錯誤訊息

### 添加子檔資料 (R1A10)
1. 讀取會計分錄歷史檔資料
2. 針對每筆記錄呼叫 R1A11 寫入子檔
3. 使用 SETGT 進行記錄定位和讀取

### 寫入子檔資料 (R1A11)
1. 使用員工代碼讀取員工姓名
2. 將分錄編號指派到顯示欄位
3. 根據日期值進行格式轉換：
   - 結案日期 AH25
   - 交易日期 AH10
   - 作業日期 AH21
4. 寫入子檔記錄

### 子檔標題設定 (R1A20)
1. 設定公司代碼顯示
2. 讀取並設定公司名稱

### 全部取消結案處理 (R1C00)
1. 讀取特定公司代碼的所有會計分錄記錄
2. 對每筆記錄進行取消結案處理：
   - 設定結案狀態 AH19 為空白
   - 記錄處理時間 AH97
   - 記錄系統日期 AH98
   - 記錄處理人員 AH99
3. 更新記錄

### 子檔選項處理 (R1D00)
1. 讀取子檔記錄
2. 根據選項值處理：
   - 選項 '6'：對指定的分錄記錄進行取消結案處理
   - 選項 '5'：呼叫 GLI1F0 程式查詢分錄明細
3. 處理 GLI1F0 的回傳碼

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理機制
- 使用指示器 99 顯示無資料錯誤訊息
- 錯誤訊息代碼：UPT2050
- 錯誤檔案名稱：PTMF

### 輸入驗證
- 選項欄位限制：只允許 '5'（查詢）和 '6'（取消結案）兩種值
- 子檔記錄必須存在才能進行操作

## 8. 備註
- 程式有更新歷史：由 GRACE 在 94/06/20 修改了選項 '5' 處理邏輯
- 選項 '5' 原本會將後續狀態設為 '6'，修改後改為清空選項值
- 程式使用 P31 公用程式進行日期格式轉換，依據公司參數設定進行顯示
- 取消結案處理會將分錄歷史檔中的狀態欄位 AH19 更新為空白，代表取消結案
- 此程式與 GLA1401（結案作業）功能相反，用於撤銷已結案的分錄記錄
- 使用子檔技術實現多筆記錄的顯示和選擇處理 
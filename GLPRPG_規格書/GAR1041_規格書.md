# GAR1041 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR1041
- **程式說明**：參數日曆系統報表查詢作業子程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR1041
- **開發人員**：未指定
- **建立日期**：未指定
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：參數日曆系統報表查詢作業子程式，負責實際報表輸出處理
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHLF01：會計主檔（輸入模式）
  - GLAKPF：會計參數檔（輸入模式）
  - S#SUPF：系統參數說明檔（輸入模式）
  - PT#BPF：部門說明檔（輸入模式）
- **印表檔案**
  - GAR104P：參數日曆系統報表查詢作業輸出檔
- **資料區**
  - PTDA01：參數資料區
- **相關程式**
  - P31：日期轉換程式
  - GAR104：參數日曆系統報表查詢作業（主程式）

## 3. 檔案欄位規格說明

### GLAHLF01（會計主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH02 | 參數代碼 | 字元 | 層級1欄位 |
| AH10 | 參數日期 | 數值 | 層級2欄位 |
| AH18 | 有效旗標 | 字元 | - |
| AH19 | 版本號 | 字元 | - |
| AH20 | 排序碼 | 字元 | - |
| AH26 | 建檔人 | 字元 | - |

### S#SUPF（系統參數說明檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| SU02 | 說明內容 | 字元 | - |

### 資料區定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $PFMT | 1 | 1 | 參數區日期格式 |
| $PTYPE | 2 | 1 | 參數區日期型態 |
| $USER | 101-110 | 10 | 使用者代號 |
| $CPY | 125-127 | 3 | 列印份數 |
| $INQ | 138 | 1 | 查詢標記 |
| $A8YMD | 201-208 | 8 | 系統日期 |
| $C8YMD | 209-216 | 8 | 系統日期 |
| $PRTCD | 217-218 | 2 | 列印機台 |
| $PENV | 219 | 1 | 輸出裝置 |
| DAH01 | 501-502 | 2 | 部門別 |
| DAH10F | 519-526 | 8 | 參數日期(起) |
| DAH10T | 527-534 | 8 | 參數日期(迄) |
| D10F | 541-547 | 7 | 日期顯示(起) |
| D10T | 548-554 | 7 | 日期顯示(迄) |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| PDATE | 數值 | 轉換後日期格式 |
| PSU02 | 字元 | 系統參數說明 |
| *IN10 | 指示燈 | 初始化控制指示燈 |
| *IN20 | 指示燈 | 報表格式控制指示燈 |
| *IN39 | 指示燈 | 標題控制指示燈 |
| *IN40 | 指示燈 | 檔案存取控制指示燈 |
| *INL1 | 指示燈 | 層級1控制指示燈 |
| *INL2 | 指示燈 | 層級2控制指示燈 |

## 4. 輸出/入螢幕布局與說明

### 報表格式
使用GAR104P列印檔案產生以下報表：

```
[公司名稱]

參數代碼產生

                              日期: [系統日期]
                              頁次: [頁碼]
                              時間: [時間]    <GAR104P>
參數日期: [起始日期] - [結束日期]    USER : [使用者ID]
===============================================================
參數代碼  建檔人    有效 版本 排序             狀態
===============================================================

[參數代碼] [建檔人] [使用者ID] [有效] [版本] [排序] [狀態欄位]

===============================================================
   ***完成***

===============================================================
   <<GAR104P>>--->產生完成
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化程式（EXSR R1000）
2. 處理層級控制（EXSR R8100）
3. 處理結束訊息（EXSR R8999）

### 子程序處理流程

#### R1000 - 初始化處理
1. 設定控制指示燈（10）
2. 讀取參數資料區(PTDA01)
3. 呼叫P31日期轉換程式，處理日期格式：
   - 轉換$A8YMD系統日期
   - 設定日期格式（$PFMT）和類型（$PTYPE）
4. 取得轉換後的日期（PDATE）
5. 讀取會計參數檔（GLAKPF）取得公司資訊
6. 讀取部門說明檔（PT#BPF）取得部門資訊
7. 輸出報表標題（WRITEPH1）

#### R8100 - 層級控制處理
1. 判斷是否需要輸出分頁標題（*IN39='1'）：
   - 若需要：輸出尾註（WRITEPE1）及標題（WRITEPH1），並關閉標題指示燈
2. 處理系統參數說明檔（S#SUPF）：
   - 讀取系統說明
   - 若不存在（*IN40='1'），則使用空白值
3. 輸出明細資料（WRITEPD1）
4. 判斷層級2控制指示燈（*INL2）：
   - 若開啟：設定格式控制指示燈（20）

#### R8999 - 結束處理
1. 判斷初始化控制指示燈（*IN10='0'）：
   - 若未初始化：執行初始化（EXSR R1000）及輸出無資料訊息（WRITEPE9）
2. 輸出結束訊息（WRITEPE2）

## 6. 子程序處理邏輯說明
- **P31程式**：日期格式轉換
  * 輸入參數：
    - P3101I：輸入日期（$A8YMD）
    - P3102I：格式代碼（'2'）
    - P3103I：轉換類型（'1'）
    - P3104I：日期格式（$PFMT）
    - P3105I：日期類型（$PTYPE）
  * 輸出參數：
    - P3101O：轉換後日期（PDATE）

## 7. 錯誤處理程序說明與訊息清冊
- 使用指示燈39控制報表標題輸出
- 使用指示燈10控制處理流程
- 使用指示燈40檢查檔案讀取狀態
- 使用指示燈L1、L2控制層級處理
- 無資料時顯示"無符合條件之資料"訊息
- 報表輸出完成顯示"產生完成"訊息

## 8. 備註
1. 本程式為參數日曆系統報表查詢作業的子程式，負責將篩選後的資料輸出到報表
2. 程式透過讀取會計主檔（GLAHLF01）獲取參數資料，包括參數代碼、參數日期、有效狀態等
3. 使用層級控制處理報表的分頁與格式，層級1為參數代碼（AH02），層級2為參數日期（AH10）
4. 使用系統參數說明檔（S#SUPF）取得參數的詳細說明內容
5. 所有日期格式都透過P31程式進行標準化處理，確保日期格式一致
6. 此程式由GAR104主程式調用，處理實際的報表生成與列印工作
7. 報表輸出完成後，顯示明確的完成訊息，提供使用者操作回饋 
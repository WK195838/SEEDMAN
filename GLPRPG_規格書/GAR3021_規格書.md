# GAR3021 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR3021
- **程式說明**：分類科目報表作業子程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR3021
- **開發人員**：MERCURY
- **建立日期**：83/01/31
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：分類科目報表輸出子程式
- **聯絡電話**：5042266

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAWPF：分類科目檔（輸入模式）
  - GLAXPF：會計科目明細檔（輸入模式）
  - PT#BPF：部門說明檔（輸入模式）
- **印表檔案**
  - GAR302P：分類科目報表輸出檔
- **相關程式**
  - GAR302：分類科目報表作業（主程式）

## 3. 檔案欄位規格說明

### GLAWPF（分類科目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AW01 | 分類科目代號 | 字元 | 層級1欄位 |

### GLAXPF（會計科目明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AX02 | 科目代號 | 字元 | - |

### #FRCDF（檔案控制區）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| RCDF | 記錄格式 | 字元 | - |

### 程式使用資料定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $USER | 101-110 | 10 | 使用者代號 |
| $EGMDY | 119-124 | 6 | 系統日期 |
| $EVR | 162 | 1 | 環境變數 |
| $CPY | 125-127 | 3 | 公司代號 |
| $WRHUS | 501-505 | 5 | 倉庫代號 |
| $PRTID | 598-599 | 2 | 列印代號 |
| DAW01S | 601-602 | 2 | 分類科目代號(起) |
| DAW01E | 603-604 | 2 | 分類科目代號(迄) |
| #B02A | 605-616 | 12 | 分類科目名稱 |
| #B02B | 617-628 | 12 | 科目名稱 |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| *IN10 | 指示燈 | 初始化控制旗標 |
| *IN20 | 指示燈 | 分類標題控制旗標 |
| *IN30 | 指示燈 | 明細資料控制旗標 |
| *IN39 | 指示燈 | 分頁控制旗標 |
| *IN40 | 指示燈 | 資料讀取控制旗標 |
| *IN46 | 指示燈 | 檔案結束控制旗標 |
| *INL1 | 指示燈 | 層級1控制旗標 |

## 4. 輸出/入螢幕布局與說明

### 報表格式
使用GAR302P列印檔案產生以下報表：

```
[公司名稱]

分類科目報表

                                                       日期: [系統日期]
                                                       頁次: [頁碼]
                                                       時間: [時間]    <GAR302P>
分類科目代號: [開始科目代號] - [結束科目代號]                使用者: [使用者ID]
=========================================================================
分類科目  科目名稱
-------------------------------------------------------------------------
          會計科目    科目說明
=========================================================================

[分類科目代號] [分類科目名稱]
                [科目代號]  [科目名稱]
                [科目代號]  [科目名稱]
                ...
```

## 5. 處理流程程序說明

### 主程序流程
1. 判斷初始化狀態（*IN10='0'）：
   - 若未初始化：執行初始化（EXSR RTN010）
2. 處理資料（EXSR RTN100）
3. 控制層級1顯示格式：
   - 關閉明細顯示指示燈（*IN30='0'）
   - 開啟標題顯示指示燈（*IN20='1'）
4. 執行結束處理（EXSR RTN990，僅當最後記錄時）

### 子程序處理流程

#### RTN010 - 初始化處理
1. 讀取分類科目檔（GLAWPF）獲取科目資訊
2. 讀取部門說明檔（PT#BPF）獲取科目名稱（若無資料則使用空白）
3. 輸出報表標題（WRITEPH1）
4. 設定初始化完成指示燈（10）

#### RTN100 - 資料處理
1. 讀取分類科目檔（GLAWPF）取得分類科目名稱：
   - 若找到資料（*IN40='0'）：使用#B02作為分類科目名稱
   - 若無資料（*IN40='1'）：使用空白作為分類科目名稱
2. 設定資料檔讀取位置（SETLL）
3. 循環處理相關會計科目資料：
   - 讀取下一筆資料（READE）
   - 讀取科目名稱（CHAINB0）
   - 判斷是否需要分頁（*IN39='1'）：若需要，執行分頁處理（EXSR RTN900）
   - 輸出明細資料（WRITEPD1）
   - 關閉標題顯示指示燈（*IN20='0'）
   - 開啟明細顯示指示燈（*IN30='1'）
   - 繼續處理直到檔案結束（*IN46='1'）

#### RTN900 - 分頁處理
1. 輸出尾註（WRITEPE1）
2. 關閉標題顯示指示燈（*IN20='0'）
3. 輸出標題（WRITEPH1）
4. 關閉分頁指示燈（39）
5. 關閉明細顯示指示燈（30）

#### RTN990 - 結束處理
1. 判斷是否有輸出資料（*IN10='0'）：
   - 若無資料：輸出標題（WRITEPH1）和無資料訊息（WRITEPE3）
2. 輸出結束訊息（WRITEPE2）

## 6. 子程序處理邏輯說明
- **檔案讀取邏輯**：
  * 使用CHAIN指令讀取分類科目檔（GLAWPF）和會計科目檔（GLAXPF）
  * 使用SETLL和READE指令循環讀取與特定分類科目相關的所有會計科目
  * 透過*IN46指示燈控制檔案讀取循環

- **報表格式控制邏輯**：
  * 使用*IN20和*IN30指示燈控制標題和明細資料的顯示格式
  * 使用*IN39指示燈控制分頁處理
  * 使用*INL1層級指示燈控制分類科目層級處理

## 7. 錯誤處理程序說明與訊息清冊
- 使用指示燈39控制分頁處理
- 使用指示燈10控制初始化狀態
- 使用指示燈20控制標題顯示
- 使用指示燈30控制明細顯示
- 使用指示燈40檢查分類科目檔讀取狀態
- 使用指示燈46控制檔案讀取循環
- 使用層級指示燈L1控制分類科目的層級處理
- 無資料時顯示"無符合條件之資料"訊息
- 報表輸出完成時顯示"產生完成"訊息

## 8. 備註
1. 本程式為分類科目報表作業的子程式，負責將篩選後的科目資料輸出到報表
2. 程式主要功能是根據分類科目代號（AW01）顯示相關的會計科目清單
3. 使用層級控制（Level Break）技術根據分類科目代號進行分組處理
4. 報表顯示格式採用階層式結構，先顯示分類科目，再顯示相關的會計科目
5. 當無資料符合條件時，程式會輸出特別的訊息通知使用者
6. 此程式由GAR302主程式調用，處理實際的報表生成與列印工作
7. 報表提供完整的科目分類及相關會計科目清單，便於會計人員查詢與分析 
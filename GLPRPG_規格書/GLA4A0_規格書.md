# GLA4A0 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA4A0
- **程式說明**：摘要代碼資料轉檔
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA4A0
- **開發人員**：A1152 ANGY
- **建立日期**：81/10/30
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：提供摘要代碼資料轉檔功能
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLADPF：摘要檔（更新模式）
  - PT#BPF：部門檔（讀取模式）
- **螢幕格式檔**
  - GLA4A0D：摘要代碼資料轉檔螢幕格式檔

## 3. 檔案欄位規格說明

### GLADPF（摘要檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AD01 | 部門代號 | 字元 | 主索引鍵之一 |
| AD02 | 摘要代號 | 字元 | 主索引鍵之二 |
| AD03 | 摘要說明 | 字元 | - |
| AD04 | 摘要內容1 | 字元 | - |
| AD05 | 摘要內容2 | 字元 | - |
| AD97 | 建檔時間 | 時間 | - |
| AD98 | 建檔日期 | 數值 | - |
| AD99 | 建檔人員 | 字元 | - |

### PT#BPF（部門檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #B01 | 部門代號 | 字元 | 主索引鍵 |
| #B02 | 部門說明 | 字元 | - |
| #B12 | 部門狀態 | 字元 | '1'為有效部門 |

### 程式使用資料定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $USER | 101-110 | 10 | 使用者代號 |
| $A8YMD | 201-208 | 8 | 系統西元日期 |
| $C8YMD | 209-216 | 8 | 系統中文日期 |
| $ADD | 135 | 1 | 新增權限 (Y/N) |
| $UPD | 136 | 1 | 修改權限 (Y/N) |
| $DLT | 137 | 1 | 刪除權限 (Y/N) |
| $INQ | 138 | 1 | 查詢權限 (Y/N) |
| $USERN | 152-161 | 10 | 使用者名稱 |
| WAD02F | 501-508 | 8 | 摘要代號起始值 |
| WAD02T | 509-516 | 8 | 摘要代號結束值 |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| SCID | 字元 | 螢幕代號（SC01為主畫面） |
| DOPT | 數值 | 轉檔選項（1=不覆蓋已存在資料，2=覆蓋不確認，3=覆蓋需確認） |
| WAD01 | 字元 | 暫存部門代號 |
| WAD02 | 字元 | 暫存摘要代號 |
| WAD03 | 字元 | 暫存摘要說明 |
| WAD04 | 字元 | 暫存摘要內容1 |
| WAD05 | 字元 | 暫存摘要內容2 |
| COVE | 字元 | 覆蓋確認碼（Y/N） |
| DAD01F | 字元 | 來源部門代號 |
| DAD01T | 字元 | 目標部門代號 |
| DAD02F | 字元 | 摘要代號起始值 |
| DAD02T | 字元 | 摘要代號結束值 |

## 4. 輸出/入螢幕布局與說明

### 摘要代碼資料轉檔系統螢幕布局

#### SC01 - 摘要代碼資料轉檔主畫面
```
                摘要代碼資料轉檔

轉檔選項：[_] 1=不覆蓋已存在資料 2=覆蓋不確認 3=覆蓋需確認

來源部門代號: [____] [部門名稱________________________]
摘要代號範圍: [________] 至 [________]

目標部門代號: [____] [部門名稱________________________]

功能鍵:
F3=離開
Enter=執行轉檔
```

#### SC02 - 覆蓋確認畫面
```
                覆蓋確認

摘要代號: [________]
摘要說明: [____________________]

是否覆蓋? [_] (Y/N)

功能鍵:
Enter=確認
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化處理（EXSR R0100）
2. 循環處理使用者操作（DOWEQ *IN03='0'）：
   - 依螢幕ID（SCID）分派處理：
     * SC01：執行摘要代碼資料轉檔主畫面處理（EXSR R1000）
3. 結束程式（SETON LR）

### 子程序處理流程

#### R0100 - 初始化處理
1. 設定初始螢幕ID為「SC01」
2. 讀取系統參數設定
3. 呼叫P31程式處理日期格式轉換
4. 初始化主畫面欄位：
   - 設定預設轉檔選項為1（DOPT=1）
   - 清空部門代號欄位（DAD01F, DAD01T）
   - 清空摘要代號範圍欄位（DAD02F, DAD02T）

#### R1000 - SC01畫面處理
1. 顯示SC01畫面並等待使用者輸入
2. 檢查使用者是否按下F3鍵退出
3. 執行畫面資料檢核（EXSR R1B00）
4. 若檢核通過（*IN99='0'），執行資料轉檔處理（EXSR R1C00）

#### R1B00 - SC01畫面資料檢核
1. 檢查來源部門代號（DAD01F）是否為空：
   - 若為空，設定錯誤訊息（UPT0010）並返回
2. 檢查來源部門是否存在並有效：
   - 從PT#BPF檔案檢索部門資料
   - 檢查部門狀態（#B12 = '1'）
   - 若部門不存在或無效，設定錯誤訊息（UGL0004）並返回
3. 處理摘要代號範圍：
   - 若起始值（DAD02F）為空，設為最小值（*LOVAL）
   - 若結束值（DAD02T）為空，設為最大值（*HIVAL）
4. 檢查摘要代號範圍是否有效：
   - 若起始值大於結束值，設定錯誤訊息（UPT0042）並返回
5. 檢查目標部門代號（DAD01T）是否為空：
   - 若為空，設定錯誤訊息（UPT0010）並返回
6. 檢查目標部門是否存在並有效：
   - 從PT#BPF檔案檢索部門資料
   - 檢查部門狀態（#B12 = '1'）
   - 若部門不存在或無效，設定錯誤訊息（UGL0004）並返回

#### R1C00 - 資料轉檔處理
1. 檢查使用者執行權限（*IN14='1'）
2. 根據使用者選擇的轉檔選項執行相應處理：
   - 選項1（DOPT=1）：執行不覆蓋已存在資料的轉檔（EXSR R1C10）
   - 選項2（DOPT=2）：執行覆蓋不確認的轉檔（EXSR R1C20）
   - 選項3（DOPT=3）：執行覆蓋需確認的轉檔（EXSR R1C30）
3. 顯示處理完成訊息（UPT2142）

#### R1C10 - 不覆蓋已存在資料的轉檔
1. 讀取符合條件的來源摘要資料（SETLL KEYADF）
2. 循環處理每筆資料（DOWEQ *IN46='0'）：
   - 暫存來源資料（EXSR R1C11）
   - 檢查目標資料是否已存在（CHAIN KEYADT）
   - 若目標資料不存在（*IN40='1'），則執行資料寫入：
     * 更新資料內容（EXSR R1D00）
     * 寫入目標檔案（WRITE AD0）
   - 讀取下一筆來源資料

#### R1C20 - 覆蓋不確認的轉檔
1. 讀取符合條件的來源摘要資料（SETLL KEYADF）
2. 循環處理每筆資料（DOWEQ *IN46='0'）：
   - 暫存來源資料（EXSR R1C11）
   - 檢查目標資料是否已存在（CHAIN KEYADT）
   - 若目標資料已存在（*IN40='0'）：
     * 更新資料內容（EXSR R1D00）
     * 更新目標檔案（UPDATE AD0）
   - 若目標資料不存在（*IN40='1'）：
     * 更新資料內容（EXSR R1D00）
     * 寫入目標檔案（WRITE AD0）
   - 讀取下一筆來源資料

#### R1C30 - 覆蓋需確認的轉檔
1. 讀取符合條件的來源摘要資料（SETLL KEYADF）
2. 循環處理每筆資料（DOWEQ *IN46='0'）：
   - 暫存來源資料（EXSR R1C11）
   - 檢查目標資料是否已存在（CHAIN KEYADT）
   - 若目標資料已存在（*IN40='0'）：
     * 顯示覆蓋確認畫面（EXSR R1C31）
     * 若使用者確認覆蓋（COVE='Y'）：
       - 更新資料內容（EXSR R1D00）
       - 更新目標檔案（UPDATE AD0）
   - 若目標資料不存在（*IN40='1'）：
     * 更新資料內容（EXSR R1D00）
     * 寫入目標檔案（WRITE AD0）
   - 讀取下一筆來源資料

#### R1C11 - 暫存來源資料
1. 將來源摘要資料暫存到工作變數：
   - WAD01 = AD01（部門代號）
   - WAD02 = AD02（摘要代號）
   - WAD03 = AD03（摘要說明）
   - WAD04 = AD04（摘要內容1）
   - WAD05 = AD05（摘要內容2）

#### R1C31 - 覆蓋確認處理
1. 初始化確認碼（COVE = ' '）
2. 顯示摘要代號和摘要說明
3. 顯示確認畫面（EXFMT DSPD2）等待使用者確認
4. 若使用者確認覆蓋（COVE='Y'）：
   - 更新資料內容（EXSR R1D00）
   - 更新目標檔案（UPDATE AD0）

#### R1D00 - 更新資料內容
1. 設定目標資料內容：
   - AD01 = DAD01T（目標部門代號）
   - AD02 = WAD02（摘要代號）
   - AD03 = WAD03（摘要說明）
   - AD04 = WAD04（摘要內容1）
   - AD05 = WAD05（摘要內容2）
2. 更新稽核資訊：
   - AD97 = 系統時間（TIME）
   - AD98 = 系統日期（$A8YMD）
   - AD99 = 使用者代號（$USER）

## 6. 子程序處理邏輯說明

### 畫面流程控制邏輯
- 使用SCID變數控制畫面切換
- 使用CASE指令根據使用者選項分派處理子程序
- 使用GOTO E1000等標籤控制程式流程
- 使用指示燈控制功能按鍵和畫面顯示

### 資料檢核邏輯
- 檢查必填欄位（使用IFEQ *BLANK）
- 檢查部門是否存在及有效（使用CHAIN指令）
- 處理摘要代號範圍的邊界條件（*LOVAL和*HIVAL）
- 檢查範圍值的有效性（起始值不能大於結束值）

### 資料轉檔處理邏輯
- 根據選項提供三種轉檔模式：
  * 不覆蓋已存在資料（保留目標資料）
  * 覆蓋不確認（自動覆蓋目標資料）
  * 覆蓋需確認（每筆資料都需確認是否覆蓋）
- 使用鍵值清單（KLIST）控制檔案存取：
  * KEYADF：來源資料讀取鍵值
  * KEYWAD：下一筆資料定位鍵值
  * KEYADT：目標資料檢索鍵值
- 使用SETLL/READE循環讀取來源資料
- 使用CHAIN檢查目標資料是否存在
- 依據不同模式使用WRITE/UPDATE指令處理目標資料

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理機制
- 使用*IN99指示燈標示錯誤狀態
- 使用ERRID和ERRF存儲錯誤訊息代碼和檔案
- 使用GOTO E1B00等標籤控制錯誤後的程式流程

### 資料檢核錯誤
- UPT0010：必填欄位未輸入（部門代號為空）
- UPT0042：範圍值無效（起始值大於結束值）
- UGL0004：部門無效（部門不存在或未啟用）

### 系統訊息
- UPT2142：處理完成提示

## 8. 備註
1. 本程式提供會計摘要代碼資料在不同部門間的轉檔功能，便於系統管理與維護
2. 程式支援三種轉檔模式，使用者可根據需求選擇適合的模式
3. 程式會自動記錄資料的變更時間、變更日期和變更人員，便於稽核追蹤
4. 資料轉檔前會進行嚴格的部門有效性檢查，確保資料完整性
5. 轉檔過程中只會處理符合條件範圍內的摘要代碼，不會影響其他資料
6. 覆蓋確認機制可以讓使用者在轉檔過程中有更精細的控制
7. 程式提供範圍處理功能，支援針對特定摘要代碼範圍進行轉檔
8. 使用簡單的操作介面，便於一般使用者操作
9. 摘要代碼是會計系統中重要的基礎資料，本程式協助管理人員更有效地維護這些資料
10. 程式的設計考慮了資料安全性，避免誤刪或覆蓋重要資料 
# GLA1502 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1502
- **程式說明**：取消結案作業列印
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1502
- **開發人員**：A1152 ANGY
- **建立日期**：81/11/05
- **系統**：會計總帳
- **功能描述**：列印取消結案的會計分錄資料

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHLF01**：會計分錄歷史檔（更新檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **GLA1502P**：報表輸出檔（印表機檔）

### 檔案間關聯
- 使用公司代碼（WAH01）連結各檔案
- 使用分錄編號（AH02/WAH02）作為GLAHLF01的次要鍵值
- 讀取PT#BPF取得公司名稱等資訊

## 3. 檔案欄位規格說明

### GLAHLF01 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AH19 | 結案狀態 | - | 1 | 文字 | 空白=取消結案 |
| AH97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 參數類別 | - | 2 | 文字 | 主鍵 |
| #B03 | 參數說明 | - | 80 | 文字 | 公司名稱/說明 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| WAH01 | 公司代碼 | 575 | 2 | 文字 | 處理的公司代碼 |
| WAH02F | 分錄編號起 | 533 | 9 | 文字 | 搜尋範圍起始分錄編號 |
| WAH02T | 分錄編號迄 | 542 | 9 | 文字 | 搜尋範圍結束分錄編號 |
| WAH26F | 員工代碼起 | 551 | 10 | 文字 | 搜尋範圍起始員工代碼 |
| WAH26T | 員工代碼迄 | 561 | 10 | 文字 | 搜尋範圍結束員工代碼 |
| WAH17F | 處理狀態起 | 571 | 2 | 文字 | 搜尋範圍起始處理狀態 |
| WAH17T | 處理狀態迄 | 573 | 2 | 文字 | 搜尋範圍結束處理狀態 |
| WAH25F | 結案日期起 | 501 | 8 | 數值 | 搜尋範圍起始結案日期 |
| WAH25T | 結案日期迄 | 509 | 8 | 數值 | 搜尋範圍結束結案日期 |
| WAH10F | 交易日期起 | 517 | 8 | 數值 | 搜尋範圍起始交易日期 |
| WAH10T | 交易日期迄 | 525 | 8 | 數值 | 搜尋範圍結束交易日期 |
| DAH25F | 結案日期起 | 601 | 7 | 數值 | 格式化後的起始結案日期 |
| DAH25T | 結案日期迄 | 609 | 7 | 數值 | 格式化後的結束結案日期 |
| DAH10F | 交易日期起 | 617 | 7 | 數值 | 格式化後的起始交易日期 |
| DAH10T | 交易日期迄 | 625 | 7 | 數值 | 格式化後的結束交易日期 |

## 4. 輸出/入螢幕布局與說明

### 輸出報表布局
本程式為批次作業，無輸入螢幕，僅有報表輸出。

#### 報表標題區
```
                                 取消結案作業列印                       頁次: XXX
                                 XXXXXXXXXX                            日期: YY/MM/DD
                                                                       時間: HH:MM:SS

分錄編號範圍: XXXXXXXXX - XXXXXXXXX    員工代碼範圍: XXXXXXXXXX - XXXXXXXXXX
處理狀態範圍: XX - XX                  結案日期範圍: XXXXXXX - XXXXXXX
交易日期範圍: XXXXXXX - XXXXXXX
```

#### 報表明細區
```
序號   分錄編號    序號   分錄編號    序號   分錄編號    序號   分錄編號
----   ---------   ----   ---------   ----   ---------   ----   ---------
XXX    XXXXXXXXX   XXX    XXXXXXXXX   XXX    XXXXXXXXX   XXX    XXXXXXXXX
```

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 設定印表機參數
   - 讀取系統參數檔取得公司名稱
   - 初始化查詢參數

2. 主處理程序（R0200子程序）
   - 讀取符合條件的會計分錄記錄
   - 處理每筆分錄資料並輸出到報表

3. 結束程式處理
   - 設定最後記錄指標(LR)結束程式

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 設定印表機標頭
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 讀取PT#BPF檔案取得公司名稱
- 初始化查詢參數值

### R0200 - 主處理程序
- 設定計數器變數
- 讀取GLAHLF01檔案中的記錄
- 如果沒有資料，執行R8999子程序
- 循環處理每筆記錄，直到檔案結束
- 執行R2000子程序處理每筆資料
- 輸出報表尾頁

### R2000 - 明細處理
- 檢查是否需要輸出報表標頭
- 檢查分錄編號是否變更
- 根據計數器值決定輸出格式（最多4筆/行）
- 更新分錄記錄的結案狀態為空白
- 更新最後處理時間、日期和處理人員

### R8999 - 無資料處理
- 當沒有符合條件的資料時執行
- 輸出報表標頭
- 輸出無資料訊息

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 程式中沒有特別的錯誤處理邏輯
- 當找不到符合條件的記錄時，會輸出無資料的訊息

### 訊息清冊
- 無特定錯誤訊息，僅在無資料時顯示「無符合條件的資料」訊息

## 8. 備註
- 本程式為會計取消結案作業的列印功能，配合GLA1501取消結案作業程式使用
- 程式會將處理過的分錄記錄更新結案狀態為空白
- 報表以每行4筆的方式輸出分錄編號，方便查閱
- 報表可依據多種條件篩選，包括分錄編號、員工代碼、處理狀態、結案日期和交易日期
- 程式使用GLAHLF01邏輯檔案，該檔案是GLAHPF的邏輯檢視 
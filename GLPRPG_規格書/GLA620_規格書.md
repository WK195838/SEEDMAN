# GLA620 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA620
- **程式說明**：預算定額分配作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA620
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.08
- **修改日期**：-
- **系統**：會計總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLA1PF**：預算定額分配主檔
- **GLA2PF**：預算定額分配明細檔
- **GLA6PF**：預算分配比率檔
- **GLADPF**：摘要檔
- **GLAKPF**：會計參數檔
- **PT#APF**：會計項目檔
- **PT#BPF**：部門檔
- **GLA620D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA620
- **呼叫程式**：
  - P31：日期格式處理程式
  - P64I：印表機查詢程式
  - GLI440：部門代碼查詢程式
  - GLI620：會計相關查詢程式
  - GLI660：比率代碼查詢程式
  - PTI140：會計項目查詢程式
  - S#S01：權限檢查程式

## 3. 檔案欄位規格說明

### GLA1PF (預算定額分配主檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A101 | 部門代號 | 字元 | 主索引鍵之一 |
| A102 | 年度 | 數值 | 主索引鍵之二 |
| A103 | 層級 | 數值 | 主索引鍵之三 |
| A104 | 部門摘要代碼 | 字元 | 主索引鍵之四 |
| A105 | 預算摘要名稱 | 字元 | - |
| A106 | 總金額 | 數值 | - |
| A197 | 輸入時間 | 時間 | - |
| A198 | 輸入日期 | 數值 | - |
| A199 | 輸入人員 | 字元 | - |

### GLA2PF (預算定額分配明細檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A201 | 部門代號 | 字元 | 主索引鍵之一 |
| A202 | 年度 | 數值 | 主索引鍵之二 |
| A203 | 層級 | 數值 | 主索引鍵之三 |
| A204 | 部門摘要代碼 | 字元 | 主索引鍵之四 |
| A205 | 會計項目代碼 | 字元 | 主索引鍵之五 |
| A206 | 金額 | 數值 | - |
| A207-A219 | 月份金額1-13 | 數值 | - |
| A297 | 輸入時間 | 時間 | - |
| A298 | 輸入日期 | 數值 | - |
| A299 | 輸入人員 | 字元 | - |

### GLA6PF (預算分配比率檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A601 | 部門代號 | 字元 | 主索引鍵之一 |
| A602 | 比率代碼 | 字元 | 主索引鍵之二 |
| A603 | 比率說明 | 字元 | - |

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPD1)
- **畫面標題**：預算定額分配作業
- **輸入欄位**：
  - 公司別 (DA101)：必填
  - 年度 (DA102)：必填
  - 層級 (DA103)：必填
  - 部門摘要代碼 (DA104)：必填
  - 複製來源 (DA101C, DA102C, DA103C, DA104C)：可選
  - 作業項目 (DOPT)：1=新增, 2=修改, 4=刪除, 5=查詢

- **功能鍵**：
  - F3：結束
  - F4：查詢
  - F18：瀏覽

### 明細畫面 (SFLCR/SFLSR)
- **畫面標題**：預算定額分配作業
- **輸入欄位**：
  - 預算摘要名稱 (DA105)
  - 比率代碼 (DA602)
  - 基數 (DBAS)
  - 明細選項 (DOP)：空白=正常, 4=刪除, 6=計算金額, 7=重新計算
  - 會計項目代碼 (DA205)
  - 比率百分比 (DPER1)
  - 金額 (DA206)

- **功能鍵**：
  - F3：結束
  - F4：查詢
  - F5：確認
  - F12：返回

### 月份金額分配畫面 (DSPD3)
- **畫面標題**：預算定額分配作業
- **輸入欄位**：
  - 月份金額 (@W03,1-13)：13個月的金額分配

- **功能鍵**：
  - F3：結束
  - F5：檢查
  - F12：返回

## 5. 處理流程程序說明

### 主要流程
1. 初始化環境和畫面 (R0100)
2. 根據畫面識別碼執行不同處理：
   - SC01：主畫面處理 (R1000)
   - SC02：明細畫面處理 (R2000)
   - SC03：月份金額分配處理 (R3000)
3. 程式結束

### 主畫面處理流程 (R1000)
1. 顯示主畫面並等待使用者輸入
2. 處理功能鍵：
   - F3：結束程式
   - F4：執行查詢功能 (R1E00)
   - F18：執行瀏覽功能 (R1A00)
3. 檢查輸入資料 (R1B00)
4. 初始化明細畫面 (R1C00)
5. 切換至明細畫面 (SC02)

### 明細畫面處理流程 (R2000)
1. 顯示明細畫面並等待使用者輸入
2. 處理功能鍵：
   - F3：結束程式
   - F4：執行查詢功能 (R2E00)
   - F12：返回主畫面 (SC01)
   - 向上翻頁：顯示下一頁明細 (R1CD0)
3. 檢查輸入資料 (R2B00)
4. 更新檔案資料 (R2D00)
5. 返回主畫面 (SC01)

### 月份金額分配處理流程 (R3000)
1. 初始化月份金額分配畫面 (R3A00)
2. 顯示月份金額分配畫面並等待使用者輸入
3. 處理功能鍵：
   - F3：結束程式
   - F12：返回明細畫面 (SC02)
4. 檢查輸入資料 (R3B00)
5. 更新檔案資料 (R3D00)
6. 返回明細畫面 (SC02)

## 6. 子程序處理邏輯說明

### 主畫面初始化 (R0100)
- 讀取參數及系統日期
- 設定功能鍵權限
- 初始化螢幕欄位

### 資料檢核 (R1B00)
1. 檢查使用者權限
2. 檢查必填欄位：公司別、年度、層級、部門摘要代碼
3. 檢查公司別是否有效
4. 檢查部門摘要代碼是否有效
5. 格式化年度顯示
6. 檢查作業項目與資料存在性

### 明細畫面初始化 (R1C00)
- 設定子檔顯示控制
- 依據作業項目執行不同初始化：
  - 新增：初始化表頭和明細 (R1CA0, R1CD0)
  - 新增(複製)：讀取來源資料 (R1CB0, R1CE0)
  - 修改：讀取既有資料 (R1CB0, R1CE0)
  - 刪除/查詢：僅讀取既有資料

### 明細資料檢核 (R2B10)
1. 檢查明細選項是否合法
2. 檢查會計項目代碼是否有效
3. 計算金額：基數 × 比率百分比 = 金額
4. 依據比率代碼計算月份金額分配

### 檔案更新 (R2D00)
- 依作業項目執行不同處理：
  - 新增：新增主檔和明細資料 (R2D10, R2D11, R2D12)
  - 修改：更新主檔和明細資料 (R2D20)
  - 刪除：刪除主檔和明細資料 (R2D30)

### 月份金額計算 (R3D00)
- 更新明細檔的月份金額欄位
- 計算總金額並更新

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 必填欄位不可為空白 |
| UPT0012 | PTMF | 層級不可為零 |
| UPT0030 | PTMF | 作業選項與使用者權限不符 |
| UPT0060 | PTMF | 複製來源資料不存在 |
| UPT2010 | PTMF | 資料不存在 |
| UPT2020 | PTMF | 資料已存在 |
| UPT2050 | PTMF | 無資料 |
| UPT2150 | PTMF | 使用者權限不足 |
| UGL0004 | GLMF | 會計項目代碼無效 |

## 8. 備註

1. 本程式為會計總帳系統中的預算定額分配作業程式，用於設定各部門的預算分配。
2. 程式支援複製功能，可將既有的預算資料複製為新年度的預算。
3. 預算可按會計項目分配，並可設定每個項目的比率百分比。
4. 程式提供兩種預算分配方式：平均分配和比率分配。
5. 平均分配會將總金額平均分配給每個月份，比率分配則按照預設的比率進行分配。
6. 使用者可以調整各月份的金額分配，但系統會確保總金額保持一致。
7. 程式自動計算項目金額 = 基數 × 比率百分比。
8. 程式會檢查公司別、部門代碼和會計項目代碼是否有效，確保資料的正確性。 
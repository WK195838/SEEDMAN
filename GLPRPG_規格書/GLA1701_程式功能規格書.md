# GLA1701 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1701
- **程式說明**：結帳作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1701
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.06
- **系統**：會計總帳
- **功能描述**：處理會計期末結帳作業，包括結轉會計分錄、產生調整分錄、更新科目餘額及列印報表等功能

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHLF01**：會計分錄歷史檔（更新檔案）
- **GLAILF01**：會計科目餘額檔（更新檔案）
- **GLALPF**：結帳分錄檔（更新檔案）
- **GLALLF01**：結帳分錄邏輯檔（讀取檔案）
- **GLAKPF**：會計期間檔（更新檔案）
- **GLAGPF**：調整分錄檔（輸出檔案）
- **GLAMPF**：結帳明細檔（更新檔案）
- **GLA5PF**：結帳記錄檔（更新檔案）
- **GLAEPF**：會計科目分類檔（參考檔案）
- **GLAFPF**：會計科目檔（參考檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **GLAHLF06**：會計分錄歷史檔邏輯檔（更新檔案）
- **GLA170D**：螢幕顯示檔（工作站檔案）
- **GLA170P**：報表輸出檔（印表機檔）
- **GLACPF**：會計科目類別檔（參考檔案）
- **GLACLF01**：會計科目類別邏輯檔（參考檔案）

### 檔案間關聯
- 使用公司代碼（AH01/AL01）連結各檔案
- 使用會計科目（AH04/AF02）連結GLAHLF01與GLAFPF
- 使用SFLSRC和SFLSRD子檔分別顯示借方和貸方明細
- 使用KEYAH、KEYAF、KEYAE、KEYA5、KEYAI、KEYAI1、KEYAK、KEYAL1、KEYAL2、KEYAM等關鍵字列表進行檔案存取

## 3. 檔案欄位規格說明

### GLAHLF01 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AH03 | 明細筆數 | - | - | 數值 | 分錄明細筆數 |
| AH04 | 科目代碼 | - | 8 | 文字 | 會計科目代碼 |
| AH05-AH08 | 摘要內容 | - | 20 | 文字 | 分錄摘要說明 |
| AH09 | 金額 | - | - | 數值 | 分錄金額 |
| AH10 | 交易日期 | - | 8 | 數值 | 會計交易日期 |
| AH12 | 借方金額 | - | - | 數值 | 借方金額 |
| AH13 | 貸方金額 | - | - | 數值 | 貸方金額 |
| AH14 | 數量 | - | - | 數值 | 交易數量 |
| AH15 | 備註 | - | 20 | 文字 | 備註說明 |
| AH16 | 摘要描述 | - | 50 | 文字 | 完整摘要描述 |
| AH17 | 來源代碼 | - | 2 | 文字 | RJ=結帳 |
| AH18 | 過帳標記 | - | 1 | 文字 | V=已過帳 |
| AH19 | 結案標記 | - | 1 | 文字 | @=結帳 |
| AH21 | 結帳日期 | - | 8 | 數值 | 結帳日期 |
| AH24 | 對應分錄號 | - | - | 文字 | 對應分錄編號 |
| AH25 | 作業日期 | - | 8 | 數值 | 作業執行日期 |
| AH26 | 作業人員 | - | 10 | 文字 | 作業執行人員 |
| AH97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### GLAILF01 (會計科目餘額檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AI01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AI02 | 年度 | - | 4 | 數值 | 主鍵 |
| AI03 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AI04-AI08 | 對應欄位 | - | - | 文字 | 對應欄位內容 |
| AI10 | 餘額 | - | - | 數值 | 科目餘額 |
| AI11 | 月份餘額 | - | - | 數值 | 各月份餘額陣列 |
| AI97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AI98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AI99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### GLALPF (結帳分錄檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AL01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AL02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AL03 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AL04-AL08 | 對應欄位 | - | - | 文字 | 對應欄位內容 |
| AL09 | 結帳餘額 | - | - | 數值 | 結帳餘額 |
| AL10 | 結轉金額 | - | - | 數值 | 已結轉金額 |
| AL11 | 結轉筆數 | - | - | 數值 | 已結轉筆數 |
| AL12 | 交易日期 | - | 8 | 數值 | 交易日期 |
| AL97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AL98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AL99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### GLAMPF (結帳明細檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AM01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AM02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AM03 | 對應分錄號 | - | 9 | 文字 | 主鍵 |
| AM04-AM08 | 對應欄位 | - | - | 文字 | 對應欄位內容 |
| AM09 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AM10 | 交易日期 | - | 8 | 數值 | 交易日期 |
| AM11 | 結轉金額 | - | - | 數值 | 結轉金額 |
| AM97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AM98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AM99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### GLA5PF (結帳記錄檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| A501 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| A502 | 來源代碼 | - | 2 | 文字 | 主鍵 |
| A503 | 最後結帳日 | - | 8 | 數值 | 最後結帳日期 |
| A597 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| A598 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| A599 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| DAH01 | 公司代碼 | 501 | 2 | 文字 | 處理的公司代碼 |
| DAH10 | 交易日期 | 503 | 7 | 數值 | 交易日期 |
| DAH17 | 來源代碼 | 510 | 2 | 文字 | 來源代碼 |
| DAH10F | 交易日期起 | 512 | 8 | 數值 | 交易日期起始值 |
| DAH17F | 來源代碼起 | 520 | 2 | 文字 | 來源代碼起始值 |
| DAH17T | 來源代碼迄 | 522 | 2 | 文字 | 來源代碼結束值 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
```
                              結帳作業                             公司：XX
                                                                 日期：YYYY/MM/DD

                 借方科目                                   貸方科目
序號  科目代碼   科目名稱      金額      序號  科目代碼   科目名稱      金額
----  --------  ----------  ----------   ----  --------  ----------  ----------
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX
```

### 報表格式
```
                              結帳作業列印                       頁次: XXX
                              XXXXXXXXXX                         日期: YY/MM/DD
                                                                時間: HH:MM:SS

序號    分錄編號      序號    分錄編號      序號    分錄編號      序號    分錄編號
----    ---------     ----    ---------     ----    ---------     ----    ---------
XXX     XXXXXXXXX     XXX     XXXXXXXXX     XXX     XXXXXXXXX     XXX     XXXXXXXXX
```

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 取得公司名稱

2. 初始化子檔（R0200子程序）
   - 初始化SFLSRC和SFLSRD子檔
   - 清除子檔內容

3. 計算科目餘額（R1000子程序）
   - 取得會計期間
   - 更新科目餘額檔

4. 處理結轉記錄（R2000子程序）
   - 檢查科目是否需要結轉
   - 根據科目屬性執行結轉或沖銷處理

5. 產生調整分錄（R3000子程序）
   - 產生調整分錄編號
   - 寫入調整分錄資料

6. 計算分錄平衡（R4000子程序）
   - 檢查借貸平衡
   - 更新分錄資料

7. 更新結帳記錄（R5000子程序）
   - 更新最後結帳日期
   - 寫入結帳記錄檔

8. 列印結帳報表（R6000子程序）
   - 輸出結帳分錄清單

9. 更新期間資料（R9000子程序）
   - 更新會計期間檔案
   - 更新分錄結案標記

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 設定初始指標
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 初始化計數器和工作變數

### R0200 - 子檔初始化
- 初始化SFLSRC和SFLSRD子檔
- 設定子檔控制指標
- 清除子檔內容

### R1000 - 計算科目餘額
- 呼叫GLS005程式取得會計期間
- 讀取會計科目檔(GLAFPF)
- 取得科目餘額
- 更新科目餘額檔(GLAILF01)

### R1100 - 更新科目餘額檔
- 檢查科目餘額記錄是否存在
- 計算借貸餘額
- 更新月份餘額資料
- 寫入或更新科目餘額檔

### R2000 - 處理結轉記錄
- 讀取會計科目檔
- 根據科目借貸屬性決定處理方式
- 執行結轉或沖銷處理

### R2100 - 結轉處理
- 取得分類代碼
- 讀取結帳分錄檔
- 計算結轉金額
- 更新結帳分錄檔

### R2200 - 寫入結帳分錄檔
- 設定結帳分錄資料
- 寫入或更新結帳分錄檔

### R2500 - 沖銷處理
- 取得分類代碼
- 處理對應分錄沖銷
- 更新結帳分錄檔

### R3000 - 產生調整分錄
- 檢查是否需要產生調整分錄
- 呼叫GLS002程式產生分錄編號
- 寫入調整分錄資料(GLAGPF)
- 寫入會計分錄資料(GLAHPF)

### R3200 - 寫入會計分錄資料
- 設定會計分錄標頭資料
- 讀取子檔記錄
- 產生分錄明細
- 寫入會計分錄檔

### R4000 - 計算分錄平衡
- 呼叫GLS003程式計算分錄平衡
- 更新分錄資料

### R5000 - 更新結帳記錄
- 讀取結帳記錄檔(GLA5PF)
- 更新最後結帳日期
- 寫入或更新結帳記錄檔

### R6000 - 列印結帳報表
- 檢查是否需要輸出報表標頭
- 設定報表資料
- 輸出分錄編號清單
- 每行最多輸出4筆分錄編號

### R7000 - 處理調整分錄
- 檢查是否為調整分錄
- 設定子檔記錄
- 更新分錄過帳標記
- 計算科目餘額

### R8000 - 更新科目餘額
- 呼叫GLS005程式取得會計期間
- 讀取會計期間檔(GLAKPF)
- 更新科目餘額檔
- 更新系統時間和處理人員

### R9000 - 更新期間資料
- 產生調整分錄
- 計算分錄平衡
- 更新結帳記錄
- 列印結帳報表
- 更新會計期間檔最後結帳日期
- 更新分錄結案標記

### R9900 - 無資料處理
- 輸出報表標頭
- 輸出無資料訊息

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 程式中沒有特別的錯誤處理邏輯
- 當找不到符合條件的記錄時，會輸出無資料的訊息

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| - | 無資料 | 顯示「無符合條件的資料」訊息 |

## 8. 備註
- 本程式為會計期末結帳作業，處理會計科目餘額的結轉和沖銷
- 程式會自動產生調整分錄，並更新相關科目餘額
- 結帳完成後會更新分錄的結案標記為'@'
- 程式會更新會計期間檔的最後結帳日期
- 結帳作業會根據科目的屬性決定是否需要結轉或沖銷
- 程式使用GLALLF01和GLAHLF06邏輯檔案，分別是GLALPF和GLAHLF01的邏輯檢視 
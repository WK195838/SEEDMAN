# 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR102
- **程式說明**：會計系統報表控制程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR102
- **系統名稱**：會計系統
- **子系統**：會計處理

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAKPF：會計主檔
- **顯示檔案**
  - GAR102D：報表控制顯示檔案

## 3. 檔案欄位規格說明
### 資料區定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| $PFMT | 1 | 1 | 字元 | 報表格式 |
| $PTYPE | 2 | 1 | 字元 | 報表類型 |
| $USER | 101-110 | 10 | 字元 | 使用者代號 |
| $CPY | 125-127 | 3 | 數值 | 公司代號 |
| $INQ | 138 | 1 | 字元 | 查詢標記 |
| $USERN | 152-161 | 10 | 字元 | 使用者名稱 |
| $A8YMD | 201-208 | 8 | 數值 | 會計年度 |
| $C8YMD | 209-216 | 8 | 數值 | 系統日期 |
| $PRTCD | 217-218 | 2 | 字元 | 列印代號 |
| $PENV | 219 | 1 | 字元 | 環境變數 |

### 報表參數：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| DAH01 | 501-502 | 2 | 字元 | 系統代號 |
| DAH25F | 503-510 | 8 | 數值 | 貸方科目起始值 |
| DAH25T | 511-518 | 8 | 數值 | 貸方科目結束值 |
| DAH10F | 519-526 | 8 | 數值 | 借方科目起始值 |
| DAH10T | 527-534 | 8 | 數值 | 借方科目結束值 |
| DAH02F | 535-543 | 9 | 字元 | 摘要起始值 |
| DAH02T | 544-552 | 9 | 字元 | 摘要結束值 |
| DAH26F | 553-562 | 10 | 字元 | 日期起始值 |
| DAH26T | 563-572 | 10 | 字元 | 日期結束值 |
| DAH17F | 573-574 | 2 | 字元 | 部門起始值 |
| DAH17T | 575-576 | 2 | 字元 | 部門結束值 |
| DAH19 | 577 | 1 | 字元 | 報表類型 |
| DAH19F | 578 | 1 | 字元 | 報表類型起始值 |
| DAH19T | 579 | 1 | 字元 | 報表類型結束值 |

## 4. 輸出/入螢幕布局與說明
- 使用顯示檔案：GAR102D
- 螢幕功能：
  * 報表控制主畫面
  * 報表參數設定
  * 報表執行選項

## 5. 處理流程程序說明
### 1. 程式初始化
- 初始化訊息設定（R0200）
- 初始化畫面值（R0100）：
  * 呼叫P31設定日期格式
  * 清除各欄位初始值

### 2. 主要處理邏輯
1. 畫面控制：
   - 顯示主畫面
   - 處理使用者輸入
   - 檢查控制變數

2. 資料驗證（R1B00）：
   - 系統代號檢查
   - 日期格式驗證
   - 科目範圍檢查
   - 摘要範圍檢查
   - 部門範圍檢查
   - 報表類型檢查
   - 功能權限檢查

3. 子程式呼叫（R1E00）：
   - 部門代號查詢（PTI121）
   - 列印代號設定（P64I）

## 6. 子程序處理邏輯說明
- **P31**：日期格式轉換程式
  * 處理日期格式轉換
  * 參數：
    - 輸入日期
    - 格式代號
    - 轉換類型

- **P30**：日期格式檢查程式
  * 檢查日期格式是否正確
  * 參數：
    - 輸入日期
    - 格式代號
    - 檢查類型

- **PTI121**：部門代號查詢程式
  * 查詢部門代號
  * 參數：
    - 部門代號
    - 回傳值

- **P64I**：列印代號設定程式
  * 設定報表列印代號
  * 參數：
    - 列印代號

## 7. 錯誤處理程序說明與訊息清冊
- 環境變數錯誤：
  * UPT2142：查詢模式錯誤
  * UPT2140：線上模式錯誤
  * UPT2110：批次模式錯誤
- 資料驗證錯誤：
  * UPT0010：系統代號空白
  * UPT2010：系統代號不存在
  * UPT0040：日期格式錯誤
  * UPT0041：日期範圍錯誤
  * UPT0042：摘要範圍錯誤
  * UPT0030：報表類型錯誤
  * UPT2150：功能權限不足

## 8. 備註
- 程式主要用於控制報表的執行
- 支援多種執行模式：
  * 查詢模式
  * 線上模式
  * 批次模式
- 使用LDA資料區傳遞參數
- 程式結構包含：
  * 參數設定
  * 資料驗證
  * 報表控制
  * 子程式呼叫
- 查詢條件特點：
  * 支援多欄位範圍查詢
  * 包含日期格式驗證
  * 支援部門代號查詢
  * 可設定列印代號 
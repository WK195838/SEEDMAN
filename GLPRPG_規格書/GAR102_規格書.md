# GAR102 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR102
- **程式說明**：參數日曆產生密碼設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR102
- **開發人員**：未指定
- **建立日期**：未指定
- **系統名稱**：會計總帳系統
- **子系統**：會計處理
- **備註**：參數日曆密碼設定程式
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAKPF：會計參數檔
- **顯示檔案**
  - GAR102D：參數日曆產生密碼螢幕顯示檔
- **資料區**
  - LDA：區域資料區
  - PTDA01：參數資料區
- **相關程式**
  - P30：日期檢核程式
  - P31：日期轉換程式
  - P64I：印表機選擇程式
  - PTI121：參數來源查詢程式

## 3. 檔案欄位規格說明

### GLAKPF（會計參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AK01 | 部門別 | 參照GLRF | 主鍵欄位 |
| AK09 | 日期格式 | 參照GLRF | 日期顯示格式 |
| AK11 | 日期類型 | 參照GLRF | 日期類型參數 |

### GAR102D（螢幕顯示檔）
| 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| CONAME | 1,26 | 32 | A | O | 公司名稱 |
| DDATE | 1,72 | 6 | Y | O | 系統日期 |
| $USERN | 2,2 | 10 | A | O | 使用者代號 |
| DAH01 | 5,39 | - | A | B | 公司別 |
| D25F/DAH25F | 7,39 | 8 | Y | B | 建檔日期(起) |
| D25T/DAH25T | 7,49 | 8 | Y | B | 建檔日期(迄) |
| D10F/DAH10F | 9,39 | 8 | Y | B | 參數日期(起) |
| D10T/DAH10T | 9,49 | 8 | Y | B | 參數日期(迄) |
| DAH02F | 11,39 | 9 | A | B | 參數代碼(起) |
| DAH02T | 11,49 | 9 | A | B | 參數代碼(迄) |
| DAH26 | 13,39 | 10 | A | B | 建檔人 |
| DAH17 | 15,39 | 2 | A | B | 參數來源 |
| DAH19 | 17,39 | 1 | A | B | 顯示內容 |
| $PENV | 19,39 | 1 | A | B | 輸出裝置 |
| $CPY | 21,39 | 3 | Y | B | 列印份數 |
| $PRTCD | 23,39 | 2 | A | B | 列印機台 |

### 程式內部變數
| 變數名稱 | 型態 | 長度 | 說明 |
|---------|------|------|------|
| #CSR | 數值 | 10 | 游標位置 |
| #LIN | 數值 | 5 | 游標行位置 |
| #COL | 數值 | 5 | 游標列位置 |
| ERRID | 字元 | 7 | 錯誤代碼 |
| ERRF | 字元 | 10 | 錯誤檔案 |
| $PFMT | 字元 | 1 | 參數區日期格式 |
| $PTYPE | 字元 | 1 | 參數區日期型態 |
| @PRT | 字元 | 1 | 列印控制旗標 |
| WTMP1~4 | 數值 | 8 | 日期臨時變數 |
| P3001O | 字元 | 1 | 日期檢核結果 |
| P3101O | 數值 | 8 | 日期轉換結果 |

## 4. 輸出/入螢幕布局與說明

### 1. 主畫面布局
```
<GAR102.1>                     [公司名稱]                        [日期]
[使用者ID]                   參數日曆產生密碼

                         公司別  : [   ]

                         建檔日期: [  /  /  ] - [  /  /  ]

                         參數日期: [  /  /  ] - [  /  /  ]

                         參數代碼: [      ] - [      ]

                         建檔人  : [          ] (可空白代表*ALL )

                         參數來源: [  ] (可空白代表*ALL )

                         顯示內容: [  ] 1.英文版
                                       2.中文版
                                       3.全部

                         輸出裝置: [ ] (0-螢幕 1-印表 2-檔案)

                         列印份數: [   ]

                         列印機台: [  ]


[錯誤訊息顯示區域]
注意    PF3 =回主畫面    PF4 =重新查詢    PF14 =處理作業
                                                           【茂世資訊】
```

## 5. 處理流程程序說明

### 主程序流程
1. 若指示燈10為開，則執行初始化訊息設定（R0200）
2. 若指示燈10為關，則執行初始化畫面設定（R0100）
3. 初始化列印旗標（@PRT）為空白
4. 循環執行主畫面處理（R1000），直到使用者按下PF3（指示燈03=開）或列印旗標（@PRT）為'Y'
5. 若指示燈03為開，則設定結束程式指示燈（LR）並返回

### 初始化畫面設定程序（R0100）
1. 設定指示燈10和27為開
2. 讀取參數資料區（PTDA01）
3. 呼叫日期處理程式（P31）轉換系統日期為顯示日期格式
4. 初始化各欄位值：
   - 公司別：空白
   - 建檔日期（起/迄）：0
   - 參數日期（起/迄）：0
   - 參數代碼（起/迄）：空白
   - 建檔人：空白
   - 參數來源：空白
   - 顯示內容：空白

### 初始化訊息設定程序（R0200）
1. 設定指示燈27和99為開
2. 根據執行環境變數（$PENV）設定不同的訊息代碼：
   - $PENV='0'（查詢模式）：錯誤代碼UPT2142
   - $PENV='1'（線上模式）：錯誤代碼UPT2140
   - $PENV='2'（批次模式）：錯誤代碼UPT2110

### 主畫面處理程序（R1000）
1. 顯示主畫面（DSPD1）
2. 清除所有指示燈（60-99）
3. 初始化游標位置變數（#LIN和#COL）
4. 當使用者按下PF3（指示燈03=開）時，返回主程序
5. 當使用者按下PF4（指示燈04=開）時，呼叫提示處理子程序（R1E00）並返回主畫面
6. 執行資料檢查（R1B00）
7. 當使用者按下PF14（指示燈14=開）且無錯誤（指示燈99=關）時：
   - 關閉主畫面（指示燈27=關）
   - 顯示處理中提示（指示燈28=開）
   - 更新畫面並關閉處理中提示
   - 將資料寫入LDA資料區
   - 設定列印旗標（@PRT）為'Y'

### 資料檢查程序（R1B00）
1. 檢查公司別（DAH01）：
   - 若為空白，設定錯誤訊息（UPT0010）
   - 若不存在於GLAKPF檔案，設定錯誤訊息（UPT2010）
2. 檢查建檔日期起始值（D25F）：
   - 若為0，則設為最小值（00010101）
   - 否則呼叫P30檢核日期格式有效性，若無效則設定錯誤訊息（UPT0040）
   - 若有效則呼叫P31轉換日期格式並存回DAH25F
3. 檢查建檔日期結束值（D25T）：
   - 若為0，則設為最大值（*HIVAL）並呼叫P31轉換格式
   - 否則呼叫P30檢核日期格式有效性，若無效則設定錯誤訊息（UPT0040）
   - 若有效則呼叫P31轉換日期格式並存回DAH25T
4. 檢查建檔日期範圍：
   - 若起始值大於結束值，設定錯誤訊息（UPT0041）並反白相關欄位
5. 檢查參數日期起始值（D10F）和結束值（D10T）：
   - 與建檔日期檢查邏輯相同
6. 檢查參數日期範圍：
   - 若起始值大於結束值，設定錯誤訊息（UPT0041）並反白相關欄位
7. 檢查參數代碼（DAH02F和DAH02T）：
   - 若起始值為空白，則設為最小值（*LOVAL）
   - 若結束值為空白，則設為最大值（*ALL'9'）
   - 若起始值大於結束值，設定錯誤訊息（UPT0042）
8. 處理建檔人（DAH26）和參數來源（DAH17）：
   - 若為空白，則分別設為最小值（*LOVAL）和最大值（*HIVAL）
   - 否則使用輸入值
9. 檢查顯示內容（DAH19）：
   - 值必須為'1'、'2'或'3'，否則設定錯誤訊息（UPT0030）
   - 根據選擇設定相應的旗標值：
     * '1'：設定DAH19F和DAH19T為'V'（英文版）
     * '2'：設定DAH19F和DAH19T為空白（中文版）
     * '3'：設定DAH19F為空白，DAH19T為'V'（全部）
10. 檢查使用者權限：
    - 若環境不是批次模式且查詢權限（$INQ）不為'Y'，設定錯誤訊息（UPT2150）

### 提示處理程序（R1E00）
1. 計算游標行列位置（將#CSR除以256得到#LIN和#COL）
2. 當游標位於參數來源欄位（行=11，列=39-40）時：
   - 呼叫參數來源查詢程式（PTI121）
   - 傳遞參數'AH17'和當前值，接收新的參數來源值
3. 當游標位於列印機台欄位（行=17，列=39-40）時：
   - 呼叫印表機選擇程式（P64I）
   - 傳遞當前列印機台代號，接收新的列印機台代號

## 6. 子程序處理邏輯說明

### P30 - 日期檢核程式
- 功能：檢查日期格式的有效性
- 參數：
  * P3001I：輸入日期
  * P3002I：日期類型（AK11）
  * P3003I：日期格式（AK09）
- 回傳：P3001O（'Y'=有效，否則無效）

### P31 - 日期轉換程式
- 功能：將日期轉換為指定的格式
- 參數：
  * P3101I：輸入日期
  * P3102I：日期類型（AK11或系統定義值）
  * P3103I：日期格式（AK09或系統定義值）
  * P3104I：輸出類型
  * P3105I：輸出格式
- 回傳：P3101O（格式化後的日期值）

### PTI121 - 參數來源查詢程式
- 功能：提供參數來源的查詢和選擇
- 參數：
  * P121I1：參數類型（'AH17'）
  * P121O1：選擇的參數來源

### P64I - 印表機選擇程式
- 功能：提供印表機代號選擇
- 參數：P64II1（輸入/輸出印表機代號，$PRTCD）
- 回傳：更新後的印表機代號

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 公司代號不可為空白 |
| UPT0030 | PTMF | 顯示內容值必須為1、2或3 |
| UPT0040 | PTMF | 日期格式不正確 |
| UPT0041 | PTMF | 日期範圍不正確（起始值大於結束值） |
| UPT0042 | PTMF | 參數代碼範圍不正確（起始值大於結束值） |
| UPT2010 | PTMF | 公司代號不存在 |
| UPT2110 | PTMF | 批次處理模式訊息 |
| UPT2140 | PTMF | 線上模式訊息 |
| UPT2142 | PTMF | 查詢模式訊息 |
| UPT2150 | PTMF | 使用者權限不足 |

## 8. 備註

1. 本程式為會計總帳系統的參數日曆產生密碼設定作業程式，用於設定參數日曆檔案的密碼。
2. 使用者可依需求設定各種篩選條件來選擇要設定密碼的資料，包括公司別、日期範圍、參數代碼、建檔人、參數來源等。
3. 程式提供三種語言版本選擇：英文版、中文版和全部。
4. 可設定輸出至螢幕、印表機或檔案，並可指定列印份數及印表機代號。
5. 日期欄位均經過有效性檢查以確保資料正確。
6. 程式會檢查使用者是否具有足夠權限執行此功能。
7. 當公司代號為空白或不存在時，系統會顯示相應的錯誤訊息。
8. 如果日期範圍或參數代碼範圍設定不正確（起始值大於結束值），系統會顯示錯誤訊息。
9. 程式使用標準的日期處理子程序以支援不同的日期格式。
10. 本程式與GAR101功能相似，但主要用於密碼設定而非報表輸出。 
# GLA530 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA530
- **程式說明**：年結分錄作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA530
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.04 (81/12/04)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAHPF**：傳票檔
- **GLAPPF**：傳票明細檔
- **GLAQPF**：傳票明細分配檔
- **GLAAPF**：會計項目檔
- **GLADPF**：部門檔
- **GLAFPF**：會計項目檔
- **GLAKPF**：參數檔
- **GLACPF**：會計資料檔
- **PT#BPF**：部門參數檔
- **GLA530D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA530
- **呼叫程式**：
  - P31：日期格式處理程式
  - P64I：印表機代碼設定程式
  - GLI410：會計項目查詢程式
  - GLI440：部門代碼查詢程式
  - GLI1E0：傳票查詢程式
  - GLS001：字串處理程式
  - GLS002：單據號碼處理程式
  - GLS005：會計日期起迄值程式
  - GLA531：年結分錄執行程式
  - GLA190：傳票輸入程式
  - GLR1K0：傳票列印程式
- **功能鍵**：F3(離開), F4(查詢), F6(確認), F9(列印), F12(返回), F14(執行作業)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：系統日期
  - $CPY (125-127)：公司代號
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $RMK01 (139-139)：特殊權限標記
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $PRTCD (217-218)：印表機代碼
  - $PENV (219-219)：印表機環境

### 陣列定義
- **@A01 (功能權限陣列)**：儲存各種功能權限
- **WFUN (功能代碼陣列)**：儲存功能代碼
- **W02 (會計項目代碼陣列)**：儲存會計項目代碼
- **W03 (會計項目名稱陣列)**：儲存會計項目名稱
- **W04 (檢核程式名稱陣列)**：儲存檢核程式名稱
- **W05 (欄位內容陣列)**：儲存輸入欄位內容
- **W06 (欄位內容說明陣列)**：儲存輸入欄位內容說明
- **W07 (欄位檢核碼陣列)**：儲存輸入欄位檢核碼
- **W13, W14, W15 (記錄追蹤陣列)**：用於資料處理追蹤

### 主要欄位說明
- **DAH01**：部門代號
- **DAH02**：分錄號碼
- **WAH10**：分錄日期
- **DAH03**：明細序號
- **DAH04**：會計項目代號
- **DAH05-DAH08**：各種輸入欄位內容
- **DAH09**：金額
- **DAH11**：有效標記
- **DAH12**：借方金額
- **DAH13**：貸方金額
- **DAH14**：數量
- **DAH15**：備註
- **DAH22**：部門代碼
- **DAH24**：傳票號碼

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (SC01-DSPD1)
- **螢幕標題**：年結分錄作業
- **畫面描述**：設定年結分錄的基本資料
- **輸入欄位**：
  - 部門代號 (DAH01)：選擇部門代號
  - 分錄年度 (DAH10Y)：輸入分錄年度
- **功能鍵**：
  - F3：離開
  - F13：列印設定
  - F14：確認進入明細畫面

### 第二畫面 (SC02-DSPD2)
- **螢幕標題**：年結分錄明細資料
- **畫面描述**：輸入年結分錄的會計項目
- **輸入欄位**：
  - 會計項目 (DAH04)：輸入會計項目代號
  - 借方金額 (DAH12)：輸入借方金額
  - 貸方金額 (DAH13)：輸入貸方金額
- **功能鍵**：
  - F3：離開
  - F4：會計項目查詢
  - F6：確認明細
  - F9：列印分錄
  - F12：返回上一畫面

### 第三畫面 (SC03-DSPD3)
- **螢幕標題**：年結分錄明細資料細項
- **畫面描述**：輸入分錄明細的細項資料
- **輸入欄位**：
  - 說明 (DAH05)：輸入說明文字
  - 摘要 (DAH06)：輸入摘要
  - 交易代碼1 (DAH07)：輸入交易代碼1
  - 交易代碼2 (DAH08)：輸入交易代碼2
  - 金額 (DAH09)：輸入金額
  - 數量 (DAH14)：輸入數量
  - 備註 (DAH15)：輸入備註
  - 部門代碼 (DAH22)：輸入部門代碼
  - 傳票號碼 (DAH24)：輸入傳票號碼
- **功能鍵**：
  - F3：離開
  - F4：查詢功能
  - F12：返回上一畫面

### 第四畫面 (SC04-DSPD4)
- **螢幕標題**：年結分錄明細清單
- **畫面描述**：顯示已輸入的分錄明細清單
- **顯示欄位**：
  - 序號 (DAH03)：明細序號
  - 會計項目 (DAH04)：會計項目代號
  - 借方金額 (DAH12)：借方金額
  - 貸方金額 (DAH13)：貸方金額
  - 說明 (DAH05)：說明文字
  - 有效標記 (DAH11)：資料有效標記
- **功能鍵**：
  - F3：離開
  - F12：返回上一畫面

### 第五畫面 (SC05-DSPD8)
- **螢幕標題**：年結分錄確認
- **畫面描述**：確認執行年結分錄作業
- **輸入欄位**：
  - 分錄日期 (DAH10A)：輸入分錄日期
- **功能鍵**：
  - F3：離開
  - F12：返回上一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入主畫面處理迴圈，依照畫面ID執行對應處理
   - SC01：主畫面 (R1000)
   - SC02：分錄明細畫面 (R2000)
   - SC04：明細清單畫面 (R4000)
   - SC05：確認執行畫面 (R5000)
3. 根據使用者輸入執行相應處理
4. 程式結束

### 主畫面處理流程 (R1000)
1. 顯示主畫面等待使用者輸入
2. 若按F3則結束程式
3. 若按F13則進入列印設定 (R1A00)
4. 檢核使用者輸入資料 (R1B00)
5. 若檢核無誤則初始化明細畫面 (R1C00)並切換至SC02

### 分錄明細畫面處理流程 (R2000)
1. 顯示分錄明細畫面等待使用者輸入
2. 若按F4則執行會計項目查詢
3. 若按F6則檢核後儲存資料
4. 檢核使用者輸入資料 (R2B00)
5. 若檢核無誤則初始化明細資料畫面 (R2C00)
6. 進入明細細項輸入處理 (R3000)

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 讀取參數資料區 (PTDA01)
2. 呼叫P31設定日期格式
3. 設定功能權限 (@A01)
4. 初始化各項輸入欄位

### 主畫面檢核 (R1B00)
1. 檢查使用者權限
2. 檢查部門代號是否已輸入並存在
3. 檢查部門是否為會計部門
4. 檢查分錄年度是否有效
5. 檢查分錄年度是否為系統年度

### 分錄明細初始化 (R1C00)
1. 設定明細序號為0
2. 清空子檔畫面緩衝區
3. 設定操作選項為新增

### 分錄明細檢核 (R2B00)
1. 檢查會計項目是否已輸入並存在
2. 檢查會計項目是否有效
3. 檢查借貸金額是否平衡
4. 檢查借貸金額不能同時輸入

### 明細細項處理 (R3000)
1. 初始化明細細項欄位
2. 顯示明細細項畫面
3. 檢核使用者輸入 (R3B00)
4. 儲存明細細項資料到子檔 (R3D00)

### 分錄明細儲存 (R2D30)
1. 取得分錄號碼
2. 儲存分錄主檔資料
3. 保存各明細項目到傳票檔 (GLAHPF)

### 年結分錄確認 (R5000)
1. 顯示確認畫面
2. 檢核分錄日期 (R5100)
3. 執行年結分錄處理 (R5200)
   - 呼叫GLA531執行年結分錄作業

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0012**：數值欄位必須大於零
- **UPT0030**：欄位資料格式錯誤
- **UPT0040**：日期格式錯誤
- **UPT2010**：資料不存在
- **UPT2072**：資料已存在
- **UPT2150**：無權限執行此功能
- **UGL0004**：非會計部門
- **UGL0009**：會計項目非有效狀態
- **UGL0010**：借貸方金額必須擇一輸入
- **UGL0011**：借貸方金額必須相等
- **UGL0012**：明細資料不存在
- **UGL0013**：年度資料已做年結
- **UGL0029**：會計期間未設定
- **UGL0033**：年度不符合
- **UGL0034**：年度不等於系統年度

### 錯誤處理
- 設定對應的錯誤指示燈 (IN60-IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於會計總帳系統中執行年結分錄作業，具有以下特點：

1. 提供年結分錄功能，協助會計人員建立年結調整分錄
2. 支援多步驟資料輸入流程：
   - 主要資料輸入：部門、年度設定
   - 明細資料輸入：會計項目、借貸金額
   - 細項資料輸入：摘要、說明、備註等
3. 支援查詢功能，可查詢會計項目、部門代碼等
4. 提供分錄列印功能，可列印分錄清單
5. 執行自動檢核，確保資料正確性：
   - 借貸平衡檢查
   - 權限檢查
   - 年度檢查
   - 會計項目有效性檢查
6. 支援權限控制，僅允許有權限的使用者執行年結分錄作業

此程式是會計年度結束時的重要輔助工具，執行年結分錄作業後，對帳務調整提供支援，確保年結作業的順利完成，協助建立正確的年結調整分錄。 
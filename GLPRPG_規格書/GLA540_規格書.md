# GLA540 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA540
- **程式說明**：年結分錄維護
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA540
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.04 (81/12/04)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAHLF01**：傳票檔
- **GLAPPF**：傳票明細檔
- **GLAQPF**：傳票明細分配檔
- **GLAAPF**：會計項目檔
- **GLADPF**：部門檔
- **GLAFPF**：會計項目檔
- **GLAKPF**：參數檔
- **PT#BPF**：部門參數檔
- **GLA540D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA540
- **呼叫程式**：
  - P31：日期格式處理程式
  - P50：錯誤處理程式
  - P55：數值處理程式（取小數點）
  - P56：字串處理程式（取斜線）
  - P64I：印表機代碼設定程式
  - GLA190：傳票輸入程式
  - GLS001：字串處理程式
  - GLS005：取得會計日期起迄值程式
  - GLS007：會計期間查詢程式
  - GLI410：會計項目查詢程式
  - GLI440：部門代碼查詢程式
  - GLI1E0：傳票查詢程式
  - GLR1K0：傳票列印程式
- **功能鍵**：F3(離開), F4(查詢), F6(確認), F9(列印), F12(返回), F13(列印設定), F14(執行作業)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：系統日期
  - $CPY (125-127)：公司代號
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $RMK01 (139-139)：特殊權限標記
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $PRTCD (217-218)：印表機代碼
  - $PENV (219-219)：印表機環境

### 陣列定義
- **@A01 (功能權限陣列)**：儲存各種功能權限（5項）
- **WFUN (功能代碼陣列)**：儲存功能代碼（5項）
- **W02 (會計項目代碼陣列)**：儲存會計項目代碼（7項）
- **W03 (會計項目名稱陣列)**：儲存會計項目名稱（7項）
- **W04 (檢核程式名稱陣列)**：儲存檢核程式名稱（7項）
- **W05 (欄位內容陣列)**：儲存輸入欄位內容（4項）
- **W06 (欄位內容說明陣列)**：儲存輸入欄位內容說明（7項）
- **W07 (欄位檢核碼陣列)**：儲存輸入欄位檢核碼（7項）
- **W13, W14, W15 (記錄追蹤陣列)**：用於資料處理追蹤（50項）

### 主要欄位說明
- **KEYAH**：傳票檔鍵值 (DAH01+DAH02)
- **KEYAF**：會計項目檔鍵值 (DAH01+AF02)
- **KEYAF1**：會計項目檔鍵值 (DAH01+AQ04)
- **KEYAA**：會計項目檔鍵值 (DAH01+W02,WI)
- **KEYAD**：部門檔鍵值 (DAH01+AD02)
- **KEYAP**：傳票明細檔鍵值 (DAH01+WAP02+WAP03+WAP04+WAP05)
- **KEYAQ**：傳票明細分配檔鍵值 (DAH01+WAP02+WAP03+WAP04+WAP05)
- **DAH01**：部門代號
- **DAH02**：傳票號碼
- **DAH03**：明細序號
- **DAH04**：會計項目代號
- **DAH05-DAH08**：各種輸入欄位內容
- **DAH09**：金額
- **DAH10**：傳票日期
- **DAH11**：有效標記
- **DAH12**：借方金額
- **DAH13**：貸方金額
- **DAH14**：數量
- **DAH15**：備註
- **DAH16**：摘要
- **DAH18**：狀態標記
- **DAH19**：處理類別
- **DAH20**：已審核標記
- **DAH22**：部門代碼
- **DAH24**：傳票號碼
- **WAH10**：傳票日期（工作區）
- **DDTOT**：借方金額合計
- **DCTOT**：貸方金額合計

## 4. 輸出/入螢幕布局與說明

### 畫面流程
本程式包含4個主要畫面：
1. **SC01**：初始參數輸入畫面
2. **SC02**：傳票明細清單畫面
3. **SC03**：明細基本輸入畫面
4. **SC04**：明細詳細資料輸入畫面

### 第一畫面 (SC01-DSPD1)
- **螢幕標題**：年結分錄維護作業
- **畫面描述**：輸入年結分錄的基本參數
- **輸入欄位**：
  - 部門代號 (DAH01)：輸入部門代號
  - 傳票號碼 (DAH02)：輸入傳票號碼
- **功能鍵**：
  - F3：離開
  - F13：列印設定
  - F14：執行作業

### 第二畫面 (SC02-SFLCR)
- **螢幕標題**：年結分錄明細清單
- **畫面描述**：顯示傳票明細清單，分為借方和貸方兩類
- **子檔畫面**：
  - SFLSRD：借方明細子檔
  - SFLSRC：貸方明細子檔
- **顯示欄位**：
  - 選項 (DOPT)：操作選項
  - 序號 (DAH03)：明細序號
  - 會計項目 (DAH04)：會計項目代號
  - 項目說明 (DAF03)：會計項目說明
  - 借方金額 (DAH12)：借方金額
  - 貸方金額 (DAH13)：貸方金額
  - 有效標記 (DAH11)：資料有效標記
  - 摘要 (DAH16)：交易摘要
- **功能鍵**：
  - F3：離開
  - F6：確認
  - F9：列印
  - F12：返回上一畫面
  - F13：設定已審核

### 明細輸入畫面 (SC03-DSPD3/SC04-DSPD4)
- **螢幕標題**：年結分錄明細資料細項
- **畫面描述**：輸入或修改傳票明細資料
- **輸入欄位**：
  - 操作選項 (DOPT)：指定處理動作（1:新增、2:修改、4:刪除）
  - 會計項目 (DAH04)：輸入會計項目代號
  - 借方金額 (DAH12)：輸入借方金額
  - 貸方金額 (DAH13)：輸入貸方金額
  - 說明 (DAH05)：輸入說明文字
  - 摘要 (DAH06)：輸入摘要
  - 交易代碼1 (DAH07)：輸入交易代碼1
  - 交易代碼2 (DAH08)：輸入交易代碼2
  - 金額 (DAH09)：輸入金額
  - 數量 (DAH14)：輸入數量
  - 備註 (DAH15)：輸入備註
  - 部門代碼 (DAH22)：輸入部門代碼
  - 傳票號碼 (DAH24)：輸入傳票號碼
  - 摘要 (DAH16)：輸入摘要
- **功能鍵**：
  - F3：離開
  - F4：查詢功能
  - F5：重新輸入
  - F12：返回上一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 根據螢幕代碼 (SCID) 進入對應處理例程
3. 處理主畫面輸入 (R1000)
4. 處理明細子檔畫面 (R2000)
5. 處理明細輸入畫面 (R3000, R4000)
6. 完成處理後返回主畫面或結束程式

### 初始化處理 (R0100)
1. 設定初始螢幕代碼 (SCID = 'SC01')
2. 讀取參數資料區 (PTDA01)
3. 呼叫P31設定日期格式
4. 設定功能權限 (@A01)
5. 初始化主畫面欄位

### 主畫面處理 (R1000)
1. 顯示主畫面 (DSPD1)
2. 檢查功能鍵
   - F3：結束程式
   - F13：呼叫列印設定 (R1A00)
   - F14：執行傳票處理
3. 檢核輸入資料 (R1B00)
4. 初始化明細畫面 (R1C00)
5. 切換至明細畫面 (SCID = 'SC02')

### 明細子檔處理 (R2000)
1. 初始化子檔畫面 (R2A10)
2. 顯示子檔畫面 (R2A20)
3. 處理使用者輸入
   - F3/F12：返回主畫面
   - F6：確認修改
   - F9：列印傳票
   - F13：設定已審核 (R2C00)
   - 選項輸入：處理明細資料 (R2B00)
4. 檢核並儲存明細資料 (R2D00)

### 明細輸入處理 (R3000, R4000)
1. 顯示明細輸入畫面 (DSPD3, DSPD4)
2. 檢核使用者輸入 (R3B00, R4B00)
3. 處理查詢請求 (R3E00, R4E00)
4. 儲存使用者輸入至子檔 (R4D00)

## 6. 子程序處理邏輯說明

### 主畫面檢核 (R1B00)
1. 檢查功能權限
2. 檢查部門代號是否存在
3. 檢查傳票號碼是否存在
4. 檢查傳票狀態（是否已審核或過帳）
5. 檢查日期有效性（呼叫GLS005）
6. 設定日期格式（呼叫P31）

### 明細初始化 (R1C00)
1. 初始化明細序號和子檔計數器
2. 清空並初始化子檔畫面
3. 根據部門代號和傳票號碼讀取傳票檔 (GLAHLF01)
4. 將傳票明細資料移至子檔畫面 (R1C10)
5. 計算總借方和總貸方金額

### 明細資料顯示 (R1C10)
1. 設定子檔顯示欄位值
2. 根據借貸方金額判斷寫入借方或貸方子檔

### 已審核設定 (R2C00)
1. 讀取並更新所有傳票明細記錄
2. 設定已審核標記 (AH20 = 'V')
3. 更新時間和使用者資訊
4. 返回主畫面並顯示訊息

### 檢核及儲存明細 (R2D00)
1. 檢核明細資料 (R2D10)
2. 儲存明細資料 (R2D30)
3. 若按F9則呼叫傳票列印程式 (GLR1K0)

### 明細檢核 (R2D10)
1. 檢查明細資料是否存在
2. 檢查借貸方金額是否平衡
3. 逐一檢核明細資料有效性 (R2D20)
4. 檢查並更新分配比率 (R2D50)

### 傳票明細分配處理 (R2D50)
1. 處理會計項目對應的分配資料
2. 計算並更新分配比率和金額
3. 呼叫傳票輸入程式 (GLA190) 處理分配資料
4. 更新明細子檔資料

### 明細資料儲存 (R2D30)
1. 刪除原有傳票明細資料
2. 設定傳票主檔資料
3. 逐一儲存明細資料到傳票檔 (R2D40)
4. 設定更新時間、日期及使用者資訊

### 明細細項編輯 (R3000, R4000)
1. 根據操作選項 (DOPT) 顯示相應輸入畫面
2. 檢核使用者輸入資料 (R3B00, R4B00)
3. 初始化輸入欄位 (R4A00)
4. 根據會計項目設定欄位值 (R4A10)
5. 儲存使用者輸入資料 (R4D00)

### 資料儲存處理 (R4D00)
1. 根據操作選項處理資料：
   - 選項1：新增明細 (R4D10)
   - 選項2：修改明細 (R4D20)
   - 選項4：刪除明細 (R4D30)
2. 更新子檔畫面資料
3. 更新借貸方金額合計

### 查詢功能 (R3E00, R4E00)
1. 根據游標位置判斷查詢項目
2. 呼叫對應查詢程式：
   - 會計項目查詢：GLI410
   - 部門代碼查詢：GLI440
   - 傳票查詢：GLI1E0
3. 處理查詢結果

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0012**：數值欄位必須大於零
- **UPT0030**：欄位資料格式錯誤
- **UPT2010**：資料不存在
- **UPT2075**：已審核完成訊息
- **UPT2150**：無權限執行此功能
- **UGL0004**：未啟用部門
- **UGL0009**：會計項目非有效狀態
- **UGL0010**：借貸方金額必須擇一輸入
- **UGL0011**：借貸方金額必須相等
- **UGL0012**：明細資料不存在
- **UGL0017**：期間驗證錯誤
- **UGL0025**：已審核不可修改
- **UGL0026**：已過帳不可修改

### 錯誤處理
- 檔案錯誤處理 (ERRSR)：呼叫P50取得錯誤訊息
- 設定對應的錯誤指示燈 (IN60-IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式是會計總帳系統中的年結分錄維護作業，具有以下特點：

1. 支援傳票明細的新增、修改、刪除功能
2. 提供明細子檔畫面，分別顯示借方和貸方明細資料
3. 自動計算並檢核借貸方金額是否平衡
4. 支援會計項目、部門代碼等資料的查詢功能
5. 支援傳票列印功能
6. 執行詳細的資料檢核，確保傳票資料的正確性：
   - 借貸平衡檢查
   - 會計項目有效性檢查
   - 部門代碼有效性檢查
   - 傳票狀態檢查（已審核、已過帳）
7. 支援傳票明細的分配處理功能
8. 支援傳票審核功能，設定已審核標記

此程式是會計年度結束時的重要工具，用於維護年結分錄資料，確保年結作業的正確性和完整性。 
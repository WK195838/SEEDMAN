# GLA320 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA320
- **程式說明**：總帳彙總設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA320
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.04
- **修改日期**：
- **系統**：總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAOPF**：彙總設定明細檔案 (輸出)
- **GLANPF**：彙總設定主檔
- **GLAAPF**：會計科目名稱檔案
- **GLADPF**：部門檔案
- **GLAFPF**：會計科目檔案
- **GLAKPF**：總帳基本檔案
- **PT#BPF**：參數檔案
- **GLA320D**：螢幕顯示檔案 (含子檔)

### 程式關係
- **主程式**：GLA320
- **呼叫程式**：
  - GLI310：彙總設定瀏覽查詢程式
  - GLI410：科目瀏覽查詢程式
  - GLI440：部門瀏覽查詢程式
  - GLS001：字串連接處理程式
  - S#S01：權限檢查程式
  - P31：日期格式處理程式
  - P55：數值格式處理程式
  - P56：分隔符處理程式
- **功能鍵**：F3(離開), F4(提示), F5(儲存), F6(確認), F12(返回), F18(瀏覽)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：日期
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：日期
  - $C8YMD (209-216)：日期

- **檢查程式參數**
  - CHKPGM：檢查程式參數區
  - WAN01 (1-2)：公司別
  - WPARM1 (3-22)：參數1
  - WPARM2 (23-32)：參數2
  - WCHK (33-33)：檢查標記

- **彙總輸入欄位定義**
  - W02 (7*2)：彙總輸入代碼
  - W03 (7*20)：彙總輸入名稱
  - W04 (7*10)：檢核程式名稱
  - W05 (4*20)：彙總輸入內容
  - W06 (7*20)：彙總輸入內容說明
  - W08 (7*10)：傳入參數名稱
  - @A01 (5*1)：功能權限

- **鍵值列表**
  - KEYAN：彙總設定主檔主鍵 (公司別+彙總代碼)
  - KEYAO：彙總設定明細檔主鍵 (公司別+彙總代碼)
  - KEYAF：會計科目檔主鍵 (公司別+科目代碼)
  - KEYAA：會計科目名稱檔主鍵 (公司別+科目代碼)
  - KEYAD：部門檔主鍵 (公司別+部門代碼)

## 4. 輸出/入螢幕布局與說明

### 主畫面 (SC01)
- **螢幕標題**：總帳彙總設定作業
- **輸入欄位**：
  - 公司別 (DAN01)：必填
  - 彙總代碼 (DAN02)：必填
  - 彙總名稱 (DAN03)：可選

- **功能鍵**：
  - F3：結束程式
  - F18：瀏覽查詢
  - ENTER：確認並進入下一畫面

### 明細設定畫面 (SC02)
- **螢幕標題**：總帳彙總設定作業
- **顯示欄位**：
  - 公司別、彙總代碼、彙總名稱
  - 項目編號 (DAO03)：自動產生
  - 科目代碼 (DAO04)：必填
  - 科目名稱 (DAF03)：顯示欄位
  - 借貸別 (DAO11)：預設'Y'
  - 借方金額 (DAO12)：可選
  - 貸方金額 (DAO13)：可選
  - 簡短描述 (DAO16)：可選

- **功能鍵**：
  - F3：結束程式
  - F5：儲存
  - F6：確認
  - F12：返回主畫面
  - F13：刪除彙總設定
  - F18：瀏覽查詢

### 明細輸入畫面 (SC03/SC04)
- **螢幕標題**：總帳彙總設定作業
- **輸入欄位**：
  - 科目代碼 (DAO04)：必填
  - 輸入項目1-4 (DAO05-DAO08)：彙總輸入內容
  - 輸入項目5 (DAO09)：分隔線設定
  - 借貸別 (DAO11)：'Y'或其他
  - 借方金額 (DAO12)：數值
  - 貸方金額 (DAO13)：數值
  - 輸入項目6 (DAO14)：數值格式設定
  - 輸入項目7 (DAO15)：條件設定
  - 簡短描述 (DAO16)：可選
  - 部門代碼 (DAO22)：可選

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F5：儲存
  - F12：返回

### 子檔畫面 (SFLSR/SFLSRC/SFLSRD)
- **螢幕標題**：總帳彙總設定作業
- **子檔欄位**：
  - 選項 (DOPT)：1=新增, 2=修改, 4=刪除
  - 項次 (DNO)：項目序號
  - 科目代碼 (DAO04)：科目代碼
  - 科目名稱 (DAF03)：科目名稱
  - 簡短描述 (DAO16)：簡短描述
  - 借貸別 (DAO11)：借貸標記
  - 借方金額 (DAO12)：借方金額
  - 貸方金額 (DAO13)：貸方金額

- **功能鍵**：
  - F3：結束程式
  - F12：返回

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 依據畫面代碼(SCID)執行不同處理流程：
   - SC01：顯示主畫面，接收公司別和彙總代碼
   - SC02：顯示彙總設定明細畫面和子檔
   - SC03/SC04：顯示明細輸入畫面

### 程式初始化流程 (R0100)
1. 設定畫面ID為SC01
2. 讀取參數資料區
3. 呼叫P31設定日期格式
4. 設定各項權限標記
5. 初始化公司別、彙總代碼和彙總名稱欄位為空白

### SC01畫面流程 (R1000)
1. 顯示主畫面並等待使用者輸入
2. 若按F3：結束程式
3. 若按F18：呼叫彙總設定瀏覽程式 (R1A00)
4. 若按ENTER：檢核輸入資料 (R1B00)
5. 若檢核通過：初始化明細畫面 (R1C00)並切換至SC02畫面
6. 若資料新增或修改權限不足，顯示錯誤訊息

### SC02畫面流程 (R2000)
1. 初始化子檔資料 (R2A10)
2. 顯示子檔畫面並等待使用者選擇 (R2A20)
3. 若按F3或F12：返回主畫面
4. 若按F13：刪除彙總設定並返回主畫面 (R2C00)
5. 若按F6：進行資料檢核和儲存處理 (R2D00)
6. 若選擇子檔項目：依選項進行處理 (R2B00)
7. 若選擇1或2：進入明細輸入畫面 (R3000)
8. 若選擇4：執行刪除功能 (R4000)

### SC03/SC04畫面流程 (R3000/R4000)
1. 初始化輸入項目顯示 (R3C00)
2. 若為修改選項，讀取已有資料 (選項2)
3. 顯示明細輸入畫面並等待使用者輸入
4. 若按F3或F12：返回SC02畫面
5. 若按F4：提供對應欄位的提示功能 (R3E00/R4E00)
6. 若輸入完成並通過檢核 (R3B00/R4B00)：儲存資料至子檔 (R4D00)
7. 返回SC02畫面

## 6. 子程序處理邏輯說明

### 權限檢查及瀏覽查詢 (R1A00)
1. 呼叫S#S01檢查用戶是否有使用GLI310的權限
2. 若權限不足，顯示錯誤訊息
3. 若權限正確，呼叫GLI310程式進行彙總設定瀏覽查詢
4. 將查詢結果回傳至主畫面

### 主畫面資料檢核 (R1B00)
1. 檢查用戶是否有對應功能權限 (新增/修改/刪除/查詢)
2. 檢查公司別是否為空白及是否存在基本檔案中
3. 檢查公司別是否為啟用狀態 (#B12='1')
4. 檢查彙總代碼是否為空白
5. 檢查彙總設定主檔是否已存在此公司別和彙總代碼的組合
6. 若檢核失敗，顯示對應錯誤訊息

### 明細畫面初始化 (R1C00)
1. 初始化項目編號、記錄筆數計數器
2. 初始化借貸金額合計變數 (DDTOT, DCTOT)
3. 清除子檔資料
4. 根據彙總代碼讀取明細檔案資料 (KEYAO)
5. 將資料庫記錄轉換為子檔格式 (R1C10)
6. 區分借方和貸方記錄，分別寫入不同子檔 (SFLSRD/SFLSRC)

### 子檔畫面處理 (R2A10/R2A20)
1. 初始化子檔顯示設定
2. 將借方和貸方子檔項目合併顯示
3. 顯示科目名稱和相關資訊
4. 設定子檔顯示控制指示燈

### 子檔選項處理 (R2B00/R2B10)
1. 讀取用戶在子檔中選擇的項目
2. 根據選項代碼 (DOPT) 執行不同功能：
   - 1或2：將子檔資料移至畫面變數，進入編輯畫面
   - 4：執行刪除功能

### 刪除彙總設定處理 (R2C00)
1. 刪除所有相關明細記錄 (GLAOPF)
2. 刪除主檔記錄 (GLANPF)
3. 返回主畫面並設定提示訊息

### 資料儲存處理 (R2D00/R2D10/R2D20)
1. 檢查子檔中是否有資料 (WNO>0)
2. 檢查借貸金額合計是否相等 (DDTOT=DCTOT)
3. 刪除原有明細記錄並重新寫入
4. 逐一將子檔資料寫入資料庫 (R2D30)
5. 更新主檔資料 (R2D40)
6. 設定儲存成功指示燈並返回主畫面

### 明細輸入畫面處理 (R3B00/R4B00)
1. 檢查科目代碼是否存在及是否啟用
2. 檢查借貸金額設定是否正確 (不可同時有值或同時為零)
3. 對每個輸入項目呼叫對應的檢核程式
4. 產生各輸入項目的說明文字
5. 檢查部門代碼是否存在
6. 產生簡短描述字串

### 明細資料儲存至子檔 (R4D00)
1. 根據操作類型執行不同的處理：
   - 新增項目 (R4D10)
   - 修改項目 (R4D20)
   - 刪除項目 (R4D30)
2. 保存當前輸入資料至子檔 (R4DA0)
3. 更新借貸金額合計變數

### 提示功能 (R3E00/R4E00)
1. 根據游標位置判斷提示類型
2. 對科目代碼提供GLI410提示功能
3. 對部門代碼提供GLI440提示功能
4. 對其他輸入項目提供對應的檢核程式提示
5. 將選擇結果返回至輸入欄位

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT2075**：資料新增/修改權限不足
- **UPT2150**：使用者無權限執行此功能
- **UPT0010**：必填欄位未輸入 (公司別/彙總代碼)
- **UPT2010**：公司別/彙總代碼不存在
- **UGL0004**：公司別未啟用
- **UGL0009**：科目未啟用
- **UGL0010**：借貸金額輸入錯誤 (同時有值或同時為零)
- **UGL0011**：借貸金額合計不相等
- **UGL0012**：至少需設定一筆明細
- **UPT0030**：輸入資料錯誤

### 錯誤處理
- 呼叫錯誤處理子程序 (ERRSR)
- 設定對應的錯誤指示燈
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於設定總帳系統中的彙總報表，主要功能包括：

1. 彙總基本資料設定：公司別、彙總代碼和彙總名稱
2. 彙總明細項目設定：科目代碼、借貸金額、輸入項目內容等
3. 彙總格式設定：分隔線、數值格式和條件設定
4. 彙總描述設定：簡短描述和部門代碼

程式採用多層次的畫面處理流程，首先設定基本資料，再進入子檔管理畫面，最後逐一編輯各明細項目。採用子檔方式可同時顯示多筆明細資料，便於用戶進行整體管理和維護。程式在資料儲存前會進行嚴格的檢核，確保借貸金額平衡和資料完整性，是總帳系統中彙總報表產出的重要設定工具。 
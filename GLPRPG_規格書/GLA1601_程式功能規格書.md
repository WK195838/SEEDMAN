# GLA1601 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1601
- **程式說明**：分錄沖銷作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1601
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.11
- **系統**：會計總帳
- **功能描述**：處理會計分錄沖銷作業，包括沖銷分錄產生及報表列印功能

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHPF**：會計分錄主檔（更新檔案）
- **GLAHLF10**：會計分錄歷史檔邏輯檔（讀取檔案）
- **GLAPPF**：會計期間檔（參考檔案）
- **GLAILF04**：會計科目餘額邏輯檔（參考檔案）
- **GLAQPF**：會計沖銷檔（參考檔案）
- **GLAFPF**：會計科目檔（參考檔案）
- **PT#APF**：銀行帳戶檔（參考檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **GLAAPF**：幣別設定檔（參考檔案）
- **GLA160D**：螢幕顯示檔（工作站檔案）
- **GLA160P**：報表輸出檔（印表機檔）

### 檔案間關聯
- 使用公司代碼（AP01/AQ01）連結各檔案
- 使用會計科目（AQ02/AF02）連結GLAQPF與GLAFPF
- 使用SFLSRC和SFLSRD子檔分別顯示借方和貸方明細
- 使用KEYAI、KEYAQ、KEYAF、KEYAA等關鍵字列表進行檔案存取

## 3. 檔案欄位規格說明

### GLAHPF (會計分錄主檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AH03 | 明細筆數 | - | - | 數值 | 分錄明細筆數 |
| AH04 | 科目代碼 | - | 8 | 文字 | 會計科目代碼 |
| AH05-AH08 | 摘要內容 | - | 20 | 文字 | 分錄摘要說明 |
| AH09 | 金額 | - | - | 數值 | 分錄金額 |
| AH10 | 交易日期 | - | 8 | 數值 | 會計交易日期 |
| AH12 | 借方金額 | - | - | 數值 | 借方金額 |
| AH13 | 貸方金額 | - | - | 數值 | 貸方金額 |
| AH14 | 數量 | - | - | 數值 | 交易數量 |
| AH15 | 備註 | - | 20 | 文字 | 備註說明 |
| AH16 | 摘要描述 | - | 50 | 文字 | 完整摘要描述 |
| AH17 | 來源代碼 | - | 2 | 文字 | GL=總帳 |
| AH18 | 過帳標記 | - | 1 | 文字 | 過帳狀態 |
| AH19 | 沖銷標記 | - | 1 | 文字 | #=需重分類 |
| AH22 | 參考號碼 | - | - | 文字 | 參考編號 |
| AH97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### GLAQPF (會計沖銷檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AQ01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AQ02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AQ02A | 科目名稱 | - | - | 文字 | 科目名稱 |
| AQ02B | 銀行代碼 | - | - | 文字 | 銀行代碼 |
| AQ04-AQ09 | 沖銷參數 | - | - | 文字 | 沖銷相關參數 |
| AQ12 | 沖銷比例 | - | - | 數值 | 沖銷百分比 |
| AQ14 | 數量 | - | - | 數值 | 沖銷數量 |
| AQ15 | 備註 | - | 20 | 文字 | 備註說明 |
| AQ16 | 摘要 | - | 50 | 文字 | 沖銷摘要 |
| AQ22 | 參考號碼 | - | - | 文字 | 參考編號 |

### GLAFPF (會計科目檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AF01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AF02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AF03 | 科目名稱 | - | - | 文字 | 科目名稱 |
| AF06 | 借貸別 | - | 1 | 文字 | 1=借方,2=貸方 |
| AF11-AF17 | 對應欄位 | - | - | 文字 | 對應欄位代碼 |

### GLAILF04 (會計科目餘額邏輯檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AI01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AI04 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AI04A | 科目名稱 | - | - | 文字 | 科目名稱 |
| AI05-AI08 | 對應欄位 | - | - | 文字 | 對應欄位內容 |
| AI10 | 餘額 | - | - | 數值 | 科目餘額 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| DAP01 | 公司代碼 | 501 | 2 | 文字 | 處理的公司代碼 |
| DAP06 | 交易日期 | 503 | 7 | 數值 | 交易日期 |
| DYEAR | 年度 | 518 | 3 | 數值 | 會計年度 |
| DMM | 月份 | 521 | 2 | 數值 | 會計月份 |
| PYM | 年月 | 518 | 5 | 數值 | 年月(YYYMM) |
| DOP | 處理選項 | 543 | 1 | 文字 | 1=沖銷,2=列印 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
```
                              分錄沖銷作業                        公司：XX
                                                                日期：YYYY/MM/DD

處理選項：1=沖銷  2=列印

                 借方科目                                   貸方科目
序號  科目代碼   科目名稱      金額      序號  科目代碼   科目名稱      金額
----  --------  ----------  ----------   ----  --------  ----------  ----------
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX
XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX   XXX   XXXXXXXX  XXXXXXXXXX  XXXXXXXXXX

                                                        借方合計：XXXXXXXXXX
                                                        貸方合計：XXXXXXXXXX
```

### 功能鍵說明
| 功能鍵 | 說明 |
|--------|------|
| F3 | 結束程式 |
| F12 | 取消處理 |

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 取得公司名稱

2. 沖銷處理（R1000子程序）
   - 讀取會計期間檔
   - 讀取科目餘額檔
   - 讀取沖銷檔
   - 產生沖銷分錄
   - 更新會計分錄主檔

3. 報表列印（R7000子程序）
   - 輸出沖銷分錄報表

4. 更新沖銷標記（R8000子程序）
   - 更新需沖銷分錄的狀態

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 讀取PT#BPF檔案取得公司名稱
- 根據處理選項設定顯示文字

### R0200 - 子檔初始化
- 初始化SFLSRC和SFLSRD子檔
- 清除子檔內容
- 設定子檔控制指標

### R1000 - 沖銷處理
- 讀取會計期間檔(GLAPPF)
- 讀取科目餘額檔(GLAILF04)
- 取得需沖銷的科目餘額
- 讀取沖銷檔(GLAQPF)
- 執行R1100子程序處理每筆沖銷資料
- 執行R1500子程序處理沖銷餘額
- 執行R2000子程序產生沖銷分錄

### R1100 - 處理沖銷資料
- 取得科目資料(GLAFPF)
- 執行R1A00和R1A10子程序初始化工作變數
- 計算沖銷金額
- 根據借貸別設定借方或貸方金額
- 執行R1B00子程序登錄沖銷資料

### R1A00 - 初始化沖銷
- 設定初始位置和計數器
- 初始化工作陣列
- 設定子檔顯示資料

### R1A10 - 移動資料到工作陣列
- 將科目餘額檔的資料移至工作陣列
- 設定對應欄位值

### R1B00 - 登錄沖銷資料
- 檢查是否為首筆資料
- 執行R1B10或R1B20子程序取得沖銷資料
- 呼叫GLA190程式處理沖銷明細
- 設定借方或貸方子檔記錄
- 增加記錄計數器

### R1B10 - 處理沖銷對應
- 根據沖銷檔的對應欄位設定沖銷資料
- 查找對應欄位值

### R1B20 - 取得輸入欄位說明
- 取得輸入欄位的代碼和說明
- 設定顯示資料

### R1200 - 處理沖銷比例
- 計算沖銷比例金額
- 根據借貸別設定借方或貸方金額
- 執行R1B00子程序登錄沖銷資料

### R1500 - 處理沖銷餘額
- 處理剩餘沖銷金額
- 更新子檔記錄

### R2000 - 產生沖銷分錄
- 產生沖銷分錄編號
- 設定分錄標頭資料
- 讀取子檔記錄
- 產生分錄明細
- 寫入會計分錄主檔(GLAHPF)

### R2A00 - 列印沖銷分錄
- 設定列印格式
- 輸出分錄明細

### R2A10 - 取得列印資料
- 取得科目名稱和銀行資料
- 設定列印欄位值

### R2B00 - 移動資料到分錄檔
- 將沖銷資料移至會計分錄檔格式
- 設定系統欄位(時間、日期、使用者)

### R7000 - 輸出報表
- 輸出報表標頭
- 輸出報表尾頁
- 處理無資料情況

### R8000 - 更新沖銷標記
- 讀取GLAHLF10檔案中的記錄
- 將沖銷標記(AH19)設為'V'
- 更新最後處理時間、日期和處理人員

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 當呼叫GLA190程式時，檢查返回碼(@RTNC)處理異常情況
- 設定指標99表示處理中斷

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| - | 無資料 | 顯示「無資料」訊息 |

## 8. 備註
- 本程式處理需重分類的會計分錄(AH19='#')
- 程式支援兩種處理模式：1=沖銷(產生沖銷分錄)，2=列印(僅列印沖銷報表)
- 沖銷處理會根據科目餘額和沖銷檔設定的比例產生對應的沖銷分錄
- 沖銷分錄會自動設定分錄編號、交易日期和摘要
- 沖銷完成後會更新原分錄的沖銷標記為'V'
- 程式使用GLAHLF10邏輯檔案，該檔案是GLAHPF的邏輯檢視，專門用於處理需重分類的分錄 
# GLA1M0 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1M0
- **程式說明**：傳票登錄
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1M0
- **開發人員**：TINA
- **建立日期**：1994.07.21
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：提供傳票登錄及維護功能
- **聯絡電話**：7313250

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLAHLF01：傳票檔（讀取模式）
  - GLAAPF：輸入項目檔（讀取模式）
  - GLADPF：摘要檔（讀取模式）
  - GLAFPF：交易別檔（讀取模式）
  - GLAKPF：會計科目檔（讀取模式）
  - GLA7PF：傳票明細檔（更新模式）
  - PT#BPF：部門檔（讀取模式）
  - PT#YPF：功能參數檔（讀取模式）
- **螢幕格式檔**
  - GLA1M0D：傳票登錄螢幕格式檔
  - SFLSR：螢幕子檔（傳票明細資料子檔）
  - SFLSRC：螢幕子檔（借方傳票明細子檔）
  - SFLSRD：螢幕子檔（貸方傳票明細子檔）

## 3. 檔案欄位規格說明

### GLAHLF01（傳票檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AH01 | 部門代號 | 字元 | 主索引鍵之一 |
| AH02 | 傳票號碼 | 字元 | 主索引鍵之二 |
| AH03 | 明細筆數 | 數值 | - |
| AH04 | 摘要代號 | 字元 | - |
| AH05 | 摘要行一 | 字元 | - |
| AH05A | 摘要行一說明 | 字元 | - |
| AH06 | 摘要行二 | 字元 | - |
| AH06A | 摘要行二說明 | 字元 | - |
| AH07 | 摘要行三 | 字元 | - |
| AH07A | 摘要行三說明 | 字元 | - |
| AH08 | 摘要行四 | 字元 | - |
| AH08A | 摘要行四說明 | 字元 | - |
| AH09 | 參照號碼 | 數值 | - |
| AH09A | 參照號碼說明 | 字元 | - |
| AH10 | 傳票日期 | 數值 | - |
| AH12 | 借方總金額 | 數值 | - |
| AH13 | 貸方總金額 | 數值 | - |
| AH14 | 支票號碼 | 數值 | - |
| AH14A | 支票號碼說明 | 字元 | - |
| AH15 | 到期日 | 字元 | - |
| AH15A | 到期日說明 | 字元 | - |
| AH16 | 原始傳票代號 | 字元 | - |
| AH19 | 狀態碼 | 字元 | - |
| AH20 | 傳票狀態 | 字元 | 'V'表已入帳 |
| AH21 | 會計年度 | 數值 | - |
| AH22 | 廠商編號 | 字元 | - |
| AH24 | 核准人員 | 字元 | - |
| AH25 | 傳票日期(年月) | 數值 | - |
| AH26 | 傳票週期 | 字元 | - |

### GLA7PF（傳票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A701 | 部門代號 | 字元 | 主索引鍵之一 |
| A702 | 傳票號碼 | 字元 | 主索引鍵之二 |
| A703 | 明細序號 | 數值 | 主索引鍵之三 |
| A704 | 借貸代號 | 字元 | 'D'為借方，'C'為貸方 |
| A705 | 職員代號 | 字元 | - |
| A706 | 金額 | 數值 | - |
| A707 | 會計科目 | 字元 | - |
| A797 | 建檔時間 | 時間 | - |
| A798 | 建檔日期 | 數值 | - |
| A799 | 建檔人員 | 字元 | - |

### GLAFPF（交易別檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AF02 | 交易項目代號 | 字元 | - |
| AF03 | 交易項目說明 | 字元 | - |
| AF11-AF17 | 輸入項目代號1-7 | 字元 | - |
| AF18 | 特別代碼 | 字元 | - |

### GLAAPF（輸入項目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AA03 | 輸入項目說明 | 字元 | - |
| AA04 | 查核程式名稱 | 字元 | - |
| AA05 | 查核程式參數 | 字元 | - |

### GLADPF（摘要檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AD02 | 摘要代號 | 字元 | - |
| AD03 | 摘要說明 | 字元 | - |

### PT#BPF（部門檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #B02 | 部門說明 | 字元 | - |
| #B12 | 部門狀態 | 字元 | '1'為有效部門 |

### PT#YPF（功能參數檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #Y01 | 功能代號 | 字元 | - |
| #Y02 | 檢核程式名稱 | 字元 | - |

### 程式使用資料定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $USER | 101-110 | 10 | 使用者代號 |
| $CHYMD | 111-116 | 6 | 系統日期 |
| $CPY | 125-127 | 3 | 公司代號 |
| $ADD | 135 | 1 | 新增權限 (Y/N) |
| $UPD | 136 | 1 | 修改權限 (Y/N) |
| $DLT | 137 | 1 | 刪除權限 (Y/N) |
| $INQ | 138 | 1 | 查詢權限 (Y/N) |
| $RMK01 | 139 | 1 | 備註權限 |
| $USERN | 152-161 | 10 | 使用者名稱 |
| $A8YMD | 201-208 | 8 | 系統西元日期 |
| $C8YMD | 209-216 | 8 | 系統中文日期 |
| $PRTCD | 217-218 | 2 | 印表機代號 |
| $PENV | 219 | 1 | 環境參數 |

### 螢幕控制變數
| 變數名稱 | 說明 | 
|---------|---------|
| SCID | 螢幕代號，SC01為輸入條件畫面，SC02為明細畫面 |
| #CSR | 游標位置 |
| #LIN | 游標行號 |
| #COL | 游標欄號 |
| DOPT | 選項代碼 |
| RRN | 畫面記錄筆數 |
| RRND | 貸方明細筆數 |
| RRNC | 借方明細筆數 |
| WRRND | 暫存貸方明細筆數 |
| WRRNC | 暫存借方明細筆數 |
| DDTOT | 貸方金額合計 |
| DCTOT | 借方金額合計 |
| DLTCOD | 刪除代碼 ('Y'/'N') |
| WNO | 暫存明細序號 |

## 4. 輸出/入螢幕布局與說明

### 傳票登錄系統螢幕布局
程式包含三個主要螢幕：

#### SC01 - 傳票登錄輸入條件畫面
```
               會計傳票登錄修改

部門代號: [___] [部門名稱________________________]
傳票號碼: [______]

功能鍵:
F3=離開
```

#### SC02 - 傳票明細維護畫面
```
               會計傳票登錄

部門: [___] [部門名稱________________]  傳票號碼: [______]
傳票日期: [________]

摘要代號: [____] [摘要名稱________________]
摘要行一: [____________________]
摘要行二: [____________________]
摘要行三: [____________________]
摘要行四: [____________________]
參照號碼: [__________]
支票號碼: [__________]
到期日: [________]
原始傳票代號: [___]
廠商編號: [________]
核准人員: [____]

      借方明細                  貸方明細
序號 科目代號   金額     序號 科目代號   金額     職員  說明
[__] [_______] [______] [__] [_______] [______] [___] [________]
[__] [_______] [______] [__] [_______] [______] [___] [________]
...

借方合計: [__________]    貸方合計: [__________]

功能鍵:
F3=離開  F6=確認  F12=取消
```

#### SC04 - 明細輸入畫面
```
               明細資料輸入

借貸代號: [_] (D=借方, C=貸方)
職員代號: [___] [__________________]
金額: [__________]
會計科目: [_______] [_________________]

功能鍵:
F3=離開  F4=查詢  F12=取消
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化處理（EXSR R0100）
2. 循環處理使用者操作（DOWEQ *IN03='0'）：
   - 依螢幕ID（SCID）分派處理：
     * SC01：執行傳票登錄條件輸入處理（EXSR R1000）
     * SC02：執行傳票明細維護處理（EXSR R2000）
3. 結束程式（SETON LR）

### 子程序處理流程

#### R0100 - 初始化處理
1. 設定初始螢幕ID為「SC01」
2. 讀取系統參數設定
3. 呼叫P31程式處理日期格式轉換
4. 設定功能權限（$ADD, $UPD, $DLT, $INQ）
5. 初始化SC01畫面欄位（清空部門代號、傳票號碼等）

#### R1000 - SC01畫面處理
1. 檢查新增權限狀態（*IN79='1'）
2. 顯示SC01畫面並等待使用者輸入
3. 檢查使用者是否按下F3鍵退出
4. 執行畫面資料檢核（EXSR R1B00）
5. 若檢核通過（*IN99='0'），執行初始化SC02畫面（EXSR R1C00）並切換至SC02畫面

#### R1B00 - SC01畫面資料檢核
1. 檢查使用者功能權限
2. 檢查部門代號是否為空
3. 從PT#BPF檔案取得部門資訊，檢查部門是否存在及有效
4. 從GLAKPF檔案檢查會計科目設定
5. 檢查傳票號碼是否為空
6. 從GLAHLF01檔案檢查傳票是否存在
7. 檢查傳票是否已入帳（AH20='V'）
8. 執行日期格式轉換處理

#### R1C00 - SC02初始化
1. 初始化傳票明細相關變數
2. 初始化螢幕子檔
3. 從GLAHLF01檔案讀取傳票資料
4. 循環讀取符合條件的傳票資料：
   - 處理錯誤情況
   - 將資料轉存至子檔顯示緩衝區（EXSR R1C10）
   - 讀取傳票明細資料（EXSR R1C20）
   - 依借貸別寫入對應的子檔（SFLSRD或SFLSRC）
   - 累計借貸方總金額（DDTOT, DCTOT）

#### R2000 - SC02畫面處理
1. 循環處理使用者在SC02畫面的操作
2. 初始化子檔顯示（EXSR R2A10）
3. 顯示SC02畫面並等待使用者輸入（EXSR R2A20）
4. 處理使用者按鍵：
   - F3/F12：返回SC01畫面
   - F6（*IN06='1'）：儲存資料（EXSR R2D00）
   - 其他：執行畫面選擇項目處理（EXSR R2B00）

#### R2A10 - SC02子檔初始化
1. 初始化子檔控制變數
2. 清空選項欄位
3. 讀取借方明細子檔(SFLSRD)資料並寫入顯示區
4. 讀取貸方明細子檔(SFLSRC)資料並寫入顯示區

#### R2B00 - SC02選項處理
1. 讀取使用者選擇的選項（READC SFLSR）
2. 如果使用者選擇了某一筆明細（DOPT不為空），則：
   - 將子檔資料轉移到輸入欄位（EXSR R2B10）
   - 呼叫明細輸入處理（EXSR R4000）

#### R2D00 - SC02儲存處理
1. 執行資料儲存（EXSR R2D30）
2. 清除狀態指示燈
3. 切換回SC01畫面
4. 設定新增成功指示燈

#### R4000 - SC04明細輸入處理
1. 設定相應的明細輸入模式（新增/修改）
2. 初始化SC04畫面（EXSR R4A00）
3. 循環處理使用者在SC04畫面的操作：
   - 顯示SC04畫面並等待使用者輸入
   - 處理使用者功能鍵：
     * F3/F12：返回SC02畫面
     * F4：執行查詢處理（EXSR R4E00）
     * 其他：檢核資料（EXSR R4B00）
4. 保存明細資料到子檔（EXSR R4D00）

#### R4A00 - SC04畫面初始化
1. 設定輸入項目代號和說明
2. 初始化查詢參數
3. 從功能參數檔(PT#YPF)讀取職員代號檢核程式設定
4. 初始化輸入項目說明資料

#### R4B00 - SC04畫面資料檢核
1. 檢核職員代號是否有效
2. 處理特殊的金額計算邏輯

#### R4D00 - 保存明細資料到子檔
1. 將輸入資料儲存到對應的子檔（SFLSRD或SFLSRC）
2. 更新借貸方記錄筆數和金額合計

## 6. 子程序處理邏輯說明

### 畫面流程控制邏輯
- 使用SCID變數控制畫面切換
- 使用條件式CASE和GOTO控制程式流程
- 使用指示燈控制功能按鍵和畫面顯示

### 資料檢核邏輯
- 檢查必填欄位（使用IFEQ *BLANK）
- 檢查部門和傳票號碼有效性（使用CHAIN指令）
- 檢查使用者權限（使用權限陣列@A01）
- 使用錯誤碼（ERRID和ERRF）處理錯誤訊息

### 子檔處理邏輯
- 使用SFLSR、SFLSRC和SFLSRD三個子檔管理畫面資料
- 使用WRITESFL和READC操作子檔資料
- 使用RRN、RRND和RRNC控制子檔記錄編號
- 對借貸方明細分別處理並在畫面上分區顯示

### 借貸平衡檢查邏輯
- 維護借方總金額(DDTOT)和貸方總金額(DCTOT)
- 傳票儲存時檢查借貸是否平衡

### 外部程式呼叫邏輯
- 使用P31處理日期格式轉換
- 使用P50處理檔案錯誤訊息
- 使用P55處理特殊字元處理
- 使用P56處理參照號碼格式
- 依據PT#YPF設定的程式名稱進行動態呼叫

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理機制
- 使用*IN99指示燈標示錯誤狀態
- 使用ERRID和ERRF存儲錯誤訊息代碼和檔案
- 使用GOTO E1B00等標籤控制錯誤後的程式流程
- 透過ERRSR子程序處理檔案錯誤

### 使用者權限檢查
- 檢查$ADD、$UPD、$DLT、$INQ權限設定
- 當權限不足時顯示錯誤訊息UPT2150

### 資料檢核錯誤
- UPT0010：必填欄位未輸入
- UPT2010：資料不存在
- UPT2075：新增資料失敗
- UGL0004：部門無效
- UGL0025：傳票已入帳，無法修改
- UPT0030：輸入資料無效

### 檔案處理錯誤
- 使用*IN98指示燈標示檔案處理錯誤
- 透過P50程式取得檔案錯誤訊息
- 檔案錯誤時中斷處理並顯示訊息

## 8. 備註
1. 本程式為會計傳票輸入與維護的主要介面，支援完整的傳票處理功能
2. 程式採用多層螢幕結構，從傳票條件輸入到明細維護，層次分明
3. 使用子檔技術(Subfile)處理傳票明細資料，提供高效的資料瀏覽和編輯
4. 具備完整的權限檢查機制，確保資料安全性
5. 資料輸入時提供多項檢核功能，確保資料正確性
6. 支援動態檢核程式呼叫，增強系統擴展性
7. 傳票明細分為借方和貸方兩區塊顯示，增強使用者體驗
8. 能夠追蹤傳票建立和修改的完整資訊（時間、人員等）
9. 提供靈活的查詢功能，方便使用者查詢資料
10. 支援多種輸入項目格式，適應不同的會計業務需求 
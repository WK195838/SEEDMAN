# GLA355 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA355
- **程式說明**：報表格式設定與損益分析表
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA355
- **開發人員**：A1149 MAY
- **建立日期**：1992.11.09
- **修改日期**：
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLARPF**：報表格式主檔
- **GLASPF**：報表格式子檔
- **GLAFPF**：會計科目檔案
- **GLAXPF**：公司代號檔案
- **GLASLF01**：會計科目資料檔案
- **PT#BPF**：參數檔案
- **PT#YPF**：參數檔案
- **GLA355D**：螢幕顯示檔案（含子檔）

### 程式關係
- **主程式**：GLA355
- **呼叫程式**：
  - GLI410：科目瀏覽查詢程式
  - P31：日期格式處理程式
- **被呼叫**：可能由其他報表格式相關程式呼叫
- **功能鍵**：F3(離開), F4(提示), F5(儲存), F12(返回), F25(下一頁)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置
  - #DRRN (378-379)：顯示記錄號

- **DS#ASL**
  - ##ASL (397-400)：ASLF01 檔案的相對記錄號

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **資料結構**
  - DAS06 (1-8)：科目定義結構
    - W02 (1-2)：科目類型符號
    - W06 (3-6)：科目代號
    - W01 (1-1)：科目首碼
    - W05 (2-5)：科目代號

  - DAS07 (1-8)：科目定義結構
    - #02 (1-2)：科目類型符號
    - #06 (3-6)：科目代號
    - #01 (1-1)：科目首碼
    - #05 (2-5)：科目代號

### 主要欄位說明
- **KEYAS**：子檔鍵值 (AS01+AS02+AS03+AS04)
- **KEYAR**：主檔鍵值 (AR01+AR02+AR03)
- **KEYARC**：複製記錄鍵值 (AR01C+AR02C+AR03C)
- **KEY#Y**：參數檔鍵值
- **KEYAF**：會計科目檔鍵值 (DAF01+DAF02)
- **KEY#B**：公司檔鍵值

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPC1)
- **螢幕標題**：報表格式設定與損益分析表
- **畫面描述**：
  - 上半部顯示報表格式主檔資訊
  - 下半部為子檔明細資料，使用子檔顯示

- **輸入欄位**：
  - 主檔資訊：
    - 公司別 (DAR01)：2碼
    - 報表代碼 (DAR02)：2碼，固定為損益分析表報表代碼
    - 格式代碼 (DAR03)：3碼
    - 說明 (DAR04)：30碼
    - 屬性 (DAR05)：1碼，1=餘額表，2=期間表

  - 子檔資訊 (每行顯示)：
    - 刪除標記 (DDEL)：1碼，4=刪除
    - 新增標記 (DNEW)：1碼，Y=新增
    - 類型 (DAS04)：4碼
    - 正負號 (DAS05)：1碼，+/-
    - 起始科目 (DAS06)：8碼
    - 結束科目 (DAS07)：8碼
    - 項目常數 (DCONST)：20碼，顯示預定義的常數文字

- **功能鍵**：
  - F3：回前一畫面
  - F4：提示功能
  - F5：確認儲存
  - F12：回前一畫面
  - F25：下一頁

### 項目常數清單
本程式提供預設的損益分析表項目常數，包括：
- 0010：營業收入
- 0020：營業成本
- 0030：營業毛利
- 0040：營業費用
- 0050：營業淨利
- 0060：非營業收入
- 0070：非營業支出
- 0080：稅前淨利（稅前）

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 若為新增模式，初始化主檔資料 (R1CA0)
3. 若為複製模式，讀取來源資料 (R1CB0, R1CE0)
4. 初始化子檔資料 (R1CD0)
5. 顯示主畫面並等待使用者輸入 (R1000)
6. 根據功能鍵或選項執行不同處理：
   - F3/F12：結束程式
   - F4：提供欄位提示功能 (R1E00)
   - F5：檢核輸入資料並儲存 (R1B00, R2D00)
   - F25：顯示下一頁子檔資料

### 程式初始化流程 (R0100)
1. 設定目前畫面ID為'SC01'
2. 讀取參數資料區
3. 呼叫P31設定日期格式
4. 設定各項權限標記
5. 初始化各項輸入欄位
6. 根據選項設定相應的處理模式（新增、修改、刪除、查詢）
7. 讀取公司資料及報表代碼資料
8. 處理複製來源資料（若有指定複製來源）

### 子檔處理流程 (R1C00)
1. 初始化子檔顯示設定 (R1CC0)
2. 根據操作選項執行不同處理：
   - 新增且無複製來源：初始化主檔及明細資料 (R1CA0, R1CD0)
   - 新增且有複製來源：讀取來源資料並複製 (R1CB0, R1CE0, R1CD0)
   - 修改：讀取原有資料 (R1CB0, R1CE0, R1CD0)
   - 刪除/查詢：只讀取資料，不允許修改 (R1CB0, R1CE0)
3. 設定子檔顯示及控制指標

## 6. 子程序處理邏輯說明

### 新增時主檔初始化 (R1CA0)
1. 設定默認值：
   - 預設說明為空白
   - 預設屬性為1（餘額表）

### 子檔初始化 (R1CC0)
1. 設定子檔顯示參數：每頁顯示9筆，子檔範圍從第12行到第20行
2. 清除子檔並設定子檔控制指標
3. 初始化記錄計數器和工作記錄號(@WRRN)

### 子檔資料初始化 (R1CD0)
1. 根據當前記錄數計算需要顯示的記錄數
2. 逐筆新增空白記錄至子檔，遞增工作記錄號
3. 為每筆記錄設定對應的項目常數文字
4. 更新最後記錄號及顯示記錄號

### 科目提示功能 (R1E00)
1. 根據游標位置判斷當前正在編輯的欄位
2. 根據欄位類型呼叫適當的提示程式：
   - 起始科目：呼叫GLI410提供科目選擇
   - 結束科目：呼叫GLI410提供科目選擇
3. 更新子檔顯示

### 資料驗證 (R1B00)
1. 對子檔中每一筆記錄執行檢核 (R1B10)
2. 主要檢核內容：
   - 檢查類型欄位 (DAS04) 是否符合規定格式（數字0-9）
   - 檢查正負號欄位 (DAS05) 是否已輸入
   - 檢查起始科目 (DAS06) 是否存在於會計科目檔
   - 檢查起始科目不可大於結束科目
   - 若有錯誤，設定相應的錯誤代碼及指示燈

### 檔案處理 (R2D00)
1. 根據操作選項執行不同的檔案處理：
   - 新增 (R2D10)：寫入主檔及子檔資料
   - 修改 (R2D20)：更新主檔及子檔資料，處理刪除標記
   - 刪除 (R2D30)：刪除主檔及相關子檔資料

### 檔案資料轉換 (R2D11)
1. 將螢幕欄位轉換為檔案格式：
   - 將正負號(+/-)轉換為數值(1/-1)
   - 清空不需要的欄位(AS08, AS09, AS10)
   - 設定更新時間及使用者資訊

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0030**：輸入資料錯誤
- **UPT0042**：起始科目不可大於結束科目
- **UPT2050**：無資料
- **UPT2072**：新增作業已完成
- **UPT2075**：修改作業已完成
- **UPT2150**：使用者無權限執行此功能

### 錯誤處理
- 設定對應的錯誤指示燈 (IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位
- 對於功能完成的訊息，顯示成功訊息並繼續處理

## 8. 備註

本程式為報表格式設定系列的專門程式，用於設定損益分析表報表格式。此程式與其他報表格式設定程式(GLA351-GLA354)類似，但專注於損益分析表的設定。

特殊功能說明：
1. 預設項目常數：程式內建損益分析表所需的標準項目（營業收入、營業成本、營業毛利等）
2. 自動編號機制：子檔記錄按照標準損益分析表順序自動編號(0010-0080)
3. 複製功能：允許從現有報表格式複製設定，提高工作效率
4. 專門針對損益分析表的資料驗證：確保資料符合損益分析表的特定需求

此程式的特點是提供一個標準化的損益分析表格式，使用者只需設定各項目對應的科目範圍和正負號，即可快速建立損益分析表。程式會依據標準損益項目自動產生子檔記錄，大幅簡化設定過程。 
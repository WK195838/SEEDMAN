# GLA1701 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1701
- **程式說明**：結帳作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1701
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.06
- **修改日期**：-
- **系統**：會計總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAHLF01**：會計認證主檔
- **GLAILF01**：預算月份金額檔
- **GLALPF**：沖帳金額主檔
- **GLALLF01**：沖帳金額檢視檔
- **GLAKPF**：會計參數檔
- **GLAGPF**：大帳主檔
- **GLAMPF**：沖帳金額明細檔
- **GLA5PF**：認證來源設定檔
- **GLAEPF**：分類代碼資料檔
- **GLAFPF**：交易別資料檔
- **PT#BPF**：部門檔
- **GLAHLF06**：大宗過期認證檢視檔
- **GLA170D**：畫面顯示檔
- **GLA170P**：報表列印檔

### 程式關係
- **主程式**：GLA1701
- **呼叫程式**：
  - P31：日期格式處理程式
  - GLS005：會計年度處理程式
  - GLS002：認證代碼產生程式
  - GLS003：金額計算程式
  - P64I：印表機處理程式
- **被呼叫者**：
  - GLA1701C：控制程式

## 3. 檔案欄位規格說明

### 主要工作變數
- **WAI1/WAI2/WAI3**：計算月數金額陣列
- **WP1/WP2**：認證號碼陣列
- **PTDA01**：參數檔資料區
- **$USER**：使用者代碼
- **$CHYMD**：日期
- **$ADD/UPD/DLT/INQ**：權限旗標
- **$USERN**：使用者名稱
- **$A8YMD/C8YMD**：系統日期
- **$CPY**：公司代號
- **$PRTCD**：印表機代號
- **DAH01**：公司代號
- **DAH10/DAH17**：認證相關參數
- **DAH10F/DAH17F/DAH17T**：認證範圍參數

## 4. 輸出/入螢幕布局與說明

### 主要顯示畫面 (GLA170D)
- **畫面標題**：結帳作業
- **輸入欄位**：不需要輸入，程式自動處理
- **畫面顯示**：僅顯示處理訊息

### 報表格式 (GLA170P)
- **報表標題**：結帳作業
- **報表欄位**：認證編號、認證說明
- **頁尾顯示**：頁碼、日期

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 初始化子檔顯示 (R0200)
3. 讀取認證記錄並處理：
   - 計算預算金額與每月分配 (R1000)
   - 處理沖銷及結帳 (R2000)
   - 處理大宗認證 (R3000)
   - 計算餘額 (R4000)
   - 更新結帳資料 (R5000)
   - 列印認證清單 (R6000)
   - 處理畫面顯示 (R7000)
   - 更新餘額資料 (R8000)
4. 更新會計參數檔 (R9000)
5. 列印報表資料 (R9900)

## 6. 子程序處理邏輯說明

### 預算金額處理 (R1000-R1100)
- 讀取會計年度資料
- 取得預算會計期間
- 計算預算金額分配
- 更新預算月份檔 (GLAILF01)

### 沖銷處理 (R2000-R2520)
- 處理沖銷及結帳資料
- 依據認證類型進行不同處理邏輯
- 貸方金額與借方金額計算
- 更新沖帳金額主檔 (GLALPF)
- 更新沖帳金額明細檔 (GLAMPF)

### 大宗認證處理 (R3000)
- 處理大宗認證移轉
- 產生認證代碼
- 更新大帳資料 (GLAGPF)
- 新增會計認證記錄 (GLAHPF)

### 餘額計算 (R4000)
- 呼叫金額計算程式
- 更新結帳後餘額

### 結帳更新 (R5000)
- 更新認證來源設定檔 (GLA5PF)
- 記錄已處理認證筆數

### 報表處理 (R6000-R6A00)
- 產生結帳報表
- 設定報表格式與標題
- 列印認證明細

### 畫面處理 (R7000-R7A00)
- 更新畫面顯示資料
- 移動資料到子檔
- 設定處理狀態指示燈

### 餘額更新 (R8000)
- 計算餘額總計
- 更新預算月份餘額

### 參數檔更新 (R9000)
- 更新會計參數檔 (GLAKPF)
- 更新過帳日期資料
- 處理大宗認證過期標記

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 公司代號錯誤 |
| UPT2010 | PTMF | 公司代號不存在 |
| UGL0013 | GLMF | 會計參數檔設定錯誤 |
| UPT2150 | PTMF | 使用者權限不足 |
| UPT2142 | PTMF | 處理完成提示 |

## 8. 備註

1. 本程式為會計總帳系統中的結帳作業程式，主要功能是處理會計科目的結帳與過帳作業。
2. 程式會自動處理大宗認證的過期標記，將過帳一年後的大宗認證標記為'@'。
3. 結帳作業會更新會計參數檔中的已過帳日期，作為下次過帳的依據。
4. 程式會產生結帳報表，列出所有處理的認證編號。
5. 結帳作業會處理借貸方金額的計算與更新，確保帳目平衡。
6. 程式使用子檔顯示處理結果，分別顯示借方與貸方的明細資料。
7. 本程式會呼叫多個子程式處理特定功能，如日期格式轉換、認證代碼產生等。
8. 程式設計使用多層次的邏輯結構，確保資料處理的正確性與完整性。 
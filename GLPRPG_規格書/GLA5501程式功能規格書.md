# GLA5501 程式功能規格書

## 1. 基本資料
- 程式編號: GLA550
- 程式名稱: 年度帳款沖轉結轉作業
- 作者: A1087 JOYCE
- 建立日期: 1992.12.05
- 修改日期: -
- 系統名稱: 會計帳冊

## 2. 檔案架構與關聯圖

程式GLA5501使用下列檔案:
- GLAHLF09 (更新)
- GLAILF01 (更新)
- GLALPF (更新)
- GLALLF01 (更新)
- GLAMPF (更新)
- GLAKPF (輸入)
- GLAEPF (輸入)
- GLAFPF (輸入)
- PT#BPF (輸入)
- GLA550P (輸出/報表)

檔案間關聯:
- GLAHLF09 為主檔案，包含需處理的帳款資料
- GLAFPF 檔案通過 AH01/AH04 欄位與主檔案關聯，提供帳款參數設定
- GLAILF01 檔案儲存年度沖帳餘額，透過 KEYAI 關聯
- GLALPF 檔案儲存沖帳餘額主檔，透過 KEYAL2 關聯
- GLALLF01 檔案處理沖帳餘額待處理檔案，透過 KEYAL1 關聯
- GLAMPF 檔案儲存沖帳餘額明細檔，透過 KEYAM 關聯
- GLAEPF 檔案提供類別細分代碼，透過 KEYAE 關聯

## 3. 檔案名稱與欄位規格

### GLAHLF09
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AH01    | 公司別   | -    | 2    | 字元 | -       |
| AH02    | 帳款編號 | -    | 9    | 字元 | -       |
| AH03    | -       | -    | -    | 數值 | -       |
| AH04    | -       | -    | -    | 字元 | 與GLAFPF關聯 |
| AH05-AH09| -      | -    | -    | 字元 | -       |
| AH10    | 帳款內容 | -    | 80   | 字元 | -       |
| AH12    | 借方金額 | -    | -    | 數值 | -       |
| AH13    | 貸方金額 | -    | -    | 數值 | -       |
| AH18    | 處理旗標 | -    | 1    | 字元 | 處理完成設為'V' |
| AH24    | -       | -    | -    | 字元 | 沖帳帳款代號 |

### GLAILF01
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AI01    | 公司別   | -    | -    | 字元 | -       |
| AI02    | 會計年度 | -    | 4    | 數值 | -       |
| AI03    | -       | -    | -    | 字元 | -       |
| AI04-AI08| -      | -    | -    | 字元 | -       |
| AI10    | -       | -    | -    | 數值 | -       |
| AI10A   | -       | -    | -    | 數值 | -       |
| AI10B   | -       | -    | -    | 數值 | -       |
| WAI1    | 實際餘額 | -    | 13x13| 數值 | 儲存每月餘額 |
| WAI2    | 借方金額 | -    | 13x13| 數值 | 儲存每月借方 |
| WAI3    | 貸方金額 | -    | 13x13| 數值 | 儲存每月貸方 |

### GLALPF
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AL01    | 公司別   | -    | -    | 字元 | -       |
| AL02    | -       | -    | -    | 字元 | -       |
| AL03    | 帳款編號 | -    | -    | 字元 | -       |
| AL04-AL08| -      | -    | -    | 多種 | 類別細分代碼 |
| AL09    | 沖帳餘額 | -    | -    | 數值 | -       |
| AL10    | 沖帳總額 | -    | -    | 數值 | -       |
| AL11    | 沖帳期數 | -    | -    | 數值 | -       |
| AL12    | -       | -    | -    | 數值 | -       |

### GLAMPF
| 欄位代號 | 欄位名稱 | 位置 | 長度 | 屬性 | 檢核說明 |
|---------|---------|------|------|------|---------|
| AM01-AM08| -      | -    | -    | 多種 | 對應AL01-AL08 |
| AM09    | 帳款編號 | -    | -    | 字元 | -       |
| AM10    | -       | -    | -    | 數值 | -       |
| AM11    | 已沖金額 | -    | -    | 數值 | -       |

## 4. 輸出/入螢幕布局與說明
本程式為批次處理程式，無互動螢幕輸入。
報表輸出至GLA550P印表機檔案。

## 5. 處理流程程序說明

程式主要流程:
1. 初始化參數 (R0100)
2. 讀取主檔案 GLAHLF09 的帳款資料
3. 處理每筆帳款資料
   a. 計算年度沖帳餘額 (R1000)
   b. 進行沖帳處理 (R2000)
   c. 若帳款編號變更，進行小計與列印 (R4000, R6000)
   d. 更新帳款旗標 (R7000)
4. 處理結束後，若有資料則計算並列印總計 (R8000)
5. 若無資料則列印空白報表 (R9900)
6. 結束程式

## 6. 子程序處理邏輯說明

### R0100 - 初始化
- 初始化系統參數與工作變數
- 呼叫日期處理程式P31
- 初始化報表變數

### R1000 - 計算年度沖帳餘額
- 呼叫R1A00取得會計年度
- 通過KEYAF關聯取得GLAFPF資料
- 若找到相關記錄，則計算年度沖帳餘額
- 更新或寫入GLAILF01檔案

### R1A00 - 會計年度計算
- 呼叫GLS005系統程式取得會計年度與期間
- 設定WY(會計年度)與WM(會計期間)變數

### R1100 - 更新/寫入年度沖帳餘額檔
- 若GLAILF01無相關記錄，則建立新記錄
- 依據借貸屬性(AF06)計算實際餘額
- 在對應月份累計借貸金額
- 更新檔案時間戳記
- 寫入或更新GLAILF01檔案

### R2000 - 處理沖帳作業
- 通過KEYAF關聯取得GLAFPF資料
- 檢查是否需要進行沖帳處理
- 根據借貸屬性決定執行沖入(R2100)或沖出(R2500)

### R2100 - 沖入處理
- 取得類別細分代碼
- 計算總沖帳金額
- 讀取沖帳餘額待處理檔案(GLALLF01)
- 若沖帳餘額與沖帳總額不同，進行差額調整
- 更新GLALLF01檔案並記錄沖帳明細(GLAMPF)
- 若有餘額，寫入沖帳餘額主檔(GLALPF)

### R21A0 - 取得類別細分代碼
- 通過KEYAE關聯取得GLAEPF資料
- 設定分類代碼到對應欄位

### R21B0 - 更新/寫入沖帳餘額明細檔
- 根據鍵值查找GLAMPF檔案記錄
- 若無記錄則建立新記錄
- 累計已沖金額
- 更新檔案時間戳記
- 寫入或更新GLAMPF檔案

### R2500 - 沖出處理
- 取得類別細分代碼
- 計算總沖帳金額
- 根據AH24欄位判斷沖帳方式
- 若AH24不為空，則呼叫R2510專用沖帳處理
- 否則呼叫R2520一般沖帳處理

### R4000 - 小計處理
- 設定鍵值並呼叫系統程式GLS003進行小計
- 進行必要的記錄查詢和更新

### R6000 - 列印明細
- 若首次執行，呼叫R6100列印報表標題
- 處理列印次數和格式
- 當累計4筆資料或需要換頁時進行列印
- 呼叫R6A00清除列印欄位

### R7000 - 更新帳款旗標
- 儲存當前帳款編號以便比較
- 若為損益表科目，計算損益差額
- 將處理旗標設為'V'表示已處理
- 更新GLAHLF09主檔案

### R8000 - 處理總計
- 設定列印控制旗標
- 計算小計並列印總計行
- 將總計金額寫入年度沖帳餘額檔

## 7. 錯誤處理程序說明與訊息清冊

錯誤處理:
- 當找不到相關記錄時，設置對應的指示器
- 程式流程中有適當的錯誤處理邏輯確保資料一致性
- 處理完成後會檢查並標記已處理記錄

## 8. 備註

1. 此程式為批次處理程式，用於年度帳款沖轉結轉作業。
2. 程式處理多個檔案間的資料關聯，執行沖帳、結轉操作。
3. 程式使用RPG III語言撰寫，包含多個子程序處理不同功能。
4. 程式有完整的金額計算與餘額結轉邏輯。
5. 處理流程設計具備錯誤檢查與資料一致性維護。 
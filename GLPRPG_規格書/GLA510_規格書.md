# GLA510 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA510
- **程式說明**：傳票清單作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA510
- **開發人員**：A1150
- **建立日期**：1992.12.02 (81/12/02)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLACPF**：會計資料檔
- **GLAHLF08**：傳票檔
- **GLAKPF**：參數檔
- **S#SUPF**：人員資料檔
- **PT#BPF**：部門參數檔
- **GLA510D**：螢幕顯示檔案
- **GLA510P**：報表輸出檔案

### 程式關係
- **主程式**：GLA510
- **呼叫程式**：
  - P31：日期格式處理程式
  - P64：列印控制程式
  - P64I：印表機代碼設定程式
  - GLS006：取得會計日期起迄值程式
  - GLS007：會計期間查詢程式
- **功能鍵**：F3(離開), F4(查詢), F14(處理作業)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $INQ (138-138)：查詢權限
  - $UPD (136-136)：修改權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **ARR (陣列)**
  - AC03-AC15 (1-13)：會計期間陣列，對應 3 至 15 月份

- **工作區資料**
  - WAK14 (1-50)：工作區
  - W01 (1-3)：會計年度
  - W02 (4-5)：會計月份

### 主要欄位說明
- **KEYAK**：參數檔鍵值 (DAC01)
- **KEYAC**：會計資料檔鍵值 (DAC01+WTMP1)
- **KEYSU**：人員資料檔鍵值 (AH26)
- **KEYSL**：傳票檔起始鍵值 (DAC01+AH10F)
- **KEYSG**：傳票檔結束鍵值 (DAC01+AH10T)
- **DAC01**：部門代號
- **DFLD1**：會計年度
- **DFLD2**：會計月份
- **DFLD3**：會計資料值
- **GLS1F/GLS1T**：會計日期區間 (依年月)
- **GLS2F/GLS2T**：會計日期區間 (依系統日期)
- **AH10F/AH10T**：傳票日期起迄值

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (DSPD1)
- **螢幕標題**：傳票清單作業
- **畫面描述**：設定傳票清單查詢條件
- **輸入欄位**：
  - 部門代號 (DAC01)：選擇部門代號
  - 會計年度 (DFLD1)：會計年度
  - 會計月份 (DFLD2)：會計月份 (1-13)

- **功能鍵**：
  - F3：離開
  - F4：查詢 (可查詢會計期間或印表機代碼)
  - F14：處理作業 (列印報表或查詢)

### 報表格式 (GLA510P)
- **報表標題**：傳票清單
- **報表欄位**：
  - 傳票日期 (PAH10)：傳票日期
  - 傳票號碼 (AH02)：傳票編號
  - 登錄人員 (PSU02)：傳票登錄人員
  - 登錄日期 (PAH25)：傳票登錄日期
  
## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入主畫面處理迴圈 (R1000)
3. 根據使用者輸入執行相應處理
4. 程式結束

### 主畫面處理流程 (R1000)
1. 顯示主畫面等待使用者輸入
2. 若按F3則結束程式
3. 若按F4則執行查詢功能 (R1E00)
4. 檢核使用者輸入資料 (R1B00)
5. 若按F14且檢核無誤：
   - 若傳票已存在 (IN32=1)，則執行列印傳票清單 (R2A00)
   - 若傳票不存在 (IN32=0)，則執行更新會計期間狀態 (R1C00)

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 設定畫面顯示指示燈 (IN27)
2. 讀取參數資料區 (PTDA01)
3. 呼叫P31設定日期格式
4. 初始化各項輸入欄位
5. 設定列印參數預設值 ($CPY, $PRTCD)

### 主畫面檢核 (R1B00)
1. 檢查部門代號是否已輸入並存在
2. 檢查會計年月是否有效
   - 轉換會計年月為系統日期格式
   - 呼叫GLS006計算日期區間起迄值
3. 檢查是否存在對應的傳票資料
   - 若存在，則設定指示燈IN32
   - 若不存在，則根據權限執行不同處理
4. 檢查使用者權限
   - 更新會計期間時需要修改權限 ($UPD='Y')
   - 列印傳票清單時需要查詢權限 ($INQ='Y')

### 更新會計期間狀態 (R1C00)
1. 讀取會計資料檔記錄
2. 將對應的會計期間設為已結帳 ('Y')
3. 更新會計資料檔
4. 若會計期間值大於原記錄值，則更新參數檔會計日期
5. 顯示處理完成訊息

### 查詢功能 (R1E00)
1. 根據游標位置判斷查詢項目
2. 會計期間查詢：
   - 若游標在第7或8行，則呼叫GLS007查詢會計期間
3. 印表機代碼查詢：
   - 若游標在第17行，則呼叫P64I查詢印表機代碼

### 列印傳票清單 (R2A00)
1. 開啟報表輸出檔
2. 設定傳票檔的讀取範圍 (KEYSL, KEYSG)
3. 循環讀取傳票檔資料：
   - 若傳票號碼變更，則印出新的明細行 (R2A21)
   - 依序處理每一筆傳票資料
4. 完成列印後執行結束處理 (R2A22)
5. 關閉報表輸出檔

### 報表明細行處理 (R2A21)
1. 印出報表標題 (若為第一筆)
2. 從參數檔取得部門資料
3. 轉換傳票日期為報表顯示格式
4. 從人員檔取得登錄人員資料
5. 轉換登錄日期為報表顯示格式
6. 印出傳票明細行

### 報表結束處理 (R2A22)
1. 設定報表結束指示
2. 印出報表尾頁
3. 呼叫P64處理列印工作
   - 設定列印份數及印表機代碼

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0030**：資料範圍超出限制
- **UPT2010**：資料不存在
- **UPT2142**：作業處理完成
- **UPT2150**：無權限執行此功能
- **UGL0031**：傳票清單作業
- **UGL0032**：會計期間已結帳

### 錯誤處理
- 設定對應的錯誤指示燈 (IN60-IN63, IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於會計總帳系統中的傳票清單管理，具有以下特點：

1. 提供傳票清單列印功能，可依部門及會計年月查詢傳票資料
2. 支援會計期間結帳功能，標記特定會計期間為已結帳
3. 結合系統權限控制，僅允許有權限的使用者執行對應功能
4. 可查詢會計期間資料，方便使用者選擇正確的會計期間
5. 提供印表機選擇功能，可指定報表輸出的印表機

此程式主要用於兩種情境：
1. 查詢與列印指定期間的傳票清單，便於財務部門進行傳票審核與管理
2. 管理會計期間狀態，標記已結帳的會計期間，避免資料被誤修改

程式會根據傳票是否存在自動判斷執行模式：當指定期間有傳票時執行列印功能；當指定期間沒有傳票時，則可標記該期間為已結帳。這種設計使程式能夠在同一個介面完成兩種不同的業務需求。 
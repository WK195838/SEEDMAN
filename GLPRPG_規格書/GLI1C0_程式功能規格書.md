# GLI1C0 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLI1C0
- **程式說明**：科目帳查詢
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLI1C0
- **開發人員**：A1149 MAY
- **建立日期**：1992.11.10
- **更新日期**：108/06/12（更新者：DEREK）
- **系統**：會計總帳
- **功能描述**：提供會計科目帳查詢功能，顯示科目餘額與交易明細

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **PT#BPF**：系統參數檔（讀取檔案）
- **GLAFPF**：會計科目檔（讀取檔案）
- **GLAKPF**：會計期間檔（讀取檔案）
- **GLAHLF03**：會計分錄歷史檔（讀取檔案）
- **GLAILF01**：會計科目餘額檔（讀取檔案）
- **GLI1C0D**：螢幕顯示檔（工作站檔案）

### 檔案間關聯
- 使用公司代碼（DAH01）連結各檔案
- 使用科目代碼（DAH04）連結GLAFPF取得科目資料
- 使用公司代碼、科目代碼、日期（DAH01、DAH04、DAH10）連結GLAHLF03取得交易資料
- 使用公司代碼、科目代碼（WAI01、WAI03）連結GLAILF01取得科目餘額資料
- 使用KEY#B、KEYAF、KEYAHR等關鍵字列表進行檔案存取

## 3. 檔案欄位規格說明

### GLAHLF03 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 10 | 文字 | 主鍵 |
| AH04 | 科目代碼 | - | 8 | 文字 | 科目代碼 |
| AH10 | 交易日期 | - | 8 | 數值 | 會計交易日期 |
| AH12 | 借方金額 | - | - | 數值 | 借方金額 |
| AH13 | 貸方金額 | - | - | 數值 | 貸方金額 |
| AH18 | 過帳標記 | - | 1 | 文字 | V=已過帳，空白=未過帳 |
| AH19 | 結案標記 | - | 1 | 文字 | V=已結案，空白=未結案 |
| AH20 | 作廢標記 | - | 1 | 文字 | V=已作廢，空白=未作廢 |

### GLAFPF (會計科目檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AF01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AF02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AF03 | 科目名稱 | - | - | 文字 | 科目名稱 |
| AF06 | 科目性質 | - | 1 | 文字 | 1=借餘，其他=貸餘 |
| AF07 | 匯率 | - | - | 數值 | 匯率 |

### GLAKPF (會計期間檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AK01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AK09 | 日期格式 | - | 1 | 文字 | 日期格式 |
| AK10 | 會計年制 | - | 1 | 文字 | 1=12個月制，其他=13個月制 |
| AK11 | 日期分隔符號 | - | 1 | 文字 | 日期分隔符號 |

### GLAILF01 (會計科目餘額檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AI01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AI02 | 年度期間 | - | 40 | 文字 | 主鍵，年度期間 |
| AI03 | 科目代碼 | - | 8 | 文字 | 主鍵，科目代碼 |
| AI10 | 上期餘額 | - | - | 數值 | 上期餘額 |
| AI11-AI23 | 各期餘額 | - | - | 數值 | 第1-13期餘額 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| #B02 | 公司名稱 | - | - | 文字 | 公司名稱 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $USERN | 使用者姓名 | 152 | 10 | 文字 | 目前使用者姓名 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| $C8YMD | 系統日期 | 209 | 8 | 數值 | 系統日期(YYYYMMDD) |
| DAH01 | 公司代碼 | 1 | 2 | 文字 | 查詢的公司代碼 |
| DAH04 | 科目代碼 | 3 | 8 | 文字 | 查詢的科目代碼 |
| DAH10 | 查詢日期 | - | 8 | 數值 | 查詢日期 |
| #AH10 | 查詢日期(內部格式) | - | 8 | 數值 | 查詢日期(內部格式) |
| A | 顯示條件 | 19 | 1 | 文字 | 1=已過帳，2=已結案未作廢，3=未作廢 |
| B | 餘額 | - | - | 數值 | 科目餘額 |
| C | 累計金額 | - | - | 數值 | 累計金額 |
| LC | 上次餘額 | - | - | 數值 | 上次餘額 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
```
                             科目帳查詢畫面                             公司：XX
                                                                      日期：YYYY/MM/DD

公司代碼：XX        科目代碼：XXXXXXXX     科目名稱：XXXXXXXXXXXXXXXXXXXX
查詢日期：YYYY/MM/DD                       顯示條件：X (1=已過帳 2=已結案 3=未作廢)

上期餘額：999,999,999,999.99              本期餘額：999,999,999,999.99

選項 分錄編號     交易日期    借方金額          貸方金額          餘額
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99
 _   XXXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   999,999,999.99

F3=結束  F4=提示  ROLL UP=下一頁
```

### 功能鍵說明
- F3：結束
- F4：提示（呼叫GLI410科目查詢）
- ROLL UP：下一頁

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 初始化子檔

2. 處理螢幕輸入（R1000子程序）
   - 顯示螢幕
   - 處理功能鍵
   - 檢查輸入資料

3. 計算科目餘額（R1A20子程序）
   - 讀取科目餘額檔
   - 計算上期餘額
   - 計算本期餘額

4. 讀取交易資料（R1A10子程序）
   - 根據查詢條件讀取會計分錄歷史檔
   - 顯示交易資料於子檔

5. 處理選項（R1C00子程序）
   - 處理使用者選擇的分錄
   - 呼叫GLI1F0程式顯示分錄詳細資料

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 初始化查詢條件變數
- 設定顯示條件預設值為'1'(已過帳)
- 呼叫R1A00初始化子檔

### R1000 - 螢幕處理
- 顯示主畫面
- 處理功能鍵輸入
- 檢查輸入資料
- 處理選項

### R1A00 - 子檔初始化
- 初始化餘額變數
- 設定子檔控制指標
- 清除子檔內容
- 呼叫R1A20計算科目餘額
- 呼叫R1A10讀取交易資料

### R1A10 - 讀取交易資料
- 根據查詢條件讀取會計分錄歷史檔
- 根據顯示條件過濾記錄
- 控制每頁顯示記錄數
- 處理檔案結束情況

### R1A11 - 寫入子檔資料
- 格式化日期顯示
- 計算交易後餘額
- 寫入子檔記錄

### R1A20 - 計算科目餘額
- 讀取公司資料
- 讀取科目資料
- 呼叫GLS005取得年度期間
- 讀取科目餘額檔
- 計算上期餘額
- 計算本期餘額
- 呼叫GLS006取得上期日期
- 呼叫GLS009取得期末餘額

### R1B00 - 檢查輸入資料
- 檢查公司代碼是否輸入
- 檢查公司代碼是否存在
- 檢查科目代碼是否輸入
- 檢查科目代碼是否存在
- 檢查查詢日期是否輸入
- 檢查查詢日期格式是否正確
- 轉換查詢日期格式

### R1C00 - 處理選項
- 讀取子檔選項
- 處理選項5（呼叫GLI1F0顯示分錄詳細資料）
- 處理返回代碼

### R1E00 - 處理提示功能
- 處理F4功能鍵
- 呼叫GLI410科目查詢程式
- 處理返回代碼

### R1N00 - 處理下一頁功能
- 檢查是否已到檔案結尾
- 讀取下一頁資料
- 更新子檔顯示

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 當輸入資料有誤時，會設定錯誤指標並顯示錯誤訊息
- 當找不到符合條件的記錄時，會顯示無資料訊息

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| UPT0010 | 必須輸入資料 | 顯示錯誤訊息，游標停在相應欄位 |
| UPT2010 | 公司代碼不存在 | 顯示錯誤訊息，游標停在公司代碼欄位 |
| UPT0030 | 科目代碼不存在 | 顯示錯誤訊息，游標停在科目代碼欄位 |
| UPT0040 | 日期格式錯誤 | 顯示錯誤訊息，游標停在查詢日期欄位 |
| UPT2050 | 無符合條件的資料 | 顯示錯誤訊息 |

## 8. 備註
- 本程式為會計科目帳查詢功能，提供使用者查詢特定科目的交易明細及餘額
- 程式會顯示科目的上期餘額和本期餘額
- 程式會根據顯示條件過濾交易記錄，可選擇顯示已過帳、已結案未作廢或未作廢的交易
- 使用者可以選擇特定交易，程式會呼叫GLI1F0程式顯示該交易的詳細資料
- 程式會根據科目性質（借餘或貸餘）計算正確的餘額
- 108/06/12 DEREK修改解決科目帳餘額顯示不正確問題（依據交易日期，科目餘額會正確顯示） 
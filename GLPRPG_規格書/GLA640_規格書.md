# GLA640 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA640
- **程式說明**：預算分配計算作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA640
- **開發人員**：A1150
- **建立日期**：81/12/09
- **修改日期**：-
- **系統**：會計總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAUPF**：預算定額分配結果檔
- **GLATPF**：預算定額分配主檔
- **GLAFPF**：交易別資料檔
- **GLAKPF**：會計參數檔
- **GLAILF04**：預算月份金額檔
- **PT#APF**：會計項目檔
- **PT#BPF**：部門檔
- **GLA640D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA640
- **呼叫程式**：
  - P31：日期格式處理程式
  - P55：格式處理程式

## 3. 檔案欄位規格說明

### GLAILF04 (預算月份金額檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AI01 | 來源部門代號 | 字元 | 主索引鍵之一 |
| AI02 | 來源年度 | 數值 | 主索引鍵之二 |
| AI03 | 會計層級 | 字元 | - |
| AI04 | 會計項目代碼 | 字元 | - |
| AI10-AI23 | 月份金額1-14 | 數值 | - |
| AI97 | 輸入時間 | 時間 | - |
| AI98 | 輸入日期 | 數值 | - |
| AI99 | 輸入人員 | 字元 | - |

### GLAUPF (預算定額分配結果檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AU01 | 目標部門代號 | 字元 | 主索引鍵之一 |
| AU02 | 目標年度 | 數值 | 主索引鍵之二 |
| AU03 | 層級 | 數值 | 主索引鍵之三 |
| AU04 | 會計層級 | 字元 | 主索引鍵之四 |
| AU05 | 會計項目代碼 | 字元 | 主索引鍵之五 |
| AU06 | 總金額 | 數值 | - |
| AU07-AU19 | 月份金額1-13 | 數值 | - |
| AU97 | 輸入時間 | 時間 | - |
| AU98 | 輸入日期 | 數值 | - |
| AU99 | 輸入人員 | 字元 | - |

### GLATPF (預算定額分配主檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AT01 | 部門代號 | 字元 | 主索引鍵之一 |
| AT02 | 年度 | 數值 | 主索引鍵之二 |
| AT03 | 層級 | 數值 | 主索引鍵之三 |
| AT04 | 會計層級 | 字元 | 主索引鍵之四 |
| AT05 | 摘要 | 字元 | - |
| AT06 | 總金額 | 數值 | - |
| AT97 | 輸入時間 | 時間 | - |
| AT98 | 輸入日期 | 數值 | - |
| AT99 | 輸入人員 | 字元 | - |

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPD1)
- **畫面標題**：預算分配計算作業
- **輸入欄位**：
  - 來源公司別 (DAI01)：必填
  - 來源年度 (DAI02)：必填
  - 換算比率 (DFLD1)：百分比值
  - 會計層級範圍 (DAI03F, DAI03T)：範圍值
  - 會計項目範圍 (DAI04F, DAI04T)：範圍值
  - 目標公司別 (DAU01)：必填
  - 目標年度 (DAU02)：必填
  - 目標層級 (DAU03)：必填
  - 處理選項 (DOPT)：1=存在則覆蓋, 2=存在則略過無確認, 3=存在則提示確認

- **功能鍵**：
  - F3：結束
  - F14：處理作業

### 確認畫面 (DSPD2)
- **畫面標題**：預算分配計算作業
- **輸入欄位**：
  - 會計層級 (DAU04)：顯示
  - 會計項目代碼 (DAU05)：顯示
  - 項目名稱 (#A02)：顯示
  - 是否覆蓋 (COVE)：Y=覆蓋, N=略過

- **功能鍵**：無特定功能鍵

## 5. 處理流程程序說明

### 主要流程
1. 初始化環境和畫面 (R0100)
2. 執行主畫面處理 (R1000)：
   - 顯示主畫面並等待使用者輸入
   - 檢查輸入資料 (R1B00)
   - A執行資料處理 (R1D00)
3. 程式結束

### 資料處理流程 (R1D00)
1. 清空結果陣列 (R1D12)
2. 依處理選項執行不同處理：
   - 選項1：存在則覆蓋 (R1D10)
   - 選項2：存在則略過無確認 (R1D20)
   - 選項3：存在則提示確認 (R1D30)
3. 提示處理完成

## 6. 子程序處理邏輯說明

### 初始化處理 (R0100)
- 設定初始參數
- 初始化螢幕欄位
- 清空處理陣列

### 資料檢核 (R1B00)
1. 檢查來源公司別：必須存在且有效
2. 檢查來源年度：必須大於零
3. 檢查換算比率：計算實際比率值
4. 檢查會計層級範圍：若未輸入則設為最大範圍
5. 檢查會計項目範圍：若未輸入則設為最大範圍
6. 檢查目標公司別：必須存在且有效
7. 檢查目標年度：必須大於零
8. 檢查目標層級：必須大於零

### 資料讀取與計算 (R1D11)
1. 讀取預算月份金額資料 (GLAILF04)
2. 設定會計層級和會計項目代碼
3. 檢查交易別資料檔 (GLAFPF) 判斷是否為借方
4. 根據借貸方標誌進行不同的金額計算：
   - 借方：計算各月份金額總和
   - 貸方：計算各月份個別金額
5. 累計總金額

### 存在覆蓋處理 (R1D10)
1. 讀取來源預算月份金額資料
2. 根據資料範圍進行過濾
3. 針對每筆符合條件的資料：
   - 計算目標金額
   - 檢查目標資料是否存在
   - 若存在則更新，不存在則新增

### 存在略過處理 (R1D20)
1. 讀取來源預算月份金額資料
2. 根據資料範圍進行過濾
3. 針對每筆符合條件的資料：
   - 計算目標金額
   - 檢查目標資料是否存在
   - 若存在則略過，不存在則新增

### 存在確認處理 (R1D30)
1. 讀取來源預算月份金額資料
2. 根據資料範圍進行過濾
3. 針對每筆符合條件的資料：
   - 計算目標金額
   - 檢查目標資料是否存在
   - 若存在則顯示確認畫面
   - 根據使用者確認決定是否覆蓋

### 總表資料新增或更新 (R2D10)
1. 檢查預算定額分配主檔 (GLATPF) 是否有對應記錄
2. 若存在則更新總金額
3. 若不存在則新增記錄
4. 更新摘要資訊

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 必填欄位不可為空白 |
| UPT0012 | PTMF | 欄位值不可為零 |
| UPT0042 | PTMF | 範圍值起始大於結束 |
| UPT2010 | PTMF | 資料不存在 |
| UPT2142 | PTMF | 處理完成提示 |
| UGL0004 | GLMF | 公司別無效或非啟用狀態 |

## 8. 備註

1. 本程式為會計總帳系統中的預算分配計算作業程式，用於從來源預算資料計算並產生目標預算資料。
2. 程式允許使用比率來換算來源預算金額，支援不同部門之間的預算分配。
3. 使用者可以指定會計層級範圍和會計項目範圍來限制處理的資料範圍。
4. 程式提供三種處理模式：直接覆蓋已存在的目標資料、略過已存在的目標資料，或提示使用者確認。
5. 程式會根據交易別資料檔中的借貸方標誌進行不同的金額計算。
6. 針對每個處理的會計項目，程式會更新預算定額分配主檔中的總金額。
7. 程式在處理完成後會顯示提示訊息，通知使用者處理結果。
8. 此程式通常與 GLA620 (預算定額分配作業) 配合使用，協助會計人員進行預算規劃和分配。 
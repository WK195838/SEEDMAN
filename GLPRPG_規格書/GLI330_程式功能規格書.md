# GLI330 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLI330
- **程式說明**：分攤比例設定資料查詢
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLI330
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.03
- **更新日期**：-
- **系統**：會計總帳
- **功能描述**：提供分攤比例設定資料的查詢功能，可依照公司代碼、會計科目、分攤類別、分攤項目及分攤別查詢相關設定資料

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAPPF**：分攤比例設定檔（讀取檔案）
- **GLAFPF**：會計科目檔（讀取檔案）
- **GLAKPF**：會計期間檔（讀取檔案）
- **PT#APF**：分攤項目檔（讀取檔案）
- **GLI330D**：螢幕顯示檔（工作站檔案）

### 檔案間關聯
- 使用公司代碼（DAP01）、會計科目（DAP02）、分攤類別（WAP03）、分攤項目（WAP04）及分攤別（WAP05）連結GLAPPF取得分攤比例設定資料
- 使用公司代碼（AP01）及會計科目（AP02）連結GLAFPF取得會計科目資料
- 使用公司代碼（AP01）連結GLAKPF取得會計期間資料
- 使用分攤項目（AP04）連結PT#APF取得分攤項目資料
- 使用KEYAP、KEYAF關鍵字列表進行檔案存取

## 3. 檔案欄位規格說明

### GLAPPF (分攤比例設定檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AP01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AP02 | 會計科目 | - | 8 | 文字 | 主鍵 |
| AP03 | 分攤類別 | - | 2 | 文字 | 主鍵 |
| AP04 | 分攤項目 | - | 6 | 文字 | 主鍵 |
| AP05 | 分攤別 | - | 1 | 文字 | 主鍵，1=預設，其他=次要 |
| AP06 | 分攤日期 | - | - | 數值 | 分攤日期 |

### GLAFPF (會計科目檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AF01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AF02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AF03 | 科目名稱 | - | - | 文字 | 科目名稱 |

### GLAKPF (會計期間檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AK01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AK09 | 日期格式 | - | 1 | 文字 | 日期格式 |
| AK11 | 日期分隔符號 | - | 1 | 文字 | 日期分隔符號 |

### PT#APF (分攤項目檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #A01 | 分攤項目代碼 | - | 6 | 文字 | 主鍵 |
| #A02 | 分攤項目名稱 | - | - | 文字 | 分攤項目名稱 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $USERN | 使用者姓名 | 152 | 10 | 文字 | 目前使用者姓名 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| $C8YMD | 系統日期 | 209 | 8 | 數值 | 系統日期(YYYYMMDD) |
| DAP01 | 公司代碼 | - | 2 | 文字 | 查詢的公司代碼 |
| DAP02 | 會計科目 | - | 8 | 文字 | 查詢的會計科目 |
| WAP03 | 分攤類別 | - | 2 | 文字 | 查詢的分攤類別 |
| WAP04 | 分攤項目 | - | 6 | 文字 | 查詢的分攤項目 |
| WAP05 | 分攤別 | - | 1 | 文字 | 查詢的分攤別 |
| P330I1 | 公司代碼 | - | 2 | 文字 | 輸入參數-公司代碼 |
| P330I2 | 會計科目 | - | 8 | 文字 | 輸入參數-會計科目 |
| P330I3 | 分攤類別 | - | 2 | 文字 | 輸入參數-分攤類別 |
| P330I4 | 分攤項目 | - | 6 | 文字 | 輸入參數-分攤項目 |
| P330I5 | 分攤別 | - | 1 | 文字 | 輸入參數-分攤別 |
| @RTNC | 返回代碼 | - | 2 | 文字 | 返回代碼 |

## 4. 輸出/入螢幕布局與說明

### 查詢結果畫面
```
                             分攤比例設定資料查詢                           公司：XX
                                                                           日期：YYYY/MM/DD

公司代碼：XX        

選項 會計科目     科目名稱                 分攤類別 分攤項目     分攤項目名稱           分攤別   分攤日期
 _   XXXXXXXX    XXXXXXXXXXXXXXXXXXXX     XX      XXXXXX      XXXXXXXXXXXXXXXXXXXX   X      YYYY/MM/DD
 _   XXXXXXXX    XXXXXXXXXXXXXXXXXXXX     XX      XXXXXX      XXXXXXXXXXXXXXXXXXXX   X      YYYY/MM/DD
 _   XXXXXXXX    XXXXXXXXXXXXXXXXXXXX     XX      XXXXXX      XXXXXXXXXXXXXXXXXXXX   X      YYYY/MM/DD
 _   XXXXXXXX    XXXXXXXXXXXXXXXXXXXX     XX      XXXXXX      XXXXXXXXXXXXXXXXXXXX   X      YYYY/MM/DD
 _   XXXXXXXX    XXXXXXXXXXXXXXXXXXXX     XX      XXXXXX      XXXXXXXXXXXXXXXXXXXX   X      YYYY/MM/DD

F3=結束  F12=返回  ROLL UP=下一頁
```

### 功能鍵說明
- F3：結束
- F12：返回
- ROLL UP：下一頁

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 初始化子檔

2. 處理螢幕輸入（R1000子程序）
   - 顯示螢幕
   - 處理功能鍵
   - 處理選項

3. 讀取分攤比例資料（R1A10子程序）
   - 讀取分攤比例設定檔
   - 顯示分攤比例資料
   - 處理翻頁

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 設定頁面大小
- 呼叫R1A00初始化子檔

### R1000 - 螢幕處理
- 顯示主畫面
- 處理功能鍵輸入
- 處理翻頁
- 呼叫R1C00處理選項

### R1A00 - 子檔初始化
- 初始化子檔變數
- 清除子檔
- 設定子檔控制指標
- 設定讀取位置
- 呼叫R1A10讀取分攤比例資料
- 處理無資料情況

### R1A10 - 讀取分攤比例資料
- 設定讀取位置
- 讀取分攤比例設定檔
- 呼叫R1A11寫入子檔

### R1A11 - 寫入子檔資料
- 讀取會計科目資料
- 讀取分攤項目資料
- 格式化分攤別顯示（預設/次要）
- 格式化分攤日期顯示
- 寫入子檔記錄

### R1C00 - 處理選項
- 讀取子檔選項
- 設定返回參數
- 設定返回代碼
- 更新子檔

### R1N00 - 處理翻頁
- 檢查是否已到最後一頁
- 呼叫R1A10讀取更多資料

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 當找不到符合條件的記錄時，會顯示無資料訊息

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| UPT2050 | 無符合條件的資料 | 顯示錯誤訊息 |

## 8. 備註
- 本程式為分攤比例設定資料查詢功能，提供使用者查詢特定條件的分攤比例設定資料
- 程式可被其他程式呼叫，用於查詢分攤比例設定資料
- 程式支援翻頁功能，可以查看更多符合條件的資料
- 程式會返回使用者選擇的分攤比例設定資料，供呼叫程式使用
- 返回代碼說明：
  - '00'：使用者選擇了一筆資料
  - '03'：使用者按了F3結束鍵
  - '12'：使用者按了F12返回鍵 
# GLA660 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA660
- **程式說明**：預算分配比率設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA660
- **開發人員**：A1139 JANE
- **建立日期**：1992.12.08
- **修改日期**：-
- **系統**：會計總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLA6PF**：預算分配比率檔
- **PT#BPF**：部門檔
- **GLAKPF**：會計參數檔
- **GLA660D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA660
- **呼叫程式**：
  - P31：日期格式處理程式
  - S#S01：權限檢查程式
- **被呼叫程式**：
  - GLI660：預算分配比率查詢

## 3. 檔案欄位規格說明

### GLA6PF (預算分配比率檔)
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A601 | 公司別 | 字元 | 主索引鍵之一 |
| A602 | 比率代碼 | 字元 | 主索引鍵之二 |
| A603 | 比率說明 | 字元 | - |
| A6041 | 1月比率 | 數值 | - |
| A6042 | 2月比率 | 數值 | - |
| A6043 | 3月比率 | 數值 | - |
| A6044 | 4月比率 | 數值 | - |
| A6045 | 5月比率 | 數值 | - |
| A6046 | 6月比率 | 數值 | - |
| A6047 | 7月比率 | 數值 | - |
| A6048 | 8月比率 | 數值 | - |
| A6049 | 9月比率 | 數值 | - |
| A604A | 10月比率 | 數值 | - |
| A604B | 11月比率 | 數值 | - |
| A604C | 12月比率 | 數值 | - |
| A604D | 13月比率 | 數值 | - |
| A697 | 輸入時間 | 時間 | - |
| A698 | 輸入日期 | 數值 | - |
| A699 | 輸入人員 | 字元 | - |

## 4. 輸出/入螢幕布局與說明

### 主畫面 (DSPD1)
- **畫面標題**：預算分配比率設定作業
- **輸入欄位**：
  - 公司別 (DA601)：必填
  - 比率代碼 (DA602)：必填
  - 複製來源公司別 (DA601C)：選填
  - 複製來源比率代碼 (DA602C)：選填
  - 作業選項 (DOPT)：1=新增, 2=修改, 4=刪除, 5=查詢

- **功能鍵**：
  - F3：結束
  - F18：代碼查詢

### 明細畫面 (DSPD2)
- **畫面標題**：預算分配比率設定作業
- **輸入欄位**：
  - 比率說明 (DA603)：輸入比率說明
  - 1月比率 (DA6041)：輸入1月份比率
  - 2月比率 (DA6042)：輸入2月份比率
  - 3月比率 (DA6043)：輸入3月份比率
  - 4月比率 (DA6044)：輸入4月份比率
  - 5月比率 (DA6045)：輸入5月份比率
  - 6月比率 (DA6046)：輸入6月份比率
  - 7月比率 (DA6047)：輸入7月份比率
  - 8月比率 (DA6048)：輸入8月份比率
  - 9月比率 (DA6049)：輸入9月份比率
  - 10月比率 (DA604A)：輸入10月份比率
  - 11月比率 (DA604B)：輸入11月份比率
  - 12月比率 (DA604C)：輸入12月份比率
  - 13月比率 (DA604D)：輸入13月份比率
  - 總計 (TOTAL)：各月份比率合計顯示

- **功能鍵**：
  - F3：結束
  - F5：重新整理
  - F12：返回前一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化環境和畫面 (R0100)
2. 執行主畫面處理 (R1000)：
   - 顯示主畫面並等待使用者輸入
   - 檢查輸入資料 (R1B00)
   - 準備第二畫面 (R1C00)
3. 執行明細畫面處理 (R2000)：
   - 顯示明細畫面並等待使用者輸入
   - 檢查輸入資料 (R2B00)
   - 執行檔案處理 (R2D00)
4. 程式結束

### 資料處理流程 (R2D00)
1. 依作業選項執行不同處理：
   - 選項1：新增資料 (R2D10)
   - 選項2：修改資料 (R2D20)
   - 選項4：刪除資料 (R2D30)
2. 返回主畫面

## 6. 子程序處理邏輯說明

### 初始化處理 (R0100)
- 設定初始參數
- 取得系統日期
- 設定使用者權限
- 初始化螢幕欄位

### 代碼查詢 (R1A00)
- 檢查查詢權限
- 呼叫預算分配比率查詢程式 (GLI660)
- 將查詢結果帶回主畫面

### 資料檢核 (R1B00)
1. 檢查作業權限：必須有對應的操作權限
2. 檢查公司別：必須存在且有效
3. 檢查比率代碼：必須輸入
4. 檢查資料存在狀態：
   - 新增時資料不可已存在
   - 修改/刪除/查詢時資料必須存在
5. 檢查複製資料的有效性

### 明細畫面準備 (R1C00)
1. 根據作業選項設定畫面欄位可輸入/不可輸入狀態
2. 檢查會計期間是否為12期間或13期間
3. 初始化明細畫面欄位值
4. 若為修改/刪除/查詢，則讀取檔案資料並顯示

### 明細畫面欄位初始化 (R1C10)
- 清空說明欄位
- 設定各月份比率為零
- 清空合計值

### 讀取檔案資料 (R1C20)
- 從檔案讀取比率資料
- 將資料設定到螢幕欄位
- 計算比率合計值

### 明細資料檢核 (R2B00)
- 計算各月份比率合計
- 檢查合計值是否等於100%

### 檔案處理 - 新增 (R2D10)
- 將畫面欄位資料轉移到檔案欄位
- 記錄交易時間和使用者
- 寫入新記錄

### 檔案處理 - 修改 (R2D20)
- 將畫面欄位資料轉移到檔案欄位
- 記錄交易時間和使用者
- 更新現有記錄

### 檔案處理 - 刪除 (R2D30)
- 刪除指定的記錄

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 檔案 | 說明 |
|---------|------|------|
| UPT0010 | PTMF | 必填欄位不可為空白 |
| UPT0060 | PTMF | 複製來源資料不存在 |
| UPT2010 | PTMF | 資料不存在 |
| UPT2020 | PTMF | 資料已存在 |
| UPT2150 | PTMF | 使用者無權限操作 |
| UGL0004 | GLMF | 公司別無效或非啟用狀態 |
| UGL0035 | GLMF | 比率總和必須等於100% |

## 8. 備註

1. 本程式為會計總帳系統中的預算分配比率設定作業程式，用於定義預算金額在各會計期間的分配比率。
2. 比率代碼可用於 GLA640 (預算分配計算作業) 和 GLA650 (預算定額分配作業) 程式中，作為資料分配的依據。
3. 公司可以定義多組分配比率以適應不同類型的預算需求。
4. 比率總和必須等於100%，程式會在儲存前進行檢核。
5. 本程式提供複製功能，可以從已存在的比率代碼複製資料，並進行調整後儲存為新的比率代碼。
6. 根據會計系統設定的會計期間數量，第13期間可能會顯示或隱藏。
7. 程式提供查詢功能，可以呼叫 GLI660 查詢程式來選擇現有的比率代碼。
8. 此程式通常與 GLA640 (預算分配計算作業) 及 GLA650 (預算定額分配作業) 配合使用，協助會計人員進行預算分配作業。 
# GLA1402 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1402
- **程式說明**：結案作業列印
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1402
- **開發人員**：A1152 ANGY
- **建立日期**：81/11/05
- **系統**：會計總帳

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHLF01**：會計分錄歷史檔（更新檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **GLA1402P**：報表輸出檔（印表機檔）

### 檔案間關聯
- 使用公司代碼（WAH01）連結各檔案
- 使用分錄編號（AH02/WAH02）作為GLAHLF01的次要鍵值
- 讀取PT#BPF取得公司名稱等資訊

## 3. 檔案欄位規格說明

### GLAHLF01 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | - | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | - | 文字 | 主鍵 |
| AH10 | 交易日期 | - | - | 數值 | 會計交易日期 |
| AH17 | 處理狀態 | - | - | 文字 | 處理狀態代碼 |
| AH19 | 結案狀態 | - | - | 文字 | V=已結案 |
| AH26 | 員工代碼 | - | - | 文字 | 處理人員代碼 |
| AH97 | 最後處理時間 | - | - | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | - | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | - | 文字 | 使用者代碼 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 參數類別 | - | - | 文字 | 主鍵 |
| #B03 | 參數說明 | - | - | 文字 | 公司名稱/說明 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| WAH01 | 公司代碼 | 575 | 2 | 文字 | 處理的公司代碼 |
| WAH02F | 分錄編號起 | 533 | 9 | 文字 | 搜尋範圍起始分錄編號 |
| WAH02T | 分錄編號迄 | 542 | 9 | 文字 | 搜尋範圍結束分錄編號 |
| WAH26F | 員工代碼起 | 551 | 10 | 文字 | 搜尋範圍起始員工代碼 |
| WAH26T | 員工代碼迄 | 561 | 10 | 文字 | 搜尋範圍結束員工代碼 |
| WAH17F | 狀態代碼起 | 571 | 2 | 文字 | 搜尋範圍起始狀態代碼 |
| WAH17T | 狀態代碼迄 | 573 | 2 | 文字 | 搜尋範圍結束狀態代碼 |
| DAH25F | 結案日期起 | 601 | 7 | 數值 | 搜尋範圍起始結案日期 |
| DAH25T | 結案日期迄 | 609 | 7 | 數值 | 搜尋範圍結束結案日期 |
| DAH10F | 交易日期起 | 617 | 7 | 數值 | 搜尋範圍起始交易日期 |
| DAH10T | 交易日期迄 | 625 | 7 | 數值 | 搜尋範圍結束交易日期 |

## 4. 輸出/入螢幕布局與說明
此程式為批次報表程式，沒有螢幕輸入輸出，只產生報表輸出。

### 報表布局
報表由以下幾部分組成：

#### 標題部分
| 欄位名稱 | 說明 |
|---------|------|
| P#B03 | 公司名稱 |
| PDATE | 系統日期 |
| 各種查詢條件 | 報表抬頭顯示查詢條件（日期區間、分錄編號範圍等） |

#### 明細部分
明細資料以表格式顯示，每行最多可顯示4筆分錄記錄，包含：
| 欄位名稱 | 說明 |
|---------|------|
| NOx | 序號 |
| AH02x | 分錄編號 |

#### 結尾部分
顯示總計資訊與處理狀態。

## 5. 處理流程程序說明

### 主要處理流程
1. 執行初始化子程序 R0100
2. 執行主處理子程序 R0200
3. 程式結束

### 初始化處理 (R0100)
1. 設定指示器 39 (第一頁)
2. 讀取參數區域
3. 呼叫 P31 設定日期顯示格式
4. 讀取公司資訊
5. 將查詢條件參數傳入報表欄位

### 主處理流程 (R0200)
1. 初始化計數器（COUNT, NO)
2. 讀取第一筆會計分錄記錄
3. 若無資料，呼叫 R8999 處理空白報表
4. 否則，對每筆記錄：
   - 呼叫 R2000 處理明細記錄
   - 讀取下一筆記錄
5. 輸出報表結尾（總計）

## 6. 子程序處理邏輯說明

### 明細處理 (R2000)
1. 判斷是否為第一頁，若是則輸出標題
2. 檢查是否為新的分錄編號（AH02 != WAH02)
3. 若是新分錄編號，則：
   - 計數器加1
   - 序號加1
   - 根據計數器位置（1-4）決定輸出位置
   - 將分錄編號輸出到對應位置
   - 當計數滿4筆時重置計數器
4. 更新WAH02為當前分錄編號
5. 執行結案作業處理：
   - 設定結案狀態 AH19 為 'V'
   - 更新最後處理時間、日期和處理人員
   - 更新記錄

### 無資料處理 (R8999)
1. 執行初始化處理
2. 輸出報表標題
3. 輸出"無符合條件資料"訊息

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理機制
- 無資料時會輸出特定的報表頁面，顯示無資料訊息
- 使用指示器 42 判斷是否讀取到記錄結尾

### 處理狀態
- 程式不顯示特定的錯誤信息，僅在無資料時輸出指定格式的無資料報表

## 8. 備註
- 此程式為配合 GLA1401（結案作業）使用的報表輸出程式
- 報表格式為一行最多顯示4筆分錄編號，節省紙張空間
- 處理過程同時會更新GLAHLF01的結案狀態為'V'
- 程式支持多種過濾條件：分錄編號範圍、員工代碼範圍、狀態代碼範圍、結案日期範圍、交易日期範圍
- 此報表可作為結案作業的處理證明文件 
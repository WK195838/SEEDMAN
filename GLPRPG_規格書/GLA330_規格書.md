# GLA330 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA330
- **程式說明**：常用統計設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA330
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.05
- **修改日期**：
- **系統**：總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAQPF**：常用統計明細檔案
- **GLAPPF**：常用統計主檔
- **GLAQLF01**：常用統計資料邏輯檔案
- **GLAAPF**：會計科目名稱檔案
- **GLADPF**：部門檔案
- **GLAFPF**：會計科目檔案
- **GLAKPF**：總帳基本檔案
- **PT#APF**：參數檔案
- **PT#BPF**：參數檔案
- **PT#YPF**：參數檔案
- **GLA330D**：螢幕顯示檔案 (含子檔)

### 程式關係
- **主程式**：GLA330
- **呼叫程式**：
  - GLI330：常用統計瀏覽查詢程式
  - GLI410：科目瀏覽查詢程式
  - GLI440：部門瀏覽查詢程式
  - GLS001：字串連接處理程式
  - S#S01：權限檢查程式
  - P30：日期檢查程式
  - P31：日期格式處理程式
  - P55：數值格式處理程式
  - P56：分隔符處理程式
  - PTI140：代碼提示程式
  - PTI121：統計類別提示程式
- **功能鍵**：F3(離開), F4(提示), F5(儲存), F6(確認), F12(返回), F18(瀏覽)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：日期
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：日期
  - $C8YMD (209-216)：日期

- **檢查程式參數**
  - CHKPGM：檢查程式參數區
  - WAP01 (1-2)：公司別
  - WPARM1 (3-22)：參數1
  - WPARM2 (23-32)：參數2
  - WCHK (33-33)：檢查標記

- **常用統計輸入欄位定義**
  - W02 (7*2)：統計輸入代碼
  - W03 (7*20)：統計輸入名稱
  - W04 (7*10)：檢核程式名稱
  - W05 (4*20)：統計輸入內容
  - W06 (7*20)：統計輸入內容說明
  - W08 (7*10)：傳入參數名稱
  - @A01 (5*1)：功能權限

- **鍵值列表**
  - KEYAP：常用統計主檔主鍵 (公司別+科目代碼+統計類別+統計代碼+類型)
  - KEYAF：會計科目檔主鍵
  - KEYAA：會計科目名稱檔主鍵
  - KEYAD：部門檔主鍵
  - KEY#Y：統計類別主鍵
  - KEYAQ1：常用統計邏輯檔案主鍵 (公司別+科目代碼+統計代碼)
  - KEYAQ：常用統計明細檔案主鍵 (公司別+科目代碼+統計類別+統計代碼+類型)

## 4. 輸出/入螢幕布局與說明

### 主畫面 (SC01)
- **螢幕標題**：常用統計設定作業
- **輸入欄位**：
  - 公司別 (DAP01)：必填
  - 科目代碼 (DAP02)：必填
  - 科目名稱 (DAF031)：顯示欄位
  - 統計代碼 (DAP04)：必填
  - 類型 (DAP05)：1=標題、2=明細
  - 統計類別 (DAP03)：類型=2時必填
  - 類別名稱 (D#Y03)：顯示欄位
  - 統計日期 (DAP06)：必填
  - 備註 (DAP07)：可選

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F18：瀏覽查詢
  - ENTER：確認並進入下一畫面

### 明細設定畫面 (SC02)
- **螢幕標題**：常用統計設定作業
- **顯示欄位**：
  - 公司別、科目代碼、科目名稱、統計代碼、類型
  - 項目編號 (DAQ03)：自動產生
  - 科目代碼 (DAQ04)：必填
  - 科目名稱 (DAF032)：顯示欄位
  - 配比權重 (DAQ12)：數值

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F6：確認
  - F12：返回主畫面
  - F18：瀏覽子檔

### 明細輸入畫面 (SC03)
- **螢幕標題**：常用統計設定作業
- **輸入欄位**：
  - 科目代碼 (DAQ04)：必填
  - 輸入項目1-4 (DAQ05-DAQ08)：統計輸入內容
  - 輸入項目5 (DAQ09)：分隔線設定
  - 配比權重 (DAQ12)：數值
  - 輸入項目6 (DAQ14)：數值格式設定
  - 輸入項目7 (DAQ15)：條件設定
  - 簡短描述 (DAQ16)：可選
  - 部門代碼 (DAQ22)：可選

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F5：儲存
  - F12：返回

### 子檔畫面 (SC04)
- **螢幕標題**：常用統計設定作業
- **子檔欄位**：
  - 選項 (DOPT)：1=新增, 2=修改, 4=刪除
  - 項次 (DNO)：項目序號
  - 科目代碼 (DAQ04)：科目代碼
  - 科目名稱 (DAF03)：科目名稱
  - 簡短描述 (DAQ16)：簡短描述
  - 配比權重 (DAQ12)：配比權重

- **功能鍵**：
  - F3：結束程式
  - F12：返回

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 依據畫面代碼(SCID)執行不同處理流程：
   - SC01：顯示主畫面，接收基本設定參數
   - SC02：顯示明細設定畫面
   - SC04：顯示子檔瀏覽畫面

### 程式初始化流程 (R0100)
1. 設定畫面ID為SC01
2. 讀取參數資料區
3. 呼叫P31設定日期格式
4. 設定各項權限標記
5. 初始化各項輸入欄位為空白值
6. 設定統計類別預設值

### SC01畫面流程 (R1000)
1. 顯示主畫面並等待使用者輸入
2. 若按F3：結束程式
3. 若按F4：提供對應欄位提示 (R1E00)
4. 若按F18：呼叫常用統計瀏覽程式 (R1A00)
5. 若按ENTER：檢核輸入資料 (R1B00)
6. 若檢核通過：初始化明細畫面 (R1C00)並切換至SC02畫面
7. 若資料新增或修改權限不足，顯示錯誤訊息

### SC02畫面流程 (R2000)
1. 初始化明細畫面顯示 (R2A00)
2. 顯示明細畫面並等待使用者輸入
3. 若按F3或F12：返回主畫面
4. 若按F4：提供科目代碼提示 (R2E00)
5. 若按F6：進行資料檢核和儲存處理 (R2D00)
6. 若按F18：切換至子檔瀏覽畫面 (SC04)
7. 若修改科目代碼：重新初始化輸入欄位 (R2C00)
8. 若輸入資料正確：進入明細輸入畫面 (R3000)

### SC03/SC04畫面流程 (R3000/R4000)
1. 初始化輸入項目顯示 (R3A00)
2. 顯示明細輸入畫面並等待使用者輸入
3. 若按F3或F12：返回SC02畫面
4. 若按F4：提供對應欄位的提示功能 (R3E00)
5. 若輸入完成並通過檢核 (R3B00)：儲存資料至子檔 (R3D00)
6. 返回SC02畫面

## 6. 子程序處理邏輯說明

### 權限檢查及瀏覽查詢 (R1A00)
1. 呼叫S#S01檢查用戶是否有使用GLI330的權限
2. 若權限不足，顯示錯誤訊息
3. 若權限正確，呼叫GLI330程式進行常用統計瀏覽查詢
4. 將查詢結果回傳至主畫面

### 主畫面資料檢核 (R1B00)
1. 檢查用戶是否有對應功能權限 (新增/修改/刪除/查詢)
2. 檢查公司別是否為空白及是否存在基本檔案中
3. 檢查公司別是否為啟用狀態 (#B12='1')
4. 檢查科目代碼是否為空白及是否存在
5. 檢查科目是否為啟用狀態 (AF08='1')
6. 檢查統計代碼是否為空白及是否存在
7. 檢查科目和統計代碼組合是否存在 (KEYAQ1)
8. 檢查類型與統計類別的關係 (類型=1時不需要類別，類型=2時需要類別)
9. 檢查統計類別是否存在
10. 檢查常用統計主檔是否已存在此組合
11. 檢查統計日期是否正確 (不可為零且需符合日期格式)

### 明細畫面初始化 (R1C00)
1. 初始化項目編號、記錄筆數計數器
2. 初始化權重合計變數 (DTOT)
3. 清除子檔資料
4. 設定預設選項為新增(1)

### 明細畫面資料檢核 (R2B00)
1. 檢查科目代碼是否為空白及是否存在
2. 檢查科目是否為啟用狀態
3. 檢查配比權重是否正確 (DAQ12>0)
4. 若有任何檢核失敗，顯示對應錯誤訊息

### 資料儲存處理 (R2D00/R2D10/R2D20)
1. 檢查明細筆數是否有資料 (WNO>0)
2. 檢查配比權重總和是否不超過100%
3. 刪除原有明細記錄並重新寫入
4. 逐一將子檔資料寫入資料庫 (R2D30)
5. 更新主檔資料 (R2D40)
6. 設定儲存成功指示燈並返回主畫面

### 明細輸入處理 (R3A00/R3A10)
1. 初始化各輸入項目顯示設定
2. 載入各輸入項目的代碼、名稱和檢核程式
3. 對每個輸入項目呼叫對應的檢核程式
4. 產生各輸入項目的說明文字
5. 若為修改選項，讀取已有資料

### 明細輸入資料檢核 (R3B00)
1. 檢查每個輸入項目的有效性
2. 特別檢查輸入項目1 (DAQ05) 是否與主檔設定相符
3. 檢查分隔線與數值格式設定
4. 檢查條件設定語法正確性
5. 檢查部門代碼是否存在
6. 產生簡短描述字串

### 明細資料儲存至子檔 (R3D00)
1. 根據操作類型執行不同的處理：
   - 新增項目 (R3D10)
   - 修改項目 (R3D20)
   - 刪除項目 (R3D30)
2. 保存當前輸入資料至子檔 (R3DA0)
3. 更新配比權重合計變數

### 子檔瀏覽處理 (R4000/R4A10/R4A20)
1. 初始化子檔顯示設定
2. 顯示所有明細項目
3. 允許用戶選擇項目進行修改或刪除
4. 若選擇修改項目，進入明細修改畫面 (R4C00)

### 提示功能 (R1E00/R2E00/R3E00)
1. 根據游標位置判斷提示類型
2. 對科目代碼提供GLI410提示功能
3. 對統計代碼提供PTI140提示功能
4. 對統計類別提供PTI121提示功能
5. 對部門代碼提供GLI440提示功能
6. 對其他輸入項目提供對應的檢核程式提示

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT2072**：資料新增成功
- **UPT2150**：使用者無權限執行此功能
- **UPT0010**：必填欄位未輸入
- **UPT0011**：資料不應填入
- **UPT0012**：必填欄位為零
- **UPT0040**：無效日期
- **UPT2010**：資料不存在
- **UPT2020**：資料已存在
- **UPT0030**：輸入資料錯誤
- **UGL0004**：公司別未啟用
- **UGL0009**：科目未啟用
- **UGL0014**：至少需設定一筆明細
- **UGL0015**：配比權重總和不可超過100%
- **UGL0027**：科目與統計代碼組合無效
- **UGL0028**：不符合科目設定

### 錯誤處理
- 設定對應的錯誤指示燈
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於設定總帳系統中的常用統計報表，主要功能包括：

1. 統計基本資料設定：公司別、科目代碼、統計類別和統計代碼
2. 統計類型設定：支援標題(1)和明細(2)兩種類型
3. 統計明細項目設定：明細科目和配比權重
4. 統計格式設定：分隔線、數值格式和條件設定

程式採用分層設計，先設定基本資料，再進入明細設定畫面。子檔功能提供全部明細的瀏覽和編輯功能，便於用戶進行整體管理和維護。

此程式對資料的有效性進行嚴格檢核，包括科目代碼有效性、統計代碼有效性、科目與統計代碼組合有效性、配比權重合理性等，確保統計報表的正確性和資料完整性。

特殊功能包括：
1. 支援兩種類型的統計設定（標題和明細）
2. 對配比權重進行檢核，確保總和不超過100%
3. 日期有效性檢查，確保統計日期符合有效格式
4. 完整的提示功能，提高使用者操作便利性 
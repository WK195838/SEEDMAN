# GLA340 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA340
- **程式說明**：常用統計設定作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA340
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.11.05
- **修改日期**：
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAQPF**：常用統計明細檔案
- **GLAPPF**：常用統計主檔
- **GLAAPF**：會計科目名稱檔案
- **GLADPF**：部門檔案
- **GLAFPF**：會計科目檔案
- **GLAKPF**：總帳基本檔案
- **PT#APF**：參數檔案
- **PT#BPF**：參數檔案
- **PT#YPF**：參數檔案
- **GLA340D**：螢幕顯示檔案 (含子檔)

### 程式關係
- **主程式**：GLA340
- **呼叫程式**：
  - GLI330：常用統計瀏覽查詢程式
  - GLI410：科目瀏覽查詢程式
  - GLI440：部門瀏覽查詢程式
  - GLS001：字串連接處理程式
  - S#S01：權限檢查程式
  - P30：日期檢查程式
  - P31：日期格式處理程式
  - P50：錯誤訊息處理程式
  - P55：數值格式處理程式
  - P56：分隔符處理程式
- **功能鍵**：F3(離開), F4(提示), F5(儲存), F6(確認), F12(返回), F13(刪除設定), F18(瀏覽)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：日期
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **檢查程式參數**
  - CHKPGM：檢查程式參數區
  - WAP01 (1-2)：公司別
  - WPARM1 (3-22)：參數1
  - WPARM2 (23-32)：參數2
  - WCHK (33-33)：檢查標記

- **常用統計輸入欄位定義**
  - W02 (7*2)：輸入項代碼
  - W03 (7*20)：輸入項名稱
  - W04 (7*10)：檢核程式名稱
  - W05 (4*20)：輸入項內容
  - W06 (7*20)：輸入項內容說明
  - W08 (7*10)：傳入參數名稱
  - @A01 (5*1)：功能權限

- **鍵值列表**
  - KEYAP：常用統計主檔主鍵 (公司別+科目代碼+統計類別+統計代碼+類型)
  - KEYAQ：常用統計明細檔案主鍵 (公司別+科目代碼+統計類別+統計代碼+類型)
  - KEYAQ1：常用統計邏輯檔案主鍵 (公司別+輸入科目+統計類別+統計項目+類型)
  - KEYAF：會計科目檔主鍵
  - KEYAA：會計科目名稱檔主鍵
  - KEYAD：部門檔主鍵
  - KEY#Y：統計類別主鍵

## 4. 輸出/入螢幕布局與說明

### 主畫面 (SC01)
- **螢幕標題**：常用統計設定作業
- **輸入欄位**：
  - 公司別 (DAP01)：必填
  - 科目代碼 (DAP02)：必填
  - 科目名稱 (DAF031)：顯示欄位
  - 統計代碼 (DAP04)：必填
  - 類型 (DAP05)：1=標題、2=明細
  - 統計類別 (DAP03)：類型=2時必填
  - 類別名稱 (D#Y03)：顯示欄位
  - 統計日期 (DAP06)：必填
  - 備註 (DAP07)：可選

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F18：瀏覽查詢
  - ENTER：確認並進入下一畫面

### 明細設定畫面 (SC02)
- **螢幕標題**：常用統計設定作業
- **顯示欄位**：
  - 公司別、科目代碼、科目名稱、統計代碼、類型
  - 項目編號 (DAQ03)：自動產生
  - 科目代碼 (DAQ04)：必填
  - 科目名稱 (DAF032)：顯示欄位
  - 配比權重 (DAQ12)：數值

- **功能鍵**：
  - F3：結束程式
  - F6：確認
  - F12：返回主畫面
  - F13：刪除設定

### 明細編輯畫面 (SC03/SC04)
- **螢幕標題**：常用統計設定作業
- **輸入欄位**：
  - 科目代碼 (DAQ04)：必填
  - 輸入項目1-4 (DAQ05-DAQ08)：統計輸入內容
  - 輸入項目5 (DAQ09)：分隔線設定
  - 配比權重 (DAQ12)：數值，必填
  - 輸入項目6 (DAQ14)：數值格式設定
  - 輸入項目7 (DAQ15)：條件設定
  - 簡短描述 (DAQ16)：可選
  - 部門代碼 (DAQ22)：可選

- **功能鍵**：
  - F3：結束程式
  - F4：提示
  - F5：儲存
  - F12：返回

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 依據畫面代碼(SCID)執行不同處理流程：
   - SC01：顯示主畫面，接收基本設定參數
   - SC02：顯示明細設定畫面並管理常用統計項目
3. 根據功能鍵處理不同功能：
   - F3：結束程式
   - F6：儲存資料
   - F13：刪除設定
   - F18：瀏覽查詢

### 程式初始化流程 (R0100)
1. 設定畫面ID為SC01
2. 讀取參數資料區
3. 呼叫P31設定日期格式
4. 設定各項權限標記
5. 初始化各項輸入欄位為空白值
6. 設定統計類別預設值

### SC01畫面流程 (R1000)
1. 若資料儲存成功(*IN79='1')，顯示成功訊息
2. 顯示主畫面並等待使用者輸入
3. 若按F3：結束程式
4. 若按F18：呼叫常用統計瀏覽程式 (R1A00)
5. 若按ENTER：檢核輸入資料 (R1B00)
6. 若檢核通過：初始化明細畫面 (R1C00)並切換至SC02畫面
7. 若檢核失敗，顯示錯誤訊息

### SC02畫面流程 (R2000)
1. 初始化明細子檔顯示 (R2A10)
2. 顯示明細畫面並等待使用者輸入 (R2A20)
3. 檢查統計日期有效性 (R2B20)
4. 根據按鍵處理不同功能：
   - F3或F12：返回主畫面
   - F6：進行資料檢核和儲存處理 (R2D00)
   - F13：刪除常用統計設定 (R2C00)
5. 讀取選項並處理使用者選擇：
   - 選項1或2：進入明細編輯畫面 (R3000)
   - 選項4：刪除項目 (R4000)

### 明細編輯流程 (R3000/R4000)
1. 如果是新增項目 (選項1)，設定新的序號和初始值
2. 初始化輸入項目顯示 (R4A00)和取得項目說明 (R4A10)
3. 顯示明細輸入畫面並等待使用者輸入
4. 若按F4：根據游標位置提供對應欄位的提示功能 (R4E00)
5. 檢核輸入資料 (R4B00)：
   - 檢查科目代碼是否有效
   - 檢查配比權重是否正確
   - 檢查各輸入項目的有效性
6. 若檢核通過：儲存資料至子檔 (R4D00)
   - 新增項目 (R4D10)
   - 修改項目 (R4D20)
   - 刪除項目 (R4D30)
7. 返回SC02畫面

## 6. 子程序處理邏輯說明

### 權限檢查及瀏覽查詢 (R1A00)
1. 呼叫S#S01檢查用戶是否有使用GLI310的權限
2. 若權限不足，顯示錯誤訊息
3. 若權限正確，呼叫GLI330程式進行常用統計瀏覽查詢
4. 將查詢結果回傳至主畫面

### 主畫面資料檢核 (R1B00)
1. 檢查用戶是否有對應功能權限 (新增/修改/刪除/查詢)
2. 檢查公司別是否為空白及是否存在基本檔案中
3. 檢查公司別是否為啟用狀態 (#B12='1')
4. 檢查科目代碼是否為空白及是否存在
5. 檢查統計代碼是否為空白及是否存在
6. 檢查類型與統計類別的關係 (類型=1時不需要類別，類型=2時需要類別)
7. 檢查統計類別是否存在
8. 檢查常用統計主檔是否已存在此組合
9. 呼叫P31處理日期格式

### 明細畫面初始化 (R1C00)
1. 初始化項目編號計數器 (WNO)、記錄筆數計數器 (RRND)
2. 初始化權重合計變數 (DTOT)
3. 設定子檔初始化指示燈
4. 讀取已存在的常用統計明細資料
5. 呼叫R1C10將資料庫資料複製至子檔
6. 計算權重合計

### 明細畫面呈現 (R2A10/R2A20/R2A30)
1. 初始化子檔控制變數 (RRN)
2. 設置子檔清除和顯示指示燈
3. 讀取子檔資料並呈現在螢幕上
4. 呈現每個項目的科目代碼、科目名稱、配比權重等資訊

### 常用統計設定刪除 (R2C00)
1. 刪除所有常用統計明細檔案資料
2. 刪除常用統計主檔資料
3. 返回主畫面並設定成功指示燈

### 資料儲存處理 (R2D00/R2D10/R2D20)
1. 檢查明細筆數是否有資料 (WNO>0)
2. 檢查配比權重總和是否不超過100% (DTOT<=100)
3. 刪除原有明細記錄
4. 逐一將子檔資料寫入資料庫 (R2D30)
5. 更新主檔資料 (R2D40)
6. 設定儲存成功指示燈並返回主畫面

### 明細輸入檢核 (R3B00)
1. 檢查科目代碼是否為空白及是否存在
2. 檢查科目是否為啟用狀態 (AF08='1')
3. 檢查配比權重是否大於零

### 明細輸入初始化 (R3C00)
1. 清空各輸入項目欄位
2. 設定各欄位的預設值

### 明細輸入項目處理 (R4A00/R4A10)
1. 載入輸入項目的代碼、名稱和檢核程式
2. 對有檢核程式的項目，呼叫檢核程式取得說明
3. 對特殊項目處理：
   - 呼叫P56處理分隔線項目
   - 呼叫P55處理數值格式項目
   - 處理條件設定項目
   - 若有部門代碼，取得部門名稱

### 明細輸入項目檢核 (R4B00)
1. 對每個輸入項目進行檢核：
   - 若有檢核程式，則呼叫檢核程式
   - 檢查輸入項目1是否符合主檔設定
2. 檢查分隔線、數值格式和條件設定的有效性
3. 檢查部門代碼是否存在
4. 組合簡短描述字串

### 明細資料儲存 (R4D00/R4D10/R4D20/R4D30)
1. 根據操作類型執行不同處理：
   - 新增項目 (R4D10)：新增記錄，增加權重合計
   - 修改項目 (R4D20)：更新記錄，調整權重合計
   - 刪除項目 (R4D30)：標記記錄為刪除，減少權重合計
2. 更新子檔資料 (R4DA0)

### 提示功能 (R4E00)
1. 根據游標位置提供不同輸入項目的提示功能
2. 針對各輸入項目呼叫對應的檢核程式提供提示
3. 對部門代碼提供GLI440提示功能

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT2075**：資料儲存成功
- **UPT2150**：使用者無權限執行此功能
- **UPT0010**：必填欄位未輸入
- **UPT0011**：資料不應填入
- **UPT0012**：必填欄位為零
- **UPT0030**：輸入資料錯誤
- **UPT0040**：無效日期
- **UPT2010**：資料不存在
- **UGL0004**：公司別未啟用
- **UGL0009**：科目未啟用
- **UGL0014**：至少需設定一筆明細
- **UGL0015**：配比權重總和不可超過100%
- **UGL0028**：不符合科目設定

### 錯誤處理
- 設定對應的錯誤指示燈
- 呼叫P50錯誤訊息處理程式
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於設定總帳系統中的常用統計報表項目，主要功能包括：

1. 常用統計基本資料設定：公司別、科目代碼、統計類別和統計代碼
2. 統計類型設定：支援標題(1)和明細(2)兩種類型
3. 統計明細項目設定：明細科目和配比權重
4. 統計格式設定：分隔線、數值格式和條件設定

程式採用分層設計，先設定基本資料，再進入明細設定畫面。提供明細項目的新增、修改和刪除功能，便於用戶管理常用統計項目。

特殊功能說明：
1. 配比權重控制：確保所有明細項目的權重總和不超過100%
2. 靈活的輸入項目設定：支援多種輸入項目格式和檢核機制
3. 提供完整的提示功能：科目代碼、部門代碼和各輸入項目提示
4. 日期有效性檢查：確保統計日期符合有效格式

本程式與GLA330類似，但針對常用統計設定提供更多輸入項目的彈性和控制能力，增強了報表呈現的多樣性和精確性。 
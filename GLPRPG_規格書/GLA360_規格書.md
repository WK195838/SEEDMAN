# GLA360 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA360
- **程式說明**：會計期間設定
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA360
- **開發人員**：A1034 STEPHANIE
- **建立日期**：1992.11.18
- **修改日期**：
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLACPF**：會計期間資料檔
- **PT#BPF**：參數檔案
- **GLAKPF**：總帳基本檔案
- **GLA360D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA360
- **呼叫程式**：
  - P30：日期檢核程式
  - P31：日期格式處理程式
  - P37：日期差異計算程式
- **功能鍵**：F3(離開), F5(儲存), F12(返回)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：公司會計年度
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **陣列定義**
  - @A01(5)：功能權限陣列
  - @A2S(13)：會計期間起始日期陣列
  - @A2E(13)：會計期間結束日期陣列
  - @A3E(13)：會計期間轉換日期陣列

### 主要欄位說明
- **KEYAC**：會計期間檔案鍵值 (AC01+AC02)
- **KEYACC**：複製來源鍵值 (AC01C+AC02C)

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (DSPD1)
- **螢幕標題**：會計期間設定
- **畫面描述**：輸入基本設定資訊
- **輸入欄位**：
  - 功能選擇 (DOPT)：1=新增, 2=修改, 4=刪除, 5=查詢
  - 公司代號 (DAC01)：2碼
  - 年度 (DAC02)：4碼
  - 來源公司代號 (DAC01C)：2碼，複製來源用
  - 來源年度 (DAC02C)：4碼，複製來源用

- **功能鍵**：
  - F3：離開

### 第二畫面 (DSPD2)
- **螢幕標題**：會計期間設定
- **畫面描述**：設定各會計期間的起訖日期
- **輸入欄位**：
  - 會計年度起始日期 (D01S-D13S)：各期間起始日期
  - 會計年度終止日期 (D01E-D13E)：各期間結束日期
  - 開帳設定 (DAC15)：Y=開帳，僅限於修改時顯示

- **功能鍵**：
  - F3：離開
  - F5：儲存
  - F12：返回前一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入畫面選擇迴圈，根據目前畫面ID (SCID) 選擇不同處理：
   - SC01：第一畫面處理 (R1000)
   - SC02：第二畫面處理 (R2000)
3. 程式結束

### 第一畫面處理流程 (R1000)
1. 顯示第一畫面等待使用者輸入
2. 若按F3則結束程式
3. 檢核使用者輸入資料 (R1B00)
4. 若檢核無誤則初始化第二畫面 (R1C00)，轉至第二畫面

### 第二畫面處理流程 (R2000)
1. 顯示第二畫面等待使用者輸入
2. 若按F3則結束程式
3. 若按F12則返回第一畫面
4. 若為新增或修改模式，檢核使用者輸入資料 (R2B00)
5. 若按F5且檢核無誤則進行檔案處理 (R2D00)
6. 處理完成後返回第一畫面

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 設定目前畫面ID為SC01
2. 設定權限標記
3. 讀取參數資料區
4. 呼叫P31設定日期格式
5. 初始化各項輸入欄位
6. 設定操作選項預設為1(新增)

### 第一畫面檢核 (R1B00)
1. 檢查使用者權限
2. 檢查公司代號是否已輸入
3. 根據功能選項檢查公司及年度資料是否存在：
   - 新增模式：檢查資料是否已存在
   - 修改/刪除/查詢模式：檢查資料是否存在
4. 如有複製來源，檢查來源資料是否存在

### 第二畫面初始化 (R1C00)
1. 根據功能選項設定畫面欄位可否輸入
2. 根據功能選項及是否有複製來源執行不同初始化：
   - 新增無複製：初始化空白資料 (R1C10)
   - 新增有複製：複製來源資料並調整年度 (R1C30, R1C20)
   - 修改/查詢/刪除：讀取檔案資料 (R1C20)

### 日期轉換處理 (R1C20)
1. 將檔案資料轉換為畫面顯示格式
2. Ａ重要功能為計算各期間的起迄日期
3. 對於新增且複製模式，會根據年度差異調整日期

### 年度調整處理 (R1C30)
1. 計算目標年度與來源年度的差異
2. 將差異值加到各期間日期上，實現自動調整

### 第二畫面檢核 (R2B00)
1. 檢核各期間起始日期格式是否正確
2. 檢核各期間結束日期格式是否正確
3. 檢核各期間起始日期不可大於結束日期
4. 期間之間自動銜接（當期結束日的下一天為次期起始日）

### 檔案處理 (R2D00)
1. 根據功能選項執行不同檔案處理：
   - 新增 (R2D10)：轉換資料並寫入檔案
   - 修改 (R2D20)：轉換資料並更新檔案
   - 刪除 (R2D30)：刪除檔案記錄

### 資料轉換 (R2D11)
1. 將畫面資料轉換為檔案格式
2. 設定更新時間及使用者資訊

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0040**：日期格式錯誤
- **UPT0041**：起始日期不可大於結束日期
- **UPT0060**：複製來源資料不存在
- **UPT2010**：資料不存在
- **UPT2020**：資料已存在
- **UPT2150**：使用者無權限執行此功能

### 錯誤處理
- 設定對應的錯誤指示燈 (IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位
- 對於日期相關錯誤，使用P30程式進行日期檢核

## 8. 備註

本程式用於設定會計總帳系統的會計期間資料，具有以下特點：

1. 提供完整的會計期間設定功能，支援最多13個會計期間設定（12個月加一個調整期間）
2. 具備年度資料複製功能，能從前一年度自動產生新年度的會計期間資料
3. 系統會自動計算並調整年度差異，便於設定連續的會計年度
4. 提供開帳設定功能，控制會計年度是否已開始記帳
5. 採用完整的日期檢核機制，確保會計期間日期資料的正確性
6. 會計期間的連續性檢核，確保期間之間無缺口

透過設定會計期間資料，系統可以正確識別各會計期間的範圍，為會計傳票及報表提供時間框架依據。此程式為會計總帳系統的基礎設定程式之一，在系統使用前必須先完成設定。 
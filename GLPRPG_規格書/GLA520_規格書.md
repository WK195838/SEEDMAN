# GLA520 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA520
- **程式說明**：年結作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA520
- **開發人員**：A1150
- **建立日期**：1992.12.07 (81/12/07)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAILF04**：日記帳檔
- **GLAILF01**：年度餘額檔
- **GLAKPF**：參數檔
- **GLACPF**：會計資料檔
- **GLAFPF**：會計項目檔
- **GLA520D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA520
- **呼叫程式**：
  - P31：日期格式處理程式
- **功能鍵**：F3(離開), F14(執行年結作業)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期

- **AR1 (陣列)**
  - AC03-AC15 (1-13)：會計期間陣列，對應 3 至 15 月份

- **AR2 (陣列)**
  - AI11-AI23 (1-169)：會計項目金額陣列

### 主要欄位說明
- **KEYAK**：參數檔鍵值 (DAI01)
- **KEYAC**：會計資料檔鍵值 (DAI01+WYR1)
- **KEYAF**：會計項目檔鍵值 (DAI01+AI03)
- **KEYAI**：年度餘額檔鍵值 (複合鍵)
- **KEYU1**：權益保留鍵值 (DAI01+WYR2+AK05)
- **KEYU2**：累計損益鍵值 (DAI01+WYR2+AK04)
- **DAI01**：部門代號
- **DAI02**：會計年度
- **DAK13**：上期年度
- **WYR1**：本期年度
- **WYR2**：下期年度
- **WAI10**：年度結算金額暫存
- **WTEMP**：年度結算金額轉換暫存

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (DSPD1)
- **螢幕標題**：年結作業
- **畫面描述**：執行會計年度結算作業
- **輸入欄位**：
  - 部門代號 (DAI01)：選擇部門代號
  - 本期年度 (DAI02)：要結算的會計年度

- **顯示欄位**：
  - 上期年度 (DAK13)：上一個會計年度

- **功能鍵**：
  - F3：離開
  - F14：執行年結作業

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入主畫面處理迴圈 (R1000)
3. 根據使用者輸入執行年結處理
4. 程式結束

### 主畫面處理流程 (R1000)
1. 顯示主畫面等待使用者輸入
2. 若按F3則結束程式
3. 檢核使用者輸入資料 (R1B00)
4. 若按F14且檢核無誤則執行年結處理 (R2A00)

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 讀取參數資料區 (PTDA01)
2. 呼叫P31設定日期格式
3. 初始化各項輸入欄位
   - 部門代號 (DAI01)
   - 本期年度 (DAI02)
   - 上期年度 (DAK13)

### 主畫面檢核 (R1B00)
1. 檢查使用者權限
   - 需要新增或修改權限才能執行年結作業
2. 檢查部門代號是否已輸入並存在
3. 檢查本期年度是否有效
4. 檢查所有會計期間是否已經結帳
   - 檢查會計期間陣列 (AC03-AC15) 是否都為 'Y'
5. 檢查本期年度是否為上期年度+1 (若上期年度不為0)

### 年結處理 (R2A00)
1. 顯示處理中訊息
2. 計算下期年度 (WYR2 = WYR1 + 1)
3. 讀取日記帳檔資料
4. 針對資產負債表科目執行以下處理：
   - 計算年度結算金額 (R2A10)
     - 累計各會計期間的金額
     - 根據科目性質 (AF06) 決定處理方式：
       - 若為借方科目，則金額保持在借方
       - 若為貸方科目，則金額保持在貸方
5. 針對權益保留科目執行以下處理：
   - 處理餘額轉下年度 (R2A20)
     - 清空本期餘額
6. 針對累計損益科目執行以下處理：
   - 處理累計損益餘額 (R2A30)
     - 若科目不存在，則新增科目 (R2A40)
7. 更新參數檔的上期年度 (AK13)
8. 顯示處理完成訊息

### 年度結算金額計算 (R2A10)
1. 計算所有會計期間的總金額
2. 根據科目性質設定正負值
3. 檢查是否已有下期年度記錄
   - 若無，則新增下期年度記錄
   - 若有，則更新下期年度記錄
4. 設定更新時間、日期及使用者資訊

### 權益保留科目處理 (R2A20)
1. 清空本期餘額資料
2. 設定更新時間、日期及使用者資訊
3. 更新年度餘額檔

### 累計損益科目處理 (R2A30)
1. 將暫存的金額加入到累計損益科目
2. 設定更新時間、日期及使用者資訊
3. 更新年度餘額檔

### 新增累計損益科目 (R2A40)
1. 設定科目基本資料
2. 設定科目金額資料
3. 設定更新時間、日期及使用者資訊
4. 寫入年度餘額檔

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT2010**：資料不存在
- **UPT2130**：資料處理中
- **UPT2142**：作業處理完成
- **UPT2150**：無權限執行此功能
- **UGL0033**：本期年度必須等於上期年度+1
- **UGL0036**：會計期間尚未結帳，無法執行年結作業

### 錯誤處理
- 設定對應的錯誤指示燈 (IN60-IN62, IN98, IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於會計總帳系統中執行年度結算作業，具有以下特點：

1. 提供會計年度結算功能，將本期會計科目餘額結轉至下期
2. 依據會計科目性質執行不同的結轉處理：
   - 資產負債表科目：結餘轉下期初始值
   - 損益表科目：結餘歸零並轉入累計損益
3. 自動計算各會計科目的年度結算金額
4. 檢查所有會計期間是否已經結帳，確保資料完整性
5. 支援權限控制，僅允許有權限的使用者執行年結作業

此程式是會計年度結束時的關鍵作業，執行年結作業後將：
1. 保留資產負債表科目的餘額至下一年度
2. 歸零損益表科目，使其在新年度重新累計
3. 將本年度的損益結果併入累計損益科目
4. 更新系統參數，將本期年度設為上期年度，便於下一年度使用

年結作業通常在會計年度結束後執行，是財務會計週期中的重要環節，確保各年度會計資料的正確性和連貫性。 
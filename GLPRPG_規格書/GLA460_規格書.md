# GLA460 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA460
- **程式說明**：參數檔輸入作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA460
- **開發人員**：A1152 ANGY
- **建立日期**：1992.10.29 (81/10/29)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAKPF**：總帳參數檔
- **GLADPF**：部門代碼檔
- **GLAFPF**：會計項目檔
- **PT#BPF**：部門參數檔
- **GLA460D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA460
- **呼叫程式**：
  - P31：日期格式處理程式
- **功能鍵**：F3(離開), F5(儲存), F12(返回)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱

- **陣列定義**
  - @A01(5)：功能權限陣列

### 主要欄位說明
- **KEYAK**：參數檔鍵值 (DAK01)
- **KEYAF1/KEYAF2**：取得會計項目名稱的鍵值 (DAK01+DAK04/DAK05)
- **KEYAD1/KEYAD2**：取得部門名稱的鍵值 (DAK01+DAK07/DAK08)
- **DAK01**：部門別
- **DAK02**：主管限制旗標 (Y=允許, N=不允許)
- **DAK04**：規範限制天數
- **DAK05**：最大筆數限制
- **DAK07**：類別代碼來源
- **DAK08**：類別代碼用途
- **DAK09**：年制設置 (1=民國年, 2=西元年)
- **DAK10**：年度會計期數 (1=12期, 2=13期)
- **DAK11**：日期格式 (1=年月日, 2=月日年, 3=日月年)
- **DAK12**：已過帳期別
- **DAK13**：已結帳年度
- **DAK14**：已結帳期別

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (DSPD1)
- **螢幕標題**：參數檔輸入作業
- **畫面描述**：輸入基本設定資訊
- **輸入欄位**：
  - 部門代號 (DAK01)：部門代號
  - 功能選擇 (DOPT)：1=新增, 2=修改, 4=刪除, 5=查詢

- **功能鍵**：
  - F3：離開

### 第二畫面 (DSPD2)
- **螢幕標題**：參數檔輸入作業
- **畫面描述**：設定參數檔詳細資料
- **顯示欄位**：
  - 部門代號 (DAK01)：部門代號
  - 部門名稱 (D#B02)：從參數檔讀取的部門名稱
  
- **輸入欄位**：
  - 01.主管授權必要 (DAK02)：Y=允許, N=不允許
  - 02.規範限制天數 (DAK04)：輸入天數
  - 03.最大筆數限制 (DAK05)：輸入筆數
  - 04.類別代碼來源 (DAK07)：部門代碼
  - 05.類別代碼用途 (DAK08)：部門代碼
  - 06.年制設置 (DAK09)：1=民國年, 2=西元年
  - 07.年度會計期數 (DAK10)：1=12期, 2=13期
  - 08.日期格式 (DAK11)：1=年月日, 2=月日年, 3=日月年
  
- **僅顯示欄位**：
  - 09.已過帳期別 (DAK12)：YYYY/MM/DD格式
  - 10.已結帳期別 (DAK14)：YYYY-MM格式
  - 11.已結帳年度 (DAK13)：顯示年度
  
- **功能鍵**：
  - F3：離開
  - F5：儲存
  - F12：返回前一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入畫面選擇迴圈，根據目前畫面ID (SCID) 選擇不同處理：
   - SC01：第一畫面處理 (R1000)
   - SC02：第二畫面處理 (R2000)
3. 程式結束

### 第一畫面處理流程 (R1000)
1. 顯示第一畫面等待使用者輸入
2. 若按F3則結束程式
3. 檢核使用者輸入資料 (R1B00)
4. 若檢核無誤則初始化第二畫面 (R1C00)，轉至第二畫面

### 第二畫面處理流程 (R2000)
1. 顯示第二畫面等待使用者輸入
2. 若按F3則結束程式
3. 若按F12則返回第一畫面
4. 若為新增或修改模式，檢核使用者輸入資料 (R2B00)
5. 若按F5且檢核無誤則進行檔案處理 (R2D00)
6. 處理完成後返回第一畫面

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 設定目前畫面ID為SC01
2. 設定權限標記
3. 讀取參數資料區
4. 呼叫P31設定日期格式
5. 初始化各項輸入欄位
6. 設定操作選項預設為1(新增)

### 第一畫面檢核 (R1B00)
1. 檢查使用者權限
2. 檢查部門代號是否已輸入並有效
3. 查詢部門名稱
4. 根據功能選項檢查資料是否存在：
   - 新增模式：檢查資料是否已存在
   - 修改/刪除/查詢模式：檢查資料是否存在

### 第二畫面初始化 (R1C00)
1. 根據功能選項設定畫面控制指示器（31）
   - 新增或修改模式：啟用畫面輸入
   - 刪除或查詢模式：禁用畫面輸入
2. 根據功能選項執行不同初始化：
   - 新增：初始化空白資料 (R1C10)
   - 修改/刪除/查詢：讀取現有資料 (R1C20)

### 第二畫面檢核 (R2B00)
1. 檢查各參數必填欄位
2. 檢核會計項目檔與部門代碼檔相關欄位
   - 規範限制天數對應的會計項目
   - 最大筆數限制對應的會計項目
   - The 類別代碼來源對應的部門代碼
   - 類別代碼用途對應的部門代碼
3. 檢查日期格式設定與年制設定的合法性
4. 轉換日期格式便於顯示

### 檔案處理 (R2D00)
1. 根據功能選項執行不同檔案處理：
   - 新增 (R2D10)：寫入參數檔資料
   - 修改 (R2D20)：更新參數檔資料
   - 刪除 (R2D30)：刪除參數檔資料

### 資料轉換 (R2D11)
1. 將畫面資料轉換為檔案格式
2. 轉換主管限制旗標為檔案格式 (Y->空白, N->V)
3. 根據不同年制設定轉換日期格式代碼
4. 設定更新時間、日期及使用者資訊

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0030**：資料格式不正確
- **UPT2010**：資料不存在
- **UPT2020**：資料已存在
- **UPT2150**：使用者無權限執行此功能
- **UGL0004**：無效的部門代碼
- **UGL0021**：無效的規範限制天數會計項目
- **UGL0022**：無效的最大筆數限制會計項目
- **UGL0023**：無效的類別代碼來源
- **UGL0024**：無效的類別代碼用途

### 錯誤處理
- 設定對應的錯誤指示燈 (IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於設定會計總帳系統的參數資料，具有以下特點：

1. 提供完整的參數設定功能，支援新增、修改、刪除和查詢操作
2. 參數設定按部門別管理，每個部門可以有自己的參數設定
3. 提供以下重要參數的設定：
   - 主管限制：控制是否需要主管授權
   - 規範限制天數：設定事前申請的時間限制
   - 最大筆數限制：控制排序輸入的資料量
   - 年制設置：選擇使用民國年或西元年
   - 會計期數：設定年度會計期數（12期或13期）
   - 日期格式：設定系統使用的日期顯示格式
4. 顯示系統狀態相關資訊：
   - 已過帳期別：顯示目前系統的過帳狀態
   - 已結帳年度和期別：顯示目前系統的結帳狀態
5. 維護參數檔與其他檔案的關聯：
   - 會計項目檔：規範限制天數和最大筆數限制對應的會計項目
   - 部門代碼檔：類別代碼來源和用途對應的部門代碼

此程式作為會計總帳系統的核心配置程式，透過設定參數檔控制系統的運作方式和行為。正確的參數設定對於系統的穩定運行至關重要，影響到日期顯示、會計期間劃分、授權控制和資料處理等多個方面。各部門可以根據自身的管理需求和作業特性，設定適合的參數。參數設定一旦完成，將應用於整個會計總帳系統的各個功能模組。 
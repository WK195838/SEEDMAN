# GAR3041 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR3041
- **程式說明**：報表格式列印
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR3041
- **開發人員**：MERCURY
- **建立日期**：83/03/03
- **系統名稱**：會計總帳系統
- **子系統**：總帳子系統
- **備註**：報表格式列印
- **聯絡電話**：5042266

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GLARPF：會計科目檔（輸入模式）
  - GLASLF01：會計科目說明檔（輸入模式）
  - PT#BPF：部門說明檔（輸入模式）
- **印表檔案**
  - GAR304P：報表格式列印輸出檔
- **相關程式**
  - GAR304：報表格式列印（主程式）

## 3. 檔案欄位規格說明

### GLARPF（會計科目檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AR01 | 部門代號 | 字元 | 層級2欄位 |
| AR02 | 會計科目代號 | 字元 | 層級2欄位 |
| AR03 | 科目層級 | 字元 | 層級1欄位 |
| AS05 | 餘額金額 | 數值 | - |

### GLASLF01（會計科目說明檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AS05P | 餘額正負號 | 字元 | + 代表正值，- 代表負值 |

### PT#BPF（部門說明檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| #B02 | 部門說明 | 字元 | - |

### #FRCDF（檔案控制區）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| RCDF | 記錄格式 | 字元 | - |

### 程式使用資料定義
| 欄位名稱 | 位置 | 長度 | 說明 |
|---------|------|------|------|
| $USER | 101-110 | 10 | 使用者代號 |
| $EGMDY | 119-124 | 6 | 系統日期 |
| $EVR | 162 | 1 | 環境變數 |
| $CPY | 125-127 | 3 | 公司代號 |
| $WRHUS | 501-505 | 5 | 倉庫代號 |
| $PRTID | 598-599 | 2 | 列印代號 |
| DAR01S | 601-602 | 2 | 部門代號(起) |
| DAR01E | 603-604 | 2 | 部門代號(迄) |
| DAR02S | 605-606 | 2 | 會計科目代號(起) |
| DAR02E | 607-608 | 2 | 會計科目代號(迄) |
| DAR03S | 609-611 | 3 | 科目層級(起) |
| DAR03E | 612-614 | 3 | 科目層級(迄) |
| DESC | - | - | 科目說明 |
| I | - | 1 | 陣列索引 |

### 程式內部陣列
| 陣列名稱 | 維度 | 說明 |
|---------|------|------|
| ARR1 | 7 x 2 | 會計科目代號陣列 |
| ARR2 | 7 x 80 | 會計科目說明陣列 |

### 程式內部變數
| 變數名稱 | 型態 | 說明 |
|---------|------|------|
| *IN10 | 指示燈 | 初始化控制旗標 |
| *IN20 | 指示燈 | 標題控制旗標 |
| *IN31 | 指示燈 | 明細資料控制旗標 |
| *IN39 | 指示燈 | 分頁控制旗標 |
| *IN40 | 指示燈 | 資料讀取控制旗標 |
| *IN46 | 指示燈 | 檔案結束控制旗標 |
| *INL1 | 指示燈 | 層級1控制旗標(科目層級) |
| *INL2 | 指示燈 | 層級2控制旗標(部門和會計科目) |

## 4. 輸出/入螢幕布局與說明

### 報表格式
使用GAR304P列印檔案產生以下報表：

```
[公司名稱]

報表格式列印

                                                       日期: [系統日期]
                                                       頁次: [頁碼]
                                                       時間: [時間]    <GAR304P>
科目層級: [開始層級] - [結束層級]                       使用者: [使用者ID]
=========================================================================
部門    會計科目  科目說明                              餘額
=========================================================================

[部門代號] [會計科目代號] [科目說明]                    [+/-][餘額金額]
```

## 5. 處理流程程序說明

### 主程序流程
1. 判斷初始化狀態（*IN10='0'）：
   - 若未初始化：執行初始化（EXSR RTN010）
   - 若為層級2變更（*INL2='1'）：輸出尾註（WRITEPE1）並執行初始化（EXSR RTN010）
2. 處理資料（EXSR RTN100）
3. 層級1與層級2控制：
   - 層級1（科目層級）：關閉指示燈31，開啟指示燈20
   - 層級2（部門和會計科目）：關閉指示燈31
4. 執行結束處理（EXSR RTN990，僅當最後記錄時）

### 子程序處理流程

#### RTN010 - 初始化處理
1. 初始化科目說明變數（MOVEL*BLANK DESC）
2. 設定陣列索引（Z-ADD1 I）
3. 從ARR1陣列查找科目代號（LOOKUP AR02,ARR1,I）
4. 如果找到科目資料（*IN40='1'），從ARR2陣列取得科目說明（MOVEL ARR2,I DESC）
5. 從部門說明檔（PT#BPF）讀取部門資訊（CHAIN AR01,#B0）
6. 若部門資料不存在（*IN40='1'），則使用空白作為部門名稱（MOVE *BLANK #B02）
7. 輸出報表標題（WRITEPH1）
8. 設定初始化完成指示燈（10）

#### RTN100 - 資料處理
1. 設定資料檔讀取位置（SETLL KEYAS）
2. 讀取第一筆資料（READE KEYAS）
3. 循環處理相關會計科目資料（DOWEQ *IN46='0'）：
   - 處理餘額正負號：
     * 若AS05>0：設定AS05P為'+'
     * 若AS05<0：設定AS05P為'-'
     * 若AS05=0：設定AS05P為空白
   - 判斷是否需要分頁（*IN39='1'）：若需要，執行分頁處理（EXSR RTN900）
   - 輸出明細資料（WRITEPD1）
   - 關閉標題顯示指示燈（*IN20='0'）
   - 開啟明細顯示指示燈（*IN31='1'）
   - 讀取下一筆資料（READE KEYAS）
   - 繼續處理直到檔案結束（*IN46='1'）

#### RTN900 - 分頁處理
1. 輸出尾註（WRITEPE1）
2. 輸出標題（WRITEPH1）
3. 關閉分頁指示燈（39）
4. 關閉明細顯示指示燈（31）

#### RTN990 - 結束處理
1. 判斷是否有輸出資料（*IN10='0'）：
   - 若無資料：輸出標題（WRITEPH1）和無資料訊息（WRITEPE3）
2. 輸出結束訊息（WRITEPE2）

## 6. 子程序處理邏輯說明
- **檔案讀取邏輯**：
  * 使用CHAIN指令讀取部門檔（PT#BPF）
  * 使用KEYAS鍵值清單定義檔案讀取鍵值（AR01+AR02+AR03）
  * 使用SETLL和READE指令循環讀取符合條件的會計科目資料
  * 透過*IN46指示燈控制檔案讀取循環

- **餘額處理邏輯**：
  * 根據AS05欄位值（餘額金額）判斷正負號：
    - 如果AS05>0：顯示正號'+'
    - 如果AS05<0：顯示負號'-'
    - 如果AS05=0：不顯示符號（空白）

- **報表格式控制邏輯**：
  * 使用*IN20指示燈控制標題的顯示格式
  * 使用*IN31指示燈控制明細資料的顯示格式
  * 使用*IN39指示燈控制分頁處理
  * 使用*INL1和*INL2層級指示燈控制科目層級和部門/會計科目的層級處理
  * 採用雙層級結構：科目層級（AR03）為層級1，部門代號（AR01）和會計科目代號（AR02）為層級2

## 7. 錯誤處理程序說明與訊息清冊
- 使用指示燈39控制分頁處理
- 使用指示燈10控制初始化狀態
- 使用指示燈20控制標題顯示
- 使用指示燈31控制明細顯示
- 使用指示燈40檢查資料讀取狀態
- 使用指示燈46控制檔案讀取循環
- 使用層級指示燈L1和L2控制科目層級和部門/會計科目的層級處理
- 無資料時顯示"無符合條件之資料"訊息（WRITEPE3）
- 報表輸出完成時顯示"產生完成"訊息（WRITEPE2）

## 8. 備註
1. 本程式為報表格式列印作業的子程式，負責將篩選後的會計科目資料輸出到報表
2. 程式使用雙層級結構，以科目層級（AR03）為第一層級，部門代號（AR01）和會計科目代號（AR02）為第二層級
3. 報表特別處理餘額金額的正負號顯示，便於財務人員識別餘額性質
4. 程式使用ARR1和ARR2兩個陣列存放會計科目代號和說明，方便查詢和處理
5. 當無資料符合條件時，程式會輸出特別的訊息通知使用者
6. 此程式由GAR304主程式調用，處理實際的報表生成與列印工作
7. 報表提供完整的會計科目餘額清單，便於會計人員執行例行的財務報表工作 
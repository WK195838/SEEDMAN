# GLA1501 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA1501
- **程式說明**：取消結案作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA1501
- **開發人員**：A1152 ANGY
- **建立日期**：1992.11.09
- **系統**：會計總帳
- **功能描述**：提供會計分錄取消結案的功能

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **GLAHLF01**：會計分錄歷史檔（更新檔案）
- **PT#BPF**：系統參數檔（參考檔案）
- **S#SUPF**：員工資料檔（參考檔案）
- **GLAKPF**：公司檔案（參考檔案）
- **GLA1501D**：螢幕顯示檔（工作站檔案）

### 檔案間關聯
- 使用公司代碼（WAH01/AH01）連結各檔案
- 使用分錄編號（AH02）作為GLAHLF01的次要鍵值
- 使用員工代碼（AH26）連結S#SUPF取得員工資料
- 使用SFLSR子檔顯示會計分錄清單

## 3. 檔案欄位規格說明

### GLAHLF01 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AH10 | 交易日期 | - | 8 | 數值 | 會計交易日期 |
| AH19 | 結案狀態 | - | 1 | 文字 | 空白=取消結案 |
| AH21 | 作業日期 | - | 8 | 數值 | 作業執行日期 |
| AH25 | 結案日期 | - | 8 | 數值 | 結案處理日期 |
| AH26 | 員工代碼 | - | 10 | 文字 | 處理人員代碼 |
| AH97 | 最後處理時間 | - | 6 | 數值 | 系統時間 |
| AH98 | 最後處理日期 | - | 8 | 數值 | 系統日期 |
| AH99 | 最後處理人員 | - | 10 | 文字 | 使用者代碼 |

### S#SUPF (員工資料檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| SU02 | 員工姓名 | - | - | 文字 | 員工名稱 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 參數類別 | - | 2 | 文字 | 主鍵 |
| #B02 | 參數代碼 | - | - | 文字 | 次要鍵 |
| #B03 | 參數說明 | - | - | 文字 | 公司名稱/說明 |

### GLAKPF (公司檔案)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AK09 | 日期格式 | - | - | 文字 | 日期顯示格式 |
| AK11 | 日期分隔符號 | - | - | 文字 | 日期分隔符號 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $USERN | 使用者名稱 | 152 | 10 | 文字 | 目前使用者名稱 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| $C8YMD | 系統日期 | 209 | 8 | 數值 | 系統日期(YYYYMMDD) |
| WAH01 | 公司代碼 | 575 | 2 | 文字 | 處理的公司代碼 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
```
                            取消結案作業                       公司：XX
                                                              日期：YYYY/MM/DD

選項：6=取消結案  5=查詢

選項  分錄編號   交易日期    結案日期    作業日期    處理人員    姓名
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX
 _    XXXXXXXXX  YYYY/MM/DD  YYYY/MM/DD  YYYY/MM/DD  XXXXXXXXXX  XXXXXXXXXXXX

F3=結束  F12=取消  F13=全部取消結案
```

### 功能鍵說明
| 功能鍵 | 說明 |
|--------|------|
| F3 | 結束程式 |
| F12 | 取消處理 |
| F13 | 全部取消結案 |

### 選項說明
| 選項 | 說明 |
|------|------|
| 6 | 取消結案 - 將選定的分錄狀態設為未結案 |
| 5 | 查詢 - 顯示分錄詳細資訊 |

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 初始化子檔

2. 螢幕處理（R1000子程序）
   - 顯示子檔畫面
   - 處理使用者輸入及功能鍵
   - 根據選項執行相應處理

3. 結束程式處理
   - 設定最後記錄指標(LR)結束程式

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 讀取GLAKPF檔案取得公司資訊
- 執行R1A00子程序初始化子檔

### R1000 - 螢幕處理
- 顯示子檔控制畫面
- 處理功能鍵：F3(結束)、F12(取消)、F13(全部取消結案)
- 執行R1D00子程序處理使用者選項

### R1A00 - 子檔初始化
- 設定子檔控制指標
- 清除子檔
- 執行R1A20子程序設定子檔標頭
- 執行R1A10子程序新增子檔資料
- 設定子檔顯示指標

### R1A10 - 新增子檔資料
- 讀取GLAHLF01檔案中的記錄
- 循環處理每筆記錄
- 執行R1A11子程序寫入子檔

### R1A11 - 寫入子檔資料
- 從S#SUPF檔案取得員工姓名
- 格式化日期顯示（交易日期、結案日期、作業日期）
- 寫入子檔記錄

### R1A20 - 設定子檔標頭
- 設定公司代碼
- 從PT#BPF檔案取得公司名稱

### R1C00 - 全部取消結案
- 讀取GLAHLF01檔案中的所有記錄
- 將每筆記錄的結案狀態(AH19)設為空白
- 更新最後處理時間、日期和處理人員

### R1D00 - 處理使用者選項
- 讀取子檔中使用者選擇的記錄
- 處理選項6(取消結案)：將結案狀態設為空白
- 處理選項5(查詢)：呼叫GLI1F0程式顯示詳細資訊
- 更新子檔顯示

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 當找不到符合條件的記錄時，顯示「無資料」訊息(UPT2050)
- 呼叫GLI1F0程式後，檢查返回碼(@RTNC)處理異常情況

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| UPT2050 | 無符合條件的資料 | 顯示訊息，等待使用者操作 |

## 8. 備註
- 本程式為會計結案作業的取消功能，配合GLA1401結案作業程式使用
- 程式會將處理過的分錄記錄更新結案狀態為空白
- 可以單筆取消結案或使用F13功能鍵全部取消結案
- 選項5可呼叫GLI1F0程式查詢分錄詳細資訊
- 程式使用GLAHLF01邏輯檔案，該檔案是GLAHPF的邏輯檢視
- 取消結案後，分錄可再次進行結案處理 
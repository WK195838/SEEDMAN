# GLI1E0 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLI1E0
- **程式說明**：明細資料查詢及選擇程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLI1E0
- **開發人員**：A1139 JANE
- **建立日期**：NOV 10, 92'
- **更新日期**：
- **系統**：會計總帳
- **功能描述**：提供會計分錄明細資料的查詢與選擇功能，可依多種條件篩選分錄資料

## 2. 檔案架構與關聯圖
此程式使用以下檔案：

### 檔案清單
- **PT#BPF**：系統參數檔（讀取檔案）
- **GLAKPF**：會計期間檔（讀取檔案）
- **GLAHLF02**：會計分錄歷史檔（讀取檔案）
- **GLAFPF**：會計科目檔（讀取檔案）
- **GLAEPF**：會計匯率檔（讀取檔案）
- **GLALPF**：會計帳款檔（讀取檔案）
- **GLALLF01**：會計帳款歷史檔（讀取檔案）
- **GLI1E0D**：螢幕顯示檔（工作站檔案）

### 檔案間關聯
- 使用公司代碼（DAH01）連結各檔案
- 使用公司代碼、科目代碼（DAH01、DAH04）連結GLAFPF取得科目資料
- 使用公司代碼、科目代碼、日期（DAH01、DAH04、CAH10）連結GLAHLF02取得交易資料
- 使用公司代碼、匯率代碼（DAH01、AF10）連結GLAEPF取得匯率資料
- 使用KEYAH、KEYAHR、KEYAE、KEYAL等關鍵字列表進行檔案存取

## 3. 檔案欄位規格說明

### GLAHLF02 (會計分錄歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AH01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AH02 | 分錄編號 | - | 9 | 文字 | 主鍵 |
| AH04 | 科目代碼 | - | 8 | 文字 | 科目代碼 |
| AH05 | 部門代碼 | - | 20 | 文字 | 部門代碼 |
| AH06 | 專案代碼 | - | 20 | 文字 | 專案代碼 |
| AH07 | 成本代碼1 | - | 20 | 文字 | 成本代碼1 |
| AH08 | 成本代碼2 | - | 20 | 文字 | 成本代碼2 |
| AH09 | 票據號碼 | - | 7 | 數值 | 票據號碼 |
| AH10 | 交易日期 | - | 8 | 數值 | 會計交易日期 |
| AH12 | 借方金額 | - | - | 數值 | 借方金額 |
| AH13 | 貸方金額 | - | - | 數值 | 貸方金額 |
| AH18 | 過帳標記 | - | 1 | 文字 | V=已過帳，空白=未過帳 |
| AH20 | 作廢標記 | - | 1 | 文字 | V=已作廢，空白=未作廢 |

### GLAFPF (會計科目檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AF01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AF02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AF03 | 科目名稱 | - | - | 文字 | 科目名稱 |
| AF06 | 科目性質 | - | 1 | 文字 | 1=借餘，2=貸餘 |
| AF10 | 匯率代碼 | - | 2 | 文字 | 匯率代碼 |

### GLAEPF (會計匯率檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AE01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AE02 | 匯率代碼 | - | 2 | 文字 | 主鍵 |
| AE04 | 匯率值 | - | - | 數值 | 匯率值 |

### GLALPF (會計帳款檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AL01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AL02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AL11 | 沖銷標記 | - | 1 | 數值 | 沖銷標記，0=未沖銷 |

### GLALLF01 (會計帳款歷史檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AL01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AL02 | 科目代碼 | - | 8 | 文字 | 主鍵 |
| AL11 | 沖銷標記 | - | 1 | 數值 | 沖銷標記，0=未沖銷 |

### GLAKPF (會計期間檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| AK01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| AK09 | 日期格式 | - | 1 | 文字 | 日期格式 |
| AK11 | 日期分隔符號 | - | 1 | 文字 | 日期分隔符號 |

### PT#BPF (系統參數檔)
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| #B01 | 公司代碼 | - | 2 | 文字 | 主鍵 |
| #B02 | 公司名稱 | - | - | 文字 | 公司名稱 |

### 程式參數區域
| 欄位代號 | 名稱 | 位置 | 長度 | 屬性 | 說明 |
|---------|------|------|------|------|------|
| $USER | 使用者代碼 | 101 | 10 | 文字 | 目前使用者代碼 |
| $USERN | 使用者姓名 | 152 | 10 | 文字 | 目前使用者姓名 |
| $A8YMD | 系統日期 | 201 | 8 | 數值 | 系統日期(YYYYMMDD) |
| $C8YMD | 系統日期 | 209 | 8 | 數值 | 系統日期(YYYYMMDD) |
| $CHYMD | 日期格式 | 111 | 6 | 文字 | 日期格式 |
| P1E0I1 | 公司代碼 | - | 2 | 文字 | 輸入參數-公司代碼 |
| P1E0I2 | 科目代碼 | - | 8 | 文字 | 輸入參數-科目代碼 |
| P1E0I3 | 借貸別 | - | 1 | 文字 | 輸入參數-借貸別，1=借方，2=貸方 |
| P1E0I4 | 部門代碼 | - | 20 | 文字 | 輸入參數-部門代碼 |
| P1E0I5 | 專案代碼 | - | 20 | 文字 | 輸入參數-專案代碼 |
| P1E0I6 | 成本代碼1 | - | 20 | 文字 | 輸入參數-成本代碼1 |
| P1E0I7 | 成本代碼2 | - | 20 | 文字 | 輸入參數-成本代碼2 |
| P1E0I8 | 票據號碼 | - | 7 | 數值 | 輸入參數-票據號碼 |
| P1E0O1 | 分錄編號 | - | 9 | 文字 | 輸出參數-分錄編號 |
| @RTNC | 返回代碼 | - | 2 | 文字 | 返回代碼 |
| DAH01 | 公司代碼 | - | 2 | 文字 | 查詢的公司代碼 |
| DAH04 | 科目代碼 | - | 8 | 文字 | 查詢的科目代碼 |
| DAH10 | 交易日期 | - | 8 | 數值 | 查詢的交易日期(顯示格式) |
| CAH10 | 交易日期 | - | 8 | 數值 | 查詢的交易日期(內部格式) |
| WAH05F | 部門代碼起碼 | - | 20 | 文字 | 部門代碼起始值 |
| WAH05T | 部門代碼迄碼 | - | 20 | 文字 | 部門代碼結束值 |
| WAH06F | 專案代碼起碼 | - | 20 | 文字 | 專案代碼起始值 |
| WAH06T | 專案代碼迄碼 | - | 20 | 文字 | 專案代碼結束值 |
| WAH07F | 成本代碼1起碼 | - | 20 | 文字 | 成本代碼1起始值 |
| WAH07T | 成本代碼1迄碼 | - | 20 | 文字 | 成本代碼1結束值 |
| WAH08F | 成本代碼2起碼 | - | 20 | 文字 | 成本代碼2起始值 |
| WAH08T | 成本代碼2迄碼 | - | 20 | 文字 | 成本代碼2結束值 |
| WAH09F | 票據號碼起碼 | - | 7 | 數值 | 票據號碼起始值 |
| WAH09T | 票據號碼迄碼 | - | 7 | 數值 | 票據號碼結束值 |

## 4. 輸出/入螢幕布局與說明

### 主畫面
```
                             明細資料查詢畫面                            公司：XX
                                                                       日期：YYYY/MM/DD

公司代碼：XX        公司名稱：XXXXXXXXXXXXXXXXXXXX
科目代碼：XXXXXXXX  科目名稱：XXXXXXXXXXXXXXXXXXXX

交易日期：YYYY/MM/DD

選項 分錄編號     交易日期    借方金額          貸方金額          部門代碼
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX
 _   XXXXXXXXX YYYY/MM/DD  999,999,999.99   999,999,999.99   XXXXXXXXXXXXXXXXXXXX

F3=結束  F12=返回  ROLL UP=下一頁
```

### 功能鍵說明
- F3：結束
- F12：返回
- ROLL UP：下一頁

### 選項說明
- /：選擇此分錄並返回
- 5：顯示分錄詳細資料（呼叫GLI1F0程式）

## 5. 處理流程程序說明

### 主要處理流程
1. 初始化程式環境（R0100子程序）
   - 讀取系統參數
   - 設定初始值
   - 初始化子檔

2. 處理螢幕輸入（R1000子程序）
   - 顯示螢幕
   - 處理功能鍵
   - 處理日期格式轉換
   - 檢查查詢條件變更

3. 讀取分錄資料（R1A10子程序）
   - 根據查詢條件讀取會計分錄歷史檔
   - 過濾符合條件的記錄
   - 寫入子檔顯示

4. 處理選項（R1C00子程序）
   - 處理使用者選擇的分錄
   - 呼叫GLI1F0程式顯示分錄詳細資料或返回選擇的分錄編號

## 6. 子程序處理邏輯說明

### R0100 - 初始化處理
- 讀取PTDA01資料區
- 呼叫P31程式取得系統日期
- 初始化返回代碼、頁面大小、日期和臨時變數
- 呼叫R1A00初始化子檔

### R1000 - 螢幕處理
- 顯示主畫面
- 處理功能鍵輸入
- 處理日期格式轉換
- 檢查查詢條件變更
- 處理選項

### R1A00 - 子檔初始化
- 初始化子檔變數
- 清除子檔
- 設定子檔控制指標
- 呼叫R1A20設定子檔標題
- 讀取會計期間檔
- 設定查詢條件
- 呼叫R1A10讀取分錄資料
- 處理無資料情況

### R1A10 - 讀取分錄資料
- 計算顯示記錄數
- 讀取會計分錄歷史檔
- 根據借貸別條件過濾記錄
- 根據其他查詢條件過濾記錄
- 呼叫R1A40檢查沖銷狀態
- 呼叫R1A11寫入子檔
- 處理檔案結束情況

### R1A11 - 寫入子檔資料
- 格式化日期顯示
- 寫入子檔記錄

### R1A20 - 設定子檔標題
- 讀取公司資料
- 讀取科目資料
- 呼叫R1A30設定查詢條件

### R1A30 - 設定查詢條件
- 讀取匯率資料
- 設定部門代碼範圍
- 設定專案代碼範圍
- 設定成本代碼1範圍
- 設定成本代碼2範圍
- 設定票據號碼範圍

### R1A40 - 檢查沖銷狀態
- 呼叫R21A0處理查詢條件
- 根據科目性質檢查帳款檔或帳款歷史檔
- 檢查沖銷標記和過帳標記
- 設定顯示控制指標

### R21A0 - 處理查詢條件
- 處理部門代碼條件
- 處理專案代碼條件
- 處理成本代碼1條件
- 處理成本代碼2條件
- 處理票據號碼條件

### R1C00 - 處理選項
- 讀取子檔選項
- 處理選項/（選擇分錄並返回）
- 處理選項5（呼叫GLI1F0顯示分錄詳細資料）
- 處理返回代碼

### R1N00 - 處理下一頁功能
- 檢查是否已到檔案結尾
- 讀取下一頁資料

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤處理
- 當找不到符合條件的記錄時，會顯示無資料訊息

### 訊息清冊
| 訊息代碼 | 說明 | 處理方式 |
|---------|------|---------|
| UPT2050 | 無符合條件的資料 | 顯示錯誤訊息 |

## 8. 備註
- 本程式為會計分錄明細資料查詢功能，提供使用者查詢特定科目的分錄明細
- 程式可接受多種查詢條件，包括公司代碼、科目代碼、借貸別、部門代碼、專案代碼、成本代碼、票據號碼等
- 程式可供其他程式呼叫，用於選擇分錄
- 程式會檢查分錄的沖銷狀態和過帳狀態
- 程式會格式化日期顯示，根據會計期間檔中的設定
- 使用者可以選擇特定分錄，程式會呼叫GLI1F0程式顯示該分錄的詳細資料
- 使用者可以選擇分錄並返回呼叫程式，返回選擇的分錄編號 
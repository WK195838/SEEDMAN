# GLA480 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA480
- **程式說明**：會計項目區間複製作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA480
- **開發人員**：A1152 ANGY
- **建立日期**：1992.10.30 (81/10/30)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLAAPF**：會計項目檔
- **PT#BPF**：部門參數檔
- **GLA480D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA480
- **呼叫程式**：
  - P31：日期格式處理程式
- **功能鍵**：F3(離開), F14(處理作業)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱

- **工作區資料**
  - WAA02F (501-502)：起始會計項目代號
  - WAA02T (503-504)：結束會計項目代號

### 主要欄位說明
- **KEYAAF**：來源會計項目檔鍵值 (DAA01F+WAA02F)
- **KEYAAT**：目標會計項目檔鍵值 (DAA01T+AA02)
- **KEYWAA**：暫存會計項目檔鍵值 (WAA01+WAA02)
- **DAA01F**：來源部門別
- **DAA02F**：來源會計項目起始值
- **DAA02T**：來源會計項目結束值
- **DAA01T**：目標部門別
- **WAA01-WAA05**：暫存的會計項目各欄位

## 4. 輸出/入螢幕布局與說明

### 第一畫面 (DSPD1)
- **螢幕標題**：會計項目區間複製作業
- **畫面描述**：設定會計項目複製參數
- **輸入欄位**：
  - 來源部門代號 (DAA01F)：來源部門代號
  - 來源項目代號 (DAA02F-DAA02T)：項目代號範圍
  - 目標部門代號 (DAA01T)：目標部門代號
  - 複製選項 (DOPT)：處理方式
    - 1：不存在則新增，存在則跳過
    - 2：不存在則新增，存在則覆蓋，無需確認
    - 3：不存在則新增，存在則需確認是否覆蓋

- **功能鍵**：
  - F3：離開
  - F14：處理作業

### 確認畫面 (DSPD2)
- **畫面描述**：已存在項目確認畫面
- **顯示欄位**：
  - 項目編號 (DAA02)：會計項目代號
  - 項目名稱 (DAA03)：會計項目名稱
  
- **輸入欄位**：
  - 是否覆蓋 (COVE)：Y=是, N=否
  
## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 進入畫面選擇迴圈，處理第一畫面 (R1000)
3. 程式結束

### 第一畫面處理流程 (R1000)
1. 顯示第一畫面等待使用者輸入
2. 若按F3則結束程式
3. 檢核使用者輸入資料 (R1B00)
4. 若按F14且檢核無誤則執行複製處理 (R1C00)

## 6. 子程序處理邏輯說明

### 程式初始化 (R0100)
1. 設定目前畫面ID為SC01
2. 讀取參數資料區
3. 呼叫P31設定日期格式
4. 初始化各項輸入欄位
5. 設定操作選項預設為1(不存在則新增，存在則跳過)

### 第一畫面檢核 (R1B00)
1. 檢查來源部門別是否已輸入並有效
2. 檢查來源會計項目範圍
   - 若起始值為空白，則設為最小值
   - 若結束值為空白，則設為最大值
   - 檢核起始值必須小於等於結束值
3. 檢查目標部門別是否已輸入並有效

### 複製處理 (R1C00)
1. 按下F14功能鍵後執行
2. 根據選擇的複製選項執行不同處理方式：
   - 選項1 (R1C10)：不存在則新增，存在則跳過
   - 選項2 (R1C20)：不存在則新增，存在則覆蓋，無需確認
   - 選項3 (R1C30)：不存在則新增，存在則需確認是否覆蓋
3. 完成後顯示處理完成訊息

### 不存在則新增，存在則跳過 (R1C10)
1. 讀取來源部門中指定範圍內的會計項目
2. 暫存會計項目資料 (R1C11)
3. 檢查目標部門中是否存在此會計項目
4. 若不存在，則轉換資料 (R1D00) 並寫入新記錄至目標部門
5. 若已存在，則跳過此記錄

### 不存在則新增，存在則覆蓋，無需確認 (R1C20)
1. 讀取來源部門中指定範圍內的會計項目
2. 暫存會計項目資料 (R1C11)
3. 檢查目標部門中是否存在此會計項目
4. 若不存在，則轉換資料 (R1D00) 並寫入新記錄至目標部門
5. 若已存在，則轉換資料 (R1D00) 並更新目標部門中的記錄

### 不存在則新增，存在則需確認是否覆蓋 (R1C30)
1. 讀取來源部門中指定範圍內的會計項目
2. 暫存會計項目資料 (R1C11)
3. 檢查目標部門中是否存在此會計項目
4. 若不存在，則轉換資料 (R1D00) 並寫入新記錄至目標部門
5. 若已存在，則顯示確認畫面 (R1C31)
6. 根據使用者的確認結果決定是否更新記錄

### 暫存會計項目資料 (R1C11)
1. 將讀取的會計項目資料暫存至工作變數中
2. 保留原始記錄的所有欄位值 (AA01-AA05)

### 確認處理 (R1C31)
1. 顯示確認畫面，包含會計項目編號和名稱
2. 詢問使用者是否要覆蓋現有記錄
3. 若確認覆蓋 (COVE='Y')，則轉換資料 (R1D00) 並更新記錄
4. 若不覆蓋，則跳過此記錄

### 轉換處理 (R1D00)
1. 將暫存的會計項目資料轉換為目標部門的格式
2. 設定部門代號為目標部門 (DAA01T)
3. 保留原始會計項目代號 (WAA02) 和其他相關欄位 (WAA03-WAA05)
4. 設定更新時間 (AA97)、日期 (AA98) 及使用者資訊 (AA99)

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0042**：起始項目必須小於結束項目
- **UPT2142**：作業處理完成
- **UGL0004**：無效的部門代碼

### 錯誤處理
- 設定對應的錯誤指示燈 (IN60, IN61, IN62, IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於會計總帳系統中複製會計項目資料，具有以下特點：

1. 提供批次複製功能，可一次複製多個會計項目
2. 支援跨部門複製，從一個部門複製到另一個部門
3. 提供三種處理模式：
   - 僅新增不存在的記錄
   - 新增不存在的記錄，自動覆蓋已存在的記錄
   - 新增不存在的記錄，經確認後覆蓋已存在的記錄
4. 保留原始會計項目的所有屬性，僅修改部門別和更新時間戳記
5. 確認處理模式允許使用者逐筆確認覆蓋操作，提供更安全的控制

此程式的主要用途是簡化會計項目的設定工作，當需要在不同部門之間設定相似的會計項目時，可透過複製功能快速建立，避免重複手動輸入，提高工作效率。同時，提供的不同處理模式讓使用者可以根據需求選擇適當的複製策略，確保資料安全和準確性。尤其對於大型組織或需要維護多部門會計項目的場景，此功能特別有用。 
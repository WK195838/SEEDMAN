# GLA610 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA610
- **程式說明**：預算分配作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA610
- **開發人員**：A1087 JOYCE
- **建立日期**：1992.12.07 (81/12/07)
- **修改日期**：-
- **系統**：會計總帳

## 2. 檔案架構與關聯圖

### 使用檔案
- **GLATPF**：預算主檔
- **GLAUPF**：預算明細檔
- **GLA6PF**：預算分配比率檔
- **GLAFPF**：會計項目檔
- **GLAKPF**：參數檔
- **PT#APF**：人員檔
- **PT#BPF**：部門參數檔
- **GLA610D**：螢幕顯示檔案

### 程式關係
- **主程式**：GLA610
- **呼叫程式**：
  - P31：日期格式處理程式
  - P50：錯誤處理程式
  - P55：數值處理程式
  - P56：字串處理程式
  - P64I：印表機代碼設定程式
  - GLI410：會計項目查詢程式
  - GLI610：預算主檔瀏覽程式
  - GLI660：預算分配比率瀏覽程式
  - PTI140：部門代碼查詢程式
  - S#S01：使用者權限檢查程式
- **功能鍵**：F3(離開), F4(查詢), F12(返回), F18(瀏覽)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置
  - #DRRN (378-379)：檔案記錄編號

- **UDS (使用者資料區)**
  - $USER (101-110)：使用者代碼
  - $CHYMD (111-116)：系統日期
  - $CPY (125-127)：公司代號
  - $ADD (135-135)：新增權限
  - $UPD (136-136)：修改權限
  - $DLT (137-137)：刪除權限
  - $INQ (138-138)：查詢權限
  - $USERN (152-161)：使用者名稱
  - $A8YMD (201-208)：系統日期
  - $C8YMD (209-216)：日期
  - $PRTCD (217-218)：印表機代碼
  - $PENV (219-219)：印表機環境

### 陣列定義
- **@A01 (功能權限陣列)**：儲存各種功能權限（5項）
- **@W01 (預算分配比率陣列)**：儲存預算分配比率（13項）
- **@W02 (檔案中預算分配金額陣列)**：儲存檔案中的預算分配金額（13項）
- **@W03 (螢幕中預算分配金額陣列)**：儲存螢幕中的預算分配金額（13項）
- **@W04 (子檔中預算分配金額陣列)**：儲存子檔中的預算分配金額（13項）

### 主要欄位說明
- **KEYAT**：預算主檔鍵值 (DAT01+WAT02+DAT03+DAT04)
- **KEYATC**：複製用預算主檔鍵值 (DAT01C+WAT02C+DAT03C+DAT04C)
- **KEYAU**：預算明細檔鍵值 (DAT01+WAT02+DAT03+DAT04+DAU05)
- **KEYAU1**：預算明細檔子檔鍵值 (DAT01+WAT02+DAT03+DAT04+SAU05)
- **KEYAF**：會計項目檔鍵值 (DAT01+DAT04)
- **KEYA6**：預算分配比率檔鍵值 (DAT01+DA602)
- **DAT01**：部門代號
- **DAT02**：年度
- **DAT03**：期別
- **DAT04**：會計項目
- **DAT05**：預算描述
- **DAT06**：預算總額
- **DA602**：分配比率代碼
- **DA603**：分配比率說明
- **DAU05**：部門成本中心
- **DAU06**：預算金額
- **SAU05**：子檔部門成本中心
- **SAU06**：子檔預算金額
- **DOPT**：操作選項（1:新增, 2:修改, 4:刪除, 5:查詢）
- **MONTH**：會計月份數（12或13個月）
- **WAT02**：年度（工作區）
- **WAT06**：預算總額累計（工作區）

## 4. 輸出/入螢幕布局與說明

### 畫面流程
本程式包含3個主要畫面：
1. **SC01**：初始參數輸入畫面
2. **SC02**：預算明細維護畫面
3. **SC03**：各月份預算分配編輯畫面

### 第一畫面 (SC01-DSPD1)
- **螢幕標題**：預算分配作業
- **畫面描述**：輸入預算分配的基本參數
- **輸入欄位**：
  - 操作選項 (DOPT)：指定處理動作（1:新增, 2:修改, 4:刪除, 5:查詢）
  - 部門代號 (DAT01)：輸入部門代號
  - 年度 (DAT02)：輸入預算年度
  - 期別 (DAT03)：輸入預算期別
  - 會計項目 (DAT04)：輸入會計項目代號
  - 複製來源資料 (DAT01C, DAT02C, DAT03C, DAT04C)：當新增時，可指定複製來源的預算資料
- **功能鍵**：
  - F3：離開
  - F4：查詢
  - F18：瀏覽預算主檔

### 第二畫面 (SC02-SFLCR)
- **螢幕標題**：預算分配明細清單
- **畫面描述**：顯示和編輯預算分配明細資料
- **主檔區域**：
  - 預算描述 (DAT05)：預算的描述性文字
  - 分配比率代碼 (DA602)：預設的分配比率代碼
  - 分配比率說明 (DA603)：分配比率說明
  - 預算總額 (DAT06)：預算總金額
- **子檔區域**：
  - 選項 (DOP)：明細記錄的操作選項（4:刪除, 6:編輯明細, 7:重新計算）
  - 部門成本中心 (DAU05)：成本中心代碼
  - 部門名稱 (D#A02)：部門名稱
  - 預算金額 (DAU06)：分配給此部門的預算金額
  - 各月份預算明細 (隱藏)：各月份的預算分配金額
- **功能鍵**：
  - F3：離開
  - F4：查詢
  - F12：返回上一畫面

### 第三畫面 (SC03-DSPD3)
- **螢幕標題**：預算月份分配編輯
- **畫面描述**：編輯各月份的預算分配金額
- **顯示欄位**：
  - 各月份預算欄位：顯示並允許編輯各月份（7-19月）的預算分配金額
  - 合計金額 (DTOT1)：各月份預算金額的合計
- **功能鍵**：
  - F3：離開
  - F12：返回上一畫面

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境 (R0100)
2. 根據螢幕代碼 (SCID) 進入對應處理例程
3. 處理主畫面輸入 (R1000)
4. 處理明細子檔畫面 (R2000)
5. 處理月份預算分配畫面 (R3000)
6. 完成處理後返回主畫面或結束程式

### 初始化處理 (R0100)
1. 設定初始螢幕代碼 (SCID = 'SC01')
2. 讀取參數資料區 (PTDA01)
3. 呼叫P31設定日期格式
4. 設定功能權限 (@A01)
5. 初始化主畫面欄位

### 主畫面處理 (R1000)
1. 顯示主畫面 (DSPD1)
2. 檢查功能鍵
   - F3：結束程式
   - F4：呼叫查詢功能 (R1E00)
   - F18：瀏覽預算主檔 (R1A00)
3. 檢核輸入資料 (R1B00)
4. 初始化明細畫面 (R1C00)
5. 切換至明細畫面 (SCID = 'SC02')

### 明細子檔處理 (R2000)
1. 顯示子檔畫面 (SFLCR)
2. 處理使用者輸入
   - F3：結束程式
   - F4：呼叫查詢功能 (R2E00)
   - F12：返回主畫面
   - 明細選項：處理明細資料 (R2B00)
3. 檢核明細資料 (R2B00)
4. 儲存明細資料至檔案 (R2D00)

### 月份預算分配處理 (R3000)
1. 初始化月份編輯畫面 (R3A00)
2. 顯示月份編輯畫面 (DSPD3)
3. 處理使用者輸入
   - F3：結束程式
   - F12：返回明細畫面
4. 檢核月份預算分配資料 (R3B00)
5. 儲存月份預算分配資料 (R3D00)

## 6. 子程序處理邏輯說明

### 預算瀏覽功能 (R1A00)
1. 檢查使用者權限 (S#S01)
2. 呼叫預算瀏覽程式 (GLI610)
3. 處理返回代碼

### 主畫面檢核 (R1B00)
1. 檢查功能權限
2. 檢查部門代號是否存在
3. 檢查年度和期別
4. 檢查會計項目是否存在和有效
5. 檢查新增時資料是否已存在
6. 檢查修改/刪除/查詢時資料是否存在
7. 檢查複製來源資料是否存在
8. 設定會計月份數（根據AK10判斷12或13個月）

### 明細初始化 (R1C00)
1. 初始化子檔記錄計數器和顯示設定
2. 根據操作選項執行不同初始化：
   - 新增：初始化主檔資料 (R1CA0)
   - 新增複製：讀取複製來源資料 (R1CB0, R1CE0)
   - 修改/刪除/查詢：讀取原始資料 (R1CB0, R1CE0)
3. 設定子檔顯示參數
4. 釋放檔案資源

### 主檔初始化 (R1CA0, R1CB0)
1. 設定主檔欄位值（根據新增或修改/刪除/查詢）
2. 複製來源時：從複製來源讀取主檔資料
3. 修改/刪除/查詢時：從原始資料讀取主檔資料

### 明細資料讀取 (R1CE0, R1CE1)
1. 根據操作選項選擇讀取來源（複製來源或原始資料）
2. 讀取明細記錄
3. 設定子檔欄位值
4. 累計預算總額

### 明細子檔處理 (R2B00, R2B10)
1. 檢查主檔資料
2. 讀取並檢核子檔記錄
3. 處理明細選項：
   - 選項4：刪除明細
   - 選項6：編輯月份預算分配 (R3000)
   - 選項7：重新計算預算分配

### 預算分配計算 (R2B10)
1. 檢查部門成本中心是否存在和有效
2. 計算預算金額
3. 根據會計項目類型 (AF05) 和分配比率執行不同計算：
   - 比率為空：均分預算金額
   - 有分配比率：根據比率計算各月份預算金額
4. 更新子檔資料

### 資料儲存處理 (R2D00)
1. 根據操作選項執行不同處理：
   - 新增 (R2D10)：寫入新記錄
   - 修改 (R2D20)：更新記錄
   - 刪除 (R2D30)：刪除記錄
2. 處理主檔及明細資料

### 月份預算編輯 (R3000, R3A00)
1. 初始化月份預算編輯畫面
2. 顯示各月份預算金額
3. 處理使用者輸入
4. 檢核月份預算總額 (R3B00)
5. 更新子檔資料 (R3D00)

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入
- **UPT0012**：數值欄位必須大於零
- **UPT0030**：欄位資料格式錯誤
- **UPT0060**：複製來源找不到
- **UPT2010**：資料不存在
- **UPT2020**：資料已存在
- **UPT2150**：無權限執行此功能
- **UGL0004**：未啟用部門
- **UGL0009**：會計項目非有效狀態

### 錯誤處理
- 設定對應的錯誤指示燈 (IN60-IN99)
- 顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式是會計總帳系統中的預算分配作業，具有以下特點：

1. 支援預算主檔和明細的新增、修改、刪除和查詢功能
2. 支援以既有預算資料作為模板進行複製新增
3. 支援依部門成本中心分配預算
4. 提供兩種預算分配方式：
   - 平均分配：將預算金額平均分配到各月份
   - 比率分配：依預先設定的分配比率計算各月份預算金額
5. 提供月份預算編輯功能，可手動調整各月份的預算分配
6. 支援12或13個會計月份的預算分配
7. 提供預算主檔瀏覽功能，方便查詢現有預算資料
8. 提供預算分配比率檔瀏覽功能，支援不同的預算分配模式

此程式是會計預算控制的重要工具，可依部門、會計項目和月份進行多層次的預算規劃和管理，有助於企業進行財務控制和資源分配。 
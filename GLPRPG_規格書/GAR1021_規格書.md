# 程式功能規格書

## 1. 基本資料
- **程式名稱**：GAR1021
- **程式說明**：會計系統報表產生程式
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GAR1021
- **系統名稱**：會計系統
- **子系統**：會計處理

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - GAWF03：會計工作檔
  - GLAHLF01：會計歷史資料檔
  - GLAKPF：會計主檔
  - GLAFPF：會計科目檔
  - PT#YPF：年度參數檔
  - S#SUPF：系統參數檔
  - PT#BPF：批次參數檔
- **輸出檔案**
  - GAR102P：報表輸出檔

## 3. 檔案欄位規格說明
### 資料區定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| $PFMT | 1 | 1 | 字元 | 報表格式 |
| $PTYPE | 2 | 1 | 字元 | 報表類型 |
| $USER | 101-110 | 10 | 字元 | 使用者代號 |
| $CPY | 125-127 | 3 | 數值 | 公司代號 |
| $INQ | 138 | 1 | 字元 | 查詢標記 |
| $A8YMD | 201-208 | 8 | 數值 | 會計年度 |
| $C8YMD | 209-216 | 8 | 數值 | 系統日期 |
| $PRTCD | 217-218 | 2 | 字元 | 列印代號 |
| $PENV | 219 | 1 | 字元 | 環境變數 |

### 程式使用資料定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| DAH01 | 501-502 | 2 | 字元 | 系統代號 |
| DAH25F | 503-510 | 8 | 數值 | 會計年度起始值 |
| DAH25T | 511-518 | 8 | 數值 | 會計年度結束值 |
| DAH10F | 519-526 | 8 | 數值 | 會計期間起始值 |
| DAH10T | 527-534 | 8 | 數值 | 會計期間結束值 |
| DAH02F | 535-543 | 9 | 字元 | 會計科目起始值 |
| DAH02T | 544-552 | 9 | 字元 | 會計科目結束值 |
| DAH26F | 553-562 | 10 | 字元 | 部門代號起始值 |
| DAH26T | 563-572 | 10 | 字元 | 部門代號結束值 |
| DAH17F | 573-574 | 2 | 字元 | 成本中心起始值 |
| DAH17T | 575-576 | 2 | 字元 | 成本中心結束值 |
| DAH19 | 577 | 1 | 字元 | 報表類型 |

## 4. 輸出/入螢幕布局與說明
- 使用報表輸出檔：GAR102P
- 報表功能：
  * 報表標題
  * 報表內容
  * 報表小計
  * 報表總計

## 5. 處理流程程序說明
### 1. 程式初始化
- 初始化處理（R1000）：
  * 設定日期格式
  * 讀取參數資料
  * 設定報表標題
  * 設定報表類型（已結帳/未結帳/全部）

### 2. 主要處理邏輯
1. 資料讀取與處理：
   - 使用KEYAH設定讀取條件
   - 依序讀取會計資料
   - 處理每筆明細資料

2. 明細資料處理（R2000）：
   - 轉換日期格式
   - 處理成本中心資料
   - 處理部門資料
   - 處理會計科目資料
   - 輸出明細資料

3. 層級控制處理：
   - 層級1初始化（R7100）
   - 層級1小計（R8100）
   - 層級1總計（R8900）
   - 無資料處理（R8999）

## 6. 子程序處理邏輯說明
- **P31**：日期格式轉換程式
  * 處理日期格式轉換
  * 參數：
    - 輸入日期
    - 格式代號（'2'）
    - 轉換類型（'1'）
    - 報表格式
    - 報表類型

## 7. 錯誤處理程序說明與訊息清冊
- 資料讀取錯誤：
  * 找不到系統代號資料
  * 找不到成本中心資料
  * 找不到部門資料
  * 找不到會計科目資料
- 資料處理錯誤：
  * 日期格式轉換錯誤
  * 資料驗證錯誤

## 8. 備註
- 程式主要用於產生會計報表
- 支援多種報表類型：
  * 已結帳
  * 未結帳
  * 全部
- 報表處理特點：
  * 支援多層級小計
  * 支援多種日期格式
  * 支援多種資料來源
  * 支援多種報表格式
- 使用工作檔GAWF03進行資料處理 
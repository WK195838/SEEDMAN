# GLA150 程式功能規格書

## 1. 基本資料
- **程式名稱**：GLA150
- **程式說明**：傳票結案作業
- **程式語言**：RPG
- **程式位置**：QRPGSRC_GLPLIB/GLA150
- **開發人員**：A1152
- **建立日期**：81/11/09
- **修改日期**：
- **系統**：總帳系統

## 2. 檔案架構與關聯圖

### 使用檔案
- **PT#BPF**：參數檔案
- **GLAKPF**：總帳基本檔案
- **GLA150D**：螢幕顯示檔案
- **GLAHLF01**：傳票檔案 (透過GLA1501C使用)
- **GLA1502P**：列印檔案 (透過GLA1501C使用)

### 程式關係
- **主程式**：GLA150
- **呼叫程式**：GLA1501C, GLI1B0
- **子程式**：GLA1501, GLA1502
- **功能鍵**：F3(離開), F4(提示), F14(處理)

## 3. 檔案欄位規格說明

### 資料結構定義
- **PTDA01**
  - $PFMT (1-1)：參數格式
  - $PTYPE (2-2)：參數類型

- **DSPFDS**
  - #CSR (370-371)：游標位置

- **LDA**
  - $USER (101-110)：使用者代碼
  - $USERN (152-161)：使用者名稱
  - $CPY (125-127)：公司代號
  - $INQ (138-138)：查詢模式
  - $A8YMD (201-208)：日期
  - $C8YMD (209-216)：日期
  - $PRTCD (217-218)：印表機代號
  - $PENV (219-219)：印表機環境
  
- **工作變數**
  - WAH25F/T (501-516)：傳票日期起迄
  - WAH10F/T (517-532)：傳票號碼起迄
  - WAH02F/T (533-550)：會計科目起迄
  - WAH26F/T (551-570)：傳票部門起迄
  - WAH17F/T (571-574)：傳票類別起迄
  - WAH01 (575-576)：公司別
  - DAH25F/T (601-615)：傳票日期欄位
  - DAH10F/T (617-631)：傳票號碼欄位

## 4. 輸出/入螢幕布局與說明

### 主要螢幕 (GLA150D)
- **螢幕標題**：傳票結案作業
- **輸入欄位**：
  - 公司別 (DAH01)：必填
  - 傳票日期起迄 (DAH25F/DAH25T)
  - 傳票號碼起迄 (DAH10F/DAH10T)
  - 會計科目起迄 (DAH02F/DAH02T)
  - 傳票部門起迄 (DAH26)
  - 傳票類別起迄 (DAH17)

- **功能鍵**：
  - F3：結束
  - F4：提示
  - F14：結案處理
  - ENTER：確認

## 5. 處理流程程序說明

### 主要流程
1. 初始化程式環境和畫面 (R0100)
2. 顯示主畫面 (R1000)
3. 處理使用者輸入
   - 若按F3：結束程式
   - 若按F4：執行提示功能 (R1E00)
   - 若按F18：呼叫GLI1B0查詢功能
   - 若按ENTER：檢查輸入資料並處理 (R1B00)
   - 若按F14：呼叫GLA1501C處理傳票結案並列印報表

4. 資料檢核通過後：
   - 呼叫GLA1501C進行傳票結案處理

### 程式初始化流程 (R0100)
1. 設定初始螢幕ID為'SC01'
2. 開啟畫面指示燈27
3. 讀取參數資料區
4. 呼叫P31設定日期格式
5. 初始化所有輸入欄位為空白或零

## 6. 子程序處理邏輯說明

### 螢幕處理 (R1000)
- 顯示主畫面並等待使用者輸入
- 處理功能鍵及輸入資料
- 根據不同功能鍵執行對應處理

### 資料檢核 (R1B00)
- 檢查必填欄位公司別 (DAH01)
- 檢查公司別是否有效
- 檢查日期格式與範圍
- 檢查傳票號碼格式與範圍
- 檢查會計科目、部門、類別格式與範圍
- 若任一檢核失敗，設定錯誤指示燈並返回主畫面

### 提示功能 (R1E00)
- 根據游標位置提供適當的提示功能
- 游標在印表機欄位時呼叫P64I提供印表機選擇

## 7. 錯誤處理程序說明與訊息清冊

### 錯誤訊息
- **UPT0010**：必填欄位未輸入 (公司別) (欄位61)
- **UGL0004**：公司別不存在或狀態無效 (欄位61)
- **UPT0040**：日期格式錯誤 (欄位62/63/64/65)
- **UPT0042**：輸入範圍錯誤，起始值大於結束值 (欄位62/63/64/65/66)

### 錯誤處理
- 設定對應的錯誤指示燈
- 返回主畫面並顯示錯誤訊息
- 將游標定位在錯誤欄位

## 8. 備註

本程式用於處理已登錄但尚未結案的傳票，進行結案處理。主要功能包括：

1. 提供多種條件選擇，包括日期範圍、傳票號碼、會計科目、部門和傳票類別
2. 根據條件篩選符合要求的傳票
3. 將選中的傳票標記為已結案（設定AH20欄位）
4. 可選擇列印結案報表

程式執行後會呼叫GLA1501C處理實際的結案作業，該程式會使用OPNQRYF來篩選符合條件的傳票，並透過GLA1501進行實際的結案處理，或透過GLA1502產生結案報表。 